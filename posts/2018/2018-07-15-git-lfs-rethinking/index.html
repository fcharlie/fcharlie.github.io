<!doctype html><html lang=en><head><title>Git LFS 的反思</title>
<meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=5" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><script src=/js/toc.js></script><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Material+Icons"></head><body><div id=app><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>归档
</a><a class="a-block drawer-menu-item false" href=/categories>分类
</a><a class="a-block drawer-menu-item false" href=/tags>标签
</a><a class="a-block drawer-menu-item false" href=/about>关于
</a><a class="a-block drawer-menu-item false" href=/index.xml>RSS Feed</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><li><a href=#%e5%89%8d%e8%a8%80 class=nav-前言>前言</a></li><li><a href=#%e5%85%b3%e4%ba%8e-git-lfs class=nav-关于-git-lfs>关于 Git LFS</a></li><li><a href=#git-lfs-%e5%ad%98%e5%82%a8 class=nav-git-lfs-存储>Git LFS 存储</a></li><ul><li><a href=#github-lfs-%e5%ad%98%e5%82%a8 class=nav-github-lfs-存储>Github LFS 存储</a></li><li><a href=#bitbucket-lfs-%e5%ad%98%e5%82%a8 class=nav-bitbucket-lfs-存储>Bitbucket LFS 存储</a></li><li><a href=#moses-to-lfsoss class=nav-moses-to-lfsoss>Moses to LFSOSS</a></li></ul><li><a href=#%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e5%af%b9%e6%af%94 class=nav-对象存储的对比>对象存储的对比</a></li><li><a href=#%e5%8f%8d%e6%80%9d class=nav-反思>反思</a></li><li><a href=#%e5%85%b6%e4%bb%96 class=nav-其他>其他</a></li><ul><li><a href=#%e5%85%b1%e4%ba%ab%e5%af%86%e9%92%a5%e4%b8%8b%e8%bd%bd class=nav-共享密钥下载>共享密钥下载</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu
</i></button>
<a id=navTitle class=navbar-brand href=https://forcemz.net/>Charlie's Rethinking
</a><button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://forcemz.net/><div class=single-column-header-title>Charlie's Rethinking</div><div class=single-column-header-subtitle>Themed by Diary.</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>Git LFS 的反思<div class=post-meta><time itemprop=datePublished>2018-07-15 10:00
</time><i class=material-icons>folder</i>
<a href=/categories/git>git</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h1 id=前言>前言</h1><p>在一年多以前，笔者曾经写过一文： <a href=https://forcemz.net/git/2017/04/16/Moses/>《Git LFS 服务器实现杂谈》</a>，最近笔者开发基于<strong>对象存储</strong>的 LFS 服务器又有了一些心得，这里分享给大家。</p><h1 id=关于-git-lfs>关于 Git LFS</h1><p>Git LFS 即 Git Large File Storage （大文件存储），即将 git 存储库中的体积较大的，不利于打包的，修改不太频繁的文件单独存储到特定的服务器上，以减小存储库体积，加快用户的克隆拉取体验。其中的原理在 <a href=https://forcemz.net/git/2017/04/16/Moses/>《Git LFS 服务器实现杂谈》</a> 都有说明，如果需要进一步的了解还可以去参考 Git LFS 技术规范： <a href=https://github.com/git-lfs/git-lfs/blob/master/docs/spec.md>spec.md</a>。</p><p>按照 LFS 规范，只要实现了 Git LFS API 以及相应的接口，LFS 客户端并不会关心大文件存储在那个地方。</p><h1 id=git-lfs-存储>Git LFS 存储</h1><p>LFS 对象可以存储到代码托管平台的服务器上，也可以存储到对象存储服务器上，不同的平台有不同的选择。这里选择几个分析一下。</p><h2 id=github-lfs-存储>Github LFS 存储</h2><p>Github 很早就与 Amazon 有深度的合作，比如 Github 的附件，Release 都是将文件存储到 AWS S3 上，然后时候共享密钥的方式下载，Github 将这些文件放在 S3 上，减轻了 Github 自身服务器的负载。文件备份等都不需要 Github 自己管理，这无疑降低了开发的难度。</p><p>所以在实现 Git LFS 时，Github 也将对象存储到 AWS S3 上，我们可以通过如下命令去调试 Github 的对象存储：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#58a1dd>GIT_TRACE_PACKET</span><span style=color:#ff636f>=</span><span style=color:#a6be9d>1</span> <span style=color:#58a1dd>GIT_TRACE</span><span style=color:#ff636f>=</span><span style=color:#a6be9d>1</span> <span style=color:#58a1dd>GIT_CURL_VERBOSE</span><span style=color:#ff636f>=</span><span style=color:#a6be9d>1</span> git push
</span></span></code></pre></div><p>下面是 <strong>upload</strong> 数据：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>&#34;objects&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;oid&#34;</span>: <span style=color:#a6be9d>&#34;42e44ce1337ecd9bab99e78f42df5f73ae1a7e5bda505054e04cd4f36ed7bf21&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;size&#34;</span>: <span style=color:#a6be9d>2097152</span>,
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;actions&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#58a1dd>&#34;upload&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#58a1dd>&#34;href&#34;</span>: <span style=color:#a6be9d>&#34;https://github-cloud.s3.amazonaws.com/alambic/media/180597487/42/e4/42e44ce1337ecd9bab99e78f42df5f73ae1a7e5bda505054e04cd4f36ed7bf21?actor_id=6904176&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#58a1dd>&#34;header&#34;</span>: {
</span></span><span style=display:flex><span>                        <span style=color:#58a1dd>&#34;Authorization&#34;</span>: <span style=color:#a6be9d>&#34;AWS4-HMAC-SHA256 Credential=AKIAIMWPLRQEC4XCWWPA/20180628/us-east-1/s3/aws4_request,SignedHeaders=host;x-amz-content-sha256;x-amz-date,Signature=SignatureString&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#58a1dd>&#34;x-amz-content-sha256&#34;</span>: <span style=color:#a6be9d>&#34;42e44ce1337ecd9bab99e78f42df5f73ae1a7e5bda505054e04cd4f36ed7bf21&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#58a1dd>&#34;x-amz-date&#34;</span>: <span style=color:#a6be9d>&#34;20180628T032201Z&#34;</span>
</span></span><span style=display:flex><span>                    },
</span></span><span style=display:flex><span>                    <span style=color:#58a1dd>&#34;expires_at&#34;</span>: <span style=color:#a6be9d>&#34;2018-06-28T03:37:01Z&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#58a1dd>&#34;expires_in&#34;</span>: <span style=color:#a6be9d>900</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#58a1dd>&#34;verify&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#58a1dd>&#34;href&#34;</span>: <span style=color:#a6be9d>&#34;https://lfs.github.com/lfstest/lfstest/objects/42e44ce1337ecd9bab99e78f42df5f73ae1a7e5bda505054e04cd4f36ed7bf21/verify&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#58a1dd>&#34;header&#34;</span>: {
</span></span><span style=display:flex><span>                        <span style=color:#58a1dd>&#34;Authorization&#34;</span>: <span style=color:#a6be9d>&#34;RemoteAuth Token&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#58a1dd>&#34;Accept&#34;</span>: <span style=color:#a6be9d>&#34;application/vnd.git-lfs+json&#34;</span>
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>将对象存储到 S3 上，存在一个缺点，即当 <strong>upload</strong> 成功后，Github 是无法被动感知的，S3 目前并没有 Update-Callback 这样的功能，Git LFS 有一个 <code>verify</code> 字段，即通知服务器去验证 <strong>upload</strong> 是否成功。</p><h2 id=bitbucket-lfs-存储>Bitbucket LFS 存储</h2><p>Bitbucket 也是一个比较大的代码托管平台，Bitbucket 的 LFS 做的比较精致，下面有一篇 Tutorials 详细介绍了如何使用 LFS： <a href=https://www.atlassian.com/git/tutorials/git-lfs>Git LFS Tutorials</a></p><p>下面是 Bitbucket LFS 的管理界面。</p><p><img src=https://wac-cdn.atlassian.com/dam/jcr:46218516-f4aa-490a-9afc-c36ca863c98f/09.png alt></p><p>我们可以使用 Git 调试模式获得 Bitbucket 的一些细节，下面是 <strong>download</strong> 的数据：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#58a1dd>&#34;objects&#34;</span>: [{
</span></span><span style=display:flex><span>		<span style=color:#58a1dd>&#34;oid&#34;</span>: <span style=color:#a6be9d>&#34;e29b4e1206ef04580f63cedd043834296fd56ad777d1903a0cab8b6178f6a6e0&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#58a1dd>&#34;actions&#34;</span>: {
</span></span><span style=display:flex><span>			<span style=color:#58a1dd>&#34;download&#34;</span>: {
</span></span><span style=display:flex><span>				<span style=color:#58a1dd>&#34;header&#34;</span>: {
</span></span><span style=display:flex><span>					<span style=color:#58a1dd>&#34;X-Client-ID&#34;</span>: <span style=color:#a6be9d>&#34;uuid-token&#34;</span>,
</span></span><span style=display:flex><span>					<span style=color:#58a1dd>&#34;Authorization&#34;</span>: <span style=color:#a6be9d>&#34;Bearer BearerToken&#34;</span>
</span></span><span style=display:flex><span>				},
</span></span><span style=display:flex><span>				<span style=color:#58a1dd>&#34;href&#34;</span>: <span style=color:#a6be9d>&#34;https://api.media.atlassian.com/file/6d4949ce-2442-424b-9875-983008b943d0/binary&#34;</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		<span style=color:#58a1dd>&#34;size&#34;</span>: <span style=color:#a6be9d>1048576</span>
</span></span><span style=display:flex><span>	}]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>从 JSON 数据中，我们可以知道 Bitbucket 并没有直接将对象存储到云服务对象存储上，并且 Bitbucket 使用了 OAuth 的验证方式。</p><p>Bitbucket 这种设计在实现精致的 LFS 管理功能时很有帮助，而 Github 将对象存储到 S3 上， 一来无法直接检验对象的 SHA256，另一方面无法检测对象的 <code>Mime</code>，也就无法做到像 Bitbucket 这样的效果。Bitbucket 可以查看 LFS 对象的 Mime(File Type)，上传时间，还可以通过删除比较旧的对象，从而降低 LFS 文件的配额占用。从这些方面来看 Bitbucket 更胜一筹。但也无法享受对象存储的好处了。</p><h2 id=moses-to-lfsoss>Moses to LFSOSS</h2><p>码云在去年开发 LFS 功能时使用的是和 Bitbucket 一样的机制，没有使用对象共享，即当 Sha256 一致时，并不支持共享，这无疑增加了服务器存储占用。</p><p>最近，随着需求的改变，我们要将 LFS 对象存储到 OSS 上，于是笔者也就开发了 LFSOSS 了，支持多种后端，只需要修改特定 URL 的生成即可支持。而不同的云存储的对象存储也有一些优缺点。</p><h1 id=对象存储的对比>对象存储的对比</h1><p>码云在支持 LFS for OSS 时，考察了几个对象存储。如 Azure Blob，Amazon S3，Aliyun OSS，Tencent COS。</p><table><thead><tr><th>Object Storage</th><th>Shared Key</th><th>Content Verify</th></tr></thead><tbody><tr><td>Azure Blob</td><td>Hmac Sha256</td><td>Content-MD5</td></tr><tr><td>Amazon S3</td><td>Hmac Sha256</td><td>Content-MD5, x-amz-content-sha256</td></tr><tr><td>Aliyun OSS</td><td>Hmac Sha1</td><td>Content-MD5, x-oss-callback</td></tr><tr><td>Tencent COS</td><td>Hmac Sha1</td><td>Content-MD5</td></tr></tbody></table><p>选择不同的云服务，不但需要考虑这些云服务的功能，还需要考虑到一些经济因素。我们可以看到在安全上，AWS S3 无疑是最好的，Azure 次之，其他的安全意识并不能算非常好，毕竟 MD5/SHA1 早已经被破解。如果考虑到对象存储服务器上使用 Hash 作为对象的索引，SHA1 无疑是不合适的，尽管 Aliyun OSS 并不能完美的切合 LFS，但由于国内的一些现状，码云仍旧基于 Aliyun 做出了一些设计上的让步，避免 LFS 在上传到对象存储时出现对象污染的情况。</p><p>回过头来看，Git LFS 更像是基于 AWS S3 定制的一样，S3 上传支持 <code>x-amz-content-sha256</code> 而 Git LFS 对象的 Hash 算法也是选择的 <code>SHA256</code>，还提供了 <code>Verify</code> 这样的功能。</p><h1 id=反思>反思</h1><p>对象存储的安全意识要跟上，避免平台的局限性而导致服务设计的妥协。</p><p>不同的设计能够实现不同的功能，这更需要取舍。</p><h1 id=其他>其他</h1><h2 id=共享密钥下载>共享密钥下载</h2><p>共享密钥实际上就是将请求的一些数据与过期时间等合成一个 Slat，使用云平台生成的 AccessKeySecret 作为 Key，基于 Hmac 生成的签名，其中不同的平台支持不同的 Hmac 安全算法。大致的原理实际上可以用如下伪代码表示：</p><pre tabindex=0><code>Slat=PlatfromMethod(ReqData,Expires,....)
Signature=Hmac(Secret,Slat)
</code></pre><hr width=100% id=EOF><p style=color:#777>Last modified on 2018-07-15</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/2018/2018-11-15-clangbuilder-win-curl/>Next<br>Clangbuilder 已支持自动构建 CURL
</a><a class=older-posts href=/posts/2018/2018-06-24-git-wire-protocol/>Previous<br>Git Wire 协议杂谈</a></nav><div class=post-comment-wrapper></div></div></div></div></div><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://forcemz.net/><div class=nav-title>Charlie's Rethinking</div><div class=nav-subtitle>Themed by Diary.</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>归档
</a><a class="a-block nav-link-item false" href=/categories>分类
</a><a class="a-block nav-link-item false" href=/tags>标签
</a><a class="a-block nav-link-item false" href=/about>关于
</a><a class="a-block nav-link-item false" href=/index.xml>RSS Feed</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><div id=extraContainer class=extra-container><div class=toc-wrapper><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><li><a href=#%e5%89%8d%e8%a8%80 class=nav-前言>前言</a></li><li><a href=#%e5%85%b3%e4%ba%8e-git-lfs class=nav-关于-git-lfs>关于 Git LFS</a></li><li><a href=#git-lfs-%e5%ad%98%e5%82%a8 class=nav-git-lfs-存储>Git LFS 存储</a></li><ul><li><a href=#github-lfs-%e5%ad%98%e5%82%a8 class=nav-github-lfs-存储>Github LFS 存储</a></li><li><a href=#bitbucket-lfs-%e5%ad%98%e5%82%a8 class=nav-bitbucket-lfs-存储>Bitbucket LFS 存储</a></li><li><a href=#moses-to-lfsoss class=nav-moses-to-lfsoss>Moses to LFSOSS</a></li></ul><li><a href=#%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e5%af%b9%e6%af%94 class=nav-对象存储的对比>对象存储的对比</a></li><li><a href=#%e5%8f%8d%e6%80%9d class=nav-反思>反思</a></li><li><a href=#%e5%85%b6%e4%bb%96 class=nav-其他>其他</a></li><ul><li><a href=#%e5%85%b1%e4%ba%ab%e5%af%86%e9%92%a5%e4%b8%8b%e8%bd%bd class=nav-共享密钥下载>共享密钥下载</a></li></ul></div></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up
</i></a><a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><script src=/js/journal.js></script></body></html>