<!doctype html><html lang=en><head><title>Privexec 杂谈</title>
<meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=5" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><script src=/js/toc.js></script><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Material+Icons"></head><body><div id=app><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>归档
</a><a class="a-block drawer-menu-item false" href=/categories>分类
</a><a class="a-block drawer-menu-item false" href=/tags>标签
</a><a class="a-block drawer-menu-item false" href=/about>关于
</a><a class="a-block drawer-menu-item false" href=/index.xml>RSS Feed</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><li><a href=#%e5%89%8d%e8%a8%80 class=nav-前言>前言</a></li><ul><li><a href=#process class=nav-process>Process</a></li><li><a href=#privexec-gui class=nav-privexec-gui>Privexec (GUI)</a></li><li><a href=#wsudo class=nav-wsudo>WSUDO</a></li><li><a href=#details class=nav-details>Details</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu
</i></button>
<a id=navTitle class=navbar-brand href=https://forcemz.net/>江二十三的思考
</a><button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://forcemz.net/><div class=single-column-header-title>江二十三的思考</div><div class=single-column-header-subtitle>Themed by Diary.</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>Privexec 杂谈<div class=post-meta><time itemprop=datePublished>2018-11-30 21:00
</time><i class=material-icons>folder</i>
<a href=/categories/windows>windows</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h1 id=前言>前言</h1><p>本站的开篇就是讲的 <a href=https://forcemz.net/container/2015/06/12/AppContainer/>《Windows AppContainer 降权，隔离与安全》</a>，一晃三年多过去了，这三年之中，我开发了一个 <a href=https://github.com/M2Team/Privexec>Privexec</a>，一个以其他权限启动进程的工具，支持启动 <code>AppContainer</code> 进程，前段实现有用户发起了功能请求<sup>1</sup>，让 <code>Privexec</code> 支持设置 <code>AppContainer</code> 的 <code>Capabilities</code>，而不是像以前一样在启动 <code>AppContainer</code> 进程时使用 <code>CreateWellKnownSid</code> 创建所有的与 <code>AppContainer</code> 相关的 <code>Capabilities SIDs</code>。于是乎，我就花了一点时间将 Privexec 重构了一番，有所感悟，便将其写下来。</p><h2 id=process>Process</h2><p>在 Windows 平台上，创建进程有 <code>WinExec</code>，<code>system</code>，<code>_spawn/_wspawn</code>，<code>CreateProcess</code>，<code>ShellExecute</code> 等多种途径，但上述函数基本上还是由 <code>CreateProcess Family</code> 封装的。在 Windows 使用 <code>C/C++</code> 创建进程应当优先使用 <code>CreateProcess</code>，CreateProcess 有三个变体，主要是为了支持以其他权限启动进程， CreateProcess 及其变体如下：</p><table><thead><tr><th>Function</th><th>Feature</th><th>Details</th></tr></thead><tbody><tr><td>CreateProcessW/A</td><td>创建常规进程，权限继承父进程权限</td><td></td></tr><tr><td>CreateProcessAsUserW/A</td><td>使用主 Token 创建进程，子进程权限与 Token 限定一致</td><td>必须开启 <code>SE_INCREASE_QUOTA_NAME</code></td></tr><tr><td>CreateProcessWithTokenW</td><td>使用主 Token 创建进程，子进程权限与 Token 限定一致</td><td>必须开启 <code>SE_IMPERSONATE_NAME</code></td></tr><tr><td>CreateProcessWithLogonW/A</td><td>使用指定用户凭据启动进程</td><td></td></tr></tbody></table><p><code>CreateProcessWithLogonW</code> 使用用户凭据获得用户令牌，然后启动进程，这等价于使用 <code>LogonUser</code> +<code>CreateProcessAsUser</code> 启动进程。</p><p><code>CreateProcessWithTokenW</code> 是 <code>Windows Vista</code> 才引入桌面系统的，没有 ANSI 版本，Github 上最常见的用法是打开桌面进程，获取其 Token，然后拷贝这个 Token 创建与桌面权限一致的进程，这是一种降权机制，仅当当前登录用户是标准用户才能降权成功。
<code>CreateProcessWithTokenW</code> 内部在调用好几个函数之后才会调用 <code>CreateProcessAsUserW</code>，在 <code>Privexec</code> 中并未使用它。
在 <code>ReactOS</code> 中，没有实现 <code>CreateProcessWithTokenW</code>，下面附上 <code>CreateProcessWithTokenW</code> 调用图：</p><p><img src=https://user-images.githubusercontent.com/6904176/62693095-6645d980-ba04-11e9-92bf-53fb526d11e9.png alt=CreateProcessWithTokenW>
<img src=https://user-images.githubusercontent.com/6904176/62693086-62b25280-ba04-11e9-84ee-d0ec5786bed3.png alt=CreateProcessWithTokenW></p><p>实际上在 <code>ReactOS</code> 中，<code>CreateProcessAsUser</code> 最终依然调用的是 <code>CreateProcess</code> 创建进程，然后将进程挂起，设置好 <code>Token</code> 后再恢复进程。在 Windows 中，你可以使用 <code>Process Monitor</code> 跟踪 <code>CreateProcessAsUser</code> 的调用堆栈，在 Windows 10 18.09 (10.0.17763.167) 中，<code>CreateProcessAsUser</code> 会调用 <code>CreateProcessInternalW</code>，而 CreateProcess 也是调用 <code>CreateProcessInternalW</code>。如果用 <code>IDA Freeware</code> <sup>2</sup> 反汇编 <code>KernelBase.dll</code> 可以发现 <code>CreateProcessAsUserW</code> 的权限最后传递到 <code>CreateProcessInternalW</code> 由 <code>CreateProcessInternalW</code> 处理了，这里与 <code>ReactOS</code> 有一定差别。</p><p><img src=https://github.com/M2Team/Privexec/raw/master/docs/images/austack.png alt=CreateProcessAsUserW></p><p>而内核中创建进程的细节讲起来篇幅过长，大家可以参考 《深入解析 Windows 操作系统 第六版（上册）》P364 <em>CreateProcess的流程</em> 。</p><p>在 Windows 中，如果要实现 <code>UAC</code> 提权，需要调用 <code>ShellExecute</code> 以 <code>runas</code> 的参数启动新的进程。如果在程序编译的清单文件中添加了如下清单代码：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span> <span style=color:#58a1dd>&lt;trustInfo</span> <span style=color:#58a1dd>xmlns=</span><span style=color:#a6be9d>&#34;urn:schemas-microsoft-com:asm.v2&#34;</span><span style=color:#58a1dd>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>&lt;security&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>&lt;requestedPrivileges</span> <span style=color:#58a1dd>xmlns=</span><span style=color:#a6be9d>&#34;urn:schemas-microsoft-com:asm.v3&#34;</span><span style=color:#58a1dd>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>&lt;requestedExecutionLevel</span> <span style=color:#58a1dd>level=</span><span style=color:#a6be9d>&#39;requireAdministrator&#39;</span> <span style=color:#58a1dd>uiAccess=</span><span style=color:#a6be9d>&#39;false&#39;</span> <span style=color:#58a1dd>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>&lt;/requestedPrivileges&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>&lt;/security&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>&lt;/trustInfo&gt;</span>
</span></span></code></pre></div><p>Shell 在启动清单附带有 UAC 提权的可执行文件时也会发生提权。以 <code>Windows 10</code> 为例，提权最终由 <code>AicLaunchAdminProcess</code> 函数实现，此函数目前实现在 <code>Windows.Storage.dll</code> 中，UAC 提权需要与 <code>Appinfo</code> 服务通信，<code>Appinfo</code> 验证提权行为后使用 <code>CreateProcessAsUserW</code> 启动进程，并将其父进程设置为 <code>ShellExecute</code> 调用者。调用细节(Windows Vista)<sup>3</sup>如下：</p><ol><li>AppInfo goes and talks to the Local Security Authority to get the elevated token of the logged in user of Session 1.</li><li>AppInfo loads up a STARTUPINFOEX structure (new to Vista), and calls the brand new Vista API InitializeProcThreadAttributeList() with room for one attribute.</li><li>OpenProcess() is called to get a handle to the process that initiated the RPC call.</li><li>UpdateProcThreadAttribute() is called with <code>PROC_THREAD_ATTRIBUTE_PARENT_PROCESS</code>, and uses the handle retrieved in step 3.</li><li>CreateProcessAsUser() is called with <code>EXTENDED_STARTUPINFO_PRESENT</code> and the results of steps 1 and 4.</li><li>DeleteProcThreadAttributeList() is called.</li><li>Results are gathered, and handles are cleaned up.</li></ol><p>Appinfo 服务描述：</p><blockquote><p>使用辅助管理权限便于交互式应用程序的运行。如果停止此服务，用户将无法使用辅助管理权限启动应用程序，而执行所需用户任务可能需要这些权限。</p></blockquote><p>当我们了解到 Windows 创建进程的粗略细节，那么就可以对 Privexec 创建其他权限的进程做出封装了。Privexec 支持的权限类型有：</p><ul><li>AppContainer</li><li>Mandatory Integrity Control</li><li>No Elevated(UAC)</li><li>Administrator</li><li>System</li><li>TrustedInstaller</li></ul><p><strong>AppContainer</strong> 通常可以使用 <code>CreateProcess</code> 创建，使用 <code>EXTENDED_STARTUPINFO_PRESENT</code> 额外的 <code>dwCreateFlags</code> 创建权限为 <code>AppContainer</code> 的进程即可。AppContainer 配置需由 <code>CreateAppContainerProfile</code> 创建，相应的 <code>Capability SID</code> 可由 <code>DeriveCapabilitySidsFromName</code> 或者 <code>CreateWellKnownSid</code> 创建，<del>而 <code>Privexec(GUI)</code> 受限与 UI 限制，目前仅支持 9 个 <code>WellKnownSid</code>，而</del>, <code>Privexec (GUI)</code> 支持从 ListView 中选择常见的 <code>Capabilities</code> 也支持从清单文件中读取，两种途径获得的 <code>Capabilities</code> 会被合并， <code>wsudo</code> 支持 <code>--appx</code> 从文件中设置 <code>Capabilities</code>，<code>wsudo</code> 中使用了 <code>DeriveCapabilitySidsFromName</code> 创建 <code>Capabilities SID</code>。</p><p>参数 <code>EXTENDED_STARTUPINFO_PRESENT</code> 表示使用 <code>STARTUPINFOEX</code> 结构，使用 <code>InitializeProcThreadAttributeList</code> 初始化 <code>STARTUPINFOEX::lpAttributeList</code>, 使用 <code>UpdateProcThreadAttribute</code> 设置 <code>lpAttributeList</code> 为 <code>PROC_THREAD_ATTRIBUTE_SECURITY_CAPABILITIES</code> 并将 <code>SECURITY_CAPABILITIES </code>绑定到 <code>STARTUPINFOEX</code> 上。</p><p><strong>Mandatory Integrity Control</strong> 主要使用 <code>SetTokenInformation</code> 将高完整性级别的 <code>Token</code> 设置为低完整性级别的 <code>Token</code> 然后使用 <code>CreateProcessAsUser</code> 创建进程。</p><p><strong>No Elevated(UAC)</strong> 当当前用户为管理员时需要使用计划任务启动 UAC 未提升进程，而计划任务主机进程也是使用 <code>CreateProcessAsUser</code> 启动非提升的进程。当当前用户不为管理员时，使用 <code>CreateProcess</code> 创建进程即可。当然如果当前管理员权限进程模拟了 <code>System</code> 令牌，可以开启进程 <code>SE_TCB_NAME</code> 权限，然后使用 <code>WTSQueryUserToken</code> 获得当前标准用户的令牌，拷贝一份此令牌，使用 <code>CreateProcessAsUser</code> 即可启动未提权的进程。</p><p><strong>Administrator</strong> 当当前进程不为管理员，则需要 UAC 提权，细节前文由描述。反之则使用 <code>CreateProcess</code> 即可。</p><p><strong>System</strong> 当前进程必须是管理员权限等级及以上进程，需要开启 <code>SE_DEBUG_NAME</code> 权限，然后获得系统权限进程的 Token, 将自身权限模拟 <code>System</code> Token，然后拷贝自身 <code>Token</code> 修改 <code>Token</code> 为 <code>Primary Token</code>，即 <code>hPrimary</code>，因为只有主 Token 才能被用于创建子进程。《Windows Internal 7th Edition》作者之一 <a href=https://github.com/zodiacon>Pavel Yosifovich</a> 就写了一个 sysrun 的例子：<a href=https://github.com/zodiacon/sysrun>sysrun</a>。</p><p><strong>TrustedInstaller</strong> 此权限严格意义上来说，是属于 <strong>Windows Modules Installer</strong> 服务的专有权限，<strong>Windows Modules Installer</strong> 的服务描述为：</p><blockquote><p>启用 Windows 更新和可选组件的安装、修改和移除。如果此服务被禁用，则此计算机的 Windows 更新的安装或卸载可能会失败。</p></blockquote><p>因此要获得此权限，需要先模拟到 <code>System</code> 权限，然后启动 <code>TrustedInstaller</code> 服务，然后获得服务进程的权限句柄，以该句柄拷贝启动新的进程。</p><p>Privexec 的进程启动相关代码在：<a href=https://github.com/M2Team/Privexec/tree/master/lib/ProcessCore>https://github.com/M2Team/Privexec/tree/master/lib/ProcessCore</a>，使用 C++17，利用 <em>Lambda</em>，<em>RIIA</em> 这样的功能可以轻易的写出句柄安全的代码。</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#ff636f>class</span> <span style=color:#58a1dd>F</span><span style=color:#ff636f>&gt;</span> <span style=color:#ff636f>class</span> <span style=color:#58a1dd>final_act</span> {
</span></span><span style=display:flex><span><span style=color:#ff636f>public</span><span style=color:#ff636f>:</span>
</span></span><span style=display:flex><span>  <span style=color:#ff636f>explicit</span> <span style=color:#58a1dd>final_act</span>(<span style=color:#58a1dd>F</span> <span style=color:#58a1dd>f</span>) <span style=color:#ff636f>noexcept</span> <span style=color:#ff636f>:</span> <span style=color:#58a1dd>f_</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>move</span>(<span style=color:#58a1dd>f</span>)), <span style=color:#58a1dd>invoke_</span>(<span style=color:#58a1dd>true</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>final_act</span>(<span style=color:#58a1dd>final_act</span> <span style=color:#ff636f>&amp;&amp;</span><span style=color:#58a1dd>other</span>) <span style=color:#ff636f>noexcept</span>
</span></span><span style=display:flex><span>      <span style=color:#ff636f>:</span> <span style=color:#58a1dd>f_</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>move</span>(<span style=color:#58a1dd>other</span>.<span style=color:#58a1dd>f_</span>)), <span style=color:#58a1dd>invoke_</span>(<span style=color:#58a1dd>other</span>.<span style=color:#58a1dd>invoke_</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>other</span>.<span style=color:#58a1dd>invoke_</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>final_act</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>final_act</span> <span style=color:#ff636f>&amp;</span>) <span style=color:#ff636f>=</span> <span style=color:#ff636f>delete</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>final_act</span> <span style=color:#ff636f>&amp;</span><span style=color:#ff636f>operator</span><span style=color:#ff636f>=</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>final_act</span> <span style=color:#ff636f>&amp;</span>) <span style=color:#ff636f>=</span> <span style=color:#ff636f>delete</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff636f>~</span><span style=color:#58a1dd>final_act</span>() <span style=color:#ff636f>noexcept</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>invoke_</span>)
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>f_</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>private</span><span style=color:#ff636f>:</span>
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>F</span> <span style=color:#58a1dd>f_</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>invoke_</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// finally() - convenience function to generate a final_act
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#ff636f>class</span> <span style=color:#58a1dd>F</span><span style=color:#ff636f>&gt;</span> <span style=color:#ff636f>inline</span> <span style=color:#58a1dd>final_act</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>F</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>finally</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>F</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>f</span>) <span style=color:#ff636f>noexcept</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>final_act</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>F</span><span style=color:#ff636f>&gt;</span>(<span style=color:#58a1dd>f</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#ff636f>class</span> <span style=color:#58a1dd>F</span><span style=color:#ff636f>&gt;</span> <span style=color:#ff636f>inline</span> <span style=color:#58a1dd>final_act</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>F</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>finally</span>(<span style=color:#58a1dd>F</span> <span style=color:#ff636f>&amp;&amp;</span><span style=color:#58a1dd>f</span>) <span style=color:#ff636f>noexcept</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>final_act</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>F</span><span style=color:#ff636f>&gt;</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>forward</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>F</span><span style=color:#ff636f>&gt;</span>(<span style=color:#58a1dd>f</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>bool</span> <span style=color:#58a1dd>filetodo</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring_view</span> <span style=color:#58a1dd>file</span>){
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>hFile</span><span style=color:#ff636f>=</span> <span style=color:#58a1dd>CreateFileW</span>(<span style=color:#58a1dd>file</span>.<span style=color:#58a1dd>data</span>(), 
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>GENERIC_READ</span>, <span style=color:#58a1dd>FILE_SHARE_READ</span>,
</span></span><span style=display:flex><span>  <span style=color:#ff636f>nullptr</span>, <span style=color:#58a1dd>OPEN_EXISTING</span>,
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>FILE_ATTRIBUTE_NORMAL</span>,
</span></span><span style=display:flex><span>  <span style=color:#ff636f>nullptr</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>hFile</span><span style=color:#ff636f>==</span><span style=color:#58a1dd>INVALID_HANDLE_VALUE</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>closer</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>finally</span>([<span style=color:#ff636f>&amp;</span>] {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>hFile</span><span style=color:#ff636f>!=</span><span style=color:#58a1dd>INVALID_HANDLE_VALUE</span>) {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>CloseHandle</span>(<span style=color:#58a1dd>hFile</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>  <span style=color:#828b96;font-style:italic>/// some codes...
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>true</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>回过头来说，你完全开发一个服务来实现以其他用户权限启动进程，然后封装一个命令，命令需要启动进程时与服务进行通信，在服务中使用 <code>CreateProcessAsUser</code> 启动新的进程。使用服务实现此功能时，需要避免不可信的提权发生。</p><p><a href=https://github.com/MouriNaruto>毛利</a> 的 <a href=https://github.com/M2Team/NSudo>NSudo</a> 与 Privexec 类似，但实现基本上是使用 <code>CreateProcessAsUser</code> + <code>Token</code> 创建进程。</p><p>题外话：在 Windows 平台上，启动进程依然有不小的代价，中间环节多，而在 Unix 平台，启动进程有 <code>fork/exec</code>，实际上要实现类似 <code>CreateProcess</code> 之类的逻辑需要使用 <code>fork/exec</code> 联合使用。现实带来了遗憾，Windows 上实现 <code>fork</code> 和 Unix 实现更高效的 <code>CreateProcess</code> 成了两个大难题。当然，在实现 <code>Windows Subsystem for Linux</code><sup>4</sup>，微软也在改进其创建进程的流程，但目前为止 <code>Minimal process</code> 并没有让 <code>cygwin</code> 这样的系统受益。</p><p><img src=https://msdnshared.blob.core.windows.net/media/2016/05/picoProcess-1024x763.png alt=picoprocess></p><h2 id=privexec-gui>Privexec (GUI)</h2><p>Privexec 狭义上是指 <code>Privexec (GUI)</code> 这个程序，现在应该指 <code>Privexec</code> 整个项目，包括 <code>wsudo</code>。在 Windows 平台上，使用 C++ 开发桌面应用虽然有很多选择，比如 <code>API, MFC, WTL, QT, DirectUI</code> 等等，但实际上基本没有一个 <strong>现代的 UI 框架</strong> 可以供你选择，上述 UI 框架或缺少自适应大小支持，或缺少高 <code>DPI</code> 支持，也可能缺少 Emoji 支持等等，另一方面不断解决依赖问题也让人厌倦。Privexec 使用 Win32 API 即可，保持极简风格也不错。Privexec 最初只是我自己开发好玩的一个工具（目前大概依然是），UI 开发选择权在我自己，而 Windows 10 <sup>5</sup>改进了基于对话框应用高 DPI 的支持，为了支持我的 <code>Surface Pro 4</code> ，于是选择了使用对话框做主界面。 界面如下：</p><p><img src=https://github.com/M2Team/Privexec/raw/master/docs/images/appcontainer.png alt=Privexec></p><p>在此次改造之前 Privexec 使用传统的 <code>Win32 API+ 全局变量</code> 这样的代码逻辑，在不断添加功能后发现代码越来越杂乱无章，于是就用 C++ 类重构了，大量使用 C++17 代码。代码地址为：<a href=https://github.com/M2Team/Privexec/tree/master/Privexec>https://github.com/M2Team/Privexec/tree/master/Privexec</a>。</p><p>我们都知道，目前 C 的 API 支持回调函数的一定只能使用全局函数或者静态成员函数。在使用 C++ 面向对象开发 UI 程序时，需要在窗口消息回调函数中先获取对象的 <code>this</code> 指针，然后再调用对象的事件处理程序。方案由多种，比如 ATL 使用的 <code>Thunk</code><sup>6</sup>，还有通过 <code>GWLP_USERDATA</code> 去传递 <code>this</code> 指针，这种用户回调携带 <code>this</code> 指针的做法简直太常见了。</p><p>ATL Thunk 相关的文章有：<a href=https://www.hackcraft.net/cpp/windowsThunk/>https://www.hackcraft.net/cpp/windowsThunk/</a></p><p>实际上，Privexec 并不需要学习 ATL/WTL 那样，使用 <code>Thunk</code> 技术，完全没有到那个程度，所以我使用了 <code>GWLP_USERDATA</code> 的做法：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#58a1dd>INT_PTR</span> <span style=color:#58a1dd>WINAPI</span> <span style=color:#58a1dd>App</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>WindowProc</span>(<span style=color:#58a1dd>HWND</span> <span style=color:#58a1dd>hWnd</span>, <span style=color:#58a1dd>UINT</span> <span style=color:#58a1dd>message</span>, <span style=color:#58a1dd>WPARAM</span> <span style=color:#58a1dd>wParam</span>,
</span></span><span style=display:flex><span>                               <span style=color:#58a1dd>LPARAM</span> <span style=color:#58a1dd>lParam</span>) {
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>App</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>app</span>{<span style=color:#ff636f>nullptr</span>};
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>message</span> <span style=color:#ff636f>==</span> <span style=color:#58a1dd>WM_INITDIALOG</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>app</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>reinterpret_cast</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>App</span> <span style=color:#ff636f>*&gt;</span>(<span style=color:#58a1dd>lParam</span>);
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>SetWindowLongPtr</span>(<span style=color:#58a1dd>hWnd</span>, <span style=color:#58a1dd>GWLP_USERDATA</span>, <span style=color:#ff636f>reinterpret_cast</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>LONG_PTR</span><span style=color:#ff636f>&gt;</span>(<span style=color:#58a1dd>app</span>));
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>app</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>Initialize</span>(<span style=color:#58a1dd>hWnd</span>);
</span></span><span style=display:flex><span>  } <span style=color:#ff636f>else</span> <span style=color:#58a1dd>if</span> ((<span style=color:#58a1dd>app</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>GetThisFromHandle</span>(<span style=color:#58a1dd>hWnd</span>)) <span style=color:#ff636f>!=</span> <span style=color:#ff636f>nullptr</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>app</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>MessageHandler</span>(<span style=color:#58a1dd>message</span>, <span style=color:#58a1dd>wParam</span>, <span style=color:#58a1dd>lParam</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>FALSE</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在 Windows 中，很多 API 实际上是由 <code>COM</code> 组件类提供，直接在 C++ 中使用 COM 对象需要小心翼翼避免资源泄漏，到了 8102 年，你应该使用智能指针或者 <code>ComPtr</code> 去包裹 COM 对象，或者使用类似下面的代码，使用 RAII 来避免资源泄漏。</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#ff636f>class</span> <span style=color:#58a1dd>T</span><span style=color:#ff636f>&gt;</span> <span style=color:#ff636f>class</span> <span style=color:#58a1dd>comptr</span> {
</span></span><span style=display:flex><span><span style=color:#ff636f>public</span><span style=color:#ff636f>:</span>
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>comptr</span>() { <span style=color:#58a1dd>ptr</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>NULL</span>; }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>comptr</span>(<span style=color:#58a1dd>T</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>p</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>ptr</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>p</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>ptr</span> <span style=color:#ff636f>!=</span> <span style=color:#58a1dd>NULL</span>)
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>ptr</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>AddRef</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>comptr</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>comptr</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>T</span><span style=color:#ff636f>&gt;</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>sptr</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>ptr</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>sptr</span>.<span style=color:#58a1dd>ptr</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>ptr</span> <span style=color:#ff636f>!=</span> <span style=color:#58a1dd>NULL</span>)
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>ptr</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>AddRef</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>T</span> <span style=color:#ff636f>**</span><span style=color:#ff636f>operator</span><span style=color:#ff636f>&amp;</span>() { <span style=color:#ff636f>return</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>ptr</span>; }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>T</span> <span style=color:#ff636f>*</span><span style=color:#ff636f>operator</span><span style=color:#ff636f>-&gt;</span>() { <span style=color:#ff636f>return</span> <span style=color:#58a1dd>ptr</span>; }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>T</span> <span style=color:#ff636f>*</span><span style=color:#ff636f>operator</span><span style=color:#ff636f>=</span>(<span style=color:#58a1dd>T</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>p</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#ff636f>*</span><span style=color:#ff636f>this</span> <span style=color:#ff636f>!=</span> <span style=color:#58a1dd>p</span>) {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>ptr</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>p</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>ptr</span> <span style=color:#ff636f>!=</span> <span style=color:#58a1dd>NULL</span>)
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>ptr</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>AddRef</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#ff636f>*</span><span style=color:#ff636f>this</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>operator</span> <span style=color:#58a1dd>T</span> <span style=color:#ff636f>*</span>() <span style=color:#ff636f>const</span> { <span style=color:#ff636f>return</span> <span style=color:#58a1dd>ptr</span>; }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#ff636f>class</span> <span style=color:#58a1dd>I</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>HRESULT</span> <span style=color:#58a1dd>QueryInterface</span>(<span style=color:#58a1dd>REFCLSID</span> <span style=color:#58a1dd>rclsid</span>, <span style=color:#58a1dd>I</span> <span style=color:#ff636f>**</span><span style=color:#58a1dd>pp</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>pp</span> <span style=color:#ff636f>!=</span> <span style=color:#58a1dd>NULL</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span> <span style=color:#58a1dd>ptr</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>QueryInterface</span>(<span style=color:#58a1dd>rclsid</span>, (<span style=color:#ff636f>void</span> <span style=color:#ff636f>**</span>)<span style=color:#58a1dd>pp</span>);
</span></span><span style=display:flex><span>    } <span style=color:#ff636f>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span> <span style=color:#58a1dd>E_FAIL</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>HRESULT</span> <span style=color:#58a1dd>CoCreateInstance</span>(<span style=color:#58a1dd>REFCLSID</span> <span style=color:#58a1dd>clsid</span>, <span style=color:#58a1dd>IUnknown</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>pUnknown</span>,
</span></span><span style=display:flex><span>                           <span style=color:#58a1dd>REFIID</span> <span style=color:#58a1dd>interfaceId</span>,
</span></span><span style=display:flex><span>                           <span style=color:#58a1dd>DWORD</span> <span style=color:#58a1dd>dwClsContext</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>CLSCTX_ALL</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>HRESULT</span> <span style=color:#58a1dd>hr</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>::</span><span style=color:#58a1dd>CoCreateInstance</span>(<span style=color:#58a1dd>clsid</span>, <span style=color:#58a1dd>pUnknown</span>, <span style=color:#58a1dd>dwClsContext</span>, <span style=color:#58a1dd>interfaceId</span>,
</span></span><span style=display:flex><span>                                    (<span style=color:#ff636f>void</span> <span style=color:#ff636f>**</span>)<span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>ptr</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>hr</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>~</span><span style=color:#58a1dd>comptr</span>() {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>ptr</span> <span style=color:#ff636f>!=</span> <span style=color:#58a1dd>NULL</span>)
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>ptr</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>Release</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>private</span><span style=color:#ff636f>:</span>
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>T</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>ptr</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Privexec 使用了 <code>pugixml</code> 用于解析 <code>AppManifest</code>，使用 <code>json.hpp</code> 解析 Alias 配置文件。</p><p>在 Privexec 中的错误提示 <code>MessageBox</code> 实际上是使用 <code>TaskDialog</code> 编写，而关于对话框同样也是。查找文件/文件夹对话框使用的是 <code>IFileDialog</code>。</p><h2 id=wsudo>WSUDO</h2><p>WSUDO 是 Priexec 的命令行版本。很早就支持颜色高亮，在前文中曾写过一篇文章 <a href=https://forcemz.net/windows/2017/06/06/ColorConsole/>《Privexec 的内幕（一）标准输出原理与彩色输出实现》</a> 对此有详细的介绍。此次重构 WSUDO，改进了命令行解析模式，可以通过命令行设置启动进程的<strong>启动目录</strong>，<strong>环境变量</strong>，<strong>AppConatiner</strong> 清单文件，具体的命令行内容如下：</p><p><img src=https://github.com/M2Team/Privexec/raw/master/docs/images/wsudo.png alt=WSUDO></p><p>在创建进程时，如果 <code>CreateProcess</code> 的参数 <a href=https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessw><code>lpEnvironment</code></a> 为 <code>NULL</code> 时，子进程将继承父进程的环境变量，这与 <code>Unix</code> (<code>exec</code> 函数家族) 系统是一致的。如果我们要设置子进程的环境变量，我们可以修改 wsudo 的环境变量传递给子进程即可。这次，我给 WSUDO 添加了 <code>-e(--env)</code> flag. 可以使用 <code>-eK=V</code>，<code>-e K=V</code> <code>--env=K=V</code>，<code>--env K=V</code> 这样的方式设置环境变量。</p><p>WSUDO 目前还支持 <code>--new-console</code> <code>--wait</code> 这样的 flag，在 Windows 中，创建 CUI 进程时，默认参数下，如果程序的子系统是 <code>Windows CUI</code>，如果父进程也是 <code>CUI</code> 程序就会继承父进程的控制台窗口，否则会创建一个新的控制台窗口。这就意味这 WSUDO 在启动 CUI 子进程时，CUI 子进程实际上的窗口也会继承 WSUDO 的当前窗口，而之前的 WSUDO 在子进程启动后就结束了，CMD/PowerShell 的等待也就结束了，这时候如果 CUI 子进程还活跃，可能对控制台窗口读写从而会导致控制台窗口输入输出紊乱。这个问题的解决方法有：</p><ul><li>WSUDO 等待子进程结束</li><li>或者启动新控制台</li></ul><p>而这次重构专门增加了 <code>--new-console</code> 和 <code>--wait</code>，并修改 WSUDO 的启动进程的默认行为，具体情形如下：</p><table><thead><tr><th>子系统</th><th>&ndash;new-console</th><th>&ndash;wait</th></tr></thead><tbody><tr><td>Windows CUI</td><td>默认关闭</td><td>默认开启</td></tr><tr><td>Windows GUI</td><td>N/A</td><td>默认关闭</td></tr></tbody></table><p>如果子进程子系统是 <code>Windows GUI</code> 且命令行参数包含 <code>--wait</code>，WSUDO 依然会等待子进程结束。</p><p>在启动子进程的之前，我们可以通过解析 <code>PE</code> 文件格式去感知可执行程序子系统是否是 <code>Windows CUI</code>，具体代码在：<a href=https://github.com/M2Team/Privexec/blob/f9a2cbbfa57a3bda65e6c70b74e80b8cc67af333/include/pe.hpp#L130>PESubsystemIsConsole</a></p><p>如果要支持 <code>AppExecLink(IO_REPARSE_TAG_APPEXECLINK)</code> 这样特殊的文件（这种文件类似于 Windows Symbolic File，是 UWP App 的程序的特殊链接文件。）需要解析重解析点，大致代码如下：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>inline</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>readlink</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>symfile</span>, <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>realfile</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>hFile</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>CreateFileW</span>(
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>symfile</span>.<span style=color:#58a1dd>c_str</span>(), <span style=color:#a6be9d>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>FILE_SHARE_READ</span> <span style=color:#ff636f>|</span> <span style=color:#58a1dd>FILE_SHARE_WRITE</span> <span style=color:#ff636f>|</span> <span style=color:#58a1dd>FILE_SHARE_DELETE</span>, <span style=color:#ff636f>nullptr</span>,
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>OPEN_EXISTING</span>, <span style=color:#58a1dd>FILE_FLAG_BACKUP_SEMANTICS</span> <span style=color:#ff636f>|</span> <span style=color:#58a1dd>FILE_FLAG_OPEN_REPARSE_POINT</span>,
</span></span><span style=display:flex><span>      <span style=color:#ff636f>nullptr</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>hFile</span> <span style=color:#ff636f>==</span> <span style=color:#58a1dd>INVALID_HANDLE_VALUE</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>ReparseBuffer</span> <span style=color:#58a1dd>rbuf</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>DWORD</span> <span style=color:#58a1dd>dwBytes</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>DeviceIoControl</span>(<span style=color:#58a1dd>hFile</span>, <span style=color:#58a1dd>FSCTL_GET_REPARSE_POINT</span>, <span style=color:#ff636f>nullptr</span>, <span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>rbuf</span>.<span style=color:#58a1dd>data</span>,
</span></span><span style=display:flex><span>                      <span style=color:#58a1dd>MAXIMUM_REPARSE_DATA_BUFFER_SIZE</span>, <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>dwBytes</span>,
</span></span><span style=display:flex><span>                      <span style=color:#ff636f>nullptr</span>) <span style=color:#ff636f>!=</span> <span style=color:#58a1dd>TRUE</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>CloseHandle</span>(<span style=color:#58a1dd>hFile</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>CloseHandle</span>(<span style=color:#58a1dd>hFile</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>switch</span> (<span style=color:#58a1dd>rbuf</span>.<span style=color:#58a1dd>data</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>ReparseTag</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>case</span> <span style=color:#58a1dd>IO_REPARSE_TAG_SYMLINK</span>: {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>wstr</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>rbuf</span>.<span style=color:#58a1dd>data</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>SymbolicLinkReparseBuffer</span>.<span style=color:#58a1dd>PathBuffer</span> <span style=color:#ff636f>+</span>
</span></span><span style=display:flex><span>                (<span style=color:#58a1dd>rbuf</span>.<span style=color:#58a1dd>data</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>SymbolicLinkReparseBuffer</span>.<span style=color:#58a1dd>SubstituteNameOffset</span> <span style=color:#ff636f>/</span>
</span></span><span style=display:flex><span>                 <span style=color:#ff636f>sizeof</span>(<span style=color:#58a1dd>WCHAR</span>));
</span></span><span style=display:flex><span>    <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>wlen</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>rbuf</span>.<span style=color:#58a1dd>data</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>SymbolicLinkReparseBuffer</span>.<span style=color:#58a1dd>SubstituteNameLength</span> <span style=color:#ff636f>/</span>
</span></span><span style=display:flex><span>                <span style=color:#ff636f>sizeof</span>(<span style=color:#58a1dd>WCHAR</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>wlen</span> <span style=color:#ff636f>&gt;=</span> <span style=color:#a6be9d>4</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>0</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;\\&#39;</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>1</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;?&#39;</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>2</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;?&#39;</span> <span style=color:#ff636f>&amp;&amp;</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>3</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;\\&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#828b96;font-style:italic>/* Starts with \??\ */</span>
</span></span><span style=display:flex><span>      <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>wlen</span> <span style=color:#ff636f>&gt;=</span> <span style=color:#a6be9d>6</span> <span style=color:#ff636f>&amp;&amp;</span>
</span></span><span style=display:flex><span>          ((<span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>4</span>] <span style=color:#ff636f>&gt;=</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;A&#39;</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>4</span>] <span style=color:#ff636f>&lt;=</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;Z&#39;</span>) <span style=color:#ff636f>||</span>
</span></span><span style=display:flex><span>           (<span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>4</span>] <span style=color:#ff636f>&gt;=</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;a&#39;</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>4</span>] <span style=color:#ff636f>&lt;=</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;z&#39;</span>)) <span style=color:#ff636f>&amp;&amp;</span>
</span></span><span style=display:flex><span>          <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>5</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;:&#39;</span> <span style=color:#ff636f>&amp;&amp;</span> (<span style=color:#58a1dd>wlen</span> <span style=color:#ff636f>==</span> <span style=color:#a6be9d>6</span> <span style=color:#ff636f>||</span> <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>6</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;\\&#39;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#828b96;font-style:italic>/* \??\&lt;drive&gt;:\ */</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>wstr</span> <span style=color:#ff636f>+=</span> <span style=color:#a6be9d>4</span>;
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>wlen</span> <span style=color:#ff636f>-=</span> <span style=color:#a6be9d>4</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      } <span style=color:#ff636f>else</span> <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>wlen</span> <span style=color:#ff636f>&gt;=</span> <span style=color:#a6be9d>8</span> <span style=color:#ff636f>&amp;&amp;</span> (<span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>4</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;U&#39;</span> <span style=color:#ff636f>||</span> <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>4</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;u&#39;</span>) <span style=color:#ff636f>&amp;&amp;</span>
</span></span><span style=display:flex><span>                 (<span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>5</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;N&#39;</span> <span style=color:#ff636f>||</span> <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>5</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;n&#39;</span>) <span style=color:#ff636f>&amp;&amp;</span>
</span></span><span style=display:flex><span>                 (<span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>6</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;C&#39;</span> <span style=color:#ff636f>||</span> <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>6</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;c&#39;</span>) <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>7</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;\\&#39;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#828b96;font-style:italic>/* \??\UNC\&lt;server&gt;\&lt;share&gt;\ - make sure the final path looks like */</span>
</span></span><span style=display:flex><span>        <span style=color:#828b96;font-style:italic>/* \\&lt;server&gt;\&lt;share&gt;\ */</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>wstr</span> <span style=color:#ff636f>+=</span> <span style=color:#a6be9d>6</span>;
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>0</span>] <span style=color:#ff636f>=</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;\\&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>wlen</span> <span style=color:#ff636f>-=</span> <span style=color:#a6be9d>6</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>realfile</span>.<span style=color:#58a1dd>assign</span>(<span style=color:#58a1dd>wstr</span>, <span style=color:#58a1dd>wlen</span>);
</span></span><span style=display:flex><span>  } <span style=color:#ff636f>break</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>case</span> <span style=color:#58a1dd>IO_REPARSE_TAG_MOUNT_POINT</span>: {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>wstr</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>rbuf</span>.<span style=color:#58a1dd>data</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>MountPointReparseBuffer</span>.<span style=color:#58a1dd>PathBuffer</span> <span style=color:#ff636f>+</span>
</span></span><span style=display:flex><span>                (<span style=color:#58a1dd>rbuf</span>.<span style=color:#58a1dd>data</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>MountPointReparseBuffer</span>.<span style=color:#58a1dd>SubstituteNameOffset</span> <span style=color:#ff636f>/</span>
</span></span><span style=display:flex><span>                 <span style=color:#ff636f>sizeof</span>(<span style=color:#58a1dd>WCHAR</span>));
</span></span><span style=display:flex><span>    <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>wlen</span> <span style=color:#ff636f>=</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>rbuf</span>.<span style=color:#58a1dd>data</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>MountPointReparseBuffer</span>.<span style=color:#58a1dd>SubstituteNameLength</span> <span style=color:#ff636f>/</span> <span style=color:#ff636f>sizeof</span>(<span style=color:#58a1dd>WCHAR</span>);
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>/* Only treat junctions that look like \??\&lt;drive&gt;:\ as symlink. */</span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>/* Junctions can also be used as mount points, like \??\Volume{&lt;guid&gt;}, */</span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>/* but that&#39;s confusing for programs since they wouldn&#39;t be able to */</span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>/* actually understand such a path when returned by uv_readlink(). */</span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>/* UNC paths are never valid for junctions so we don&#39;t care about them. */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#ff636f>!</span>(<span style=color:#58a1dd>wlen</span> <span style=color:#ff636f>&gt;=</span> <span style=color:#a6be9d>6</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>0</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;\\&#39;</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>1</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;?&#39;</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>2</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;?&#39;</span> <span style=color:#ff636f>&amp;&amp;</span>
</span></span><span style=display:flex><span>          <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>3</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;\\&#39;</span> <span style=color:#ff636f>&amp;&amp;</span>
</span></span><span style=display:flex><span>          ((<span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>4</span>] <span style=color:#ff636f>&gt;=</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;A&#39;</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>4</span>] <span style=color:#ff636f>&lt;=</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;Z&#39;</span>) <span style=color:#ff636f>||</span>
</span></span><span style=display:flex><span>           (<span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>4</span>] <span style=color:#ff636f>&gt;=</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;a&#39;</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>4</span>] <span style=color:#ff636f>&lt;=</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;z&#39;</span>)) <span style=color:#ff636f>&amp;&amp;</span>
</span></span><span style=display:flex><span>          <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>5</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;:&#39;</span> <span style=color:#ff636f>&amp;&amp;</span> (<span style=color:#58a1dd>wlen</span> <span style=color:#ff636f>==</span> <span style=color:#a6be9d>6</span> <span style=color:#ff636f>||</span> <span style=color:#58a1dd>wstr</span>[<span style=color:#a6be9d>6</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;\\&#39;</span>))) {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>SetLastError</span>(<span style=color:#58a1dd>ERROR_SYMLINK_NOT_SUPPORTED</span>);
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>/* Remove leading \??\ */</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>wstr</span> <span style=color:#ff636f>+=</span> <span style=color:#a6be9d>4</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>wlen</span> <span style=color:#ff636f>-=</span> <span style=color:#a6be9d>4</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>realfile</span>.<span style=color:#58a1dd>assign</span>(<span style=color:#58a1dd>wstr</span>, <span style=color:#58a1dd>wlen</span>);
</span></span><span style=display:flex><span>  } <span style=color:#ff636f>break</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>case</span> <span style=color:#58a1dd>IO_REPARSE_TAG_APPEXECLINK</span>: {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>rbuf</span>.<span style=color:#58a1dd>data</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>AppExecLinkReparseBuffer</span>.<span style=color:#58a1dd>StringCount</span> <span style=color:#ff636f>!=</span> <span style=color:#a6be9d>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>LPWSTR</span> <span style=color:#58a1dd>szString</span> <span style=color:#ff636f>=</span> (<span style=color:#58a1dd>LPWSTR</span>)<span style=color:#58a1dd>rbuf</span>.<span style=color:#58a1dd>data</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>AppExecLinkReparseBuffer</span>.<span style=color:#58a1dd>StringList</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>for</span> (<span style=color:#58a1dd>ULONG</span> <span style=color:#58a1dd>i</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>; <span style=color:#58a1dd>i</span> <span style=color:#ff636f>&lt;</span> <span style=color:#58a1dd>rbuf</span>.<span style=color:#58a1dd>data</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>AppExecLinkReparseBuffer</span>.<span style=color:#58a1dd>StringCount</span>;
</span></span><span style=display:flex><span>           <span style=color:#58a1dd>i</span><span style=color:#ff636f>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>i</span> <span style=color:#ff636f>==</span> <span style=color:#a6be9d>2</span>) {
</span></span><span style=display:flex><span>          <span style=color:#58a1dd>realfile</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>szString</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>szString</span> <span style=color:#ff636f>+=</span> <span style=color:#58a1dd>wcslen</span>(<span style=color:#58a1dd>szString</span>) <span style=color:#ff636f>+</span> <span style=color:#a6be9d>1</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  } <span style=color:#ff636f>break</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>default</span><span style=color:#ff636f>:</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>true</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>WSUDO 还支持内置命令 <code>alias</code>，可以增加和删除别名。增加别名时如果别名存在则会被覆盖：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-batch data-lang=batch><span style=display:flex><span>wsudo alias add ehs <span style=color:#a6be9d>&#34;notepad </span><span style=color:#58a1dd>%SYSTEMROOT%</span><span style=color:#a6be9d>/System32/drivers/etc/hosts&#34;</span> <span style=color:#a6be9d>&#34;Edit Hosts&#34;</span>
</span></span><span style=display:flex><span>wsudo alias delete ehs
</span></span></code></pre></div><h2 id=details>Details</h2><ol><li><a href=https://github.com/M2Team/Privexec/issues/2>Feature Request: AppContainer &ldquo;Capabilities&rdquo; Selection</a></li><li><a href=https://www.hex-rays.com/products/ida/support/download_freeware.shtml>IDA Support: Freeware Version</a></li><li><a href=https://www.codeproject.com/Articles/19165/Vista-UAC-The-Definitive-Guide>Vista UAC: The Definitive Guide</a></li><li><a href=https://blogs.msdn.microsoft.com/wsl/2016/05/23/pico-process-overview/>Pico Process Overview</a></li><li><a href=https://blogs.windows.com/buildingapps/2017/04/04/high-dpi-scaling-improvements-desktop-applications-windows-10-creators-update/#GhtloWCUWO8rEeRG.97>High-DPI Scaling Improvements for Desktop Applications in the Windows 10 Creators Update (1703)</a></li><li><a href=https://en.wikipedia.org/wiki/Thunk>A thunk is a computer programming subroutine that is created, often automatically, to assist a call to another subroutine .</a></li></ol><hr width=100% id=EOF><p style=color:#777>Last modified on 2018-11-30</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/2019/2019-01-25-file-parsing/>Next<br>文件的解析
</a><a class=older-posts href=/posts/2018/2018-11-18-git-namespace-snapshot/>Previous<br>基于 Git Namespace 的存储库快照方案</a></nav><div class=post-comment-wrapper></div></div></div></div></div><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://forcemz.net/><div class=nav-title>江二十三的思考</div><div class=nav-subtitle>Themed by Diary.</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>归档
</a><a class="a-block nav-link-item false" href=/categories>分类
</a><a class="a-block nav-link-item false" href=/tags>标签
</a><a class="a-block nav-link-item false" href=/about>关于
</a><a class="a-block nav-link-item false" href=/index.xml>RSS Feed</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><div id=extraContainer class=extra-container><div class=toc-wrapper><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><li><a href=#%e5%89%8d%e8%a8%80 class=nav-前言>前言</a></li><ul><li><a href=#process class=nav-process>Process</a></li><li><a href=#privexec-gui class=nav-privexec-gui>Privexec (GUI)</a></li><li><a href=#wsudo class=nav-wsudo>WSUDO</a></li><li><a href=#details class=nav-details>Details</a></li></ul></div></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up
</i></a><a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><script src=/js/journal.js></script></body></html>