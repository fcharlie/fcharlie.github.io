<!doctype html><html lang=en><head><title>Clangbuilder 和 libcxx</title>
<meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=5" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><script src=/js/toc.js></script><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Material+Icons"></head><body><div id=app><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>归档
</a><a class="a-block drawer-menu-item false" href=/categories>分类
</a><a class="a-block drawer-menu-item false" href=/tags>标签
</a><a class="a-block drawer-menu-item false" href=/about>关于
</a><a class="a-block drawer-menu-item false" href=/index.xml>RSS Feed</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><li><a href=#%e5%89%8d%e8%a8%80 class=nav-前言>前言</a></li><ul><li><a href=#clangbuilder class=nav-clangbuilder>Clangbuilder</a></li><li><a href=#libc class=nav-libc>Libc++</a></li><li><a href=#%e6%9c%80%e5%90%8e class=nav-最后>最后</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu
</i></button>
<a id=navTitle class=navbar-brand href=https://forcemz.net/>江二十三的思考
</a><button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://forcemz.net/><div class=single-column-header-title>江二十三的思考</div><div class=single-column-header-subtitle>Themed by Diary.</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>Clangbuilder 和 libcxx<div class=post-meta><time itemprop=datePublished>2017-07-29 10:00
</time><i class=material-icons>folder</i>
<a href=/categories/developer>developer</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h1 id=前言>前言</h1><p>作为一个 C++ 开发者，自然少不了与编译器打交道。
笔者在 2013年1月17日 发布了第一个 ClangOnWindows 二进制包 <a href=https://sourceforge.net/projects/clangonwin/>ClangOnWindows</a>，截至 2017-07-29，一共被下载 19212 次，实际上构建 LLVM/Clang 是一个非常耗时的事，于是乎笔者于 2014 年国庆节期间编写了 Clangbuilder，这是一个基于 Powershell 的 LLVM/Clang 自动化构建工具，能够自动下载工具链（除 Visual Studio）,自动获取 LLVM 源码，自动执行构建命令。Clangbuilder 的初期并不支持 libcxx 的构建，原因无他，当时 libcxx 不支持 Windows (for MSVC)，现在依然如此，不过现在可以使用 <code>clang-cl</code> 构建 libcxx。本文即介绍通过 Clangbuilder 构建 libcxx。</p><h2 id=clangbuilder>Clangbuilder</h2><p><a href=https://github.com/fstudio/clangbuilder>Clangbuilder</a> 是一个基于 Powershell 的 LLVM/Clang 自动化构建工具，通常用户在双击 <code>InitializeEnv.bat</code> 脚本后，安装脚本将自动安装构建 LLVM/Clang 所需的工具依赖。核心依赖如下：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>&#34;core&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#a6be9d>&#34;7z&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6be9d>&#34;cmake&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6be9d>&#34;git&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6be9d>&#34;ninja&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6be9d>&#34;nsis&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6be9d>&#34;nuget&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6be9d>&#34;python2&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6be9d>&#34;vswhere&#34;</span>
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Clangbuilder devinstall 还支持如下工具：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>7z                  18.03               7-Zip is a file archiver with a high compression ratio
</span></span><span style=display:flex><span>aria2               1.33.1              The ultra fast download utility
</span></span><span style=display:flex><span>cmake               3.11.0              CMake is an open-source, cross-platform family of tools designed to build, test and package software
</span></span><span style=display:flex><span>curl                7.59.0              Curl is a command-line tool for transferring data specified with URL syntax.
</span></span><span style=display:flex><span>git                 2.17.0              Git is a modern distributed version control system focused on speed
</span></span><span style=display:flex><span>gnuutils            1.0                 GNU utils for Windows
</span></span><span style=display:flex><span>hg                  4.5.2               Mercurial is a free, distributed source control management tool.
</span></span><span style=display:flex><span>ninja               1.8.2               Ninja is a small build system with a focus on speed.
</span></span><span style=display:flex><span>nsis                3.03                NSIS (Nullsoft Scriptable Install System) is a professional open source system to create Windows installers.
</span></span><span style=display:flex><span>nuget               4.6.1               NuGet is the package manager for .NET. The NuGet client tools provide the ability to produce and consume packages.
</span></span><span style=display:flex><span>openssh             v7.6.1.0p1-Beta     Portable OpenSSH
</span></span><span style=display:flex><span>putty               0.70                PuTTY: a free SSH and Telnet client.
</span></span><span style=display:flex><span>python2             2.7.14              Python 2.7
</span></span><span style=display:flex><span>swigwin             3.0.12              Simplified Wrapper and Interface Generator
</span></span><span style=display:flex><span>vswhere             2.4.1               Locate Visual Studio 2017 and newer installations.
</span></span><span style=display:flex><span>wget                1.19.4              A command-line utility for retrieving files using HTTP, HTTPS and FTP protocols.
</span></span></code></pre></div><p>我们支持 msi 和 zip 以及单文件工具，当安装 <code>7z</code> 后，可以解压 <code>tar.gz</code>，<code>.iso</code> 等格式的文件</p><p>下载依赖后，Clangbuilder 会自动构建一个图形化工具叫 <code>ClangbuilderUI</code>，用户可以使用 ClangbuilderUI 来一键构建或者启动环境。</p><p><img src=https://github.com/fstudio/clangbuilder/raw/master/docs/images/cbui.png alt=CangbuilderUI></p><p>由于 Windows 10 新增了很多特性，ClangbuilderUI 目前已经不支持 Windows 10 以下的版本，开发者可以自己去修改 ClangbuilderUI。</p><h2 id=libc>Libc++</h2><p>Libc++ 是一个非常优秀的 C++ 标准库的实现，目前是 macOS iOS 上默认的 C++ 标准库，其开发者非常活跃，因此，此项目在吸收新技术的方面值得称赞，比如 libc++ 目前已经实验性的支持 <code>coroutine</code> 了（微软 Visual C++ 团队大牛贡献）。由于是重新实现的，避免了很多 C++98 时期以来的坑。但是在 Windows 上一直处于无法编译的尴尬，使用 MinGW 编译的也就只能使用 MinGW 的一系列工具了，在 libcxx 开发者和 Visual C++ STL 开发者 STL 等人的共同努力下，libc++ 终于能够被 <code>clang-cl</code> 编译，由于目前 Visual C++ 不支持 <code>include_next</code> 特性，因此也就不能编译 libcxx。</p><p>详细的文档可以查看 <a href=http://libcxx.llvm.org/docs/BuildingLibcxx.html#experimental-support-for-windows>Experimental Support for Windows</a></p><p>因此在 Windows 上基于 MSVC 构建兼容的 Clang 版本时如果需要构建 libcxx 时，需要支持编译器为 clang-cl，而 Clangbuilder 目前支持 <code>NinjaBootstarp</code> 和 <code>NinjaIterate</code> 两种机制构建 libcxx ，在 ClangbuilderUI 中选择相应的 Engine 即可。第一种顾名思义就是使用 Ninja 自举，先使用 MSVC 构建第一个版本的 Clang, 然后再使用 CMake 生成 ninja 构建文件，这是将编译器替换为 clang-cl，然后设置编译 Libcxx， 如果代码没有错误，也就构建成功了。</p><p>而 NinjaIterate 需要预先构建的 clang-cl，这种非常适用于笔者这种经常构建 clang 的人士，修改 <a href=https://github.com/fstudio/clangbuilder/blob/master/config/prebuilt.json>config/prebuilt.json</a> 设置好预构建的 clang 的路径和架构，Clangbuilder 将自动识别并构建。没有代码错误就能很快构建成功。</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>&#34;LLVM&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>&#34;Path&#34;</span>: <span style=color:#a6be9d>&#34;D:/LLVM&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>&#34;Arch&#34;</span>: <span style=color:#a6be9d>&#34;x64&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Clangbuilder 支持将 LLVM 自动打包成安装文件，由于 libcxx 的项目文件并未将 <code>c++.dll</code> 安装配置好，因此，在使用 libc++ 的时候需要将 c++.dll 拷贝道 PATH 或者项目目录等。</p><p>使用 libc++ 的命令行：</p><blockquote><p>clang++ -std=c++11 -stdlib=libc++ -nostdinc++ -Iinclude\c++\v1 -Llib hello.cc -lc++</p></blockquote><p>然后就可以运行程序了。</p><p>也可以使用</p><blockquote><p>clang-cl -std:c++14 -Iinclude\c++\v1 hello.cc c++.lib</p></blockquote><p>值得注意的是，静态链接似乎是不起作用的。</p><h2 id=最后>最后</h2><p>Clangbuilder 是个好工具，希望对大家有用。</p><hr width=100% id=EOF><p style=color:#777>Last modified on 2017-07-29</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/2017/2017-07-31-git-secure-with-powershell/>Next<br>基于 Powershell Core 的 Git 存储库加密方案
</a><a class=older-posts href=/posts/2017/2017-06-05-color-console/>Previous<br>Privexec 的内幕（一）标准输出原理与彩色输出实现</a></nav><div class=post-comment-wrapper></div></div></div></div></div><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://forcemz.net/><div class=nav-title>江二十三的思考</div><div class=nav-subtitle>Themed by Diary.</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>归档
</a><a class="a-block nav-link-item false" href=/categories>分类
</a><a class="a-block nav-link-item false" href=/tags>标签
</a><a class="a-block nav-link-item false" href=/about>关于
</a><a class="a-block nav-link-item false" href=/index.xml>RSS Feed</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><div id=extraContainer class=extra-container><div class=toc-wrapper><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><li><a href=#%e5%89%8d%e8%a8%80 class=nav-前言>前言</a></li><ul><li><a href=#clangbuilder class=nav-clangbuilder>Clangbuilder</a></li><li><a href=#libc class=nav-libc>Libc++</a></li><li><a href=#%e6%9c%80%e5%90%8e class=nav-最后>最后</a></li></ul></div></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up
</i></a><a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><script src=/js/journal.js></script></body></html>