<!doctype html><html lang=en><head><title>Privexec 的内幕（一）标准输出原理与彩色输出实现</title>
<meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=5" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><script src=/js/toc.js></script><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Material+Icons"></head><body><div id=app><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>归档
</a><a class="a-block drawer-menu-item false" href=/categories>分类
</a><a class="a-block drawer-menu-item false" href=/tags>标签
</a><a class="a-block drawer-menu-item false" href=/about>关于
</a><a class="a-block drawer-menu-item false" href=/index.xml>RSS Feed</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><li><a href=#%e5%89%8d%e8%a8%80 class=nav-前言>前言</a></li><ul><li><a href=#%e5%85%b3%e4%ba%8e%e6%a0%87%e5%87%86%e8%be%93%e5%87%ba class=nav-关于标准输出>关于标准输出</a></li><li><a href=#printf-%e7%9a%84%e5%bf%83%e8%b7%af%e5%8e%86%e7%a8%8b class=nav-printf-的心路历程>Printf 的心路历程</a></li><li><a href=#writeconsole-%e5%86%85%e9%83%a8%e5%8e%9f%e7%90%86 class=nav-writeconsole-内部原理>WriteConsole 内部原理</a></li><li><a href=#%e6%8e%a7%e5%88%b6%e5%8f%b0%e5%bd%a9%e8%89%b2%e8%be%93%e5%87%ba class=nav-控制台彩色输出>控制台彩色输出</a></li><li><a href=#%e7%bb%88%e7%ab%af%e6%a8%a1%e6%8b%9f%e5%99%a8%e5%bd%a9%e8%89%b2%e8%be%93%e5%87%ba class=nav-终端模拟器彩色输出>终端模拟器彩色输出</a></li><li><a href=#vt-%e6%a8%a1%e5%bc%8f%e9%a2%9c%e8%89%b2%e8%be%93%e5%87%ba class=nav-vt-模式颜色输出>VT 模式颜色输出</a></li><li><a href=#%e8%be%93%e5%87%ba%e5%87%bd%e6%95%b0%e8%87%aa%e5%8a%a8%e9%80%89%e6%8b%a9 class=nav-输出函数自动选择>输出函数自动选择</a></li><li><a href=#%e5%85%b6%e4%bb%96 class=nav-其他>其他</a></li><li><a href=#%e5%a4%87%e6%b3%a8 class=nav-备注>备注</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu
</i></button>
<a id=navTitle class=navbar-brand href=https://forcemz.net/>江二十三的思考
</a><button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://forcemz.net/><div class=single-column-header-title>江二十三的思考</div><div class=single-column-header-subtitle>Themed by Diary.</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>Privexec 的内幕（一）标准输出原理与彩色输出实现<div class=post-meta><time itemprop=datePublished>2017-06-05 20:00
</time><i class=material-icons>folder</i>
<a href=/categories/windows>windows</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h1 id=前言>前言</h1><p><a href=https://github.com/M2Team/Privexec>Privexec</a> 是笔者借鉴远景好友 MouriNaruto 的 <a href=https://github.com/M2Team/NSudo>NSudo</a> 而开发的一个<strong>提权或者降权</strong>执行进程的工具。其中 wsudo 是 Privexec 的命令行版本。</p><p>在 wsudo 中，笔者使用了 Privexec.Console 提供彩色输出，截图如下：</p><p><img src=https://raw.githubusercontent.com/M2Team/Privexec/master/docs/images/wsudo.png alt=wsudo></p><p><img src=https://raw.githubusercontent.com/M2Team/Privexec/master/docs/images/wsudo3.png alt=wsudo3></p><p>本文将讲述标准输出是如何输出到控制台的，以及怎样在 Windows 中实现同时支持标准控制台和 MSYS2 Cygwin 终端模拟器以及 VT 模式的控制台彩色输出。</p><h2 id=关于标准输出>关于标准输出</h2><p>大部分编程语言的入门从 <code>Helloworld</code> 开始，也就是将文本 <code>Helloworld</code> 输出到标准输出。在 C++ 中使用 <code>std::cout</code> ，在 C 中使用 <code>printf</code> 以及在 C# 中使用 <code>Console.Write</code>。进程启动时，操作系统或者父进程会设置好进程的标准输出<sup>1</sup>。默认情况下，标准输出设备是 <code>控制台 console</code> 或者是 <code>终端 tty</code> 当然在启动进程前，可以将标准输出<strong>重定向</strong>到 <code>管道 (Pipe/Named Pipe, Pipe/FIFO)</code>，<code>文件</code> 而在 Unix like 系统中，还可以将输出重定向到 <code>socket</code> 等其他 Unix 文件。在 Windows 上，如果要将 IO 重定向到 socket 需要使用 <code>WSASocket</code> 创建 socket，且不要使用 <code>WSA_FLAG_OVERLAPPED</code> 标志。</p><p>输出的设备或者文件存在多样性，对于 CRT 而言，标准输出的实现就要兼顾这些设备，通常来说，操作系统会提供 <code>WriteFile</code> <code>write</code> 这样的 API 或者系统调用支持输出，一般来说，printf 这样的函数也是使用这样的 API 或者系统调用实现。这些函数的输出优先考虑的是本机默认编码，比如 Unix 上，一般都是 UTF-8，对于兼容性大户 Windows 来说，虽然内部编码都是 UTF-16 但是输出到文件时，任然优先选择的是本机代码页，比如在简体中文系统中是，代码页也就是 936。</p><h2 id=printf-的心路历程>Printf 的心路历程</h2><p>在以前我曾经思考过 <code>printf</code> 是如何实现的，很多开发者在开始也有同样的疑惑，在知乎上，就有人提问：<a href=https://www.zhihu.com/question/28749911>printf()等系统库函数是如何实现的？</a> ，在这个问题下，有很多人回复了，有兴趣的用户可以看一下；</p><p>在 Unix 的 CRT 中，printf 的调用历程在这篇文章中有详细介绍：<a href=http://blog.hostilefork.com/where-printf-rubber-meets-road/>Where the printf() Rubber Meets the Road</a></p><p>在 Windows 10 中，新增了 <code>Universal CRT (UCRT)</code> <a href=https://msdn.microsoft.com/en-us/library/abx4dbyh.aspx>CRT Library Features</a>，<a href=https://blogs.msdn.microsoft.com/vcblog/2015/03/03/introducing-the-universal-crt/>Introducing the Universal CRT</a>，与之前的 Visual C++ CRT 有了很大的不同，全部代码使用 C++11 重构，不用疑惑，正是使用 C++11 实现 <strong>C</strong> Runtime。笔者对 printf 的分析也是基于 ucrt 。</p><p>Visual C++ 会将 CRT/C++ STL 源码一同发布（没有构建文件），在 Visual Studio 的安装目录下的 <code>VC\crt\src</code> ，而 <code>UCRT</code> 源码则在 <code>%ProgramFiles(x86)%Windows Kits\10\Source\$BuildVersion\ucrt</code></p><p>在 UCRT 中 printf 是个内联函数，调用了 <code>_vfprintf_l</code>，<code>_vfprintf_l</code> 也是内联 的，它调用了 <code>__stdio_common_vfprintf</code>。在 ucrt 源码路径 <code>stdio\output.cpp</code> 中 <code>__stdio_common_vfprintf</code> 调用了模板函数 <code>common_vfprintf</code> ，而 <code>common_vfprintf</code> 则在内部调用了模板类 <code>output_processor</code> ,<code>output_processor</code> 使用了输出适配器模板类 <code>stream_output_adapter</code></p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#ff636f>typename</span> <span style=color:#58a1dd>Character</span><span style=color:#ff636f>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>class</span> <span style=color:#58a1dd>stream_output_adapter</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>:</span> <span style=color:#ff636f>public</span> <span style=color:#58a1dd>output_adapter_common</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>Character</span>, <span style=color:#58a1dd>stream_output_adapter</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>Character</span><span style=color:#ff636f>&gt;&gt;</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#ff636f>public</span><span style=color:#ff636f>:</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>typedef</span> <span style=color:#58a1dd>__acrt_stdio_char_traits</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>Character</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>char_traits</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>stream_output_adapter</span>(<span style=color:#58a1dd>FILE</span><span style=color:#ff636f>*</span> <span style=color:#ff636f>const</span> <span style=color:#58a1dd>public_stream</span>) <span style=color:#ff636f>throw</span>()
</span></span><span style=display:flex><span>        <span style=color:#ff636f>:</span> <span style=color:#58a1dd>_stream</span>{<span style=color:#58a1dd>public_stream</span>}
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>validate</span>() <span style=color:#ff636f>const</span> <span style=color:#ff636f>throw</span>()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>_VALIDATE_RETURN</span>(<span style=color:#58a1dd>_stream</span>.<span style=color:#58a1dd>valid</span>(), <span style=color:#58a1dd>EINVAL</span>, <span style=color:#58a1dd>false</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> <span style=color:#58a1dd>char_traits</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>validate_stream_is_ansi_if_required</span>(<span style=color:#58a1dd>_stream</span>.<span style=color:#58a1dd>public_stream</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>write_character_without_count_update</span>(<span style=color:#58a1dd>Character</span> <span style=color:#ff636f>const</span> <span style=color:#58a1dd>c</span>) <span style=color:#ff636f>const</span> <span style=color:#ff636f>throw</span>()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>_stream</span>.<span style=color:#58a1dd>is_string_backed</span>() <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>_stream</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>_base</span> <span style=color:#ff636f>==</span> <span style=color:#ff636f>nullptr</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#ff636f>return</span> <span style=color:#58a1dd>true</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> <span style=color:#58a1dd>char_traits</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>puttc_nolock</span>(<span style=color:#58a1dd>c</span>, <span style=color:#58a1dd>_stream</span>.<span style=color:#58a1dd>public_stream</span>()) <span style=color:#ff636f>!=</span> <span style=color:#58a1dd>char_traits</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>eof</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>void</span> <span style=color:#58a1dd>write_string</span>(
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Character</span> <span style=color:#ff636f>const</span><span style=color:#ff636f>*</span>      <span style=color:#ff636f>const</span> <span style=color:#58a1dd>string</span>,
</span></span><span style=display:flex><span>        <span style=color:#ff636f>int</span>                   <span style=color:#ff636f>const</span> <span style=color:#58a1dd>length</span>,
</span></span><span style=display:flex><span>        <span style=color:#ff636f>int</span><span style=color:#ff636f>*</span>                  <span style=color:#ff636f>const</span> <span style=color:#58a1dd>count_written</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>__crt_deferred_errno_cache</span><span style=color:#ff636f>&amp;</span> <span style=color:#58a1dd>status</span>
</span></span><span style=display:flex><span>        ) <span style=color:#ff636f>const</span> <span style=color:#ff636f>throw</span>()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>_stream</span>.<span style=color:#58a1dd>is_string_backed</span>() <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>_stream</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>_base</span> <span style=color:#ff636f>==</span> <span style=color:#ff636f>nullptr</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#ff636f>*</span><span style=color:#58a1dd>count_written</span> <span style=color:#ff636f>+=</span> <span style=color:#58a1dd>length</span>;
</span></span><span style=display:flex><span>            <span style=color:#ff636f>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>write_string_impl</span>(<span style=color:#58a1dd>string</span>, <span style=color:#58a1dd>length</span>, <span style=color:#58a1dd>count_written</span>, <span style=color:#58a1dd>status</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>private</span><span style=color:#ff636f>:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>__crt_stdio_stream</span> <span style=color:#58a1dd>_stream</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>File stream 的写入流程是 <code>write_strings</code> -> <code>write_string_impl</code> -> <code>write_character</code> -> <code>write_character_without_count_update</code> ,然后是 <code>char_traits::puttc_nolock</code>。</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#828b96;font-style:italic>#define _CORECRT_GENERATE_FORWARDER(prefix, callconv, name, callee_name)                     \
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>    __pragma(warning(push))                                                                  \
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>    __pragma(warning(disable: 4100)) </span><span style=color:#828b96;font-style:italic>/* unreferenced formal parameter */</span><span style=color:#828b96;font-style:italic>                     \
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>    template &lt;typename... Params&gt;                                                            \
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>    prefix auto callconv name(Params&amp;&amp;... args) throw() -&gt; decltype(callee_name(args...))    \
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>    {                                                                                        \
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>        _BEGIN_SECURE_CRT_DEPRECATION_DISABLE                                                \
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>        return callee_name(args...);                                                         \
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>        _END_SECURE_CRT_DEPRECATION_DISABLE                                                  \
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>    }                                                                                        \
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>    __pragma(warning(pop))
</span></span></span></code></pre></div><p><code>char_traits::puttch_nolock</code> 实际上是通过 <code>__acrt_stdio_char_traits</code> <code>__crt_char_traits</code> 定义的静态成员函数，，printf 对应的是 <code>_fputc_nolock</code>。</p><p><code>_fputc_nolock</code> 和 <code>fputc</code> 类似，实际上 <code>fputc</code> 也会调用它，在 <code>_fputc_nolock</code> 中调用了 <code>__acrt_stdio_flush_and_write_narrow_nolock</code>，在源码 <code>stdio/_flsbuf.cpp</code> 中，
<code>__acrt_stdio_flush_and_write_narrow_nolock</code> 又调用了 <code>common_flush_and_write_nolock&lt;char></code></p><p>往下一步走会调用 <code>write_buffer_nolock</code> -> <code>_write</code> -><code>_write_nolock(lowio/write.cpp)</code></p><p>然后根据不同设备和字符类型，<code>_write_nolock</code> 会调用：</p><ul><li>Console ANSI write_double_translated_ansi_nolock</li><li>Console UTF16 write_double_translated_unicode_nolock</li><li>File ANSI write_text_ansi_nolock</li><li>File UTF16 write_text_utf16le_nolock</li><li>File UTF8 write_text_utf8_nolock</li><li>File Binary write_binary_nolock</li></ul><p>最后终究要调用 <code>WriteFile</code>，对于不需要缓冲区的文件读写为什么不直接使用 <code>WriteFile</code> ？</p><p>值得一提的是，在 Windows 中，如果使用 FILE 读写文件，尽量使用 <code>rb</code> <code>wb</code> 之类的标志，显示的指定文件类型是 <code>binary</code>, 否则自动添加 <code>CR</code> 就不好了。</p><p>通过源码，我们还知道 UTF-16 或者 UTF-8 一般还是需要转换成 Ansi 才能输出到控制台。</p><p>UCRT 还提供了 <code>_cputs</code> <code>_cprintf</code> <code>_cputws</code> <code>_cwprintf</code> 这样的函数，这些函数处理流程类似但要简单的多，<code>output_processor</code> 的输出适配器是 <code>console_output_adapter</code>，无论是字符类型是 wchar_t 还是 char 最终都会调用 <code>_putwch_nolock</code> 及 <code>__dcrt_write_console_w</code>，最后使用 <code>WriteConsoleW</code> 写入到控制台。</p><p><code>_cwprintf</code> 与 <code>wprintf</code> 相比，输出 Unicode 字符要容易的多，不过，在使用标准输出的时候，你不能假定程序一定拥有控制台。</p><h2 id=writeconsole-内部原理>WriteConsole 内部原理</h2><p>虽然在 Windows/ReactOS 中，CRT 写入到标准输出的使用了 <code>WriteFile</code> ，WriteFile 是如何写到控制台的？</p><p>在 <code>ReactOS</code> 源码中，WriteFile 将检查 <code>hFile</code> 其值是否为 <code>STD_INPUT_HANDLE</code> ,<code>STD_OUTPUT_HANDLE</code> ,<code>STD_ERROR_HANDLE</code> 如果是就从 PEB 中获得对应的控制台句柄，否则使用句柄 <code>hFile</code> 原本的值，然后就判断是否是控制台句柄，如果是控制台，则调用 <code>WriteConsoleA</code>，对于其他类型文件会直接调用 <code>NtWriteFile</code>。</p><p>将 <code>STD_*_HANDLE</code> 转换为 Windows 内核对象：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#58a1dd>HANDLE</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>TranslateStdHandle</span>(<span style=color:#58a1dd>IN</span> <span style=color:#58a1dd>HANDLE</span> <span style=color:#58a1dd>hHandle</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>PRTL_USER_PROCESS_PARAMETERS</span> <span style=color:#58a1dd>Ppb</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>NtCurrentPeb</span>()<span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>ProcessParameters</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>switch</span> ((<span style=color:#58a1dd>ULONG</span>)<span style=color:#58a1dd>hHandle</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff636f>case</span> <span style=color:#58a1dd>STD_INPUT_HANDLE</span>:  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>Ppb</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>StandardInput</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff636f>case</span> <span style=color:#58a1dd>STD_OUTPUT_HANDLE</span>: <span style=color:#ff636f>return</span> <span style=color:#58a1dd>Ppb</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>StandardOutput</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff636f>case</span> <span style=color:#58a1dd>STD_ERROR_HANDLE</span>:  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>Ppb</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>StandardError</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>hHandle</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>判断是否是控制台文件：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#828b96;font-style:italic>#define IsConsoleHandle(h)  \
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>    (((ULONG_PTR)(h) &amp; 0x10000003) == 0x3)
</span></span></span></code></pre></div><p>或者</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#58a1dd>BOOL</span> <span style=color:#58a1dd>IsConsoleHandle</span>(<span style=color:#58a1dd>HANDLE</span> <span style=color:#58a1dd>hHandle</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>DWORD</span> <span style=color:#58a1dd>dwMode</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>/* Check whether the handle may be that of a console... */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> ((<span style=color:#58a1dd>GetFileType</span>(<span style=color:#58a1dd>hHandle</span>) <span style=color:#ff636f>&amp;</span> <span style=color:#ff636f>~</span><span style=color:#58a1dd>FILE_TYPE_REMOTE</span>) <span style=color:#ff636f>!=</span> <span style=color:#58a1dd>FILE_TYPE_CHAR</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> <span style=color:#58a1dd>FALSE</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>/*
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>     * It may be. Perform another test... The idea comes from the
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>     * MSDN description of the WriteConsole API:
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>     * &#34;WriteConsole fails if it is used with a standard handle
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>     *  that is redirected to a file. If an application processes
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>     *  multilingual output that can be redirected, determine whether
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>     *  the output handle is a console handle (one method is to call
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>     *  the GetConsoleMode function and check whether it succeeds).
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>     *  If the handle is a console handle, call WriteConsole. If the
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>     *  handle is not a console handle, the output is redirected and
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>     *  you should call WriteFile to perform the I/O.&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>GetConsoleMode</span>(<span style=color:#58a1dd>hHandle</span>, <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>dwMode</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>有兴趣的可以参阅 ReactOS WriteFile 源码：
<a href=https://github.com/reactos/reactos/blob/40a16a9cf1cdfca399e9154b42d32c30b63480f5/reactos/dll/win32/kernel32/client/file/rw.c#L38>WriteFile to Console</a></p><p>对于控制台句柄，CloseHandle，ReadFile，CreateFile ，以及 WriteFile 都要单独的调用对象的控制台 API。比如说，如果文件名是 <code>CON</code>, <code>CONOUT$</code>, <code>CONIN$</code>, <code>\\.\CON</code> 时就会使用 <code>OpenConsoleW</code> 打开控制台。然后返回控制台的句柄。</p><p>WriteConsoleA 又是如何写入到图形界面呢？在 Windows Technet 有两幅图分别介绍了 Vista 以前的控制台结构和 Windows 7 的控制台架构 <a href=https://blogs.technet.microsoft.com/askperf/2009/10/05/windows-7-windows-server-2008-r2-console-host/>Windows 7 / Windows Server 2008 R2: Console Host</a></p><p>在 Windows 7 以前，WriteConsole 通过 LPC 与 CSRSS（Client Server Runtime Process） 通信：</p><p><img src=https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_technet/askperf/WindowsLiveWriter/Windows7WindowsServer2008R2ConsoleHost_7F3D/image_c064c0f7-4048-4dba-86bd-4a9722b53a11.png alt=Windows></p><p>由于CSRSS 以 <code>Local System</code> 权限运行，这样的逻辑容易导致 <a href=https://en.wikipedia.org/wiki/Shatter_attack>Shatter attack</a>，于是在 Windows 7 中出现了新的 <code>Console Host</code> ：</p><p><img src=https://msdnshared.blob.core.windows.net/media/TNBlogsFS/BlogFileStorage/blogs_technet/askperf/WindowsLiveWriter/Windows7WindowsServer2008R2ConsoleHost_7F3D/image_7f7ebef5-47db-4d0c-aa78-5dd0e6bb75c8.png alt=Windows7OrLater></p><p>在这种架构中，WriteConsole LPC 调用将控制台消息发送到了一个 Conhost 宿主进程，这个进程是在 CreateProcess 中自动创建的。</p><p>在 ReactOS 中，依然使用的是 <code>CsrCaptureMessageBuffer</code> 将数据发送到 CSRSS。源码在这里： <a href=https://github.com/reactos/reactos/blob/master/reactos/dll/win32/kernel32/client/console/readwrite.c>WriteConsole</a></p><p>ReactOS 文档：<a href=https://doxygen.reactos.org/index.html>ReactOS</a></p><p>WriteFile 输出到控制台时，实际调用的是 <strong>WriteConsoleA</strong>，在前面我们还知道使用 wprintf 时，CRT 会将文本内容转换成 Ansi(Codepage) 然后再使用 WriteFile 写入到控制台窗口。</p><p>我们知道，绘制字符的时候，ANSI 文本最终将会转换成 UTF-16LE 文本，然后经 DrawTextExW 或者其他函数绘制出来，如果使用了 wprintf 这样的函数，势必会经过两次转换 <strong>UTF16->CodePage->UTF16</strong>，在 Unicode 中存在的字符不一定存在于代码页中，这就导致文本在转换编码的时候发生丢失，输出到控制台时，可能是乱码或者干脆截断了。所以在 Windows 控制台中， Unicode 编码，特别是 emoji 还是不要妄想通过 wprintf 输出。</p><p>在 Windows 中，内码是 Unicode，而控制台也支持使用 <code>WriteConsoleW</code> 这样的 API 输出文本，如果我们直接使用 <code>WriteConsoleW</code> 就可以避免出现字符无法呈现或者乱码的问题了。如果控制台的图形对各种字体字符支持更好，这个 API 也就能够输出彩色字符或者更多的 Emoji。遗憾的是，目前 Console 字体渲染的改进任然在计划中，暂时不支持 Emoji 和各种特殊字体。</p><h2 id=控制台彩色输出>控制台彩色输出</h2><p>讲了这么长一段，该讲如何实现彩色输出了，首先，我们要知道 Windows 控制台 API 是支持颜色输出的，不过，这些 API 仅支持 16 色输出。
在 .Net Core <a href=https://github.com/dotnet/corefx/blob/master/src/System.Console/src/System/ConsoleColor.cs#L10>corefx</a> 有如下一个枚举定义了控制台基本的颜色：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#58a1dd>    [Serializable]</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>public</span> <span style=color:#ff636f>enum</span> <span style=color:#58a1dd>ConsoleColor</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Black</span> = <span style=color:#a6be9d>0</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>DarkBlue</span> = <span style=color:#a6be9d>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>DarkGreen</span> = <span style=color:#a6be9d>2</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>DarkCyan</span> = <span style=color:#a6be9d>3</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>DarkRed</span> = <span style=color:#a6be9d>4</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>DarkMagenta</span> = <span style=color:#a6be9d>5</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>DarkYellow</span> = <span style=color:#a6be9d>6</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Gray</span> = <span style=color:#a6be9d>7</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>DarkGray</span> = <span style=color:#a6be9d>8</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Blue</span> = <span style=color:#a6be9d>9</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Green</span> = <span style=color:#a6be9d>10</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Cyan</span> = <span style=color:#a6be9d>11</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Red</span> = <span style=color:#a6be9d>12</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Magenta</span> = <span style=color:#a6be9d>13</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Yellow</span> = <span style=color:#a6be9d>14</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>White</span> = <span style=color:#a6be9d>15</span>
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>在 C++ 中，如果在 <code>WriteConsoleW</code> 调用之前使用了 <code>SetConsoleTextAttribute</code> 设置输出格式，那么就能输出带有上述颜色的文本内容了。在 Privexec.Console 中，使用控制台 API 输出颜色代码如下：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>WriteConhost</span>(<span style=color:#ff636f>int</span> <span style=color:#58a1dd>color</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>data</span>, <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>len</span>) {
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>CONSOLE_SCREEN_BUFFER_INFO</span> <span style=color:#58a1dd>csbi</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>hConsole</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>GetStdHandle</span>(<span style=color:#58a1dd>STD_OUTPUT_HANDLE</span>);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>GetConsoleScreenBufferInfo</span>(<span style=color:#58a1dd>hConsole</span>, <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>csbi</span>);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>WORD</span> <span style=color:#58a1dd>oldColor</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>csbi</span>.<span style=color:#58a1dd>wAttributes</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>WORD</span> <span style=color:#58a1dd>color_</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>static_cast</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>WORD</span><span style=color:#ff636f>&gt;</span>(<span style=color:#58a1dd>color</span>);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>WORD</span> <span style=color:#58a1dd>newColor</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>color</span> <span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>White</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>newColor</span> <span style=color:#ff636f>=</span> (<span style=color:#58a1dd>oldColor</span> <span style=color:#ff636f>&amp;</span> <span style=color:#a6be9d>0x0F</span>) <span style=color:#ff636f>|</span> <span style=color:#58a1dd>color_</span>;
</span></span><span style=display:flex><span>  } <span style=color:#ff636f>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>newColor</span> <span style=color:#ff636f>=</span> (<span style=color:#58a1dd>oldColor</span> <span style=color:#ff636f>&amp;</span> <span style=color:#a6be9d>0xF0</span>) <span style=color:#ff636f>|</span> <span style=color:#58a1dd>color_</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>SetConsoleTextAttribute</span>(<span style=color:#58a1dd>hConsole</span>, <span style=color:#58a1dd>newColor</span>);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>DWORD</span> <span style=color:#58a1dd>dwWrite</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>WriteConsoleW</span>(<span style=color:#58a1dd>hConsole</span>, <span style=color:#58a1dd>data</span>, (<span style=color:#58a1dd>DWORD</span>)<span style=color:#58a1dd>len</span>, <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>dwWrite</span>, <span style=color:#ff636f>nullptr</span>);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>SetConsoleTextAttribute</span>(<span style=color:#58a1dd>hConsole</span>, <span style=color:#58a1dd>oldColor</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#ff636f>static_cast</span><span style=color:#ff636f>&lt;</span><span style=color:#ff636f>int</span><span style=color:#ff636f>&gt;</span>(<span style=color:#58a1dd>dwWrite</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在这里，我们选择的是 <code>STD_OUTPUT_HANDLE</code>，使用 <code>&amp;0x0F</code> 或者 <code>&amp;0xF0</code> 的目的是不修改原有的背景色或者前景色，第二次调用 <code>SetConsoleTextAttribute</code> 的目的是恢复控制台原有的颜色。</p><h2 id=终端模拟器彩色输出>终端模拟器彩色输出</h2><p>在 Windows 上，还有 Cygwin 和 MSYS2 MSYS 这样的模拟 Unix 的环境。wsudo 对其支持也非常有必要。
这些环境启动进程往往是通过管道通信，这个时候，我们可以判断是否是终端还是控制台。</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>bool</span> <span style=color:#58a1dd>IsWindowsConhost</span>(<span style=color:#58a1dd>HANDLE</span> <span style=color:#58a1dd>hConsole</span>, <span style=color:#ff636f>bool</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>isvt</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>GetFileType</span>(<span style=color:#58a1dd>hConsole</span>) <span style=color:#ff636f>!=</span> <span style=color:#58a1dd>FILE_TYPE_CHAR</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>DWORD</span> <span style=color:#58a1dd>mode</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#ff636f>!</span><span style=color:#58a1dd>GetConsoleMode</span>(<span style=color:#58a1dd>hConsole</span>, <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>mode</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> ((<span style=color:#58a1dd>mode</span> <span style=color:#ff636f>&amp;</span> <span style=color:#58a1dd>ENABLE_VIRTUAL_TERMINAL_PROCESSING</span>) <span style=color:#ff636f>!=</span> <span style=color:#a6be9d>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>isvt</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>true</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>true</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>如果使用 GetFileType(hConsole) 得到的文件类型不是 <code>FILE_TYPE_CHAR</code> 我们就可以确定不是控制台，并且如果不支持 <code>GetConsoleMode</code> 函数，也要视其不是控制台。</p><p>核心代码如下：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>namespace</span> <span style=color:#58a1dd>console</span> {
</span></span><span style=display:flex><span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#58a1dd>wchar2utf8</span>(<span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>buf</span>, <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>len</span>) {
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#58a1dd>str</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>N</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>WideCharToMultiByte</span>(<span style=color:#58a1dd>CP_UTF8</span>, <span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>buf</span>, (<span style=color:#ff636f>int</span>)<span style=color:#58a1dd>len</span>, <span style=color:#ff636f>nullptr</span>, <span style=color:#a6be9d>0</span>, <span style=color:#ff636f>nullptr</span>,
</span></span><span style=display:flex><span>                               <span style=color:#ff636f>nullptr</span>);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>str</span>.<span style=color:#58a1dd>resize</span>(<span style=color:#58a1dd>N</span>);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>WideCharToMultiByte</span>(<span style=color:#58a1dd>CP_UTF8</span>, <span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>buf</span>, (<span style=color:#ff636f>int</span>)<span style=color:#58a1dd>len</span>, <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>str</span>[<span style=color:#a6be9d>0</span>], <span style=color:#58a1dd>N</span>, <span style=color:#ff636f>nullptr</span>, <span style=color:#ff636f>nullptr</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>str</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>struct</span> <span style=color:#58a1dd>TerminalsColorTable</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>int</span> <span style=color:#58a1dd>index</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>blod</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>namespace</span> <span style=color:#58a1dd>vt</span> {
</span></span><span style=display:flex><span><span style=color:#ff636f>namespace</span> <span style=color:#58a1dd>fg</span> {
</span></span><span style=display:flex><span><span style=color:#ff636f>enum</span> <span style=color:#58a1dd>Color</span> {
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Black</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>30</span>,
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Red</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>31</span>,
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Green</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>32</span>,
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Yellow</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>33</span>,
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Blue</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>34</span>,
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Magenta</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>35</span>,
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Cyan</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>36</span>,
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Gray</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>37</span>,
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Reset</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>39</span>
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff636f>namespace</span> <span style=color:#58a1dd>bg</span> {
</span></span><span style=display:flex><span><span style=color:#ff636f>enum</span> <span style=color:#58a1dd>Color</span> {
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Black</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>40</span>,
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Red</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>41</span>,
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Green</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>42</span>,
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Yellow</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>43</span>,
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Blue</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>44</span>,
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Magenta</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>45</span>,
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Cyan</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>46</span>,
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Gray</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>47</span>,
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Reset</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>49</span>
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff636f>bool</span> <span style=color:#58a1dd>TerminalsConvertColor</span>(<span style=color:#ff636f>int</span> <span style=color:#58a1dd>color</span>, <span style=color:#58a1dd>TerminalsColorTable</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>co</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>unordered_map</span><span style=color:#ff636f>&lt;</span><span style=color:#ff636f>int</span>, <span style=color:#58a1dd>TerminalsColorTable</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>tables</span> <span style=color:#ff636f>=</span> {
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Black</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Black</span>, <span style=color:#58a1dd>false</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>DarkBlue</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Blue</span>, <span style=color:#58a1dd>false</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>DarkGreen</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Green</span>, <span style=color:#58a1dd>false</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>DarkCyan</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Cyan</span>, <span style=color:#58a1dd>false</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>DarkRed</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Red</span>, <span style=color:#58a1dd>false</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>DarkMagenta</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Magenta</span>, <span style=color:#58a1dd>false</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>DarkYellow</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Yellow</span>, <span style=color:#58a1dd>false</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>DarkGray</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Gray</span>, <span style=color:#58a1dd>false</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Blue</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Blue</span>, <span style=color:#58a1dd>true</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Green</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Green</span>, <span style=color:#58a1dd>true</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Cyan</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Cyan</span>, <span style=color:#58a1dd>true</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Red</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Red</span>, <span style=color:#58a1dd>true</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Magenta</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Magenta</span>, <span style=color:#58a1dd>true</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Yellow</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Yellow</span>, <span style=color:#58a1dd>true</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>White</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Gray</span>, <span style=color:#58a1dd>true</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Black</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Black</span>, <span style=color:#58a1dd>false</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Blue</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Blue</span>, <span style=color:#58a1dd>false</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Green</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Green</span>, <span style=color:#58a1dd>false</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Cyan</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Cyan</span>, <span style=color:#58a1dd>false</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Red</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Red</span>, <span style=color:#58a1dd>false</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Magenta</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Magenta</span>, <span style=color:#58a1dd>false</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Yellow</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Yellow</span>, <span style=color:#58a1dd>false</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>DarkGray</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Gray</span>, <span style=color:#58a1dd>false</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>LightBlue</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Blue</span>, <span style=color:#58a1dd>true</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>LightGreen</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Green</span>, <span style=color:#58a1dd>true</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>LightCyan</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Cyan</span>, <span style=color:#58a1dd>true</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>LightRed</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>fg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Red</span>, <span style=color:#58a1dd>true</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>LightMagenta</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Magenta</span>, <span style=color:#58a1dd>true</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>LightYellow</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Yellow</span>, <span style=color:#58a1dd>true</span>}},
</span></span><span style=display:flex><span>      {<span style=color:#58a1dd>console</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bc</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>LightWhite</span>, {<span style=color:#58a1dd>vt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>bg</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Gray</span>, <span style=color:#58a1dd>true</span>}},
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>iter</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>tables</span>.<span style=color:#58a1dd>find</span>(<span style=color:#58a1dd>color</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>iter</span> <span style=color:#ff636f>==</span> <span style=color:#58a1dd>tables</span>.<span style=color:#58a1dd>end</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>co</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>iter</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>second</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>true</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>WriteTerminals</span>(<span style=color:#ff636f>int</span> <span style=color:#58a1dd>color</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>data</span>, <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>len</span>) {
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>TerminalsColorTable</span> <span style=color:#58a1dd>co</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>str</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>wchar2utf8</span>(<span style=color:#58a1dd>data</span>, <span style=color:#58a1dd>len</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#ff636f>!</span><span style=color:#58a1dd>TerminalsConvertColor</span>(<span style=color:#58a1dd>color</span>, <span style=color:#58a1dd>co</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#ff636f>static_cast</span><span style=color:#ff636f>&lt;</span><span style=color:#ff636f>int</span><span style=color:#ff636f>&gt;</span>(<span style=color:#58a1dd>fwrite</span>(<span style=color:#58a1dd>str</span>.<span style=color:#58a1dd>data</span>(), <span style=color:#a6be9d>1</span>, <span style=color:#58a1dd>str</span>.<span style=color:#58a1dd>size</span>(), <span style=color:#58a1dd>stdout</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>co</span>.<span style=color:#58a1dd>blod</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>fprintf</span>(<span style=color:#58a1dd>stdout</span>, <span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>\33</span><span style=color:#a6be9d>[1;%dm&#34;</span>, <span style=color:#58a1dd>co</span>.<span style=color:#58a1dd>index</span>);
</span></span><span style=display:flex><span>  } <span style=color:#ff636f>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>fprintf</span>(<span style=color:#58a1dd>stdout</span>, <span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>\33</span><span style=color:#a6be9d>[%dm&#34;</span>, <span style=color:#58a1dd>co</span>.<span style=color:#58a1dd>index</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>l</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>fwrite</span>(<span style=color:#58a1dd>str</span>.<span style=color:#58a1dd>data</span>(), <span style=color:#a6be9d>1</span>, <span style=color:#58a1dd>str</span>.<span style=color:#58a1dd>size</span>(), <span style=color:#58a1dd>stdout</span>);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>fwrite</span>(<span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>\33</span><span style=color:#a6be9d>[0m&#34;</span>, <span style=color:#a6be9d>1</span>, <span style=color:#ff636f>sizeof</span>(<span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>\33</span><span style=color:#a6be9d>[0m&#34;</span>) <span style=color:#ff636f>-</span> <span style=color:#a6be9d>1</span>, <span style=color:#58a1dd>stdout</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#ff636f>static_cast</span><span style=color:#ff636f>&lt;</span><span style=color:#ff636f>int</span><span style=color:#ff636f>&gt;</span>(<span style=color:#58a1dd>l</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这些终端环境基本上将文本视为 UTF8 编码，为了让文字正常显示，我们需要将其转换为 UTF8。经过测试，中文都能正常显示。</p><h2 id=vt-模式颜色输出>VT 模式颜色输出</h2><p>在 Windows 10 中，新增了 <strong>Windows Subsystem for Linux</strong> ，可以通过 Bash 命令启动终端运行 Linux 程序，Windows 控制台还增加了 VT 模式 <a href=https://msdn.microsoft.com/en-us/library/windows/desktop/mt638032.aspx>Console Virtual Terminal Sequences</a>，并且支持24-Bit 颜色：<a href=https://blogs.msdn.microsoft.com/commandline/2016/09/22/24-bit-color-in-the-windows-console/>24-bit Color in the Windows Console!</a>，这意味着，可以像 Linux 一样在 printf 中添加转义字符控制颜色输出。
在 Github 中也有 Issues 讨论: <a href=https://github.com/Microsoft/BashOnWindows/issues/345>support 256 color</a>
笔者在开发时发现 WriteConsoleW 也支持 VT 模式，对于也添加了代码支持 VT 模式：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>WriteConsoleInternal</span>(<span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>buffer</span>, <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>len</span>) {
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>DWORD</span> <span style=color:#58a1dd>dwWrite</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>hConsole</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>GetStdHandle</span>(<span style=color:#58a1dd>STD_OUTPUT_HANDLE</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>WriteConsoleW</span>(<span style=color:#58a1dd>hConsole</span>, <span style=color:#58a1dd>buffer</span>, (<span style=color:#58a1dd>DWORD</span>)<span style=color:#58a1dd>len</span>, <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>dwWrite</span>, <span style=color:#ff636f>nullptr</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#ff636f>static_cast</span><span style=color:#ff636f>&lt;</span><span style=color:#ff636f>int</span><span style=color:#ff636f>&gt;</span>(<span style=color:#58a1dd>dwWrite</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>WriteVTConsole</span>(<span style=color:#ff636f>int</span> <span style=color:#58a1dd>color</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>data</span>, <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>len</span>) {
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>TerminalsColorTable</span> <span style=color:#58a1dd>co</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#ff636f>!</span><span style=color:#58a1dd>TerminalsConvertColor</span>(<span style=color:#58a1dd>color</span>, <span style=color:#58a1dd>co</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>WriteConsoleInternal</span>(<span style=color:#58a1dd>data</span>, <span style=color:#58a1dd>len</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring</span> <span style=color:#58a1dd>buf</span>(<span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>\x1b</span><span style=color:#a6be9d>[&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>co</span>.<span style=color:#58a1dd>blod</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>buf</span>.<span style=color:#58a1dd>append</span>(<span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#34;1;&#34;</span>).<span style=color:#58a1dd>append</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>to_wstring</span>(<span style=color:#58a1dd>co</span>.<span style=color:#58a1dd>index</span>)).<span style=color:#58a1dd>push_back</span>(<span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;m&#39;</span>);
</span></span><span style=display:flex><span>  } <span style=color:#ff636f>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>buf</span>.<span style=color:#58a1dd>append</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>to_wstring</span>(<span style=color:#58a1dd>co</span>.<span style=color:#58a1dd>index</span>)).<span style=color:#58a1dd>push_back</span>(<span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;m&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>WriteConsoleInternal</span>(<span style=color:#58a1dd>buf</span>.<span style=color:#58a1dd>data</span>(), (<span style=color:#58a1dd>DWORD</span>)<span style=color:#58a1dd>buf</span>.<span style=color:#58a1dd>size</span>());
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>N</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>WriteConsoleInternal</span>(<span style=color:#58a1dd>data</span>, (<span style=color:#58a1dd>DWORD</span>)<span style=color:#58a1dd>len</span>);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>WriteConsoleInternal</span>(<span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>\x1b</span><span style=color:#a6be9d>[0m&#34;</span>, (<span style=color:#ff636f>sizeof</span>(<span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>\x1b</span><span style=color:#a6be9d>[0m&#34;</span>) <span style=color:#ff636f>-</span> <span style=color:#a6be9d>1</span>));
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#ff636f>static_cast</span><span style=color:#ff636f>&lt;</span><span style=color:#ff636f>int</span><span style=color:#ff636f>&gt;</span>(<span style=color:#58a1dd>N</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#ff636f>typename</span>... <span style=color:#58a1dd>Args</span><span style=color:#ff636f>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>PrintConsole</span>(<span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>format</span>, <span style=color:#58a1dd>Args</span>... <span style=color:#58a1dd>args</span>) {
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring</span> <span style=color:#58a1dd>buffer</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>size</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>StringPrint</span>(<span style=color:#ff636f>nullptr</span>, <span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>format</span>, <span style=color:#58a1dd>args</span>...);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>buffer</span>.<span style=color:#58a1dd>resize</span>(<span style=color:#58a1dd>size</span>);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>size</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>StringPrint</span>(<span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>buffer</span>[<span style=color:#a6be9d>0</span>], <span style=color:#58a1dd>buffer</span>.<span style=color:#58a1dd>size</span>() <span style=color:#ff636f>+</span> <span style=color:#a6be9d>1</span>, <span style=color:#58a1dd>format</span>, <span style=color:#58a1dd>args</span>...);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>WriteConsoleInternal</span>(<span style=color:#58a1dd>buffer</span>.<span style=color:#58a1dd>data</span>(), <span style=color:#58a1dd>size</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>由于 VT 模式支持 256 色，这里还增加了 <code>PrintConsole</code> 模板函数，支持用户自定义输出多一些色彩。</p><h2 id=输出函数自动选择>输出函数自动选择</h2><p>在不考虑 freopen 这样的重新设置标准输出输出的情况下，Privexec.Console 使用如下代码支持自动选择不同的输出函数</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>class</span> <span style=color:#58a1dd>ConsoleInternal</span> {
</span></span><span style=display:flex><span><span style=color:#ff636f>public</span><span style=color:#ff636f>:</span>
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>ConsoleInternal</span>() {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>HANDLE</span> <span style=color:#58a1dd>hConsole</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>GetStdHandle</span>(<span style=color:#58a1dd>STD_OUTPUT_HANDLE</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>hConsole</span> <span style=color:#ff636f>==</span> <span style=color:#58a1dd>INVALID_HANDLE_VALUE</span>) {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>impl</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>WriteFiles</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>GetFileType</span>(<span style=color:#58a1dd>hConsole</span>) <span style=color:#ff636f>==</span> <span style=color:#58a1dd>FILE_TYPE_DISK</span>) {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>impl</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>WriteFiles</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>isvt</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>IsWindowsConhost</span>(<span style=color:#58a1dd>hConsole</span>, <span style=color:#58a1dd>isvt</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>isvt</span>) {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>impl</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>WriteVTConsole</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>impl</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>WriteConhost</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>impl</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>WriteTerminals</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>int</span> <span style=color:#58a1dd>WriteRealize</span>(<span style=color:#ff636f>int</span> <span style=color:#58a1dd>color</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>data</span>, <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>len</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#ff636f>this</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>impl</span>(<span style=color:#58a1dd>color</span>, <span style=color:#58a1dd>data</span>, <span style=color:#58a1dd>len</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>private</span><span style=color:#ff636f>:</span>
</span></span><span style=display:flex><span>  <span style=color:#ff636f>int</span> (<span style=color:#ff636f>*</span><span style=color:#58a1dd>impl</span>)(<span style=color:#ff636f>int</span> <span style=color:#58a1dd>color</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>data</span>, <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>len</span>);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>WriteInternal</span>(<span style=color:#ff636f>int</span> <span style=color:#58a1dd>color</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>buf</span>, <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>len</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>static</span> <span style=color:#58a1dd>ConsoleInternal</span> <span style=color:#58a1dd>provider</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>provider</span>.<span style=color:#58a1dd>WriteRealize</span>(<span style=color:#58a1dd>color</span>, <span style=color:#58a1dd>buf</span>, <span style=color:#58a1dd>len</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>使用 <code>console::Print</code> 不用担心乱码和颜色问题，在这几个主流的环境中都能正常显示（包括 ConEmu）。Print 使用的完全是 wchar_t。</p><h2 id=其他>其他</h2><p>很欣慰的是 Windows 控制台团队在 Windows 10 开发之处就在不断改进控制台： 比如 <a href=https://blogs.windows.com/buildingapps/2014/10/07/console-improvements-in-the-windows-10-technical-preview/>Console Improvements in the Windows 10 Technical Preview</a></p><p>还有计划中的 Emoji 支持： <a href=https://github.com/Microsoft/BashOnWindows/issues/590>Add emoji support to Windows Console</a></p><p>以及基于 DirectWrite 改进控制台字体渲染的计划： <a href=https://github.com/Microsoft/BashOnWindows/issues/75#issuecomment-304415019>UTF-8 rendering woes</a></p><p>当然 ConEmu 也有计划使用 DirectWrite 改进其渲染。</p><p>不过遗憾的是，Mintty 的开发者并不认为有使用 DirectWrite 改进渲染的必要。</p><p>基于 Rust 的跨平台 GPU 终端 <a href=https://github.com/jwilm/alacritty>Alacritty - A cross-platform, GPU-accelerated terminal emulator</a> 也计划在 1.0 时对 Windows 提供支持，字体渲染也有 DirectWrite 的身影。</p><p>Privexec.Console 官方并不会支持 Windows 10 以前的版本，毕竟作者精力有限。</p><h2 id=备注>备注</h2><ol><li>父进程未显式设置标准输入输出和标准错误时，子进程会继承父进程的值，在 Windows 中，GUI 程序的标准输入输出和 Unix 下重定向到 <code>/dev/null</code> 类似，但启动的 CUI 子进程默认下依然有控制台窗口</li></ol><hr width=100% id=EOF><p style=color:#777>Last modified on 2017-06-05</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/2017/2017-07-29-clangbuild-and-libcxx/>Next<br>Clangbuilder 和 libcxx
</a><a class=older-posts href=/posts/2017/2017-05-14-kismet/>Previous<br>Kismet 杂谈</a></nav><div class=post-comment-wrapper></div></div></div></div></div><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://forcemz.net/><div class=nav-title>江二十三的思考</div><div class=nav-subtitle>Themed by Diary.</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>归档
</a><a class="a-block nav-link-item false" href=/categories>分类
</a><a class="a-block nav-link-item false" href=/tags>标签
</a><a class="a-block nav-link-item false" href=/about>关于
</a><a class="a-block nav-link-item false" href=/index.xml>RSS Feed</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><div id=extraContainer class=extra-container><div class=toc-wrapper><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><li><a href=#%e5%89%8d%e8%a8%80 class=nav-前言>前言</a></li><ul><li><a href=#%e5%85%b3%e4%ba%8e%e6%a0%87%e5%87%86%e8%be%93%e5%87%ba class=nav-关于标准输出>关于标准输出</a></li><li><a href=#printf-%e7%9a%84%e5%bf%83%e8%b7%af%e5%8e%86%e7%a8%8b class=nav-printf-的心路历程>Printf 的心路历程</a></li><li><a href=#writeconsole-%e5%86%85%e9%83%a8%e5%8e%9f%e7%90%86 class=nav-writeconsole-内部原理>WriteConsole 内部原理</a></li><li><a href=#%e6%8e%a7%e5%88%b6%e5%8f%b0%e5%bd%a9%e8%89%b2%e8%be%93%e5%87%ba class=nav-控制台彩色输出>控制台彩色输出</a></li><li><a href=#%e7%bb%88%e7%ab%af%e6%a8%a1%e6%8b%9f%e5%99%a8%e5%bd%a9%e8%89%b2%e8%be%93%e5%87%ba class=nav-终端模拟器彩色输出>终端模拟器彩色输出</a></li><li><a href=#vt-%e6%a8%a1%e5%bc%8f%e9%a2%9c%e8%89%b2%e8%be%93%e5%87%ba class=nav-vt-模式颜色输出>VT 模式颜色输出</a></li><li><a href=#%e8%be%93%e5%87%ba%e5%87%bd%e6%95%b0%e8%87%aa%e5%8a%a8%e9%80%89%e6%8b%a9 class=nav-输出函数自动选择>输出函数自动选择</a></li><li><a href=#%e5%85%b6%e4%bb%96 class=nav-其他>其他</a></li><li><a href=#%e5%a4%87%e6%b3%a8 class=nav-备注>备注</a></li></ul></div></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up
</i></a><a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><script src=/js/journal.js></script></body></html>