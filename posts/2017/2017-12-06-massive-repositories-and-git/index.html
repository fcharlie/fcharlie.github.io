<!doctype html><html lang=en><head><title>Git 巨型存储库的解决方案</title>
<meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=5" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><script src=/js/toc.js></script><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Material+Icons"></head><body><div id=app><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>归档
</a><a class="a-block drawer-menu-item false" href=/categories>分类
</a><a class="a-block drawer-menu-item false" href=/tags>标签
</a><a class="a-block drawer-menu-item false" href=/about>关于
</a><a class="a-block drawer-menu-item false" href=/index.xml>RSS Feed</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e5%89%8d%e8%a8%80 class=nav-前言>前言</a></li><li><a href=#%e6%b5%85%e5%85%8b%e9%9a%86%e5%92%8c%e7%a8%80%e7%96%8f%e6%a3%80%e5%87%ba class=nav-浅克隆和稀疏检出>浅克隆和稀疏检出</a></li><li><a href=#git-lfs-%e7%9a%84%e5%88%9d%e8%a1%b7 class=nav-git-lfs-的初衷>Git LFS 的初衷</a></li><li><a href=#gvfs-%e7%9a%84%e5%8e%9f%e7%90%86 class=nav-gvfs-的原理>GVFS 的原理</a></li><li><a href=#%e4%bd%bf%e7%94%a8-libgit2 class=nav-使用-libgit2>使用 Libgit2</a></li><li><a href=#gvfs-%e5%ba%94%e7%94%a8%e5%88%86%e6%9e%90 class=nav-gvfs-应用分析>GVFS 应用分析</a></li><li><a href=#%e7%9b%b8%e5%85%b3%e4%bf%a1%e6%81%af class=nav-相关信息>相关信息</a></li><li><a href=#%e6%9c%80%e5%90%8e class=nav-最后>最后</a></li><li><a href=#%e9%93%be%e6%8e%a5 class=nav-链接>链接</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu
</i></button>
<a id=navTitle class=navbar-brand href=https://forcemz.net/>Charlie's Rethinking
</a><button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://forcemz.net/><div class=single-column-header-title>Charlie's Rethinking</div><div class=single-column-header-subtitle>Themed by Diary.</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>Git 巨型存储库的解决方案<div class=post-meta><time itemprop=datePublished>2017-12-06 10:00
</time><i class=material-icons>folder</i>
<a href=/categories/git>git</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h2 id=前言>前言</h2><p>通常来说，分布式版本控制系统适合体积较小的存储库，<a href=https://en.wikipedia.org/wiki/Distributed_version_control>分布式版本控制系统</a> 意味着存储库和工作目录都放置在开发者自己的机器上，当开发者需要克隆一个巨大的存储库时，为了获得完整的拷贝，版本控制软件不得不从远程服务器上下载大量的数据。这是分布式版本控制系统最大的缺陷之一。</p><p>这种缺陷并不会阻碍 git 的流行，自 2008 年以来，git 已经成为事实上的版本控制软件的魁首，诸如 GCC<sup>1</sup>，LLVM<sup>2</sup> 这样的基础软件也已迁移到或者正在迁移到 git。那么 git 如何解决这种大存储库的麻烦呢？</p><h2 id=浅克隆和稀疏检出>浅克隆和稀疏检出</h2><p>很早之前，我在构建 LLVM 的时候，都使用 svn 去检出 LLVM 源码，当时并不知道 git 能够支持浅克隆。后来从事代码托管开发，精通git 后，索性在 Clangbuilder<sup>3</sup> 中使用 git 浅克隆获取 LLVM 源码。</p><p>浅克隆意味着只克隆指定个数的 commit，在 git 克隆的时候使用 <code>--depth=N</code> 参数就能够支持克隆最近的 N 个 commit，这种机制对于像 CI 这样的服务来说，简直是如虎添翼。</p><pre tabindex=0><code>       --depth &lt;depth&gt;
           Create a shallow clone with a history truncated to the specified number of commits. Implies
           --single-branch unless --no-single-branch is given to fetch the histories near the tips of all branches.
</code></pre><p>与常规克隆不同的是，浅克隆可能需要多执行一次请求，用来协商 commit 的深度信息。</p><p>在服务器上支持浅克隆一般不需要做什么事。如果使用 <em>git-upload-pack</em> 命令实现克隆功能时，对于 HTTP 协议要特殊设置，需要及时关闭 <em>git-upload-pack</em> 的输入。否则，git-upload-pack 会阻塞不会退出。对于 Git 和 SSH 协议，完全不要考虑那么多，HTTP协议是 <strong>Request&ndash;Respone</strong> 这种类型的，而 Git 和 SSH 协议则没有这个限制。</p><p>而稀疏检出指得是在将文件从存储库中检出到目录时，只检出特定的目录。这个需要设置 <code>.git/info/sparse-checkout</code>。稀疏检出是一种客户端行为，只会优化用户的检出体验，并不会减少服务器传输。</p><h2 id=git-lfs-的初衷>Git LFS 的初衷</h2><p>Git 实质上是一种文件快照系统。创建提交时会将文件打包成新的 blob 对象。这种机制意味着 git 在管理大文件时是非常占用存储的。比如一个 1GB 的 PSD 文件，修改 10 次，存储库就可能是 10 GB。当然，这取决于 zip 对 PSD 文件的压缩率。同样的，这种存储库在网络上传输，需要耗费更多的网络带宽。</p><p>对于 Github 而言，大文件耗费了他们大量的存储和带宽。Github 团队于是在 2015 年推出了 Git LFS，在前面的博客中，我介绍了如何实现一个 Git LFS 服务器<sup>4</sup>，这里也就不再多讲了。</p><h2 id=gvfs-的原理>GVFS 的原理</h2><p>好了，说到今天的重点了。微软有专门的文件介绍了 <strong>《Git 缩放》</strong><sup>5</sup> <strong>《GVFS 设计历史》</strong><sup>6</sup>，相关的内容也就不赘述了。</p><p>GVFS 协议地址为： <a href=https://github.com/Microsoft/GVFS/blob/master/Protocol.md>The GVFS Protocol (v1)</a></p><p>GVFS 目前只设计和实现了 HTTP 协议，我将其 HTTP 接口整理如下表：</p><table><thead><tr><th>Method</th><th>URL</th><th>Body</th><th>Accept</th></tr></thead><tbody><tr><td>GET</td><td>/gvfs/config</td><td>NA</td><td>application/json, gvfs not care</td></tr><tr><td>GET</td><td>/gvfs/objects/{objectId}</td><td>NA</td><td>application/x-git-loose-object</td></tr><tr><td>POST</td><td>/gvfs/objects</td><td>Json Objects</td><td>application/x-git-packfile; application/x-gvfs-loose-objects(cache server)</td></tr><tr><td>POST</td><td>/gvfs/sizes</td><td>JOSN Array</td><td>application/json</td></tr><tr><td>GET</td><td>/gvfs/prefetch[?lastPackTimestamp={secondsSinceEpoch}]</td><td>NA</td><td>application/x-gvfs-timestamped-packfiles-indexes</td></tr></tbody></table><p>GVFS 最初要通过 <code>/gvfs/config</code> 接口去判断远程服务器对 GVFS 的支持程序，以及缓存服务器地址。获取引用列表依然需要通过 <code>GET /info/refs?service=git-upload-pack</code> 去请求远程服务器。</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#828b96;font-style:italic>//https://github.com/Microsoft/GVFS/blob/b07e554db151178fb397e51974d76465a13af017/GVFS/FastFetch/CheckoutFetchHelper.cs#L47</span>
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>GitRefs</span> <span style=color:#58a1dd>refs</span> = <span style=color:#ff636f>null</span>;
</span></span><span style=display:flex><span>            <span style=color:#ff636f>string</span> <span style=color:#58a1dd>commitToFetch</span>;
</span></span><span style=display:flex><span>            <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>isBranch</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#58a1dd>refs</span> = <span style=color:#ff636f>this</span>.<span style=color:#58a1dd>ObjectRequestor</span>.<span style=color:#58a1dd>QueryInfoRefs</span>(<span style=color:#58a1dd>branchOrCommit</span>);
</span></span><span style=display:flex><span>                <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>refs</span> == <span style=color:#ff636f>null</span>)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#ff636f>throw</span> <span style=color:#ff636f>new</span> <span style=color:#58a1dd>FetchException</span>(<span style=color:#a6be9d>&#34;Could not query info/refs from: {0}&#34;</span>, <span style=color:#ff636f>this</span>.<span style=color:#58a1dd>Enlistment</span>.<span style=color:#58a1dd>RepoUrl</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#ff636f>else</span> <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>refs</span>.<span style=color:#58a1dd>Count</span> == <span style=color:#a6be9d>0</span>)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#ff636f>throw</span> <span style=color:#ff636f>new</span> <span style=color:#58a1dd>FetchException</span>(<span style=color:#a6be9d>&#34;Could not find branch {0} in info/refs from: {1}&#34;</span>, <span style=color:#58a1dd>branchOrCommit</span>, <span style=color:#ff636f>this</span>.<span style=color:#58a1dd>Enlistment</span>.<span style=color:#58a1dd>RepoUrl</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#58a1dd>commitToFetch</span> = <span style=color:#58a1dd>refs</span>.<span style=color:#58a1dd>GetTipCommitId</span>(<span style=color:#58a1dd>branchOrCommit</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#ff636f>else</span>
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#58a1dd>commitToFetch</span> = <span style=color:#58a1dd>branchOrCommit</span>;
</span></span><span style=display:flex><span>            }
</span></span></code></pre></div><p>拿到引用列表后才能开始 GVFS clone。分析 <code>POST /gvfs/objects</code> 接口规范，我们知道，最初调用此接口时，只会获得特定的 commit 以及 tree 对象。引用列表返回的都是 commit id。拿到 tree 对象后，就可以拿到 tree 之中的 blob id。通过 <code>POST /gvfs/sizes</code> 可以拿到需要获得的对象的原始大小，通常而言，<code>/gvfs/sizes</code> 请求的对象的类型一般都是 blob，在 GVFS 源码的 <code>QueryForFileSizes</code> 正是说明了这一点。实际上一个完整功能的 GVFS 服务器实现这三个接口就可以正常运行。</p><p><code>POST /gvfs/objects</code> 请求类型：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#58a1dd>&#34;objectIds&#34;</span>:[
</span></span><span style=display:flex><span>		<span style=color:#a6be9d>&#34;e402091910d6d71c287181baaddfd9e36a511636&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6be9d>&#34;7ba8566052440d81c8d50f50d3650e5dd3c28a49&#34;</span>
</span></span><span style=display:flex><span>	],
</span></span><span style=display:flex><span>	<span style=color:#58a1dd>&#34;commitDepth&#34;</span>:<span style=color:#a6be9d>2</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>struct</span> <span style=color:#58a1dd>GvfsObjects</span>{
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>vector</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>objectIds</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff636f>int</span> <span style=color:#58a1dd>commitDepth</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p><code>POST /gvfs/sizes</code></p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>		<span style=color:#a6be9d>&#34;e402091910d6d71c287181baaddfd9e36a511636&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6be9d>&#34;7ba8566052440d81c8d50f50d3650e5dd3c28a49&#34;</span>
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>对于 Loose Object，目前的 git 代码托管平台基本上都不支持哑协议了，GVFS 这里支持 loose object 更多的目的是用来支持缓存，而 prefetch 的道理类似，像 Windows 源码这样体积的存储库，一般的代码托管平台优化策略往往无效。每一次计算 commit 中的目录布局都是非常耗时的，因此，GVFS 在设计之处都在尽量的利用缓存服务器。</p><h2 id=使用-libgit2>使用 Libgit2</h2><p>据我所知，国内最早实现 gvfs 服务器的是华为开发者庄表伟，具体介绍在简书上： <a href=http://www.jianshu.com/p/5a74c5194fa6>《GVFS协议与工作原理》</a>。我在实现 gvfs 的过程也参考了他的实现。与他的基于 rack 用 git 命令行实现的服务器不同的是，我是使用 libgit2 实现一个 git-gvfs 命令行，然后被 git-srv 和 bzsrv 调用。采取这种机制一是使用 git 命令行需要多个命令的组合，无论是 git-srv 还是基于 go 的 bzsrv 还要处理各种各样的命令，不利于细节屏蔽。二来是我对 libgit2 已经比较熟，并且也对 git 的存储协议，pack 格式比较了解。</p><p>git-srv 是码云分布式 git 传输的核心组件，无论是 HTTP 还是 SSH 还是 Git 协议，其传输数据都由其前端转发到 git-srv，最后通过 git-* 命令实现，支持的命令有 git-upload-pack git-upload-archive git-receive-pack git-archive，如果直接使用 git 命令实现 gvfs 功能不吝于重写 git-srv，很容易对线上的服务造成影响。简单的方法就是使用 libgit2 实现一个 git-gvfs cli.</p><p>git-gvfs 命令的基本用法是：</p><pre tabindex=0><code>git-gvfs GVFS impl cli
usage: [command] [args] gitdir
    config         show server config
    sizes           input json object ids, show those size
    pack-objects   pack input oid&#39;s objects
    loose-object   --oid; send loose object
    prefetch       --lastPackTimestamp; prefetch transfer
</code></pre><p><code>git-gvfs config</code> 命令用于显示服务器配置，在 brzo 或者 bzsrv 就可以被拦截，这里保留。</p><p><code>git-gvfs sizes</code> 命令对应 <code>POST /gvfs/sizes</code> 请求，请求体写入到 git-gvfs 的 <em>stdin</em> ，git-gvfs 使用 <code>nlohmann::json</code> 解析请求，然后使用 <code>git_odb</code> 去查询所有输入对象的未压缩大小。</p><p><code>pack-objects</code> 命令对应 <code>POST /gvfs/objects</code> 请求，输入的对象是 commit 时，使用 commitDepth 的长度回溯遍历，取第一个 parent commit。如果对象的类型不是 blob，则向下解析，直到树没有子树。构建 pack 可以使用 <a href=https://libgit2.github.com/libgit2/#HEAD/type/git_packbuilder><code>git_packbuilder</code></a>，写入文件使用 <a href=https://libgit2.github.com/libgit2/#HEAD/group/packbuilder/git_packbuilder_write><code>git_packbuilder_write</code></a>，直接写入 <code>stdout</code> 用<a href=https://libgit2.github.com/libgit2/#HEAD/group/packbuilder/git_packbuilder_foreach>git_packbuilder_foreach</a>。为了支持缓存，要先写入磁盘，然后从磁盘读取再写入到 <strong>stdout</strong>。</p><p><code>loose-object</code> 即读取松散对象写入到标准输出。</p><p><code>prefetch</code> 对应 <code>GET /gvfs/prefetch[?lastPackTimestamp={secondsSinceEpoch}]|</code> 这里核心是扫描 gvfs 临时目录。将所有某个时间点之后创建的 pack 文件打包成一个 pack。这里需要对 pack 对象进行遍历，最初的 pack 遍历我是使用 Git Native Hook 的机制，但后来发现 odb 边界导致性能不太理想，于是我使用 <code>git_odb_new</code> 新建 odb，然后使用 <code>git_odb_backend_one_pack</code> 创建 <code>git_odb_backend</code> 打开一个个的 pack 文件，使用 <code>git_odb_add_backend</code> 将 <code>odb_backend</code> 添加到 odb，这时候就可以对 odb 进行遍历，获得所有的对象，要创建 packbuilder 需要 <code>git_repositroy</code> 对象，因此，可以使用 <code>git_repository_warp_odb</code> 创建一个 fake repo. 代码片段如下：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>class</span> <span style=color:#58a1dd>FakePackbuilder</span> {
</span></span><span style=display:flex><span><span style=color:#ff636f>private</span><span style=color:#ff636f>:</span>
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>git_odb</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>db</span>{<span style=color:#ff636f>nullptr</span>};
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>git_repository</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>repo</span>{<span style=color:#ff636f>nullptr</span>};
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>git_packbuilder</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>pb</span>{<span style=color:#ff636f>nullptr</span>};
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>vector</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>pks</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>pksremove</span>{<span style=color:#58a1dd>false</span>};
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#58a1dd>name</span>;
</span></span><span style=display:flex><span>  <span style=color:#828b96;font-style:italic>/// skip self
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#ff636f>inline</span> <span style=color:#ff636f>void</span> <span style=color:#58a1dd>removepkidx</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>pk</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>pk</span>.<span style=color:#58a1dd>size</span>() <span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>name</span>.<span style=color:#58a1dd>size</span>() <span style=color:#ff636f>&amp;&amp;</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>pk</span>.<span style=color:#58a1dd>compare</span>(<span style=color:#58a1dd>pk</span>.<span style=color:#58a1dd>size</span>() <span style=color:#ff636f>-</span> <span style=color:#58a1dd>name</span>.<span style=color:#58a1dd>size</span>(), <span style=color:#58a1dd>name</span>.<span style=color:#58a1dd>size</span>(), <span style=color:#58a1dd>name</span>) <span style=color:#ff636f>!=</span> <span style=color:#a6be9d>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>idxfile</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>pk</span>.<span style=color:#58a1dd>substr</span>(<span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>pk</span>.<span style=color:#58a1dd>size</span>() <span style=color:#ff636f>-</span> <span style=color:#a6be9d>4</span>).<span style=color:#58a1dd>append</span>(<span style=color:#a6be9d>&#34;idx&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>remove</span>(<span style=color:#58a1dd>pk</span>.<span style=color:#58a1dd>c_str</span>()); <span style=color:#828b96;font-style:italic>///
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>remove</span>(<span style=color:#58a1dd>idxfile</span>.<span style=color:#58a1dd>c_str</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>public</span><span style=color:#ff636f>:</span>
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>FakePackbuilder</span>() <span style=color:#ff636f>=</span> <span style=color:#ff636f>default</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>FakePackbuilder</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>FakePackbuilder</span> <span style=color:#ff636f>&amp;</span>) <span style=color:#ff636f>=</span> <span style=color:#ff636f>delete</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>FakePackbuilder</span> <span style=color:#ff636f>&amp;</span><span style=color:#ff636f>operator</span><span style=color:#ff636f>=</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>FakePackbuilder</span> <span style=color:#ff636f>&amp;</span>) <span style=color:#ff636f>=</span> <span style=color:#ff636f>delete</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>~</span><span style=color:#58a1dd>FakePackbuilder</span>() {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>pb</span> <span style=color:#ff636f>!=</span> <span style=color:#ff636f>nullptr</span>) {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>git_packbuilder_free</span>(<span style=color:#58a1dd>pb</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>repo</span> <span style=color:#ff636f>!=</span> <span style=color:#ff636f>nullptr</span>) {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>git_repository_free</span>(<span style=color:#58a1dd>repo</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>db</span> <span style=color:#ff636f>!=</span> <span style=color:#ff636f>nullptr</span>) {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>git_odb_free</span>(<span style=color:#58a1dd>db</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>pksremove</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff636f>for</span> (<span style=color:#ff636f>auto</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>p</span> : <span style=color:#58a1dd>pks</span>) {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>removepkidx</span>(<span style=color:#58a1dd>p</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>vector</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span><span style=color:#ff636f>&gt;</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>Pks</span>() { <span style=color:#ff636f>return</span> <span style=color:#58a1dd>pks</span>; }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>const</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>vector</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span><span style=color:#ff636f>&gt;</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>Pks</span>() <span style=color:#ff636f>const</span> { <span style=color:#ff636f>return</span> <span style=color:#58a1dd>pks</span>; }
</span></span><span style=display:flex><span>  <span style=color:#828b96;font-style:italic>/// packbuilder callback
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#ff636f>static</span> <span style=color:#ff636f>int</span> <span style=color:#58a1dd>PackbuilderCallback</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>git_oid</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>id</span>, <span style=color:#ff636f>void</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>playload</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>fake</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>reinterpret_cast</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>FakePackbuilder</span> <span style=color:#ff636f>*&gt;</span>(<span style=color:#58a1dd>playload</span>);
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>git_odb_object</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>obj</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>git_odb_read</span>(<span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>obj</span>, <span style=color:#58a1dd>fake</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>db</span>, <span style=color:#58a1dd>id</span>) <span style=color:#ff636f>!=</span> <span style=color:#a6be9d>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span> <span style=color:#ff636f>-</span><span style=color:#a6be9d>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>git_odb_object_type</span>(<span style=color:#58a1dd>obj</span>) <span style=color:#ff636f>!=</span> <span style=color:#58a1dd>GIT_OBJ_BLOB</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>git_packbuilder_insert</span>(<span style=color:#58a1dd>fake</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>pb</span>, <span style=color:#58a1dd>id</span>, <span style=color:#ff636f>nullptr</span>) <span style=color:#ff636f>!=</span> <span style=color:#a6be9d>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>git_odb_object_free</span>(<span style=color:#58a1dd>obj</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> <span style=color:#a6be9d>1</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>git_odb_object_free</span>(<span style=color:#58a1dd>obj</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#58a1dd>Packfilename</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>git_oid</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>id</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span>(<span style=color:#a6be9d>&#34;pack-&#34;</span>).<span style=color:#58a1dd>append</span>(<span style=color:#58a1dd>git_oid_tostr_s</span>(<span style=color:#58a1dd>id</span>)).<span style=color:#58a1dd>append</span>(<span style=color:#a6be9d>&#34;.pack&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>Repack</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>gvfsdir</span>, <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>npk</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>git_odb_new</span>(<span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>db</span>) <span style=color:#ff636f>!=</span> <span style=color:#a6be9d>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>fprintf</span>(<span style=color:#58a1dd>stderr</span>, <span style=color:#a6be9d>&#34;new odb failed</span><span style=color:#a6be9d>\n</span><span style=color:#a6be9d>&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>for</span> (<span style=color:#ff636f>auto</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>p</span> : <span style=color:#58a1dd>pks</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>idxfile</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>p</span>.<span style=color:#58a1dd>substr</span>(<span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>p</span>.<span style=color:#58a1dd>size</span>() <span style=color:#ff636f>-</span> <span style=color:#a6be9d>4</span>).<span style=color:#58a1dd>append</span>(<span style=color:#a6be9d>&#34;idx&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>git_odb_backend</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>backend</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>nullptr</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>git_odb_backend_one_pack</span>(<span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>backend</span>, <span style=color:#58a1dd>idxfile</span>.<span style=color:#58a1dd>c_str</span>()) <span style=color:#ff636f>!=</span> <span style=color:#a6be9d>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>err</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>giterr_last</span>();
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>fprintf</span>(<span style=color:#58a1dd>stderr</span>, <span style=color:#a6be9d>&#34;%s</span><span style=color:#a6be9d>\n</span><span style=color:#a6be9d>&#34;</span>, <span style=color:#58a1dd>err</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>message</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#828b96;font-style:italic>/// NOTE backend no public free fun ?????
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>git_odb_add_backend</span>(<span style=color:#58a1dd>db</span>, <span style=color:#58a1dd>backend</span>, <span style=color:#a6be9d>2</span>) <span style=color:#ff636f>!=</span> <span style=color:#a6be9d>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#828b96;font-style:italic>// backend-&gt;free(backend);///
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>        <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>backend</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>free</span> <span style=color:#ff636f>!=</span> <span style=color:#ff636f>nullptr</span>) {
</span></span><span style=display:flex><span>          <span style=color:#58a1dd>backend</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>free</span>(<span style=color:#58a1dd>backend</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>git_repository_wrap_odb</span>(<span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>repo</span>, <span style=color:#58a1dd>db</span>) <span style=color:#ff636f>!=</span> <span style=color:#a6be9d>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>fprintf</span>(<span style=color:#58a1dd>stderr</span>, <span style=color:#a6be9d>&#34;warp odb failed</span><span style=color:#a6be9d>\n</span><span style=color:#a6be9d>&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>git_packbuilder_new</span>(<span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>pb</span>, <span style=color:#58a1dd>repo</span>) <span style=color:#ff636f>!=</span> <span style=color:#a6be9d>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>fprintf</span>(<span style=color:#58a1dd>stderr</span>, <span style=color:#a6be9d>&#34;new packbuilder failed</span><span style=color:#a6be9d>\n</span><span style=color:#a6be9d>&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>git_odb_foreach</span>(<span style=color:#58a1dd>db</span>, <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>FakePackbuilder</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>PackbuilderCallback</span>, <span style=color:#ff636f>this</span>) <span style=color:#ff636f>!=</span> <span style=color:#a6be9d>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>git_packbuilder_write</span>(<span style=color:#58a1dd>pb</span>, <span style=color:#58a1dd>gvfsdir</span>.<span style=color:#58a1dd>c_str</span>(), <span style=color:#a6be9d>0</span>, <span style=color:#ff636f>nullptr</span>, <span style=color:#ff636f>nullptr</span>) <span style=color:#ff636f>!=</span> <span style=color:#a6be9d>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>id</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>git_packbuilder_hash</span>(<span style=color:#58a1dd>pb</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>id</span> <span style=color:#ff636f>==</span> <span style=color:#ff636f>nullptr</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>pksremove</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>true</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>name</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>Packfilename</span>(<span style=color:#58a1dd>id</span>);
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>npk</span>.<span style=color:#58a1dd>assign</span>(<span style=color:#58a1dd>gvfsdir</span>).<span style=color:#58a1dd>append</span>(<span style=color:#a6be9d>&#34;/&#34;</span>).<span style=color:#58a1dd>append</span>(<span style=color:#58a1dd>name</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>true</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>上述 FakePackBuilder 还支持删除旧的 pack，新的 pack 产生，旧的几个 pack 文件就可以被删除了。</p><p>在 git-gvfs 稳定后，或许会提供一个开源跨平台版本。</p><h2 id=gvfs-应用分析>GVFS 应用分析</h2><p>GVFS 有哪些应用场景？</p><p>实际上还是很多的。比如，我曾经帮助同事将某客户的存储库由 svn 迁移到 git，迁移的过程很长，最后使用 svn-fast-export 实现，转换后，存储库的体积达到 80 GB。就目前码云的线上限制而言，这种存储库都无法上传上去，而私有化，这种存储库同样会给使用者带来巨大的麻烦。如果使用 GVFS，这就相当于只下载目录结构，浅表的 commit，然后需要时才下载所需的文件，好处显而易见。随着码云业务的发展，这种拥有历史悠久的存储库的客户只会越来越多，GVFS 或许必不可少了。</p><h2 id=相关信息>相关信息</h2><p>在微软的 GVFS 推出后，Google 开发者也在修改 Git 支持部分克隆<sup>7</sup>，用来改进巨型存储库的访问体验。代码在 Github 上 <sup>8</sup> 目前还处于开发过程中。部分克隆相对于 GVFS 最大的不足可能是 FUFS。而 GVFS 客户端仅支持 Windows 10 14393 也正是由于这一点，GVFS 正因这一点才被叫做 GVFS (Git Virtual Filesystem)。FUFS 能够在目录中呈现未下载的文件，在文件需要读写时，由驱动触发下载，这就是其优势。</p><h2 id=最后>最后</h2><p>回过头来一想，在支持大存储库的改造上，git 越来越不像一个分布式版本控制系统，除了提交行为还是比较纯正。软件的发展正是如此，功能的整合使得界限变得不那么清晰。</p><h2 id=链接>链接</h2><ol><li><a href=https://gcc.gnu.org/ml/gcc/2015-08/msg00140.html>Moving to git</a></li><li><a href=http://llvm.org/docs/Proposals/GitHubMove.html>Moving LLVM Projects to GitHub</a></li><li><a href=https://github.com/fstudio/clangbuilder/blob/63f45b5b99d6b2f8473356dfbe3454238f6dee2e/bin/LLVMRemoteFetch.ps1#L33>Checkout LLVM use &ndash;depth</a></li><li><a href=http://forcemz.net/git/2017/04/16/Moses/>Git LFS 服务器实现杂谈</a></li><li><a href=https://www.visualstudio.com/zh-hans/learn/git-at-scale/>Git at scale</a></li><li><a href=https://www.visualstudio.com/zh-hans/learn/gvfs-design-history/>GVFS Design History</a></li><li><a href=https://public-inbox.org/git/20170915134343.3814dc38@twelve2.svl.corp.google.com/T/#u>Make GVFS available for Linux and macOS</a></li><li><a href=https://github.com/jonathantanmy/git/tree/partialclone2>jonathantanmy/git</a></li></ol><hr width=100% id=EOF><p style=color:#777>Last modified on 2017-12-06</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/2018/2018-03-22-git-submodule-rethinking/>Next<br>Git Submodule 的反思
</a><a class=older-posts href=/posts/2017/2017-11-27-asio-graceful-restart/>Previous<br>基于 Asio 的服务器平滑重启方案</a></nav><div class=post-comment-wrapper></div></div></div></div></div><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://forcemz.net/><div class=nav-title>Charlie's Rethinking</div><div class=nav-subtitle>Themed by Diary.</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>归档
</a><a class="a-block nav-link-item false" href=/categories>分类
</a><a class="a-block nav-link-item false" href=/tags>标签
</a><a class="a-block nav-link-item false" href=/about>关于
</a><a class="a-block nav-link-item false" href=/index.xml>RSS Feed</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><div id=extraContainer class=extra-container><div class=toc-wrapper><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e5%89%8d%e8%a8%80 class=nav-前言>前言</a></li><li><a href=#%e6%b5%85%e5%85%8b%e9%9a%86%e5%92%8c%e7%a8%80%e7%96%8f%e6%a3%80%e5%87%ba class=nav-浅克隆和稀疏检出>浅克隆和稀疏检出</a></li><li><a href=#git-lfs-%e7%9a%84%e5%88%9d%e8%a1%b7 class=nav-git-lfs-的初衷>Git LFS 的初衷</a></li><li><a href=#gvfs-%e7%9a%84%e5%8e%9f%e7%90%86 class=nav-gvfs-的原理>GVFS 的原理</a></li><li><a href=#%e4%bd%bf%e7%94%a8-libgit2 class=nav-使用-libgit2>使用 Libgit2</a></li><li><a href=#gvfs-%e5%ba%94%e7%94%a8%e5%88%86%e6%9e%90 class=nav-gvfs-应用分析>GVFS 应用分析</a></li><li><a href=#%e7%9b%b8%e5%85%b3%e4%bf%a1%e6%81%af class=nav-相关信息>相关信息</a></li><li><a href=#%e6%9c%80%e5%90%8e class=nav-最后>最后</a></li><li><a href=#%e9%93%be%e6%8e%a5 class=nav-链接>链接</a></li></ul></div></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up
</i></a><a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><script src=/js/journal.js></script></body></html>