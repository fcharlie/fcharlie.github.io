<!doctype html><html lang=en><head><title>基于 Powershell Core 的 Git 存储库加密方案</title>
<meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=5" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><script src=/js/toc.js></script><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Material+Icons"></head><body><div id=app><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>归档
</a><a class="a-block drawer-menu-item false" href=/categories>分类
</a><a class="a-block drawer-menu-item false" href=/tags>标签
</a><a class="a-block drawer-menu-item false" href=/about>关于
</a><a class="a-block drawer-menu-item false" href=/index.xml>RSS Feed</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e8%83%8c%e6%99%af class=nav-背景>背景</a></li><li><a href=#%e5%85%b6%e4%bb%96%e6%96%b9%e6%a1%88 class=nav-其他方案>其他方案</a></li><li><a href=#powershell class=nav-powershell>PowerShell</a></li><li><a href=#git-secure-%e5%8e%9f%e7%90%86 class=nav-git-secure-原理>Git-Secure 原理</a></li><li><a href=#%e6%9c%80%e5%90%8e%e5%85%b3%e4%ba%8e-powershell class=nav-最后关于-powershell>最后关于 PowerShell</a></li><li><a href=#%e5%85%b6%e4%bb%96 class=nav-其他>其他</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu
</i></button>
<a id=navTitle class=navbar-brand href=https://forcemz.net/>Charlie's Rethinking
</a><button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://forcemz.net/><div class=single-column-header-title>Charlie's Rethinking</div><div class=single-column-header-subtitle>Themed by Diary.</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>基于 Powershell Core 的 Git 存储库加密方案<div class=post-meta><time itemprop=datePublished>2017-07-31 10:00
</time><i class=material-icons>folder</i>
<a href=/categories/git>git</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h2 id=背景>背景</h2><p>虽然码云提供免费私有存储库，但一些用户还是认为网站管理员可以看到他们的源码，认为私有库也不太安全。而且这些用户也没有私有化部署的打算。如何消除他们的疑虑？使用笔者开发的 <strong>Git-Secure</strong> 就可以实现存储库的加密。项目开源地址：<a href=https://gitee.com/oscstudio/git-secure>Git-Secure</a></p><pre tabindex=0><code class=language-usage data-lang=usage>Git Secure utilies 1.0
Usage: git-secure cmd args
       add         add file contents to the index
       clone       clone a encrypted repository
       config      config your secure repository
       commit      create a commit
       diff        show commit changes between commit worktree
       init        initialize a secure repository
       key         create a aes key
       pull        Fetch from and integrate with another repository or a local branch
       push        Update remote refs along with associated objects
       remote      set remote for secure repositroy
       status      Show the working tree status
       help        print help message
</code></pre><h2 id=其他方案>其他方案</h2><p>笔者在开发 Git-Secure 之前也去了解过有什么方案支持存储库加密，在 Github 上有一个简单的项目，将所有的文件压缩后创建单文件存储库，加密后提交，然后推送到远程服务器。这样有一些缺点，第一，无法通过 diff 查看文件变更；第二，由于 git 的快照特性，存储库的膨胀会很严重。因此笔者还是决定自己动手开发。</p><h2 id=powershell>PowerShell</h2><p>在实现一系列的 git 功能时，我们可以直接使用 git 命令，通过一些 shell 脚本将 git 命令组合来实现这些功能，也可以使用 libgit2 或者 libgit 调用函数来实现这些功能。第一个开发起来比较简单，于是笔者采用了第一种。得益于 PowerShell Core 的开源和跨平台，笔者作为一个熟练使用 PowerShell 脚本的开发者，肯定优先使用 PowerShell。当然相对于 Bash Shell 之类的 Shell 脚本， PowerShell 的功能更加强大，可以无缝调用 .Net 类库，比如，我们加密使用的是 AES 算法，就可以调用 <code>System.Security.Cryptography.AesManaged</code> 来实现 AES 加密。</p><h2 id=git-secure-原理>Git-Secure 原理</h2><p>Git-Secure 原理非常简单，即本地存在两个存储库，一个是用户可见的存储库，用户使用 git-secure 的 commit, push 这些操作时，实际上是转换到隐藏的真实的存储库，用户 commit 时，将修改的文件加密后提交到隐藏的加密存储库，推送时，将隐藏存储库推送到远程服务器。</p><p>而 Git-Secure 的 fecth,pull 等操作则是上述操作的逆过程。</p><p>commit 源码： <a href=https://gitee.com/oscstudio/git-secure/blob/master/ps/commit.ps1>ps/commit.ps1</a></p><p>pull 源码：<a href=https://gitee.com/oscstudio/git-secure/blob/master/ps/pull.ps1>ps/pull.ps1</a></p><p>Git-Secure 加密使用了 AES-256，加密模块源码地址：<a href=https://gitee.com/oscstudio/git-secure/blob/master/Modules/AesProvider/AesProvider.psm1>Modules/AesProvider/AesProvider.psm1</a></p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#ff636f>function</span> <span style=color:#58a1dd>New-AesKey</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>Param</span>(
</span></span><span style=display:flex><span>        [<span style=color:#58a1dd>Parameter</span>(<span style=color:#58a1dd>Mandatory</span> = <span style=color:#58a1dd>$false</span>, <span style=color:#58a1dd>Position</span> = <span style=color:#a6be9d>1</span>, <span style=color:#58a1dd>ValueFromPipeline</span> = <span style=color:#58a1dd>$true</span>)]
</span></span><span style=display:flex><span>        [<span style=color:#58a1dd>Int</span>]<span style=color:#58a1dd>$KeySize</span> = <span style=color:#a6be9d>256</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$AESProvider</span> = <span style=color:#58a1dd>New-Object</span> <span style=color:#a6be9d>&#34;System.Security.Cryptography.AesManaged&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>KeySize</span> = <span style=color:#58a1dd>$KeySize</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>GenerateKey</span>()
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> [<span style=color:#58a1dd>System.Convert</span>]::<span style=color:#58a1dd>ToBase64String</span>(<span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>Key</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Write-Error</span> <span style=color:#58a1dd>$_</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>function</span> <span style=color:#58a1dd>New-AesFile</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>param</span>(
</span></span><span style=display:flex><span>        [<span style=color:#58a1dd>Parameter</span>(<span style=color:#58a1dd>Position</span> = <span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>Mandatory</span> = <span style=color:#58a1dd>$True</span>, <span style=color:#58a1dd>HelpMessage</span> = <span style=color:#a6be9d>&#34;Enter your need encrypt file&#34;</span>)]
</span></span><span style=display:flex><span>        [<span style=color:#58a1dd>System.IO.FileInfo</span>]<span style=color:#58a1dd>$File</span>,
</span></span><span style=display:flex><span>        [<span style=color:#58a1dd>string</span>]<span style=color:#58a1dd>$Key</span>,
</span></span><span style=display:flex><span>        [<span style=color:#58a1dd>string</span>]<span style=color:#58a1dd>$Destination</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> ([<span style=color:#58a1dd>System.String</span>]::<span style=color:#58a1dd>IsNullOrEmpty</span>(<span style=color:#58a1dd>$Destination</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$Destination</span> = <span style=color:#58a1dd>$Path</span> + <span style=color:#a6be9d>&#34;.crypt&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$EncryptionKey</span> = [<span style=color:#58a1dd>System.Convert</span>]::<span style=color:#58a1dd>FromBase64String</span>(<span style=color:#58a1dd>$Key</span>)
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$KeySize</span> = <span style=color:#58a1dd>$EncryptionKey</span>.<span style=color:#58a1dd>Length</span> * <span style=color:#a6be9d>8</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$AESProvider</span> = <span style=color:#58a1dd>New-Object</span> <span style=color:#a6be9d>&#39;System.Security.Cryptography.AesManaged&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>Mode</span> = [<span style=color:#58a1dd>System.Security.Cryptography.CipherMode</span>]::<span style=color:#58a1dd>CBC</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>BlockSize</span> = <span style=color:#a6be9d>128</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>KeySize</span> = <span style=color:#58a1dd>$KeySize</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>Key</span> = <span style=color:#58a1dd>$EncryptionKey</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>Catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Write-Error</span> <span style=color:#a6be9d>&#39;Unable to configure AES, verify you are using a valid key.&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff636f>Return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>Write-Verbose</span> <span style=color:#a6be9d>&#34;Encryping </span>$(<span style=color:#58a1dd>$File</span>.<span style=color:#58a1dd>FullName</span>)<span style=color:#a6be9d> with the </span><span style=color:#58a1dd>$KeySize</span><span style=color:#a6be9d>-bit key </span><span style=color:#58a1dd>$Key</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>Try</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$FileStreamReader</span> = <span style=color:#58a1dd>New-Object</span> <span style=color:#58a1dd>System</span>.<span style=color:#58a1dd>IO</span>.<span style=color:#58a1dd>FileStream</span>(<span style=color:#58a1dd>$File</span>.<span style=color:#58a1dd>FullName</span>, [<span style=color:#58a1dd>System.IO.FileMode</span>]::<span style=color:#58a1dd>Open</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>Catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Write-Error</span> <span style=color:#a6be9d>&#34;Unable to open </span>$(<span style=color:#58a1dd>$File</span>.<span style=color:#58a1dd>FullName</span>)<span style=color:#a6be9d> for reading.</span><span style=color:#a6be9d>`n</span><span style=color:#58a1dd>$_</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> <span style=color:#a6be9d>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>Try</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$FileStreamWriter</span> = <span style=color:#58a1dd>New-Object</span> <span style=color:#58a1dd>System</span>.<span style=color:#58a1dd>IO</span>.<span style=color:#58a1dd>FileStream</span>(<span style=color:#58a1dd>$Destination</span>, [<span style=color:#58a1dd>System.IO.FileMode</span>]::<span style=color:#58a1dd>Create</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>Catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Write-Error</span> <span style=color:#a6be9d>&#34;Unable to open </span><span style=color:#58a1dd>$Destination</span><span style=color:#a6be9d> for writing.&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$FileStreamReader</span>.<span style=color:#58a1dd>Close</span>()
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> <span style=color:#a6be9d>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>GenerateIV</span>()
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>$FileStreamWriter</span>.<span style=color:#58a1dd>Write</span>([<span style=color:#58a1dd>System.BitConverter</span>]::<span style=color:#58a1dd>GetBytes</span>(<span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>IV</span>.<span style=color:#58a1dd>Length</span>), <span style=color:#a6be9d>0</span>, <span style=color:#a6be9d>4</span>)
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>$FileStreamWriter</span>.<span style=color:#58a1dd>Write</span>(<span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>IV</span>, <span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>IV</span>.<span style=color:#58a1dd>Length</span>)
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>Write-Verbose</span> <span style=color:#a6be9d>&#34;Encrypting </span>$(<span style=color:#58a1dd>$File</span>.<span style=color:#58a1dd>FullName</span>)<span style=color:#a6be9d> with an IV of </span>$([<span style=color:#58a1dd>System.Convert</span>]::<span style=color:#58a1dd>ToBase64String</span>(<span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>IV</span>))<span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$Transform</span> = <span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>CreateEncryptor</span>()
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$CryptoStream</span> = <span style=color:#58a1dd>New-Object</span> <span style=color:#58a1dd>System</span>.<span style=color:#58a1dd>Security</span>.<span style=color:#58a1dd>Cryptography</span>.<span style=color:#58a1dd>CryptoStream</span>(<span style=color:#58a1dd>$FileStreamWriter</span>, <span style=color:#58a1dd>$Transform</span>, [<span style=color:#58a1dd>System.Security.Cryptography.CryptoStreamMode</span>]::<span style=color:#58a1dd>Write</span>)
</span></span><span style=display:flex><span>        [<span style=color:#58a1dd>Int</span>]<span style=color:#58a1dd>$Count</span> = <span style=color:#a6be9d>0</span>
</span></span><span style=display:flex><span>        [<span style=color:#58a1dd>Int</span>]<span style=color:#58a1dd>$BlockSizeBytes</span> = <span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>BlockSize</span> / <span style=color:#a6be9d>8</span>
</span></span><span style=display:flex><span>        [<span style=color:#58a1dd>Byte[]</span>]<span style=color:#58a1dd>$Data</span> = <span style=color:#58a1dd>New-Object</span> <span style=color:#58a1dd>Byte</span>[] <span style=color:#58a1dd>$BlockSizeBytes</span>
</span></span><span style=display:flex><span>        <span style=color:#ff636f>Do</span> {
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>$Count</span> = <span style=color:#58a1dd>$FileStreamReader</span>.<span style=color:#58a1dd>Read</span>(<span style=color:#58a1dd>$Data</span>, <span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>$BlockSizeBytes</span>)
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>$CryptoStream</span>.<span style=color:#58a1dd>Write</span>(<span style=color:#58a1dd>$Data</span>, <span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>$Count</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff636f>While</span> (<span style=color:#58a1dd>$Count</span> <span style=color:#ff636f>-gt</span> <span style=color:#a6be9d>0</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>        <span style=color:#828b96;font-style:italic>#Close open files</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$CryptoStream</span>.<span style=color:#58a1dd>FlushFinalBlock</span>()
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$CryptoStream</span>.<span style=color:#58a1dd>Close</span>()
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$FileStreamReader</span>.<span style=color:#58a1dd>Close</span>()
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$FileStreamWriter</span>.<span style=color:#58a1dd>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Write-Verbose</span> <span style=color:#a6be9d>&#34;Successfully encrypted </span>$(<span style=color:#58a1dd>$File</span>.<span style=color:#58a1dd>FullName</span>)<span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Write-Error</span> <span style=color:#a6be9d>&#34;Failed to encrypt </span>$(<span style=color:#58a1dd>$File</span>.<span style=color:#58a1dd>FullName</span>)<span style=color:#a6be9d>.&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$CryptoStream</span>.<span style=color:#58a1dd>Close</span>()
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$FileStreamWriter</span>.<span style=color:#58a1dd>Close</span>()
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$FileStreamReader</span>.<span style=color:#58a1dd>Close</span>()
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Remove-Item</span> <span style=color:#58a1dd>$Destination</span>
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> <span style=color:#a6be9d>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#a6be9d>0</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff636f>function</span> <span style=color:#58a1dd>Restore-AesFile</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>param</span>(
</span></span><span style=display:flex><span>        [<span style=color:#58a1dd>System.IO.FileInfo</span>]<span style=color:#58a1dd>$File</span>,
</span></span><span style=display:flex><span>        [<span style=color:#58a1dd>string</span>]<span style=color:#58a1dd>$Key</span>,
</span></span><span style=display:flex><span>        [<span style=color:#58a1dd>string</span>]<span style=color:#58a1dd>$Destination</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#ff636f>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$EncryptionKey</span> = [<span style=color:#58a1dd>System.Convert</span>]::<span style=color:#58a1dd>FromBase64String</span>(<span style=color:#58a1dd>$Key</span>)
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$KeySize</span> = <span style=color:#58a1dd>$EncryptionKey</span>.<span style=color:#58a1dd>Length</span> * <span style=color:#a6be9d>8</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$AESProvider</span> = <span style=color:#58a1dd>New-Object</span> <span style=color:#a6be9d>&#39;System.Security.Cryptography.AesManaged&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>Mode</span> = [<span style=color:#58a1dd>System.Security.Cryptography.CipherMode</span>]::<span style=color:#58a1dd>CBC</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>BlockSize</span> = <span style=color:#a6be9d>128</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>KeySize</span> = <span style=color:#58a1dd>$KeySize</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>Key</span> = <span style=color:#58a1dd>$EncryptionKey</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>Catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Write-Error</span> <span style=color:#a6be9d>&#39;Unable to configure AES, verify you are using a valid key.&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff636f>Return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>Write-Verbose</span> <span style=color:#a6be9d>&#34;Encryping </span>$(<span style=color:#58a1dd>$File</span>.<span style=color:#58a1dd>FullName</span>)<span style=color:#a6be9d> with the </span><span style=color:#58a1dd>$KeySize</span><span style=color:#a6be9d>-bit key </span><span style=color:#58a1dd>$Key</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>#Open file to decrypt</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>Try</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$FileStreamReader</span> = <span style=color:#58a1dd>New-Object</span> <span style=color:#58a1dd>System</span>.<span style=color:#58a1dd>IO</span>.<span style=color:#58a1dd>FileStream</span>(<span style=color:#58a1dd>$File</span>.<span style=color:#58a1dd>FullName</span>, [<span style=color:#58a1dd>System.IO.FileMode</span>]::<span style=color:#58a1dd>Open</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>Catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Write-Error</span> <span style=color:#a6be9d>&#34;Unable to open </span>$(<span style=color:#58a1dd>$File</span>.<span style=color:#58a1dd>FullName</span>)<span style=color:#a6be9d> for reading.&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> <span style=color:#a6be9d>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ff636f>Try</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$FileStreamWriter</span> = <span style=color:#58a1dd>New-Object</span> <span style=color:#58a1dd>System</span>.<span style=color:#58a1dd>IO</span>.<span style=color:#58a1dd>FileStream</span>(<span style=color:#58a1dd>$Destination</span>, [<span style=color:#58a1dd>System.IO.FileMode</span>]::<span style=color:#58a1dd>Create</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>Catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Write-Error</span> <span style=color:#a6be9d>&#34;Unable to open </span><span style=color:#58a1dd>$DestinationFile</span><span style=color:#a6be9d> for writing.&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$FileStreamReader</span>.<span style=color:#58a1dd>Close</span>()
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> <span style=color:#a6be9d>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>#Get IV</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>try</span> {
</span></span><span style=display:flex><span>        [<span style=color:#58a1dd>Byte[]</span>]<span style=color:#58a1dd>$LenIV</span> = <span style=color:#58a1dd>New-Object</span> <span style=color:#58a1dd>Byte</span>[] <span style=color:#a6be9d>4</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$FileStreamReader</span>.<span style=color:#58a1dd>Seek</span>(<span style=color:#a6be9d>0</span>, [<span style=color:#58a1dd>System.IO.SeekOrigin</span>]::<span style=color:#ff636f>Begin</span>) | <span style=color:#58a1dd>Out-Null</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$FileStreamReader</span>.<span style=color:#58a1dd>Read</span>(<span style=color:#58a1dd>$LenIV</span>, <span style=color:#a6be9d>0</span>, <span style=color:#a6be9d>3</span>) | <span style=color:#58a1dd>Out-Null</span>
</span></span><span style=display:flex><span>        [<span style=color:#58a1dd>Int</span>]<span style=color:#58a1dd>$LIV</span> = [<span style=color:#58a1dd>System.BitConverter</span>]::<span style=color:#58a1dd>ToInt32</span>(<span style=color:#58a1dd>$LenIV</span>, <span style=color:#a6be9d>0</span>)
</span></span><span style=display:flex><span>        [<span style=color:#58a1dd>Byte[]</span>]<span style=color:#58a1dd>$IV</span> = <span style=color:#58a1dd>New-Object</span> <span style=color:#58a1dd>Byte</span>[] <span style=color:#58a1dd>$LIV</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$FileStreamReader</span>.<span style=color:#58a1dd>Seek</span>(<span style=color:#a6be9d>4</span>, [<span style=color:#58a1dd>System.IO.SeekOrigin</span>]::<span style=color:#ff636f>Begin</span>) | <span style=color:#58a1dd>Out-Null</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$FileStreamReader</span>.<span style=color:#58a1dd>Read</span>(<span style=color:#58a1dd>$IV</span>, <span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>$LIV</span>) | <span style=color:#58a1dd>Out-Null</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>IV</span> = <span style=color:#58a1dd>$IV</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Write-Error</span> <span style=color:#a6be9d>&#39;Unable to read IV from file, verify this file was made using the included New-AesFile function.&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> <span style=color:#a6be9d>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>Write-Verbose</span> <span style=color:#a6be9d>&#34;Decrypting </span>$(<span style=color:#58a1dd>$File</span>.<span style=color:#58a1dd>FullName</span>)<span style=color:#a6be9d> with an IV of </span>$([<span style=color:#58a1dd>System.Convert</span>]::<span style=color:#58a1dd>ToBase64String</span>(<span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>IV</span>))<span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>#Decrypt</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$Transform</span> = <span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>CreateDecryptor</span>()
</span></span><span style=display:flex><span>        [<span style=color:#58a1dd>Int</span>]<span style=color:#58a1dd>$Count</span> = <span style=color:#a6be9d>0</span>
</span></span><span style=display:flex><span>        [<span style=color:#58a1dd>Int</span>]<span style=color:#58a1dd>$BlockSizeBytes</span> = <span style=color:#58a1dd>$AESProvider</span>.<span style=color:#58a1dd>BlockSize</span> / <span style=color:#a6be9d>8</span>
</span></span><span style=display:flex><span>        [<span style=color:#58a1dd>Byte[]</span>]<span style=color:#58a1dd>$Data</span> = <span style=color:#58a1dd>New-Object</span> <span style=color:#58a1dd>Byte</span>[] <span style=color:#58a1dd>$BlockSizeBytes</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$CryptoStream</span> = <span style=color:#58a1dd>New-Object</span> <span style=color:#58a1dd>System</span>.<span style=color:#58a1dd>Security</span>.<span style=color:#58a1dd>Cryptography</span>.<span style=color:#58a1dd>CryptoStream</span>(<span style=color:#58a1dd>$FileStreamWriter</span>, <span style=color:#58a1dd>$Transform</span>, [<span style=color:#58a1dd>System.Security.Cryptography.CryptoStreamMode</span>]::<span style=color:#58a1dd>Write</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff636f>Do</span> {
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>$Count</span> = <span style=color:#58a1dd>$FileStreamReader</span>.<span style=color:#58a1dd>Read</span>(<span style=color:#58a1dd>$Data</span>, <span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>$BlockSizeBytes</span>)
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>$CryptoStream</span>.<span style=color:#58a1dd>Write</span>(<span style=color:#58a1dd>$Data</span>, <span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>$Count</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff636f>While</span> (<span style=color:#58a1dd>$Count</span> <span style=color:#ff636f>-gt</span> <span style=color:#a6be9d>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$CryptoStream</span>.<span style=color:#58a1dd>FlushFinalBlock</span>()
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$CryptoStream</span>.<span style=color:#58a1dd>Close</span>()
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$FileStreamWriter</span>.<span style=color:#58a1dd>Close</span>()
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$FileStreamReader</span>.<span style=color:#58a1dd>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Write-Verbose</span> <span style=color:#a6be9d>&#34;Successfully decrypted </span>$(<span style=color:#58a1dd>$File</span>.<span style=color:#58a1dd>FullName</span>)<span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Write-Error</span> <span style=color:#a6be9d>&#34;Failed to decrypt </span>$(<span style=color:#58a1dd>$File</span>.<span style=color:#58a1dd>FullName</span>)<span style=color:#a6be9d>.&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$CryptoStream</span>.<span style=color:#58a1dd>Close</span>()
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$FileStreamWriter</span>.<span style=color:#58a1dd>Close</span>()
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>$FileStreamReader</span>.<span style=color:#58a1dd>Close</span>()
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>Remove-Item</span> <span style=color:#58a1dd>$Destination</span>
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> <span style=color:#a6be9d>1</span>
</span></span><span style=display:flex><span>    }        
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#a6be9d>0</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>所以说这工具并没有什么技术含量，主要是功能的整合。我在使用 PowerShell 管道的解析 git 的输出时感觉比 Shell 脚本方便多了。</p><h2 id=最后关于-powershell>最后关于 PowerShell</h2><p>非常推荐 PowerShell。</p><h2 id=其他>其他</h2><p>相关新闻链接 <a href=https://www.oschina.net/news/87432/git-1-0-released>码云存储库加密工具 1.0 正式发布</a></p><hr width=100% id=EOF><p style=color:#777>Last modified on 2017-07-31</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/2017/2017-09-01-kisasum-hash-utility/>Next<br>Kisasum Hash 实用工具
</a><a class=older-posts href=/posts/2017/2017-07-29-clangbuild-and-libcxx/>Previous<br>Clangbuilder 和 libcxx</a></nav><div class=post-comment-wrapper></div></div></div></div></div><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://forcemz.net/><div class=nav-title>Charlie's Rethinking</div><div class=nav-subtitle>Themed by Diary.</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>归档
</a><a class="a-block nav-link-item false" href=/categories>分类
</a><a class="a-block nav-link-item false" href=/tags>标签
</a><a class="a-block nav-link-item false" href=/about>关于
</a><a class="a-block nav-link-item false" href=/index.xml>RSS Feed</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><div id=extraContainer class=extra-container><div class=toc-wrapper><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e8%83%8c%e6%99%af class=nav-背景>背景</a></li><li><a href=#%e5%85%b6%e4%bb%96%e6%96%b9%e6%a1%88 class=nav-其他方案>其他方案</a></li><li><a href=#powershell class=nav-powershell>PowerShell</a></li><li><a href=#git-secure-%e5%8e%9f%e7%90%86 class=nav-git-secure-原理>Git-Secure 原理</a></li><li><a href=#%e6%9c%80%e5%90%8e%e5%85%b3%e4%ba%8e-powershell class=nav-最后关于-powershell>最后关于 PowerShell</a></li><li><a href=#%e5%85%b6%e4%bb%96 class=nav-其他>其他</a></li></ul></div></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up
</i></a><a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><script src=/js/journal.js></script></body></html>