<!doctype html><html lang=en><head><title>文件的真实路径</title>
<meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=5" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><script src=/js/toc.js></script><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Material+Icons"></head><body><div id=app><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>归档
</a><a class="a-block drawer-menu-item false" href=/categories>分类
</a><a class="a-block drawer-menu-item false" href=/tags>标签
</a><a class="a-block drawer-menu-item false" href=/about>关于
</a><a class="a-block drawer-menu-item false" href=/index.xml>RSS Feed</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><li><a href=#%e5%89%8d%e8%a8%80 class=nav-前言>前言</a></li><ul><li><a href=#%e6%96%87%e4%bb%b6%e7%9a%84%e7%9c%9f%e5%ae%9e%e8%b7%af%e5%be%84 class=nav-文件的真实路径>文件的真实路径</a></li><li><a href=#%e9%80%9a%e8%bf%87%e9%87%8d%e8%a7%a3%e6%9e%90%e7%82%b9%e8%8e%b7%e5%be%97%e7%9c%9f%e5%ae%9e%e8%b7%af%e5%be%84 class=nav-通过重解析点获得真实路径>通过重解析点获得真实路径</a></li><li><a href=#%e6%9c%80%e5%90%8e class=nav-最后>最后</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu
</i></button>
<a id=navTitle class=navbar-brand href=https://forcemz.net/>江二十三的思考
</a><button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://forcemz.net/><div class=single-column-header-title>江二十三的思考</div><div class=single-column-header-subtitle>Themed by Diary.</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>文件的真实路径<div class=post-meta><time itemprop=datePublished>2020-04-24 10:00
</time><i class=material-icons>folder</i>
<a href=/categories/windows>windows</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h1 id=前言>前言</h1><p>最近浏览 Windows Terminal 提交，发现其文档中链接了一个 PowerShell 的 Issue：<a href=https://github.com/PowerShell/PowerShell/issues/9970>Windows Store applications incorrectly assumed to be console applications </a>，这个问题描述起来很简单，就是在 PowerShell 中打开 <code>wt.exe</code>， PowerShell 会一直等待 Windows Terminal 的退出，但实际上 Windows Terminal 是一个 GUI 程序，按照 Windows 的默认行为，PowerShell 在创建 Windows Terminal 进程后，就应该返回。这个问题是怎么产生的，其实很简单，<code>wt.exe</code> 是 Windows Terminal 的 <code>AppExecutionAlias</code>，<code>AppExecutionAlias</code> 是一类特殊的重解析点，Windows 在创建进程时会根据 <code>AppExecutionAlias</code> 设施的信息启动对应的 Store App。那么 PowerShell 应当获得相应 Store App 的主程序的 <code>Subsystem</code> 才能正确的决定是否应该等待进程退出。因此这里获得其真实路径是必不可少的。</p><h2 id=文件的真实路径>文件的真实路径</h2><p>在 POSIX 中，我们可以使用 <code>realpath</code> 获得文件的真实路径，如果一个文件是常规文件则返回它的绝对路径，如果一个文件是符号链接，则返回它指向的目标文件的绝对路径。就这么简单。在 Windows 上我们该怎么做？</p><p>在 Windows 中，符号链接是使用 <a href=https://docs.microsoft.com/en-us/windows/win32/fileio/reparse-points>Reparse Point</a> 机制实现的，其 <code>ReparseTag</code> <code>IO_REPARSE_TAG_SYMLINK</code> 值为 <code>0xA000000C</code>，<a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-fscc/8ac44452-328c-4d7b-a784-d72afd19bd9f#gt_4fed0b53-5fc8-4818-886f-93d87f3035e1>描述信息</a>如下：</p><blockquote><p>symbolic link: A symbolic link is a reparse point that points to another file system object. The object being pointed to is called the target. Symbolic links are transparent to users; the links appear as normal files or directories, and can be acted upon by the user or application in exactly the same manner. Symbolic links can be created using the FSCTL_SET_REPARSE_POINT request as specified in [MS-FSCC] section 2.3.61. They can be deleted using the FSCTL_DELETE_REPARSE_POINT request as specified in [MS-FSCC] section 2.3.5. Implementing symbolic links is optional for a file system.</p></blockquote><p>那么我们可以通过解析重解析点获得符号链接的真实路径。但我们通常不这么做，因此 Windows 有个 API 可以帮助我们做到这件事。<a href=https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-getfinalpathnamebyhandlew>GetFinalPathNameByHandleW</a> 能够帮助我们获得已打开的文件的最终路径，也就是真实路径，而我们在打开符号链接时，<code>IoCreateFile</code> 最终将打开符号链接的目标文件，因此，通过 <code>GetFinalPathNameByHandleW</code> 我们就可以获得其真实路径。话不多说代码如下：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#ff636f>class</span> <span style=color:#58a1dd>_Ty</span><span style=color:#ff636f>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>[[nodiscard]]</span> <span style=color:#58a1dd>_Ty</span> <span style=color:#58a1dd>_Unaligned_load</span>(<span style=color:#ff636f>const</span> <span style=color:#ff636f>void</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>_Ptr</span>) { <span style=color:#828b96;font-style:italic>// load a _Ty from _Ptr
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#ff636f>static_assert</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>is_trivial_v</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>_Ty</span><span style=color:#ff636f>&gt;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6be9d>&#34;Unaligned loads require trivial types&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>_Ty</span> <span style=color:#58a1dd>_Tmp</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>memcpy</span>(<span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>_Tmp</span>, <span style=color:#58a1dd>_Ptr</span>, <span style=color:#ff636f>sizeof</span>(<span style=color:#58a1dd>_Tmp</span>));
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>_Tmp</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>[[nodiscard]]</span> <span style=color:#ff636f>inline</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>_Is_drive_prefix</span>(<span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#ff636f>const</span> <span style=color:#58a1dd>_First</span>) {
</span></span><span style=display:flex><span>  <span style=color:#828b96;font-style:italic>// test if _First points to a prefix of the form X:
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#828b96;font-style:italic>// pre: _First points to at least 2 wchar_t instances
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#828b96;font-style:italic>// pre: Little endian
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>_Value</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>_Unaligned_load</span><span style=color:#ff636f>&lt;</span><span style=color:#ff636f>unsigned</span> <span style=color:#ff636f>int</span><span style=color:#ff636f>&gt;</span>(<span style=color:#58a1dd>_First</span>);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>_Value</span> <span style=color:#ff636f>&amp;=</span>
</span></span><span style=display:flex><span>      <span style=color:#a6be9d>0xFFFF&#39;FFDFu</span>; <span style=color:#828b96;font-style:italic>// transform lowercase drive letters into uppercase ones
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#58a1dd>_Value</span> <span style=color:#ff636f>-=</span>
</span></span><span style=display:flex><span>      (<span style=color:#ff636f>static_cast</span><span style=color:#ff636f>&lt;</span><span style=color:#ff636f>unsigned</span> <span style=color:#ff636f>int</span><span style=color:#ff636f>&gt;</span>(<span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;:&#39;</span>) <span style=color:#ff636f>&lt;&lt;</span> (<span style=color:#ff636f>sizeof</span>(<span style=color:#ff636f>wchar_t</span>) <span style=color:#ff636f>*</span> <span style=color:#58a1dd>CHAR_BIT</span>)) <span style=color:#ff636f>|</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#39;A&#39;</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>_Value</span> <span style=color:#ff636f>&lt;</span> <span style=color:#a6be9d>26</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>inline</span> <span style=color:#ff636f>bool</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>_Is_drive_prefix_with_slash_slash_question</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring_view</span> <span style=color:#58a1dd>text</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>text</span>.<span style=color:#58a1dd>size</span>() <span style=color:#ff636f>&gt;</span> <span style=color:#a6be9d>6</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>StartsWith</span>(<span style=color:#58a1dd>text</span>, <span style=color:#58a1dd>LR</span><span style=color:#a6be9d>&#34;(</span><span style=color:#a6be9d>\\</span><span style=color:#a6be9d>?\)&#34;</span>) <span style=color:#ff636f>&amp;&amp;</span>
</span></span><span style=display:flex><span>         <span style=color:#58a1dd>_Is_drive_prefix</span>(<span style=color:#58a1dd>text</span>.<span style=color:#58a1dd>data</span>() <span style=color:#ff636f>+</span> <span style=color:#a6be9d>4</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>optional</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>RealPathByHandle</span>(<span style=color:#58a1dd>HANDLE</span> <span style=color:#58a1dd>FileHandle</span>,
</span></span><span style=display:flex><span>                                             <span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>error_code</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>ec</span>) {
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring</span> <span style=color:#58a1dd>buffer</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>buffer</span>.<span style=color:#58a1dd>resize</span>(<span style=color:#a6be9d>260</span>); <span style=color:#828b96;font-style:italic>// opt
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#58a1dd>DWORD</span> <span style=color:#58a1dd>kind</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>VOLUME_NAME_DOS</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>for</span> (;;) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>const</span> <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>blen</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>buffer</span>.<span style=color:#58a1dd>size</span>();
</span></span><span style=display:flex><span>    <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>len</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>GetFinalPathNameByHandleW</span>(<span style=color:#58a1dd>FileHandle</span>, <span style=color:#58a1dd>buffer</span>.<span style=color:#58a1dd>data</span>(),
</span></span><span style=display:flex><span>                                         <span style=color:#ff636f>static_cast</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>DWORD</span><span style=color:#ff636f>&gt;</span>(<span style=color:#58a1dd>blen</span>), <span style=color:#58a1dd>kind</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>len</span> <span style=color:#ff636f>==</span> <span style=color:#a6be9d>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>e</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>GetLastError</span>();
</span></span><span style=display:flex><span>      <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>e</span> <span style=color:#ff636f>==</span> <span style=color:#58a1dd>ERROR_PATH_NOT_FOUND</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>kind</span> <span style=color:#ff636f>==</span> <span style=color:#58a1dd>VOLUME_NAME_DOS</span>) {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>kind</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>VOLUME_NAME_NT</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff636f>continue</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>ec</span>.<span style=color:#58a1dd>code</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>e</span>;
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>ec</span>.<span style=color:#58a1dd>message</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>resolve_system_error_message</span>(<span style=color:#58a1dd>ec</span>.<span style=color:#58a1dd>code</span>);
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>nullopt</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>buffer</span>.<span style=color:#58a1dd>resize</span>(<span style=color:#58a1dd>len</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>len</span> <span style=color:#ff636f>&lt;</span> <span style=color:#ff636f>static_cast</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>DWORD</span><span style=color:#ff636f>&gt;</span>(<span style=color:#58a1dd>blen</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#ff636f>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>kind</span> <span style=color:#ff636f>!=</span> <span style=color:#58a1dd>VOLUME_NAME_DOS</span>) {
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// result is in the NT namespace, so apply the DOS to NT namespace prefix
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring_view</span> <span style=color:#58a1dd>ntprefix</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>LR</span><span style=color:#a6be9d>&#34;(</span><span style=color:#a6be9d>\\</span><span style=color:#a6be9d>?\GLOBALROOT)&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>StringCat</span>(<span style=color:#58a1dd>ntprefix</span>, <span style=color:#58a1dd>buffer</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#828b96;font-style:italic>// &#39;\\?\C:\Path&#39;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>_Is_drive_prefix_with_slash_slash_question</span>(<span style=color:#58a1dd>buffer</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>make_optional</span>(<span style=color:#58a1dd>buffer</span>.<span style=color:#58a1dd>substr</span>(<span style=color:#a6be9d>4</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>StartsWithIgnoreCase</span>(<span style=color:#58a1dd>buffer</span>, <span style=color:#58a1dd>LR</span><span style=color:#a6be9d>&#34;(</span><span style=color:#a6be9d>\\</span><span style=color:#a6be9d>?\UNC\)&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring_view</span> <span style=color:#58a1dd>sv</span>(<span style=color:#58a1dd>buffer</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>make_optional</span>(<span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>StringCat</span>(<span style=color:#58a1dd>LR</span><span style=color:#a6be9d>&#34;(</span><span style=color:#a6be9d>\\</span><span style=color:#a6be9d>)&#34;</span>, <span style=color:#58a1dd>sv</span>.<span style=color:#58a1dd>substr</span>(<span style=color:#a6be9d>6</span>)));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>make_optional</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>move</span>(<span style=color:#58a1dd>buffer</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>optional</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>RealPath</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring_view</span> <span style=color:#58a1dd>src</span>,
</span></span><span style=display:flex><span>                                     <span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>error_code</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>ec</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>FileHandle</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>CreateFileW</span>(
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>src</span>.<span style=color:#58a1dd>data</span>(), <span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>FILE_SHARE_READ</span> <span style=color:#ff636f>|</span> <span style=color:#58a1dd>FILE_SHARE_WRITE</span> <span style=color:#ff636f>|</span> <span style=color:#58a1dd>FILE_SHARE_DELETE</span>,
</span></span><span style=display:flex><span>      <span style=color:#ff636f>nullptr</span>, <span style=color:#58a1dd>OPEN_EXISTING</span>, <span style=color:#58a1dd>FILE_FLAG_BACKUP_SEMANTICS</span>, <span style=color:#ff636f>nullptr</span>);
</span></span><span style=display:flex><span>  <span style=color:#828b96;font-style:italic>// FILE_FLAG_BACKUP_SEMANTICS open directory require
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>FileHandle</span> <span style=color:#ff636f>==</span> <span style=color:#58a1dd>INVALID_HANDLE_VALUE</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>ec</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>make_system_error_code</span>();
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>nullopt</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>closer</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>finally</span>([<span style=color:#ff636f>&amp;</span>] { <span style=color:#58a1dd>CloseHandle</span>(<span style=color:#58a1dd>FileHandle</span>); });
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>RealPathByHandle</span>(<span style=color:#58a1dd>FileHandle</span>, <span style=color:#58a1dd>ec</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里需要注意 <code>FILE_FLAG_BACKUP_SEMANTICS</code> 用于打开目录，这个时候我们不需要读写，因此第二个参数 <code>dwDesiredAccess</code> 值为 <code>0</code>。如果使用了 <code>FILE_FLAG_OPEN_REPARSE_POINT</code> 标志打开符号链接，则不会打开目标文件。</p><p>但我们使用这个函数去查询 <code>AppExecutionAlias</code> 的真实路径时，由于没有设置 <code>FILE_FLAG_OPEN_REPARSE_POINT</code> 因此无法打开文件。</p><h2 id=通过重解析点获得真实路径>通过重解析点获得真实路径</h2><p>我们如果去解析重解析点，然后经过特殊处理，这样也是可以获得文件的真实路径。解析重解析点主要的难题在于获得一些不透明的结构，包含 <code>AppExecutionAlias</code> 的 <code>REPARSE_DATA_BUFFER</code> 结构如下：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>typedef</span> <span style=color:#ff636f>struct</span> <span style=color:#58a1dd>_REPARSE_DATA_BUFFER</span> {
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>ULONG</span> <span style=color:#58a1dd>ReparseTag</span>;         <span style=color:#828b96;font-style:italic>// Reparse tag type
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#58a1dd>USHORT</span> <span style=color:#58a1dd>ReparseDataLength</span>; <span style=color:#828b96;font-style:italic>// Length of the reparse data
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#58a1dd>USHORT</span> <span style=color:#58a1dd>Reserved</span>;          <span style=color:#828b96;font-style:italic>// Used internally by NTFS to store remaining length
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#ff636f>union</span> {
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// Structure for IO_REPARSE_TAG_SYMLINK
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>// Handled by nt!IoCompleteRequest
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#ff636f>struct</span> {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>USHORT</span> <span style=color:#58a1dd>SubstituteNameOffset</span>;
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>USHORT</span> <span style=color:#58a1dd>SubstituteNameLength</span>;
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>USHORT</span> <span style=color:#58a1dd>PrintNameOffset</span>;
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>USHORT</span> <span style=color:#58a1dd>PrintNameLength</span>;
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>ULONG</span> <span style=color:#58a1dd>Flags</span>;
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>WCHAR</span> <span style=color:#58a1dd>PathBuffer</span>[<span style=color:#a6be9d>1</span>];
</span></span><span style=display:flex><span>      <span style=color:#828b96;font-style:italic>// Example of distinction between substitute and print names:
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#828b96;font-style:italic>// mklink /d ldrive c:\
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>      // SubstituteName: c:\\??\
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>      // PrintName: c:\
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>    } SymbolicLinkReparseBuffer;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// Structure for IO_REPARSE_TAG_MOUNT_POINT
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>// Handled by nt!IoCompleteRequest
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#ff636f>struct</span> {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>USHORT</span> <span style=color:#58a1dd>SubstituteNameOffset</span>;
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>USHORT</span> <span style=color:#58a1dd>SubstituteNameLength</span>;
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>USHORT</span> <span style=color:#58a1dd>PrintNameOffset</span>;
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>USHORT</span> <span style=color:#58a1dd>PrintNameLength</span>;
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>WCHAR</span> <span style=color:#58a1dd>PathBuffer</span>[<span style=color:#a6be9d>1</span>];
</span></span><span style=display:flex><span>    } <span style=color:#58a1dd>MountPointReparseBuffer</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// Structure for IO_REPARSE_TAG_WIM
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>// Handled by wimmount!FPOpenReparseTarget-&gt;wimserv.dll
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>// (wimsrv!ImageExtract)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#ff636f>struct</span> {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>GUID</span> <span style=color:#58a1dd>ImageGuid</span>;           <span style=color:#828b96;font-style:italic>// GUID of the mounted VIM image
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#58a1dd>BYTE</span> <span style=color:#58a1dd>ImagePathHash</span>[<span style=color:#a6be9d>0x14</span>]; <span style=color:#828b96;font-style:italic>// Hash of the path to the file within the image
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    } <span style=color:#58a1dd>WimImageReparseBuffer</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// Structure for IO_REPARSE_TAG_WOF
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>// Handled by FSCTL_GET_EXTERNAL_BACKING, FSCTL_SET_EXTERNAL_BACKING in NTFS
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>// (Windows 10+)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#ff636f>struct</span> {
</span></span><span style=display:flex><span>      <span style=color:#828b96;font-style:italic>//-- WOF_EXTERNAL_INFO --------------------
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#58a1dd>ULONG</span> <span style=color:#58a1dd>Wof_Version</span>;  <span style=color:#828b96;font-style:italic>// Should be 1 (WOF_CURRENT_VERSION)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#58a1dd>ULONG</span> <span style=color:#58a1dd>Wof_Provider</span>; <span style=color:#828b96;font-style:italic>// Should be 2 (WOF_PROVIDER_FILE)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span>      <span style=color:#828b96;font-style:italic>//-- FILE_PROVIDER_EXTERNAL_INFO_V1 --------------------
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#58a1dd>ULONG</span> <span style=color:#58a1dd>FileInfo_Version</span>; <span style=color:#828b96;font-style:italic>// Should be 1 (FILE_PROVIDER_CURRENT_VERSION)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#58a1dd>ULONG</span>
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>FileInfo_Algorithm</span>; <span style=color:#828b96;font-style:italic>// Usually 0 (FILE_PROVIDER_COMPRESSION_XPRESS4K)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    } <span style=color:#58a1dd>WofReparseBuffer</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// Structure for IO_REPARSE_TAG_APPEXECLINK
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#ff636f>struct</span> {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>ULONG</span> <span style=color:#58a1dd>StringCount</span>;   <span style=color:#828b96;font-style:italic>// Number of the strings in the StringList, separated
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>                           <span style=color:#828b96;font-style:italic>// by &#39;\0&#39;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#58a1dd>WCHAR</span> <span style=color:#58a1dd>StringList</span>[<span style=color:#a6be9d>1</span>]; <span style=color:#828b96;font-style:italic>// Multistring (strings separated by &#39;\0&#39;, terminated
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>                           <span style=color:#828b96;font-style:italic>// by &#39;\0\0&#39;)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    } <span style=color:#58a1dd>AppExecLinkReparseBuffer</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// Structure for IO_REPARSE_TAG_WCI (0x80000018)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#ff636f>struct</span> {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>ULONG</span> <span style=color:#58a1dd>Version</span>; <span style=color:#828b96;font-style:italic>// Expected to be 1 by wcifs.sys
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#58a1dd>ULONG</span> <span style=color:#58a1dd>Reserved</span>;
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>GUID</span> <span style=color:#58a1dd>LookupGuid</span>;      <span style=color:#828b96;font-style:italic>// GUID used for lookup in wcifs!WcLookupLayer
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#58a1dd>USHORT</span> <span style=color:#58a1dd>WciNameLength</span>; <span style=color:#828b96;font-style:italic>// Length of the WCI subname, in bytes
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#58a1dd>WCHAR</span> <span style=color:#58a1dd>WciName</span>[<span style=color:#a6be9d>1</span>];     <span style=color:#828b96;font-style:italic>// The WCI subname (not zero terminated)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    } <span style=color:#58a1dd>WcifsReparseBuffer</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// Handled by cldflt.sys!HsmpRpReadBuffer
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#ff636f>struct</span> {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>USHORT</span> <span style=color:#58a1dd>Flags</span>;    <span style=color:#828b96;font-style:italic>// Flags (0x8000 = not compressed)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#58a1dd>USHORT</span> <span style=color:#58a1dd>Length</span>;   <span style=color:#828b96;font-style:italic>// Length of the data (uncompressed)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#58a1dd>BYTE</span> <span style=color:#58a1dd>RawData</span>[<span style=color:#a6be9d>1</span>]; <span style=color:#828b96;font-style:italic>// To be RtlDecompressBuffer-ed
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    } <span style=color:#58a1dd>HsmReparseBufferRaw</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// Dummy structure
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#ff636f>struct</span> {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>UCHAR</span> <span style=color:#58a1dd>DataBuffer</span>[<span style=color:#a6be9d>1</span>];
</span></span><span style=display:flex><span>    } <span style=color:#58a1dd>GenericReparseBuffer</span>;
</span></span><span style=display:flex><span>  } <span style=color:#58a1dd>DUMMYUNIONNAME</span>;
</span></span><span style=display:flex><span>} <span style=color:#58a1dd>REPARSE_DATA_BUFFER</span>, <span style=color:#ff636f>*</span><span style=color:#58a1dd>PREPARSE_DATA_BUFFER</span>;
</span></span></code></pre></div><p>知道这个结构，我们就能对其进行解析了：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#828b96;font-style:italic>// https://github.com/fcharlie/bela/blob/728a4b726f303e7c861823232991de7fdea4d992/src/belawin/reparsepoint.cc#L32
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>bool</span> <span style=color:#58a1dd>FileReparser</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>FileDeviceLookup</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring_view</span> <span style=color:#58a1dd>file</span>,
</span></span><span style=display:flex><span>                                    <span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>error_code</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>ec</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>buffer</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>reinterpret_cast</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>REPARSE_DATA_BUFFER</span> <span style=color:#ff636f>*&gt;</span>(
</span></span><span style=display:flex><span>          <span style=color:#58a1dd>HeapAlloc</span>(<span style=color:#58a1dd>GetProcessHeap</span>(), <span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>MAXIMUM_REPARSE_DATA_BUFFER_SIZE</span>));
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>buffer</span> <span style=color:#ff636f>==</span> <span style=color:#ff636f>nullptr</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>ec</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>make_system_error_code</span>();
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>FileHandle</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>CreateFileW</span>(
</span></span><span style=display:flex><span>          <span style=color:#58a1dd>file</span>.<span style=color:#58a1dd>data</span>(), <span style=color:#a6be9d>0</span>,
</span></span><span style=display:flex><span>          <span style=color:#58a1dd>FILE_SHARE_READ</span> <span style=color:#ff636f>|</span> <span style=color:#58a1dd>FILE_SHARE_WRITE</span> <span style=color:#ff636f>|</span> <span style=color:#58a1dd>FILE_SHARE_DELETE</span>, <span style=color:#ff636f>nullptr</span>,
</span></span><span style=display:flex><span>          <span style=color:#58a1dd>OPEN_EXISTING</span>,
</span></span><span style=display:flex><span>          <span style=color:#58a1dd>FILE_FLAG_BACKUP_SEMANTICS</span> <span style=color:#ff636f>|</span> <span style=color:#58a1dd>FILE_FLAG_OPEN_REPARSE_POINT</span>, <span style=color:#ff636f>nullptr</span>);
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>FileHandle</span> <span style=color:#ff636f>==</span> <span style=color:#58a1dd>INVALID_HANDLE_VALUE</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>ec</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>make_system_error_code</span>();
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>DeviceIoControl</span>(<span style=color:#58a1dd>FileHandle</span>, <span style=color:#58a1dd>FSCTL_GET_REPARSE_POINT</span>, <span style=color:#ff636f>nullptr</span>, <span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>buffer</span>,
</span></span><span style=display:flex><span>                      <span style=color:#58a1dd>MAXIMUM_REPARSE_DATA_BUFFER_SIZE</span>, <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>len</span>,
</span></span><span style=display:flex><span>                      <span style=color:#ff636f>nullptr</span>) <span style=color:#ff636f>!=</span> <span style=color:#58a1dd>TRUE</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>ec</span>.<span style=color:#58a1dd>code</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>GetLastError</span>(); <span style=color:#58a1dd>ec</span>.<span style=color:#58a1dd>code</span> <span style=color:#ff636f>!=</span> <span style=color:#58a1dd>ERROR_NOT_A_REPARSE_POINT</span>) {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>ec</span>.<span style=color:#58a1dd>message</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>resolve_system_error_message</span>(<span style=color:#58a1dd>ec</span>.<span style=color:#58a1dd>code</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>true</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>inline</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>DecodeAppLink</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>REPARSE_DATA_BUFFER</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>buffer</span>,
</span></span><span style=display:flex><span>                          <span style=color:#58a1dd>AppExecTarget</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>target</span>) {
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>LPWSTR</span> <span style=color:#58a1dd>szString</span> <span style=color:#ff636f>=</span> (<span style=color:#58a1dd>LPWSTR</span>)<span style=color:#58a1dd>buffer</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>AppExecLinkReparseBuffer</span>.<span style=color:#58a1dd>StringList</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>vector</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring_view</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>strv</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>for</span> (<span style=color:#58a1dd>ULONG</span> <span style=color:#58a1dd>i</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>; <span style=color:#58a1dd>i</span> <span style=color:#ff636f>&lt;</span> <span style=color:#58a1dd>buffer</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>AppExecLinkReparseBuffer</span>.<span style=color:#58a1dd>StringCount</span>; <span style=color:#58a1dd>i</span><span style=color:#ff636f>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>len</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>wcslen</span>(<span style=color:#58a1dd>szString</span>);
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>strv</span>.<span style=color:#58a1dd>emplace_back</span>(<span style=color:#58a1dd>szString</span>, <span style=color:#58a1dd>len</span>);
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>szString</span> <span style=color:#ff636f>+=</span> <span style=color:#58a1dd>len</span> <span style=color:#ff636f>+</span> <span style=color:#a6be9d>1</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>strv</span>.<span style=color:#58a1dd>empty</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>target</span>.<span style=color:#58a1dd>pkid</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>strv</span>[<span style=color:#a6be9d>0</span>];
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>strv</span>.<span style=color:#58a1dd>size</span>() <span style=color:#ff636f>&gt;</span> <span style=color:#a6be9d>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>target</span>.<span style=color:#58a1dd>appuserid</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>strv</span>[<span style=color:#a6be9d>1</span>];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>strv</span>.<span style=color:#58a1dd>size</span>() <span style=color:#ff636f>&gt;</span> <span style=color:#a6be9d>2</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>target</span>.<span style=color:#58a1dd>target</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>strv</span>[<span style=color:#a6be9d>2</span>];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>true</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// https://github.com/fcharlie/bela/blob/728a4b726f303e7c861823232991de7fdea4d992/src/belawin/reparsepoint.cc#L278
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>optional</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>RealPathEx</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring_view</span> <span style=color:#58a1dd>src</span>,
</span></span><span style=display:flex><span>                                       <span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>error_code</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>ec</span>) {
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>FileReparser</span> <span style=color:#58a1dd>reparser</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#ff636f>!</span><span style=color:#58a1dd>reparser</span>.<span style=color:#58a1dd>FileDeviceLookup</span>(<span style=color:#58a1dd>src</span>, <span style=color:#58a1dd>ec</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>ec</span>.<span style=color:#58a1dd>code</span> <span style=color:#ff636f>==</span> <span style=color:#58a1dd>ERROR_NOT_A_REPARSE_POINT</span>) {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>ec</span>.<span style=color:#58a1dd>code</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>make_optional</span>(<span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>PathAbsolute</span>(<span style=color:#58a1dd>src</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>nullopt</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>switch</span> (<span style=color:#58a1dd>reparser</span>.<span style=color:#58a1dd>buffer</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>ReparseTag</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>case</span> <span style=color:#58a1dd>IO_REPARSE_TAG_APPEXECLINK</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>AppExecTarget</span> <span style=color:#58a1dd>target</span>; <span style=color:#58a1dd>DecodeAppLink</span>(<span style=color:#58a1dd>reparser</span>.<span style=color:#58a1dd>buffer</span>, <span style=color:#58a1dd>target</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>make_optional</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>move</span>(<span style=color:#58a1dd>target</span>.<span style=color:#58a1dd>target</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>ec</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>make_error_code</span>(<span style=color:#a6be9d>1</span>, <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#34;BAD: unable decode AppLinkExec&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>nullopt</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>case</span> <span style=color:#58a1dd>IO_REPARSE_TAG_SYMLINK</span>:
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>CloseHandle</span>(<span style=color:#58a1dd>reparser</span>.<span style=color:#58a1dd>FileHandle</span>);
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>reparser</span>.<span style=color:#58a1dd>FileHandle</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>INVALID_HANDLE_VALUE</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#ff636f>auto</span> <span style=color:#58a1dd>target</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>RealPath</span>(<span style=color:#58a1dd>src</span>, <span style=color:#58a1dd>ec</span>); <span style=color:#58a1dd>target</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>make_optional</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>move</span>(<span style=color:#ff636f>*</span><span style=color:#58a1dd>target</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>nullopt</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>case</span> <span style=color:#58a1dd>IO_REPARSE_TAG_GLOBAL_REPARSE</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring</span> <span style=color:#58a1dd>target</span>; <span style=color:#58a1dd>DecodeSymbolicLink</span>(<span style=color:#58a1dd>reparser</span>.<span style=color:#58a1dd>buffer</span>, <span style=color:#58a1dd>target</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>make_optional</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>move</span>(<span style=color:#58a1dd>target</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>ec</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>make_error_code</span>(<span style=color:#a6be9d>1</span>, <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#34;BAD: unable decode Global SymbolicLink&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>nullopt</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>default</span><span style=color:#ff636f>:</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>break</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>make_optional</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring</span><span style=color:#ff636f>&gt;</span>(<span style=color:#58a1dd>src</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>对于 <code>AppExecutionAlias</code>，我们可以先使用 <code>Target</code> 作为其真实路径，然后再去解析 PE 文件的子系统，这样就能避免 PowerShell 的那个问题发生。解析符号链接时，为了避免需要繁琐的解析目标文件，我们重新使用 <code>bela::RealPath</code> 获得真实路径。</p><h2 id=最后>最后</h2><p>在 Windows 中，比如 Git for VFS，Azure，OneDrive，Container 等服务或者功能也都使用了特定的重解析点。有兴趣可以去了解一下。</p><hr width=100% id=EOF><p style=color:#777>Last modified on 2020-04-24</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/2020/2020-06-30-nonsense-file-compression/>Next<br>胡说八道文件压缩
</a><a class=older-posts href=/posts/2020/2020-01-10-talking-about-eating-pork/>Previous<br>谈吃肉</a></nav><div class=post-comment-wrapper></div></div></div></div></div><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://forcemz.net/><div class=nav-title>江二十三的思考</div><div class=nav-subtitle>Themed by Diary.</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>归档
</a><a class="a-block nav-link-item false" href=/categories>分类
</a><a class="a-block nav-link-item false" href=/tags>标签
</a><a class="a-block nav-link-item false" href=/about>关于
</a><a class="a-block nav-link-item false" href=/index.xml>RSS Feed</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><div id=extraContainer class=extra-container><div class=toc-wrapper><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><li><a href=#%e5%89%8d%e8%a8%80 class=nav-前言>前言</a></li><ul><li><a href=#%e6%96%87%e4%bb%b6%e7%9a%84%e7%9c%9f%e5%ae%9e%e8%b7%af%e5%be%84 class=nav-文件的真实路径>文件的真实路径</a></li><li><a href=#%e9%80%9a%e8%bf%87%e9%87%8d%e8%a7%a3%e6%9e%90%e7%82%b9%e8%8e%b7%e5%be%97%e7%9c%9f%e5%ae%9e%e8%b7%af%e5%be%84 class=nav-通过重解析点获得真实路径>通过重解析点获得真实路径</a></li><li><a href=#%e6%9c%80%e5%90%8e class=nav-最后>最后</a></li></ul></div></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up
</i></a><a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><script src=/js/journal.js></script></body></html>