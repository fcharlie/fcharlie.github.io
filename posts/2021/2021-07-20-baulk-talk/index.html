<!doctype html><html lang=en><head><title>Baulk - 一次有趣的尝试</title>
<meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=5" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><script src=/js/toc.js></script><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Material+Icons"></head><body><div id=app><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>归档
</a><a class="a-block drawer-menu-item false" href=/categories>分类
</a><a class="a-block drawer-menu-item false" href=/tags>标签
</a><a class="a-block drawer-menu-item false" href=/about>关于
</a><a class="a-block drawer-menu-item false" href=/index.xml>RSS Feed</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e5%89%8d%e8%a8%80 class=nav-前言>前言</a></li><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e4%bc%9a%e6%9c%89-baulk class=nav-为什么会有-baulk>为什么会有 Baulk</a></li><li><a href=#baulk-%e6%9c%89%e5%93%aa%e4%ba%9b%e7%89%b9%e8%89%b2 class=nav-baulk-有哪些特色>Baulk 有哪些特色</a></li><ul><li><a href=#baulk-%e6%98%af%e4%b8%80%e4%b8%aa%e7%bb%bf%e8%89%b2%e7%9a%84%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8 class=nav-baulk-是一个绿色的包管理器>Baulk 是一个绿色的包管理器</a></li></ul><li><a href=#baulk-%e7%9a%84%e7%8e%af%e5%a2%83%e9%9a%94%e7%a6%bb%e7%89%b9%e6%80%a7 class=nav-baulk-的环境隔离特性>Baulk 的环境隔离特性</a></li><li><a href=#baulk-%e7%9a%84%e5%85%b6%e4%bb%96%e5%8a%9f%e8%83%bd class=nav-baulk-的其他功能>Baulk 的其他功能</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu
</i></button>
<a id=navTitle class=navbar-brand href=https://forcemz.net/>Charlie's Rethinking
</a><button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://forcemz.net/><div class=single-column-header-title>Charlie's Rethinking</div><div class=single-column-header-subtitle>Themed by Diary.</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>Baulk - 一次有趣的尝试<div class=post-meta><time itemprop=datePublished>2021-07-20 20:00
</time><i class=material-icons>folder</i>
<a href=/categories/toolset>toolset</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h2 id=前言>前言</h2><p>作为一个程序员，你认为你做过的最让你自豪的东西是什么？作为了一个菜鸡程序员，很遗憾，我拿不出什么像样的作品，工作上也只是站在前人的肩膀上，做了一些微小的改动。如果硬要说一个作品是我最得意的，我会选择 Baulk，它是一个极简的 Windows 包管理器，开发这个工具花费了我大量的业余时间，我很多有意思的构想也在开发 baulk 的过程中付诸实现了。Baulk <code>[bɔːk]</code> 其含义是<code>错误；失败；障碍（等于balk）</code> 或是 <code>阻止；错过；推诿（等于balk）</code>；对于绝大多数人来说，2020 年有一个坠落的魔幻开局，到了今年，新冠疫情的阴影任然笼罩全球，Baulk 诞生于 2020 年 3 月 9 日，那个时候我确实是挫败的吧。Baulk 还可以翻译成<code>梁木</code>，阴云将逐渐消散，baulk 也可以成为 <code>梁木</code>。</p><p>我认为 Baulk 是个有趣的工具，在这篇文章中，我将说一说它为什么会有趣。</p><h2 id=为什么会有-baulk>为什么会有 Baulk</h2><p>为什么会有 Baulk，我想到了一个词<strong>文人相轻</strong>，总觉得自己能够写出更好的软件，他人写的并不能满足我的需求，于是乎，也就有了 Baulk。</p><p>《典论·论文》- 曹丕： <code>文人相轻,自古而然.傅毅之于班固,伯仲之间耳.而固小之,与弟超书曰：“武仲以能属文，为兰台令史,下笔不能自休.”夫人善于自见.而文非一体,鲜能备善,是以各以所长,相轻所短.里语曰：“家有弊帚,享之千金.”斯不自见之患也。</code></p><p>在开发 Baulk 很长一段时间，我使用 PowerShell 开发了一个简单的包管理软件 devi，这个软件最初用于 Clang on Windows 的构建工具的安装，升级。毕竟重复得一次次手动下载安装一些软件总显得有些愚蠢，就如同我们重复说同样的话会被别人觉得怪异。</p><p>使用 PowerShell 开发的 devi 缺点也很明显，慢，尽管我是一个 PowerShell 粉丝，但事实我也需要说出来，PowerShell 的加载速度慢，毕竟它需要加载 PowerShell 解析引擎，如果还加载一些启动配置文件，那个速度就很感人了。</p><p>2020 年上半年，我终于开始不再忍受基于 PowerShell 的 devi，于是就开始使用 C++17（后来升级为 C++20） 开发新的包管理器 baulk，在 Windows 上有 scoop、chocolatey 这样优秀的开源包管理器，但它们都是基于 PowerShell（C#） 开发，然后在环境变量和安装机制上也与 Baulk 有一些分歧。这些不同之处也是 baulk 存在的原因。</p><h2 id=baulk-有哪些特色>Baulk 有哪些特色</h2><p>在 baulk 的 ReadMe 页面，介绍了 baulk 的一些特色，但很繁杂，并不是很容易了解全，这里再次简单的介绍一下。</p><h3 id=baulk-是一个绿色的包管理器>Baulk 是一个绿色的包管理器</h3><p>在 baulk 的设计哲学中，便携，绿色是其管理软件的宗旨，这衍生出来一些特性，baulk 在安装软件的过程中所执行的动作只有：</p><ol><li>解压压缩包</li><li>移动到安装目录</li><li>创建命令的符号链接或者启动器</li></ol><p>为了实现解压各种格式的安装包，baulk 将 Golang 的 <a href=https://github.com/golang/go/tree/master/src/archive/zip>archive/zip</a> 和 <a href=https://github.com/golang/go/tree/master/src/archive/zip>archive/tar</a> 使用 C++20 重新实现，提供了 <code>.zip</code>、<code>tar.*</code> 等格式的解压能力。其中 zip 解压缩相比于 Minizip 新增支持 deflate64 解压缩能力，与 7z 的 zip 解压缩相比，支持 zstd，可以说 baulk 的解压缩能力还是不错的，另外，baulk 集成了 google 的 <a href=https://github.com/google/compact_enc_det>Compact Encoding Detection(CED for short)</a> 支持文本编码的自动识别，而一些旧的 zip 文件名并非使用 UTF-8，导致在不同的代码也共享具有中文或者其他多字节编码的文件名的 zip 文件查看或者解压缩乱码，这个问题在 baulk 中被基本解决。</p><p>baulk 创新的使用了 Linux/macOS 的安装-软链接技术，这样能够合并 PATH 环境变量的条目数，降低操作系统在搜索环境变量的次数，对的你没看错，操作系统在查找 PATH 中的命令时需要一个目录去找，如果环境变量 PATH 组成的目录太多，会导致搜索次数太多，另外还有一个非常严重的问题，PATH 条目过多还存在 环境变量冲突的影响。baulk 的软链机制就很好的解决了这些问题。有些程序依赖自身目录下的动态链接库，并没有正确处理 GetModuleFilename，所以我们还增加了启动器的机制，当用户安装了 Visual Studio (c++ compiler exists)，我们会生成极简的启动源码，编译成启动器，如果没有则会使用 baulk-lnk.exe 代理，baulk-lnk.exe 需要分析安装信息，所以要慢一点点，只有一点点，不会太多。</p><h2 id=baulk-的环境隔离特性>Baulk 的环境隔离特性</h2><p>baulk 作为一个绿色的包管理器，一个很强的特性是环境隔离机制，为了支持并行安装同类软件的多个版本，我在 baulk 中引入了虚拟环境隔离机制，对于像 JDK/Golang/DMD/node.js 这样的软件，用户需要安装多个版本并且相互不影响，这个时候 baulk 就派上大用场了，baulk 也不需要像 RVM(ruby) 那样麻烦就能做到提供一套通用解决方案：</p><p>下面以 zulu（JDK 的著名发行版）为例，在这里我们支持的 venv 能够指定 category，这是一个大的分类，比如所有的 JDK 发行版的分类就应该是 java，而 <code>path</code> 则告知 baulk-exec 在加载虚拟环境时需要追加的 PATH 环境变量，而 env 则是除了 path 之外其他追加的环境变量，这些变量都支持推导，baulk 内置一些变量可以帮助开发者更好的展开环境变量。</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>&#34;description&#34;</span>: <span style=color:#a6be9d>&#34;Zulu is certified build of OpenJDK&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>&#34;version&#34;</span>: <span style=color:#a6be9d>&#34;16.0.2&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>&#34;homepage&#34;</span>: <span style=color:#a6be9d>&#34;https://www.azul.com/&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>&#34;url64&#34;</span>: <span style=color:#a6be9d>&#34;https://cdn.azul.com/zulu/bin/zulu16.32.15-ca-jdk16.0.2-win_x64.zip&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>&#34;url64.hash&#34;</span>: <span style=color:#a6be9d>&#34;SHA256:2b9ad008596c535c0b4da6ddabe56b35af3198cf00a933b1e60e074a30f31047&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>&#34;urlarm64&#34;</span>: <span style=color:#a6be9d>&#34;https://cdn.azul.com/zulu/bin/zulu16.30.17-ca-jdk16.0.1-win_aarch64.zip&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>&#34;urlarm64.hash&#34;</span>: <span style=color:#a6be9d>&#34;SHA256:5263cfc5f9526a5cb9520111d5abb506c6cad18bd1d1ea165d0f218cfd1318c3&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>&#34;extension&#34;</span>: <span style=color:#a6be9d>&#34;zip&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>&#34;venv&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>&#34;category&#34;</span>: <span style=color:#a6be9d>&#34;java&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>&#34;path&#34;</span>: <span style=color:#a6be9d>&#34;${BAULK_PKGROOT}\\bin&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>&#34;env&#34;</span>: [
</span></span><span style=display:flex><span>            <span style=color:#a6be9d>&#34;JAVA_HOME=${BAULK_PKGROOT}&#34;</span>
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>当然，baulk 还支持 <code>include</code>、<code>lib</code> 这类特殊的环境变量，这些单独抽出来是为了方便追加。另外 baulk 还支持 <code>dependencies</code> 机制，比如 kotlin-native 就依赖 zulu。</p><p>baulk 虚拟环境的精髓在 baulk-exec 中得以实现，其命令行如下：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>baulk-exec - Baulk extend executor
</span></span><span style=display:flex><span>Usage: baulk-exec [option] &lt;command&gt; [&lt;args&gt;] ...
</span></span><span style=display:flex><span>  -h|--help            Show usage text and quit
</span></span><span style=display:flex><span>  -v|--version         Show version number and quit
</span></span><span style=display:flex><span>  -V|--verbose         Make the operation more talkative
</span></span><span style=display:flex><span>  -C|--cleanup         Create clean environment variables to avoid interference
</span></span><span style=display:flex><span>  -W|--cwd             Set the command startup directory
</span></span><span style=display:flex><span>  -A|--arch            Select a specific arch, use native architecture by default
</span></span><span style=display:flex><span>  -E|--venv            Choose to load a specific package virtual environment
</span></span><span style=display:flex><span>  --vs                 Load Visual Studio related environment variables
</span></span><span style=display:flex><span>  --vs-preview         Load Visual Studio (Preview) related environment variables
</span></span><span style=display:flex><span>  --clang              Add Visual Studio&#39;s built-in clang to the PATH environment variable
</span></span><span style=display:flex><span>  --time               Summarize command system resource usage
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Example:
</span></span><span style=display:flex><span>  baulk-exec -V --vs TUNNEL_DEBUG=1 pwsh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Built-in alias:
</span></span><span style=display:flex><span>  winsh          A fake shell. It may be pwsh or powershell and cmd.
</span></span><span style=display:flex><span>  pwsh           PowerShell Core
</span></span><span style=display:flex><span>  pwsh-preview   PowerShell Core Preview
</span></span></code></pre></div><p>对了，如果用户觉得环境变量乱糟糟的，可以使用 <code>-C/--cleanup</code> 机制避免外部混乱的环境变量带来干扰，为了方便 C++ 开发，baulk 支持初始化 Visual C++ 环境变量，<code>--clang</code> 则可以初始化 Visual Studio 内置的 clang，当然你还可以使用 <code>--time</code> 去分析执行某个命令所消耗的时间。</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span> &gt;$ baulk-exec --time baulk unzip .<span style=color:#a6be9d>\D</span>G520884_x64.zip
</span></span><span style=display:flex><span>x DiskGenius<span style=color:#a6be9d>\V</span>Preview.dll
</span></span><span style=display:flex><span>run <span style=color:#58a1dd>command</span> <span style=color:#a6be9d>&#39;baulk unzip .\DG520884_x64.zip&#39;</span> use time:
</span></span><span style=display:flex><span>Creation: 625.6us
</span></span><span style=display:flex><span>Kernel:   125ms
</span></span><span style=display:flex><span>User:     93.75ms
</span></span><span style=display:flex><span>Exit:     231.0306ms
</span></span><span style=display:flex><span>Wall:     231.9762ms
</span></span></code></pre></div><h2 id=baulk-的其他功能>Baulk 的其他功能</h2><p>baulk 还实现了许多其他的功能，限于篇幅长度也就不一一说了，有兴趣可以访问 [<a href=https://github.com/baulk/baulk/issues>baulk/ReadMe.zh-CN.md at master · baulk/baulk (github.com)</a>] 提出建议或者参与到项目的贡献当中。</p><hr width=100% id=EOF><p style=color:#777>Last modified on 2021-07-20</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/2022/2022-01-01-life-is-like-a-dream/>Next<br>若浮生若梦，为欢几何
</a><a class=older-posts href=/posts/2021/2021-03-12-report-workers-2021/>Previous<br>调查报告：你想待在这个城市吗？</a></nav><div class=post-comment-wrapper></div></div></div></div></div><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://forcemz.net/><div class=nav-title>Charlie's Rethinking</div><div class=nav-subtitle>Themed by Diary.</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>归档
</a><a class="a-block nav-link-item false" href=/categories>分类
</a><a class="a-block nav-link-item false" href=/tags>标签
</a><a class="a-block nav-link-item false" href=/about>关于
</a><a class="a-block nav-link-item false" href=/index.xml>RSS Feed</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><div id=extraContainer class=extra-container><div class=toc-wrapper><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e5%89%8d%e8%a8%80 class=nav-前言>前言</a></li><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e4%bc%9a%e6%9c%89-baulk class=nav-为什么会有-baulk>为什么会有 Baulk</a></li><li><a href=#baulk-%e6%9c%89%e5%93%aa%e4%ba%9b%e7%89%b9%e8%89%b2 class=nav-baulk-有哪些特色>Baulk 有哪些特色</a></li><ul><li><a href=#baulk-%e6%98%af%e4%b8%80%e4%b8%aa%e7%bb%bf%e8%89%b2%e7%9a%84%e5%8c%85%e7%ae%a1%e7%90%86%e5%99%a8 class=nav-baulk-是一个绿色的包管理器>Baulk 是一个绿色的包管理器</a></li></ul><li><a href=#baulk-%e7%9a%84%e7%8e%af%e5%a2%83%e9%9a%94%e7%a6%bb%e7%89%b9%e6%80%a7 class=nav-baulk-的环境隔离特性>Baulk 的环境隔离特性</a></li><li><a href=#baulk-%e7%9a%84%e5%85%b6%e4%bb%96%e5%8a%9f%e8%83%bd class=nav-baulk-的其他功能>Baulk 的其他功能</a></li></ul></div></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up
</i></a><a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><script src=/js/journal.js></script></body></html>