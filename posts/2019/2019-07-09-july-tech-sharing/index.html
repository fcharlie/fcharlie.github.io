<!doctype html><html lang=en><head><title>七月的技术分享</title>
<meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=5" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><script src=/js/toc.js></script><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Material+Icons"></head><body><div id=app><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>归档
</a><a class="a-block drawer-menu-item false" href=/categories>分类
</a><a class="a-block drawer-menu-item false" href=/tags>标签
</a><a class="a-block drawer-menu-item false" href=/about>关于
</a><a class="a-block drawer-menu-item false" href=/index.xml>RSS Feed</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e5%89%8d%e8%a8%80 class=nav-前言>前言</a></li><li><a href=#%e6%94%af%e6%8c%81%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e5%b1%95%e5%bc%80%e7%9a%84%e9%85%8d%e7%bd%ae%e8%a7%a3%e6%9e%90 class=nav-支持环境变量展开的配置解析>支持环境变量展开的配置解析</a></li><li><a href=#%e5%8f%af%e5%9b%9e%e6%bb%9a%e7%9a%84-shell-%e8%87%aa%e8%a7%a3%e5%8e%8b%e5%ae%89%e8%a3%85%e5%8c%85 class=nav-可回滚的-shell-自解压安装包>可回滚的 Shell 自解压安装包</a></li><li><a href=#%e6%9c%80%e5%90%8e class=nav-最后>最后</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu
</i></button>
<a id=navTitle class=navbar-brand href=https://forcemz.net/>Charlie's Rethinking
</a><button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://forcemz.net/><div class=single-column-header-title>Charlie's Rethinking</div><div class=single-column-header-subtitle>Themed by Diary.</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>七月的技术分享<div class=post-meta><time itemprop=datePublished>2019-07-09 10:00
</time><i class=material-icons>folder</i>
<a href=/categories/talk>talk</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h2 id=前言>前言</h2><p>写代码是一个不断积累的过程，将一些好的想法转变为解决实际问题的程序通常让程序员感到愉悦。而最近我也有两个还算好的想法，在本文中分享给大家。</p><h2 id=支持环境变量展开的配置解析>支持环境变量展开的配置解析</h2><p>在 Gitee 的基础服务组件中，像 Basalt (git ssh 服务器)，git-diamond (Gitee 内部的 git 协议服务器)，git-srv (Gitee 分布式 git 传输后端) 都支持这样形式的配置： <code>${APPDIR}/run/git-srv.pid</code> 。在运行过程中，<code>APPDIR</code> 被解释成相应组件的安装根目录，在配置文件中，解析到 <code>${APPDIR}/run/git-srv.pid</code> 后，使用推导函数，将其展开为 <code>/home/git/oscstudio/run/git-srv.pid</code>。这样一来，默认配置情况下，Gitee 的这些组件都支持安装到任意位置，而无需在编译时设置 <code>--prefix</code>。而像 nginx 这样的软件，在构建时，使用 <code>--prefix</code> 指定了安装目录后，如果不使用 <code>-p</code> 指定 <code>prefix</code>，是无法安装到任意位置的。</p><p>除此之外，环境变量展开还可以做很多事情，但环境变量展开是如何实现的？</p><p>在 Golang 的源码中，有一个 <a href=https://github.com/golang/go/blob/06ef108cec98b3dfc0fba3f49e733a18eb9badd5/src/os/env.go#L50><code>os.ExpandEnv</code></a> 函数可以使用环境变量替换输入的字符串中所有以格式 <code>${var}</code> 和 <code>$var</code> 的字符串 ，而这个函数实际上是 <code>os.Expand</code> 使用 <code>os.GetEnv</code> 的特例，因此，你完全可以封装自己的 <code>GetEnv</code>。在 <a href=https://gitee.com/oscstudio/gitenv/blob/master/envctx.go><code>oscstudio/gitenv</code></a> 中，我们就有一个 <code>Envcontext</code> 用于实现上述 <code>APPDIR</code> 这样的环境变量解析。</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff636f>package</span> <span style=color:#58a1dd>gitenv</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6be9d>&#34;errors&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6be9d>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6be9d>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6be9d>&#34;path/filepath&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// Envcontext is
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>type</span> <span style=color:#58a1dd>Envcontext</span> <span style=color:#ff636f>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#58a1dd>Env</span> <span style=color:#ff636f>map</span>[<span style=color:#ff636f>string</span>]<span style=color:#ff636f>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// NewEnvcontext todo
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>func</span> <span style=color:#58a1dd>NewEnvcontext</span>() (<span style=color:#ff636f>*</span><span style=color:#58a1dd>Envcontext</span>, <span style=color:#ff636f>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#58a1dd>exe</span>, <span style=color:#58a1dd>err</span> <span style=color:#ff636f>:=</span> <span style=color:#58a1dd>os</span>.<span style=color:#58a1dd>Executable</span>()
</span></span><span style=display:flex><span>	<span style=color:#ff636f>if</span> <span style=color:#58a1dd>err</span> <span style=color:#ff636f>!=</span> <span style=color:#ff636f>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff636f>return</span> <span style=color:#ff636f>nil</span>, <span style=color:#58a1dd>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#58a1dd>ec</span> <span style=color:#ff636f>:=</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>Envcontext</span>{<span style=color:#58a1dd>Env</span>: <span style=color:#58a1dd>make</span>(<span style=color:#ff636f>map</span>[<span style=color:#ff636f>string</span>]<span style=color:#ff636f>string</span>)}
</span></span><span style=display:flex><span>	<span style=color:#58a1dd>exedir</span> <span style=color:#ff636f>:=</span> <span style=color:#58a1dd>filepath</span>.<span style=color:#58a1dd>Dir</span>(<span style=color:#58a1dd>exe</span>)
</span></span><span style=display:flex><span>	<span style=color:#ff636f>if</span> <span style=color:#58a1dd>filepath</span>.<span style=color:#58a1dd>Base</span>(<span style=color:#58a1dd>exedir</span>) <span style=color:#ff636f>==</span> <span style=color:#a6be9d>&#34;bin&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#58a1dd>ec</span>.<span style=color:#58a1dd>Env</span>[<span style=color:#a6be9d>&#34;APPDIR&#34;</span>] = <span style=color:#58a1dd>filepath</span>.<span style=color:#58a1dd>Dir</span>(<span style=color:#58a1dd>exedir</span>)
</span></span><span style=display:flex><span>	} <span style=color:#ff636f>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#58a1dd>ec</span>.<span style=color:#58a1dd>Env</span>[<span style=color:#a6be9d>&#34;APPDIR&#34;</span>] = <span style=color:#58a1dd>exedir</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff636f>return</span> <span style=color:#58a1dd>ec</span>, <span style=color:#ff636f>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// Append env
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>func</span> (<span style=color:#58a1dd>ec</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>Envcontext</span>) <span style=color:#58a1dd>Append</span>(<span style=color:#58a1dd>key</span>, <span style=color:#58a1dd>value</span> <span style=color:#ff636f>string</span>) <span style=color:#ff636f>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#ff636f>if</span> <span style=color:#58a1dd>len</span>(<span style=color:#58a1dd>key</span>) <span style=color:#ff636f>==</span> <span style=color:#a6be9d>0</span> <span style=color:#ff636f>||</span> <span style=color:#58a1dd>len</span>(<span style=color:#58a1dd>value</span>) <span style=color:#ff636f>==</span> <span style=color:#a6be9d>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff636f>return</span> <span style=color:#58a1dd>errors</span>.<span style=color:#58a1dd>New</span>(<span style=color:#a6be9d>&#34;Empty key value&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#58a1dd>ec</span>.<span style=color:#58a1dd>Env</span>[<span style=color:#58a1dd>key</span>] = <span style=color:#58a1dd>value</span>
</span></span><span style=display:flex><span>	<span style=color:#ff636f>return</span> <span style=color:#ff636f>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// Delete Env
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>func</span> (<span style=color:#58a1dd>ec</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>Envcontext</span>) <span style=color:#58a1dd>Delete</span>(<span style=color:#58a1dd>key</span> <span style=color:#ff636f>string</span>) <span style=color:#ff636f>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#ff636f>if</span> <span style=color:#58a1dd>_</span>, <span style=color:#58a1dd>ok</span> <span style=color:#ff636f>:=</span> <span style=color:#58a1dd>ec</span>.<span style=color:#58a1dd>Env</span>[<span style=color:#58a1dd>key</span>]; <span style=color:#58a1dd>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#58a1dd>delete</span>(<span style=color:#58a1dd>ec</span>.<span style=color:#58a1dd>Env</span>, <span style=color:#58a1dd>key</span>)
</span></span><span style=display:flex><span>		<span style=color:#ff636f>return</span> <span style=color:#ff636f>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff636f>return</span> <span style=color:#58a1dd>fmt</span>.<span style=color:#58a1dd>Errorf</span>(<span style=color:#a6be9d>&#34;&#39;%s&#39; not exists&#34;</span>, <span style=color:#58a1dd>key</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// Expand callback
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>func</span> (<span style=color:#58a1dd>ec</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>Envcontext</span>) <span style=color:#58a1dd>Expand</span>(<span style=color:#58a1dd>s</span> <span style=color:#ff636f>string</span>) <span style=color:#ff636f>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#ff636f>if</span> <span style=color:#58a1dd>_</span>, <span style=color:#58a1dd>ok</span> <span style=color:#ff636f>:=</span> <span style=color:#58a1dd>ec</span>.<span style=color:#58a1dd>Env</span>[<span style=color:#58a1dd>s</span>]; <span style=color:#58a1dd>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff636f>return</span> <span style=color:#58a1dd>ec</span>.<span style=color:#58a1dd>Env</span>[<span style=color:#58a1dd>s</span>]
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff636f>return</span> <span style=color:#58a1dd>os</span>.<span style=color:#58a1dd>Getenv</span>(<span style=color:#58a1dd>s</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// Expandenv is
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>func</span> (<span style=color:#58a1dd>ec</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>Envcontext</span>) <span style=color:#58a1dd>Expandenv</span>(<span style=color:#58a1dd>s</span> <span style=color:#ff636f>string</span>) <span style=color:#ff636f>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#ff636f>return</span> <span style=color:#58a1dd>os</span>.<span style=color:#58a1dd>Expand</span>(<span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>ec</span>.<span style=color:#58a1dd>Expand</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>上述 <code>Envcontext</code> 是基于 Golang 的，但 Gitee 很多服务是基于 C++ 编写，因此，我们需要一个 C++ 版本，为了支持异构查找，我们使用 <code>absl::flat_hash_map</code> 存储自定义的环境变量，这样也就避免了修改进程的环境变量，这里有一个 <strong>header-only</strong> 版本（借鉴了 Golang 的思路）：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#828b96;font-style:italic>////////
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#828b96;font-style:italic>#ifndef EXPAND_ENV_HPP
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>#define EXPAND_ENV_HPP
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>#include</span> <span style=color:#828b96;font-style:italic>&lt;string&gt;</span><span style=color:#828b96;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>#include</span> <span style=color:#828b96;font-style:italic>&lt;string_view&gt;</span><span style=color:#828b96;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>#include</span> <span style=color:#828b96;font-style:italic>&lt;absl/strings/str_format.h&gt;</span><span style=color:#828b96;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>#include</span> <span style=color:#828b96;font-style:italic>&lt;absl/container/flat_hash_map.h&gt;</span><span style=color:#828b96;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ff636f>namespace</span> <span style=color:#58a1dd>env</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>class</span> <span style=color:#58a1dd>Derivative</span> {
</span></span><span style=display:flex><span><span style=color:#ff636f>public</span><span style=color:#ff636f>:</span>
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Derivative</span>() <span style=color:#ff636f>=</span> <span style=color:#ff636f>default</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Derivative</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>Derivative</span> <span style=color:#ff636f>&amp;</span>) <span style=color:#ff636f>=</span> <span style=color:#ff636f>delete</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Derivative</span> <span style=color:#ff636f>&amp;</span><span style=color:#ff636f>operator</span><span style=color:#ff636f>=</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>Derivative</span> <span style=color:#ff636f>&amp;</span>) <span style=color:#ff636f>=</span> <span style=color:#ff636f>delete</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>AddBashCompatible</span>(<span style=color:#ff636f>int</span> <span style=color:#58a1dd>argc</span>, <span style=color:#ff636f>char</span> <span style=color:#ff636f>*</span><span style=color:#ff636f>const</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>argv</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>EraseEnv</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>key</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>SetEnv</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>key</span>, <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>value</span>, <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>force</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>false</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>PutEnv</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>nv</span>, <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>force</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>false</span>);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>[[nodiscard]]</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>GetEnv</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>key</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>ExpandEnv</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>raw</span>, <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>w</span>,
</span></span><span style=display:flex><span>                 <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>disableos</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>false</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>private</span><span style=color:#ff636f>:</span>
</span></span><span style=display:flex><span>  <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>AppendEnv</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>key</span>, <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>w</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>flat_hash_map</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span>, <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>envblock</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>namespace</span> <span style=color:#58a1dd>env_internal</span> {
</span></span><span style=display:flex><span><span style=color:#ff636f>inline</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>is_shell_specia_var</span>(<span style=color:#ff636f>char</span> <span style=color:#58a1dd>ch</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> (<span style=color:#58a1dd>ch</span> <span style=color:#ff636f>==</span> <span style=color:#a6be9d>&#39;*&#39;</span> <span style=color:#ff636f>||</span> <span style=color:#58a1dd>ch</span> <span style=color:#ff636f>==</span> <span style=color:#a6be9d>&#39;#&#39;</span> <span style=color:#ff636f>||</span> <span style=color:#58a1dd>ch</span> <span style=color:#ff636f>==</span> <span style=color:#a6be9d>&#39;$&#39;</span> <span style=color:#ff636f>||</span> <span style=color:#58a1dd>ch</span> <span style=color:#ff636f>==</span> <span style=color:#a6be9d>&#39;@&#39;</span> <span style=color:#ff636f>||</span> <span style=color:#58a1dd>ch</span> <span style=color:#ff636f>==</span> <span style=color:#a6be9d>&#39;!&#39;</span> <span style=color:#ff636f>||</span>
</span></span><span style=display:flex><span>          <span style=color:#58a1dd>ch</span> <span style=color:#ff636f>==</span> <span style=color:#a6be9d>&#39;?&#39;</span> <span style=color:#ff636f>||</span> <span style=color:#58a1dd>ch</span> <span style=color:#ff636f>==</span> <span style=color:#a6be9d>&#39;-&#39;</span> <span style=color:#ff636f>||</span> (<span style=color:#58a1dd>ch</span> <span style=color:#ff636f>&gt;=</span> <span style=color:#a6be9d>&#39;0&#39;</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>ch</span> <span style=color:#ff636f>&lt;=</span> <span style=color:#a6be9d>&#39;9&#39;</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>inline</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>is_alphanum</span>(<span style=color:#ff636f>char</span> <span style=color:#58a1dd>ch</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> (<span style=color:#58a1dd>ch</span> <span style=color:#ff636f>==</span> <span style=color:#a6be9d>&#39;_&#39;</span> <span style=color:#ff636f>||</span> (<span style=color:#58a1dd>ch</span> <span style=color:#ff636f>&gt;=</span> <span style=color:#a6be9d>&#39;0&#39;</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>ch</span> <span style=color:#ff636f>&lt;=</span> <span style=color:#a6be9d>&#39;9&#39;</span>) <span style=color:#ff636f>||</span> (<span style=color:#58a1dd>ch</span> <span style=color:#ff636f>&gt;=</span> <span style=color:#a6be9d>&#39;a&#39;</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>ch</span> <span style=color:#ff636f>&lt;=</span> <span style=color:#a6be9d>&#39;z&#39;</span>) <span style=color:#ff636f>||</span>
</span></span><span style=display:flex><span>          (<span style=color:#58a1dd>ch</span> <span style=color:#ff636f>&gt;=</span> <span style=color:#a6be9d>&#39;A&#39;</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>ch</span> <span style=color:#ff636f>&lt;=</span> <span style=color:#a6be9d>&#39;Z&#39;</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>inline</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>resovle_shell_name</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_t</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>off</span>) {
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>off</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>s</span>.<span style=color:#58a1dd>front</span>() <span style=color:#ff636f>==</span> <span style=color:#a6be9d>&#39;{&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>s</span>.<span style=color:#58a1dd>size</span>() <span style=color:#ff636f>&gt;</span> <span style=color:#a6be9d>2</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>is_shell_specia_var</span>(<span style=color:#58a1dd>s</span>[<span style=color:#a6be9d>1</span>]) <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>s</span>[<span style=color:#a6be9d>2</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>&#39;}&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>off</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>3</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>return</span> <span style=color:#58a1dd>s</span>.<span style=color:#58a1dd>substr</span>(<span style=color:#a6be9d>1</span>, <span style=color:#a6be9d>2</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff636f>for</span> (<span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>i</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>1</span>; <span style=color:#58a1dd>i</span> <span style=color:#ff636f>&lt;</span> <span style=color:#58a1dd>s</span>.<span style=color:#58a1dd>size</span>(); <span style=color:#58a1dd>i</span><span style=color:#ff636f>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>s</span>[<span style=color:#58a1dd>i</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>&#39;}&#39;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>i</span> <span style=color:#ff636f>==</span> <span style=color:#a6be9d>1</span>) {
</span></span><span style=display:flex><span>          <span style=color:#58a1dd>off</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>2</span>;
</span></span><span style=display:flex><span>          <span style=color:#ff636f>return</span> <span style=color:#a6be9d>&#34;&#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>off</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>i</span> <span style=color:#ff636f>+</span> <span style=color:#a6be9d>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> <span style=color:#58a1dd>s</span>.<span style=color:#58a1dd>substr</span>(<span style=color:#a6be9d>1</span>, <span style=color:#58a1dd>i</span> <span style=color:#ff636f>-</span> <span style=color:#a6be9d>1</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>off</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#a6be9d>&#34;&#34;</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>is_shell_specia_var</span>(<span style=color:#58a1dd>s</span>[<span style=color:#a6be9d>0</span>])) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>off</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>s</span>.<span style=color:#58a1dd>substr</span>(<span style=color:#a6be9d>0</span>, <span style=color:#a6be9d>1</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>i</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>for</span> (; <span style=color:#58a1dd>i</span> <span style=color:#ff636f>&lt;</span> <span style=color:#58a1dd>s</span>.<span style=color:#58a1dd>size</span>() <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>is_alphanum</span>(<span style=color:#58a1dd>s</span>[<span style=color:#58a1dd>i</span>]); <span style=color:#58a1dd>i</span><span style=color:#ff636f>++</span>) {
</span></span><span style=display:flex><span>    ;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>off</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>i</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>s</span>.<span style=color:#58a1dd>substr</span>(<span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>i</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>inline</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>os_expand_env</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>key</span>, <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>value</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>v</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>::</span><span style=color:#58a1dd>getenv</span>(<span style=color:#58a1dd>key</span>.<span style=color:#58a1dd>data</span>());
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>v</span> <span style=color:#ff636f>==</span> <span style=color:#ff636f>nullptr</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>value</span>.<span style=color:#58a1dd>append</span>(<span style=color:#58a1dd>v</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>true</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>} <span style=color:#828b96;font-style:italic>// namespace env_internal
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ff636f>inline</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>Derivative</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>AddBashCompatible</span>(<span style=color:#ff636f>int</span> <span style=color:#58a1dd>argc</span>, <span style=color:#ff636f>char</span> <span style=color:#ff636f>*</span><span style=color:#ff636f>const</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>argv</span>) {
</span></span><span style=display:flex><span>  <span style=color:#828b96;font-style:italic>// $0~$N
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#ff636f>for</span> (<span style=color:#ff636f>int</span> <span style=color:#58a1dd>i</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>; <span style=color:#58a1dd>i</span> <span style=color:#ff636f>&lt;</span> <span style=color:#58a1dd>argc</span>; <span style=color:#58a1dd>i</span><span style=color:#ff636f>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>envblock</span>.<span style=color:#58a1dd>emplace</span>(<span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>AlphaNum</span>(<span style=color:#58a1dd>i</span>).<span style=color:#58a1dd>Piece</span>(), <span style=color:#58a1dd>argv</span>[<span style=color:#58a1dd>i</span>]);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>envblock</span>.<span style=color:#58a1dd>emplace</span>(<span style=color:#a6be9d>&#34;$&#34;</span>,
</span></span><span style=display:flex><span>                   <span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>AlphaNum</span>(<span style=color:#ff636f>::</span><span style=color:#58a1dd>getpid</span>()).<span style=color:#58a1dd>Piece</span>()); <span style=color:#828b96;font-style:italic>// current process PID
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>true</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>inline</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>Derivative</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>EraseEnv</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>key</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>envblock</span>.<span style=color:#58a1dd>erase</span>(<span style=color:#58a1dd>key</span>) <span style=color:#ff636f>!=</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>inline</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>Derivative</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>SetEnv</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>key</span>, <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>value</span>,
</span></span><span style=display:flex><span>                               <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>force</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>force</span>) {
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// envblock[key] = value;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#58a1dd>envblock</span>.<span style=color:#58a1dd>insert_or_assign</span>(<span style=color:#58a1dd>key</span>, <span style=color:#58a1dd>value</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>true</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>envblock</span>.<span style=color:#58a1dd>emplace</span>(<span style=color:#58a1dd>key</span>, <span style=color:#58a1dd>value</span>).<span style=color:#58a1dd>second</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>inline</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>Derivative</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>PutEnv</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>nv</span>, <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>force</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>nv</span>.<span style=color:#58a1dd>find</span>(<span style=color:#a6be9d>&#39;=&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>pos</span> <span style=color:#ff636f>==</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring_view</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>npos</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>SetEnv</span>(<span style=color:#58a1dd>nv</span>, <span style=color:#a6be9d>&#34;&#34;</span>, <span style=color:#58a1dd>force</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>SetEnv</span>(<span style=color:#58a1dd>nv</span>.<span style=color:#58a1dd>substr</span>(<span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>pos</span>), <span style=color:#58a1dd>nv</span>.<span style=color:#58a1dd>substr</span>(<span style=color:#58a1dd>pos</span> <span style=color:#ff636f>+</span> <span style=color:#a6be9d>1</span>), <span style=color:#58a1dd>force</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>[[nodiscard]]</span> <span style=color:#ff636f>inline</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>Derivative</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>GetEnv</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>key</span>) <span style=color:#ff636f>const</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>it</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>envblock</span>.<span style=color:#58a1dd>find</span>(<span style=color:#58a1dd>key</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>it</span> <span style=color:#ff636f>==</span> <span style=color:#58a1dd>envblock</span>.<span style=color:#58a1dd>end</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#a6be9d>&#34;&#34;</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>it</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>second</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>inline</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>Derivative</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>AppendEnv</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>key</span>, <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>w</span>) <span style=color:#ff636f>const</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>it</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>envblock</span>.<span style=color:#58a1dd>find</span>(<span style=color:#58a1dd>key</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>it</span> <span style=color:#ff636f>==</span> <span style=color:#58a1dd>envblock</span>.<span style=color:#58a1dd>end</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>false</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>w</span>.<span style=color:#58a1dd>append</span>(<span style=color:#58a1dd>it</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>second</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>true</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// Expand Env string to normal string only support  Unix style&#39;${KEY}&#39;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>inline</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>Derivative</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>ExpandEnv</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>raw</span>, <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>w</span>,
</span></span><span style=display:flex><span>                                  <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>disableos</span>) <span style=color:#ff636f>const</span> {
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>w</span>.<span style=color:#58a1dd>reserve</span>(<span style=color:#58a1dd>raw</span>.<span style=color:#58a1dd>size</span>() <span style=color:#ff636f>*</span> <span style=color:#a6be9d>2</span>);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>i</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>for</span> (<span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>j</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>; <span style=color:#58a1dd>j</span> <span style=color:#ff636f>&lt;</span> <span style=color:#58a1dd>raw</span>.<span style=color:#58a1dd>size</span>(); <span style=color:#58a1dd>j</span><span style=color:#ff636f>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>raw</span>[<span style=color:#58a1dd>j</span>] <span style=color:#ff636f>==</span> <span style=color:#a6be9d>&#39;$&#39;</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>j</span> <span style=color:#ff636f>+</span> <span style=color:#a6be9d>1</span> <span style=color:#ff636f>&lt;</span> <span style=color:#58a1dd>raw</span>.<span style=color:#58a1dd>size</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>w</span>.<span style=color:#58a1dd>append</span>(<span style=color:#58a1dd>raw</span>.<span style=color:#58a1dd>substr</span>(<span style=color:#58a1dd>i</span>, <span style=color:#58a1dd>j</span> <span style=color:#ff636f>-</span> <span style=color:#58a1dd>i</span>));
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>off</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>name</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>env_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>resovle_shell_name</span>(<span style=color:#58a1dd>raw</span>.<span style=color:#58a1dd>substr</span>(<span style=color:#58a1dd>j</span> <span style=color:#ff636f>+</span> <span style=color:#a6be9d>1</span>), <span style=color:#58a1dd>off</span>);
</span></span><span style=display:flex><span>      <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>name</span>.<span style=color:#58a1dd>empty</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>off</span> <span style=color:#ff636f>==</span> <span style=color:#a6be9d>0</span>) {
</span></span><span style=display:flex><span>          <span style=color:#58a1dd>w</span>.<span style=color:#58a1dd>push_back</span>(<span style=color:#58a1dd>raw</span>[<span style=color:#58a1dd>j</span>]);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      } <span style=color:#ff636f>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff636f>if</span> (<span style=color:#ff636f>!</span><span style=color:#58a1dd>AppendEnv</span>(<span style=color:#58a1dd>name</span>, <span style=color:#58a1dd>w</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#ff636f>if</span> (<span style=color:#ff636f>!</span><span style=color:#58a1dd>disableos</span>) {
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>env_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>os_expand_env</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span>(<span style=color:#58a1dd>name</span>), <span style=color:#58a1dd>w</span>);
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>j</span> <span style=color:#ff636f>+=</span> <span style=color:#58a1dd>off</span>;
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>i</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>j</span> <span style=color:#ff636f>+</span> <span style=color:#a6be9d>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>w</span>.<span style=color:#58a1dd>append</span>(<span style=color:#58a1dd>raw</span>.<span style=color:#58a1dd>substr</span>(<span style=color:#58a1dd>i</span>));
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>true</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>} <span style=color:#828b96;font-style:italic>// namespace env
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>#endif
</span></span></span></code></pre></div><p>这个 <code>Derivative</code> 类是我借鉴 <code>Golang</code> 先在 bela 中实现的，在 bela 中，我们使用了 <a href=https://github.com/greg7mdp/parallel-hashmap>parallel-hashmap</a> 作为环境变量容器，并且提供了支持 <code>std::wstring</code> 异构查找的<a href=https://github.com/fcharlie/bela/blob/master/include/bela/phmap/std_wstring.patch>补丁</a>。并且还使用 <code>parallel_flat_hash_map</code> 实现了线程安全的 <code>DerivativeMT</code>，测试无误后将其移植到到 Gitee 的项目中。</p><p><strong>2019-07-10</strong> <a href=https://github.com/greg7mdp>Gregory Popovitch</a> 接受了我的 <a href=https://github.com/greg7mdp/parallel-hashmap/pull/15>PR</a>，目前已经使用官方的 <code>parallel-hashmap</code> 作为 Bela 的环境变量容器。</p><p>因此，如果你需要在 Windows 中使用 <code>Derivative</code>，建议使用 <a href=https://github.com/fcharlie/bela/blob/master/include/bela/env.hpp><code>bela</code></a>，其他环境可以使用这个 <code>header-only</code> 版本。</p><h2 id=可回滚的-shell-自解压安装包>可回滚的 Shell 自解压安装包</h2><p>我在 Gitee 开发一些基础组件，除了要为 Gitee 公有云提供技术支持，同时也需要为私有化提供技术支持，因此，这些基础组件如若能静态编译，解压后直接运行是最简单不过的，但是当处于维护模式，升级软件时，却不得不考虑配置是否覆盖，如何支持二进制回滚的问题。</p><p>当我们使用 cmake 作为构建系统时，cmake 拥有打包工具 <code>cpack</code>，在 Linux 中，<code>cpack</code> 可以打包一个 <code>STGZ</code> 文件，这个文件有些特别，文件前部是一个脚本，后面则是一个 <code>tar.gz</code> 文件，当执行此文件前部的脚本时，脚本会读取文件中 <code>.tar.gz</code> 文件的偏移，以管道的方式调用 <code>tar</code> 解压。这样就实现了安装。<code>cmake</code> 使用一个名为：<a href=https://github.com/Kitware/CMake/blob/master/Modules/CPack.STGZ_Header.sh.in>CPack.STGZ_Header.sh.in</a> 的模板，如果要安装后执行特定的配置文件，我们则可以在项目文件中添加一个修改后的 <code>CPack.STGZ_Header.sh.in</code> 覆盖 cmake 自身的模板即可。</p><p>在 cmake 中，配置文件的安装支持 <code>RENAME</code>，但 <code>target</code> 暂不支持 <code>RENAME</code>，因此，我们可以将 target 修改为原来的 <code>$TARGET_NAME.new</code>，在解压到安装目录后，自定义配置文件检测相应的 target 是否已经存在，存在则重命名，然后将 <code>$TARGET_NAME.new</code> 重命名为 <code>$TARGET_NAME</code>，这样便能够支持二进制回滚。配置文件配置也是类似，我们还可以运行 diff 去检测配置文件哪里发生了修改，提示用户更新。</p><p>在 Gitee 中，有一些项目基于 Golang 编写，而 cmake 目前并不支持 golang，虽然使用 cmake 可以打包，但是还是有一些麻烦，实际上编写 stgz 构建脚本非常简单，相应脚本如下：</p><p>主构建脚本（bali：我使用 <a href=https://github.com/fcharlie/bali>https://github.com/fcharlie/bali</a> 作为 Golang 项目的构建软件）：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#828b96;font-style:italic>#!/usr/bin/env pwsh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>param</span>(
</span></span><span style=display:flex><span>    [<span style=color:#58a1dd>ValidateSet</span>(<span style=color:#a6be9d>&#34;linux&#34;</span>, <span style=color:#a6be9d>&#34;drawin&#34;</span>, <span style=color:#a6be9d>&#34;windows&#34;</span>)]
</span></span><span style=display:flex><span>    [<span style=color:#58a1dd>Alias</span>(<span style=color:#a6be9d>&#34;T&#34;</span>)]
</span></span><span style=display:flex><span>    [<span style=color:#58a1dd>String</span>]<span style=color:#58a1dd>$Target</span> = <span style=color:#a6be9d>&#34;linux&#34;</span>,
</span></span><span style=display:flex><span>    [<span style=color:#58a1dd>String</span>]<span style=color:#58a1dd>$Arch</span> = <span style=color:#a6be9d>&#34;amd64&#34;</span>,
</span></span><span style=display:flex><span>    [<span style=color:#58a1dd>Alias</span>(<span style=color:#a6be9d>&#34;h&#34;</span>)]
</span></span><span style=display:flex><span>    [<span style=color:#58a1dd>Switch</span>]<span style=color:#58a1dd>$Help</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>if</span> (<span style=color:#58a1dd>$Help</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>Write-Host</span> <span style=color:#a6be9d>&#34;charlie&#39;s mkstgz script tools
</span></span></span><span style=display:flex><span><span style=color:#a6be9d>  -T|--target      target name, Linux, macOS, Windows
</span></span></span><span style=display:flex><span><span style=color:#a6be9d>  -h|--help        print usage and exit.
</span></span></span><span style=display:flex><span><span style=color:#a6be9d>  &#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>exit</span> <span style=color:#a6be9d>0</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>$BALIUTILS</span> = <span style=color:#58a1dd>Get-Command</span> <span style=color:#58a1dd>-CommandType</span> <span style=color:#58a1dd>Application</span> <span style=color:#58a1dd>bali</span> <span style=color:#58a1dd>-ErrorAction</span> <span style=color:#58a1dd>SilentlyContinue</span> 
</span></span><span style=display:flex><span><span style=color:#ff636f>if</span> (<span style=color:#58a1dd>$null</span> <span style=color:#ff636f>-eq</span> <span style=color:#58a1dd>$BALIUTILS</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>Write-Host</span> <span style=color:#58a1dd>-ForegroundColor</span> <span style=color:#58a1dd>Red</span> <span style=color:#a6be9d>&#34;Please install bali to allow mkstgz&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>exit</span> <span style=color:#a6be9d>1</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>$AppDir</span> = <span style=color:#58a1dd>Split-Path</span> <span style=color:#58a1dd>-Parent</span> <span style=color:#58a1dd>-Path</span> <span style=color:#58a1dd>$PSScriptRoot</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>$result</span> = <span style=color:#58a1dd>Start-Process</span> <span style=color:#58a1dd>-FilePath</span> <span style=color:#a6be9d>&#34;bali&#34;</span> <span style=color:#58a1dd>-ArgumentList</span> <span style=color:#a6be9d>&#34;-t </span><span style=color:#58a1dd>$Target</span><span style=color:#a6be9d> -Arch </span><span style=color:#58a1dd>$Arch</span><span style=color:#a6be9d>&#34;</span> <span style=color:#58a1dd>-WorkingDirectory</span> <span style=color:#58a1dd>$AppDir</span> <span style=color:#58a1dd>-NoNewWindow</span> <span style=color:#58a1dd>-Wait</span> <span style=color:#58a1dd>-PassThru</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>if</span> (<span style=color:#58a1dd>$result</span>.<span style=color:#58a1dd>ExitCode</span> <span style=color:#ff636f>-ne</span> <span style=color:#a6be9d>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>Write-Host</span> <span style=color:#58a1dd>-ForegroundColor</span> <span style=color:#58a1dd>Red</span> <span style=color:#a6be9d>&#34;bali build MyPackage failed&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>exit</span> <span style=color:#a6be9d>1</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>$Baliobj</span> = <span style=color:#58a1dd>Get-Content</span> <span style=color:#58a1dd>-Path</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$AppDir</span><span style=color:#a6be9d>/bali.json&#34;</span> | <span style=color:#58a1dd>ConvertFrom-Json</span> <span style=color:#58a1dd>-ErrorAction</span> <span style=color:#58a1dd>SilentlyContinue</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>if</span> (<span style=color:#58a1dd>$null</span> <span style=color:#ff636f>-eq</span> <span style=color:#58a1dd>$Baliobj</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>Write-Host</span> <span style=color:#58a1dd>-ForegroundColor</span> <span style=color:#58a1dd>Red</span> <span style=color:#a6be9d>&#34;parse </span><span style=color:#58a1dd>$AppDir</span><span style=color:#a6be9d>/bali.json failed&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>exit</span> <span style=color:#a6be9d>1</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>if</span> (<span style=color:#58a1dd>$null</span> <span style=color:#ff636f>-eq</span> <span style=color:#58a1dd>$Baliobj</span>.<span style=color:#58a1dd>version</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>$version</span> = <span style=color:#a6be9d>&#34;0.0.1&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff636f>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>$version</span> = <span style=color:#58a1dd>$Baliobj</span>.<span style=color:#58a1dd>version</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>Write-Host</span> <span style=color:#a6be9d>&#34;The version of MyPackage detected is: </span><span style=color:#58a1dd>$version</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>Get-ChildItem</span> <span style=color:#58a1dd>-Path</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$AppDir</span><span style=color:#a6be9d>/build/bin&#34;</span> | <span style=color:#58a1dd>ForEach-Object</span> {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>Rename-Item</span> <span style=color:#58a1dd>-Path</span> <span style=color:#58a1dd>$_</span>.<span style=color:#58a1dd>FullName</span> <span style=color:#58a1dd>-NewName</span> <span style=color:#a6be9d>&#34;</span>$(<span style=color:#58a1dd>$_</span>.<span style=color:#58a1dd>FullName</span>)<span style=color:#a6be9d>.new&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>Get-ChildItem</span> <span style=color:#58a1dd>-Path</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$AppDir</span><span style=color:#a6be9d>/build/config&#34;</span> | <span style=color:#58a1dd>ForEach-Object</span> {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>Rename-Item</span> <span style=color:#58a1dd>-Path</span> <span style=color:#58a1dd>$_</span>.<span style=color:#58a1dd>FullName</span> <span style=color:#58a1dd>-NewName</span> <span style=color:#a6be9d>&#34;</span>$(<span style=color:#58a1dd>$_</span>.<span style=color:#58a1dd>FullName</span>)<span style=color:#a6be9d>.template&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>Copy-Item</span> <span style=color:#58a1dd>-Path</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$PSScriptRoot</span><span style=color:#a6be9d>/post_install.sh&#34;</span> <span style=color:#58a1dd>-Destination</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$AppDir</span><span style=color:#a6be9d>/build/bin/post_install.sh&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>$TarDistPath</span> = <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$AppDir</span><span style=color:#a6be9d>/MyPackage-</span><span style=color:#58a1dd>$Target</span><span style=color:#a6be9d>-</span><span style=color:#58a1dd>$Arch</span><span style=color:#a6be9d>-</span><span style=color:#58a1dd>$version</span><span style=color:#a6be9d>.tar.gz&#34;</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>$StgzDistPath</span> = <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$AppDir</span><span style=color:#a6be9d>/MyPackage-</span><span style=color:#58a1dd>$Target</span><span style=color:#a6be9d>-</span><span style=color:#58a1dd>$Arch</span><span style=color:#a6be9d>-</span><span style=color:#58a1dd>$version</span><span style=color:#a6be9d>.sh&#34;</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>$StgzFileName</span> = <span style=color:#a6be9d>&#34;MyPackage-</span><span style=color:#58a1dd>$Target</span><span style=color:#a6be9d>-</span><span style=color:#58a1dd>$Arch</span><span style=color:#a6be9d>-</span><span style=color:#58a1dd>$version</span><span style=color:#a6be9d>.sh&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>Write-Host</span> <span style=color:#a6be9d>&#34;Compress MyPackage to </span><span style=color:#58a1dd>$TarDistPath</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>$TarArg</span> = <span style=color:#a6be9d>&#34;-czf </span><span style=color:#a6be9d>`&#34;</span><span style=color:#58a1dd>$TarDistPath</span><span style=color:#a6be9d>`&#34;</span><span style=color:#a6be9d> .&#34;</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>$TarStatus</span> = <span style=color:#58a1dd>Start-Process</span> <span style=color:#58a1dd>-FilePath</span> <span style=color:#a6be9d>&#34;tar&#34;</span> <span style=color:#58a1dd>-ArgumentList</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$TarArg</span><span style=color:#a6be9d>&#34;</span> <span style=color:#58a1dd>-WorkingDirectory</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$AppDir</span><span style=color:#a6be9d>/build&#34;</span> <span style=color:#58a1dd>-Wait</span> <span style=color:#58a1dd>-NoNewWindow</span> <span style=color:#58a1dd>-PassThru</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>if</span> (<span style=color:#58a1dd>$TarStatus</span>.<span style=color:#58a1dd>ExitCode</span> <span style=color:#ff636f>-ne</span> <span style=color:#a6be9d>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>exit</span> <span style=color:#58a1dd>$TarStatus</span>.<span style=color:#58a1dd>ExitCode</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>Copy-Item</span> <span style=color:#58a1dd>-Path</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$PSScriptRoot</span><span style=color:#a6be9d>/stgz.sh&#34;</span> <span style=color:#58a1dd>-Destination</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$StgzDistPath</span><span style=color:#a6be9d>&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#58a1dd>Write-Host</span> <span style=color:#a6be9d>&#34;Create a self-extracting file for MyPackage`: </span><span style=color:#58a1dd>$StgzDistPath</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>$writer</span> = <span style=color:#58a1dd>New-Object</span> <span style=color:#58a1dd>System</span>.<span style=color:#58a1dd>IO</span>.<span style=color:#58a1dd>FileStream</span>(<span style=color:#58a1dd>$StgzDistPath</span>, [<span style=color:#58a1dd>System.IO.FileMode</span>]::<span style=color:#58a1dd>Append</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff636f>catch</span> {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>Write-Host</span> <span style=color:#58a1dd>-ForegroundColor</span> <span style=color:#58a1dd>Red</span> <span style=color:#a6be9d>&#34;unable open </span><span style=color:#58a1dd>$StgzDistPath</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>exit</span> <span style=color:#a6be9d>1</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>$reader</span> = <span style=color:#58a1dd>New-Object</span> <span style=color:#58a1dd>System</span>.<span style=color:#58a1dd>IO</span>.<span style=color:#58a1dd>FileStream</span>(<span style=color:#58a1dd>$TarDistPath</span>, [<span style=color:#58a1dd>System.IO.FileMode</span>]::<span style=color:#58a1dd>Open</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff636f>catch</span> {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>$writer</span>.<span style=color:#58a1dd>Close</span>()
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>Write-Host</span> <span style=color:#58a1dd>-ForegroundColor</span> <span style=color:#58a1dd>Red</span> <span style=color:#a6be9d>&#34;unable open </span><span style=color:#58a1dd>$TarDistPath</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>exit</span> <span style=color:#a6be9d>1</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>$reader</span>.<span style=color:#58a1dd>CopyTo</span>(<span style=color:#58a1dd>$writer</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff636f>finally</span> {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>$writer</span>.<span style=color:#58a1dd>Close</span>()
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>$reader</span>.<span style=color:#58a1dd>Close</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#58a1dd>char</span>]<span style=color:#58a1dd>$Esc</span> = <span style=color:#58a1dd>0x1b</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>Write-Host</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$Esc</span><span style=color:#a6be9d>[32mPackaged successfully</span><span style=color:#58a1dd>$Esc</span><span style=color:#a6be9d>[0m
</span></span></span><span style=display:flex><span><span style=color:#a6be9d>Your can run &#39;</span><span style=color:#58a1dd>$StgzFileName</span><span style=color:#a6be9d> --prefix=/path/to/MyPackage&#39; to install MyPackage&#34;</span>
</span></span></code></pre></div><p>STGZ 文件头部（stgz.sh）：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#828b96;font-style:italic>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic># Display usage</span>
</span></span><span style=display:flex><span>stgz_usage<span style=color:#ff636f>()</span> <span style=color:#ff636f>{</span>
</span></span><span style=display:flex><span>    cat <span style=color:#a6be9d>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#a6be9d>Usage: $0 [options]
</span></span></span><span style=display:flex><span><span style=color:#a6be9d>Options: [defaults in brackets after descriptions]
</span></span></span><span style=display:flex><span><span style=color:#a6be9d>  --help            print this message
</span></span></span><span style=display:flex><span><span style=color:#a6be9d>  --version         print cmake installer version
</span></span></span><span style=display:flex><span><span style=color:#a6be9d>  --prefix=dir      directory in which to install
</span></span></span><span style=display:flex><span><span style=color:#a6be9d>EOF</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>exit</span> <span style=color:#a6be9d>1</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>stgz_fix_slashes<span style=color:#ff636f>()</span> <span style=color:#ff636f>{</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>echo</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$1</span><span style=color:#a6be9d>&#34;</span> | sed <span style=color:#a6be9d>&#39;s/\\/\//g&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>stgz_echo_exit<span style=color:#ff636f>()</span> <span style=color:#ff636f>{</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>echo</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$1</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>exit</span> <span style=color:#a6be9d>1</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>for</span> a in <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$@</span><span style=color:#a6be9d>&#34;</span>; <span style=color:#ff636f>do</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> <span style=color:#58a1dd>echo</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$a</span><span style=color:#a6be9d>&#34;</span> | grep <span style=color:#a6be9d>&#34;^--prefix=&#34;</span> &gt;/dev/null 2&gt;/dev/null; <span style=color:#ff636f>then</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>stgz_prefix_dir</span><span style=color:#ff636f>=</span><span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>${</span><span style=color:#58a1dd>a</span>/--prefix=<span style=color:#a6be9d>\/</span>//<span style=color:#a6be9d>}</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>stgz_prefix_dir</span><span style=color:#ff636f>=</span><span style=color:#ff636f>$(</span>stgz_fix_slashes <span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>${</span><span style=color:#58a1dd>stgz_prefix_dir</span><span style=color:#a6be9d>}</span><span style=color:#a6be9d>&#34;</span><span style=color:#ff636f>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> <span style=color:#58a1dd>echo</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$a</span><span style=color:#a6be9d>&#34;</span> | grep <span style=color:#a6be9d>&#34;^--help&#34;</span> &gt;/dev/null 2&gt;/dev/null; <span style=color:#ff636f>then</span>
</span></span><span style=display:flex><span>        stgz_usage
</span></span><span style=display:flex><span>    <span style=color:#ff636f>fi</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>echo</span> <span style=color:#a6be9d>&#34;This is a self-extracting archive.&#34;</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>toplevel</span><span style=color:#ff636f>=</span><span style=color:#ff636f>$(</span><span style=color:#58a1dd>pwd</span><span style=color:#ff636f>)</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>if</span> <span style=color:#ff636f>[[</span> <span style=color:#a6be9d>&#34;x</span><span style=color:#a6be9d>${</span><span style=color:#58a1dd>stgz_prefix_dir</span><span style=color:#a6be9d>}</span><span style=color:#a6be9d>&#34;</span> !<span style=color:#ff636f>=</span> <span style=color:#a6be9d>&#34;x&#34;</span> <span style=color:#ff636f>]]</span>; <span style=color:#ff636f>then</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>toplevel</span><span style=color:#ff636f>=</span><span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>${</span><span style=color:#58a1dd>stgz_prefix_dir</span><span style=color:#a6be9d>}</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>echo</span> <span style=color:#a6be9d>&#34;The archive will be extracted to: </span><span style=color:#a6be9d>${</span><span style=color:#58a1dd>toplevel</span><span style=color:#a6be9d>}</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>if</span> <span style=color:#ff636f>[</span> ! -d <span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>${</span><span style=color:#58a1dd>toplevel</span><span style=color:#a6be9d>}</span><span style=color:#a6be9d>&#34;</span> <span style=color:#ff636f>]</span>; <span style=color:#ff636f>then</span>
</span></span><span style=display:flex><span>    mkdir -p <span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>${</span><span style=color:#58a1dd>toplevel</span><span style=color:#a6be9d>}</span><span style=color:#a6be9d>&#34;</span> <span style=color:#ff636f>||</span> <span style=color:#58a1dd>exit</span> <span style=color:#a6be9d>1</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>echo</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>echo</span> <span style=color:#a6be9d>&#34;Using traget directory: </span><span style=color:#a6be9d>${</span><span style=color:#58a1dd>toplevel</span><span style=color:#a6be9d>}</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>echo</span> <span style=color:#a6be9d>&#34;Extracting, please wait...&#34;</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>echo</span> <span style=color:#a6be9d>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>ARCHIVE</span><span style=color:#ff636f>=</span><span style=color:#ff636f>$(</span>awk <span style=color:#a6be9d>&#39;/^__ARCHIVE_BELOW__/ {print NR + 1; exit 0; }&#39;</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$0</span><span style=color:#a6be9d>&#34;</span><span style=color:#ff636f>)</span>
</span></span><span style=display:flex><span>tail <span style=color:#a6be9d>&#34;-n+</span><span style=color:#58a1dd>$ARCHIVE</span><span style=color:#a6be9d>&#34;</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$0</span><span style=color:#a6be9d>&#34;</span> | tar xzvm -C <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$toplevel</span><span style=color:#a6be9d>&#34;</span> &gt;/dev/null 2&gt;&amp;<span style=color:#a6be9d>1</span> 3&gt;&amp;<span style=color:#a6be9d>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>if</span> <span style=color:#ff636f>[[</span> -f <span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>${</span><span style=color:#58a1dd>toplevel</span><span style=color:#a6be9d>}</span><span style=color:#a6be9d>/bin/post_install.sh&#34;</span> <span style=color:#ff636f>]]</span>; <span style=color:#ff636f>then</span>
</span></span><span style=display:flex><span>    chmod +x <span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>${</span><span style=color:#58a1dd>toplevel</span><span style=color:#a6be9d>}</span><span style=color:#a6be9d>/bin/post_install.sh&#34;</span>
</span></span><span style=display:flex><span>    bash <span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>${</span><span style=color:#58a1dd>toplevel</span><span style=color:#a6be9d>}</span><span style=color:#a6be9d>/bin/post_install.sh&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>exit</span> <span style=color:#a6be9d>0</span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>#This line must be the last line of the file</span>
</span></span><span style=display:flex><span>__ARCHIVE_BELOW__
</span></span></code></pre></div><p>安装后执行的 <code>post-install.sh</code>：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#828b96;font-style:italic>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>BINPATH</span><span style=color:#ff636f>=</span><span style=color:#ff636f>$(</span>dirname <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$0</span><span style=color:#a6be9d>&#34;</span><span style=color:#ff636f>)</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>BINPATH</span><span style=color:#ff636f>=</span><span style=color:#ff636f>$(</span>realpath <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$BINPATH</span><span style=color:#a6be9d>&#34;</span><span style=color:#ff636f>)</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>CONFIGPATH</span><span style=color:#ff636f>=</span><span style=color:#ff636f>$(</span>realpath <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$BINPATH</span><span style=color:#a6be9d>/../config&#34;</span><span style=color:#ff636f>)</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>toplevel</span><span style=color:#ff636f>=</span><span style=color:#ff636f>$(</span>realpath <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$BINPATH</span><span style=color:#a6be9d>/../&#34;</span><span style=color:#ff636f>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>stgz_apply_target<span style=color:#ff636f>()</span> <span style=color:#ff636f>{</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>echo</span> <span style=color:#a6be9d>&#34;apply target </span><span style=color:#58a1dd>$1</span><span style=color:#a6be9d> </span><span style=color:#58a1dd>$2</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>NEWNAME</span><span style=color:#ff636f>=</span><span style=color:#ff636f>$(</span>basename <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$1</span><span style=color:#a6be9d>&#34;</span><span style=color:#ff636f>)</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>NAME</span><span style=color:#ff636f>=</span><span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>${</span><span style=color:#58a1dd>NEWNAME</span>:<span style=color:#58a1dd>0</span>:<span style=color:#58a1dd>0</span>-4<span style=color:#a6be9d>}</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>NBDIR</span><span style=color:#ff636f>=</span><span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$2</span><span style=color:#a6be9d>/bin&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>TARGETFILE</span><span style=color:#ff636f>=</span><span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NBDIR</span><span style=color:#a6be9d>/</span><span style=color:#58a1dd>$NAME</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> <span style=color:#ff636f>[[</span> ! -d <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NBDIR</span><span style=color:#a6be9d>/old&#34;</span> <span style=color:#ff636f>]]</span>; <span style=color:#ff636f>then</span>
</span></span><span style=display:flex><span>        mkdir -p <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NBDIR</span><span style=color:#a6be9d>/old&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> <span style=color:#ff636f>[[</span> -f <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NBDIR</span><span style=color:#a6be9d>/old/</span><span style=color:#58a1dd>$NAME</span><span style=color:#a6be9d>.3&#34;</span> <span style=color:#ff636f>]]</span>; <span style=color:#ff636f>then</span>
</span></span><span style=display:flex><span>        rm <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NBDIR</span><span style=color:#a6be9d>/old/</span><span style=color:#58a1dd>$NAME</span><span style=color:#a6be9d>.3&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> <span style=color:#ff636f>[[</span> -f <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NBDIR</span><span style=color:#a6be9d>/old/</span><span style=color:#58a1dd>$NAME</span><span style=color:#a6be9d>.2&#34;</span> <span style=color:#ff636f>]]</span>; <span style=color:#ff636f>then</span>
</span></span><span style=display:flex><span>        mv <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NBDIR</span><span style=color:#a6be9d>/old/</span><span style=color:#58a1dd>$NAME</span><span style=color:#a6be9d>.2&#34;</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NBDIR</span><span style=color:#a6be9d>/old/</span><span style=color:#58a1dd>$NAME</span><span style=color:#a6be9d>.3&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> <span style=color:#ff636f>[[</span> -f <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NBDIR</span><span style=color:#a6be9d>/old/</span><span style=color:#58a1dd>$NAME</span><span style=color:#a6be9d>.1&#34;</span> <span style=color:#ff636f>]]</span>; <span style=color:#ff636f>then</span>
</span></span><span style=display:flex><span>        mv <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NBDIR</span><span style=color:#a6be9d>/old/</span><span style=color:#58a1dd>$NAME</span><span style=color:#a6be9d>.1&#34;</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NBDIR</span><span style=color:#a6be9d>/old/</span><span style=color:#58a1dd>$NAME</span><span style=color:#a6be9d>.2&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> <span style=color:#ff636f>[[</span> -f <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NBDIR</span><span style=color:#a6be9d>/</span><span style=color:#58a1dd>$NAME</span><span style=color:#a6be9d>.old&#34;</span> <span style=color:#ff636f>]]</span>; <span style=color:#ff636f>then</span>
</span></span><span style=display:flex><span>        mv <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NBDIR</span><span style=color:#a6be9d>/</span><span style=color:#58a1dd>$NAME</span><span style=color:#a6be9d>.old&#34;</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NBDIR</span><span style=color:#a6be9d>/old/</span><span style=color:#58a1dd>$NAME</span><span style=color:#a6be9d>.1&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>###</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> <span style=color:#ff636f>[[</span> -f <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$TARGETFILE</span><span style=color:#a6be9d>&#34;</span> <span style=color:#ff636f>]]</span>; <span style=color:#ff636f>then</span>
</span></span><span style=display:flex><span>        mv <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$TARGETFILE</span><span style=color:#a6be9d>&#34;</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$TARGETFILE</span><span style=color:#a6be9d>.old&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>fi</span>
</span></span><span style=display:flex><span>    mv <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$TARGETFILE</span><span style=color:#a6be9d>.new&#34;</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$TARGETFILE</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>stgz_apply_config<span style=color:#ff636f>()</span> <span style=color:#ff636f>{</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>echo</span> <span style=color:#a6be9d>&#34;Install config </span><span style=color:#58a1dd>$1</span><span style=color:#a6be9d> to </span><span style=color:#58a1dd>$2</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>NEWNAME</span><span style=color:#ff636f>=</span><span style=color:#ff636f>$(</span>basename <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$1</span><span style=color:#a6be9d>&#34;</span><span style=color:#ff636f>)</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>NAME</span><span style=color:#ff636f>=</span><span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>${</span><span style=color:#58a1dd>NEWNAME</span>:<span style=color:#58a1dd>0</span>:<span style=color:#58a1dd>0</span>-9<span style=color:#a6be9d>}</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>NCDIR</span><span style=color:#ff636f>=</span><span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$2</span><span style=color:#a6be9d>/config&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> <span style=color:#ff636f>[[</span> ! -d <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NCDIR</span><span style=color:#a6be9d>&#34;</span> <span style=color:#ff636f>]]</span>; <span style=color:#ff636f>then</span>
</span></span><span style=display:flex><span>        mkdir -p <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NCDIR</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> <span style=color:#ff636f>[[</span> -f <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NCDIR</span><span style=color:#a6be9d>/</span><span style=color:#58a1dd>$NAME</span><span style=color:#a6be9d>&#34;</span> <span style=color:#ff636f>]]</span>; <span style=color:#ff636f>then</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>echo</span> <span style=color:#a6be9d>&#34;File </span><span style=color:#58a1dd>$NAME</span><span style=color:#a6be9d> exists in </span><span style=color:#58a1dd>$NCDIR</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>        git --no-pager diff --no-index <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$1</span><span style=color:#a6be9d>&#34;</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NCDIR</span><span style=color:#a6be9d>/</span><span style=color:#58a1dd>$NAME</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>else</span>
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>echo</span> <span style=color:#a6be9d>&#34;rename </span><span style=color:#58a1dd>$1</span><span style=color:#a6be9d> to </span><span style=color:#58a1dd>$NCDIR</span><span style=color:#a6be9d>/</span><span style=color:#58a1dd>$NAME</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>        mv <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$1</span><span style=color:#a6be9d>&#34;</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$NCDIR</span><span style=color:#a6be9d>/</span><span style=color:#58a1dd>$NAME</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>fi</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>for</span> file in <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$BINPATH</span><span style=color:#a6be9d>&#34;</span>/*.new; <span style=color:#ff636f>do</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>echo</span> <span style=color:#a6be9d>&#34;apply </span><span style=color:#a6be9d>${</span><span style=color:#58a1dd>file</span><span style=color:#a6be9d>}</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>    stgz_apply_target <span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>${</span><span style=color:#58a1dd>file</span><span style=color:#a6be9d>}</span><span style=color:#a6be9d>&#34;</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$toplevel</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>for</span> file in <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$CONFIGPATH</span><span style=color:#a6be9d>&#34;</span>/*.template; <span style=color:#ff636f>do</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>echo</span> <span style=color:#a6be9d>&#34;apply </span><span style=color:#58a1dd>$file</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span>    stgz_apply_config <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$file</span><span style=color:#a6be9d>&#34;</span> <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$toplevel</span><span style=color:#a6be9d>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rm <span style=color:#a6be9d>&#34;</span><span style=color:#58a1dd>$BINPATH</span><span style=color:#a6be9d>/post_install.sh&#34;</span>
</span></span></code></pre></div><p>以上三个脚本就可以像 bali 构建的项目打包成 <code>STGZ</code> 文件，运行 <code>MyPackage-$Target-$Arch-$version.sh --prefix=/path/to/MyPackage</code> 后就可以了，不会覆盖配置还支持二进制回滚，这对于需要平滑重启的业务来说还是有一些帮助的。</p><h2 id=最后>最后</h2><p>没什么可说的了。</p><hr width=100% id=EOF><p style=color:#777>Last modified on 2019-07-09</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/2019/2019-07-20-cmdline-escape/>Next<br>Windows 命令行转义杂谈
</a><a class=older-posts href=/posts/2019/2019-06-25-talk-computer-update/>Previous<br>坐和放宽 - 您的计算机需要更新</a></nav><div class=post-comment-wrapper></div></div></div></div></div><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://forcemz.net/><div class=nav-title>Charlie's Rethinking</div><div class=nav-subtitle>Themed by Diary.</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>归档
</a><a class="a-block nav-link-item false" href=/categories>分类
</a><a class="a-block nav-link-item false" href=/tags>标签
</a><a class="a-block nav-link-item false" href=/about>关于
</a><a class="a-block nav-link-item false" href=/index.xml>RSS Feed</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><div id=extraContainer class=extra-container><div class=toc-wrapper><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e5%89%8d%e8%a8%80 class=nav-前言>前言</a></li><li><a href=#%e6%94%af%e6%8c%81%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e5%b1%95%e5%bc%80%e7%9a%84%e9%85%8d%e7%bd%ae%e8%a7%a3%e6%9e%90 class=nav-支持环境变量展开的配置解析>支持环境变量展开的配置解析</a></li><li><a href=#%e5%8f%af%e5%9b%9e%e6%bb%9a%e7%9a%84-shell-%e8%87%aa%e8%a7%a3%e5%8e%8b%e5%ae%89%e8%a3%85%e5%8c%85 class=nav-可回滚的-shell-自解压安装包>可回滚的 Shell 自解压安装包</a></li><li><a href=#%e6%9c%80%e5%90%8e class=nav-最后>最后</a></li></ul></div></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up
</i></a><a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><script src=/js/journal.js></script></body></html>