<!doctype html><html lang=en><head><title>Windows å‘½ä»¤è¡Œè½¬ä¹‰æ‚è°ˆ</title>
<meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=5" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><script src=/js/toc.js></script><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Material+Icons"></head><body><div id=app><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>å½’æ¡£
</a><a class="a-block drawer-menu-item false" href=/categories>åˆ†ç±»
</a><a class="a-block drawer-menu-item false" href=/tags>æ ‡ç­¾
</a><a class="a-block drawer-menu-item false" href=/about>å…³äº
</a><a class="a-block drawer-menu-item false" href=/index.xml>RSS Feed</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e8%83%8c%e6%99%af class=nav-èƒŒæ™¯>èƒŒæ™¯</a></li><li><a href=#windows-terminal-%e7%9a%84%e5%91%bd%e4%bb%a4%e8%a1%8c%e8%bd%ac%e4%b9%89%e9%94%99%e8%af%af class=nav-windows-terminal-çš„å‘½ä»¤è¡Œè½¬ä¹‰é”™è¯¯>Windows Terminal çš„å‘½ä»¤è¡Œè½¬ä¹‰é”™è¯¯</a></li><li><a href=#windows-ucrt-%e7%9a%84%e8%bf%9b%e7%a8%8b%e5%90%af%e5%8a%a8%e5%87%bd%e6%95%b0 class=nav-windows-ucrt-çš„è¿›ç¨‹å¯åŠ¨å‡½æ•°>Windows UCRT çš„è¿›ç¨‹å¯åŠ¨å‡½æ•°</a></li><li><a href=#%e8%af%b4%e4%b8%8d%e5%ae%8c%e7%9a%84%e8%bd%ac%e4%b9%89 class=nav-è¯´ä¸å®Œçš„è½¬ä¹‰>è¯´ä¸å®Œçš„è½¬ä¹‰</a></li><li><a href=#%e6%9c%80%e5%90%8e class=nav-æœ€å>æœ€å</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu
</i></button>
<a id=navTitle class=navbar-brand href=https://forcemz.net/>æ±ŸäºŒåä¸‰çš„æ€è€ƒ
</a><button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://forcemz.net/><div class=single-column-header-title>æ±ŸäºŒåä¸‰çš„æ€è€ƒ</div><div class=single-column-header-subtitle>Themed by Diary.</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>Windows å‘½ä»¤è¡Œè½¬ä¹‰æ‚è°ˆ<div class=post-meta><time itemprop=datePublished>2019-07-20 20:00
</time><i class=material-icons>folder</i>
<a href=/categories/windows>windows</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h2 id=èƒŒæ™¯>èƒŒæ™¯</h2><p>2019 å¹´äº”æœˆçš„ Microsoft Build å¤§ä¼šï¼Œå¾®è½¯å®£å¸ƒäº† Windows Terminalï¼Œå¹¶åœ¨ Github ä¸Šå¼€æºï¼š<a href=https://github.com/microsoft/terminal>https://github.com/microsoft/terminal</a>ã€‚æˆ‘ä½œä¸ºæŠ€æœ¯çˆ±å¥½è€…ï¼Œè‚¯å®šè¦å°é²œä¸€ç•ªã€‚</p><p>ä½¿ç”¨æˆªå›¾ï¼š</p><p><img src=https://user-images.githubusercontent.com/6904176/58634006-b05e6080-82d9-11e9-9e3f-2715647edf1b.png alt></p><p>åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œå¤šæ ‡ç­¾ï¼Œäºšå…‹åŠ›çš„çª—å£èƒŒæ™¯å’Œ <code>Colour Emojis</code> éƒ½è®©æˆ‘éå¸¸æ»¡æ„ï¼Œè€Œä¸”ä½¿ç”¨ Direct2D ç»˜åˆ¶çš„ emojiï¼Œçœ‹èµ·æ¥è¦æ¯” Mintty ä½¿ç”¨ GDI+PNG çš„ emoji æ–¹æ¡ˆå¥½çš„å¤šï¼ˆPNG çš„ emoji æ— è®ºæ˜¯æ”¾å¤§å’Œç¼©å°éƒ½æ›´å®¹æ˜“å¤±çœŸï¼ŒMintty å¹¶æ²¡æœ‰ Segoe UI å­—ä½“çš„ emoji é£æ ¼ï¼Œå…¶ä»–é£æ ¼æˆ‘å¹¶ä¸å¤ªå–œæ¬¢ï¼‰ã€‚ä¸è¿‡æˆ‘åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­å‘ç°äº†ä¸€ä¸ª BUGï¼Œå³ <a href=https://github.com/microsoft/terminal/issues/1090>Bug Report: The conhost command line is not properly escaped #1090 </a>ï¼Œåæ¥æˆ‘åˆæäº¤äº†ä¸€ä¸ª PR ä¿®å¤äº†æ­¤é—®é¢˜ï¼Œåœ¨ç ”ç©¶å…¶ä»–è½¯ä»¶æºç æ—¶ï¼Œæˆ‘å‘ç°è¿™ä¸ªé—®é¢˜å¹¶ä¸æ˜¯ä¸ªä¾‹ï¼Œå› æ­¤æœ‰å¿…è¦å¯¹æ­¤é—®é¢˜è¿›è¡Œä¸€æ¬¡è®¨è®ºï¼Œä¾¿æœ‰äº†æ­¤æ–‡ã€‚</p><h2 id=windows-terminal-çš„å‘½ä»¤è¡Œè½¬ä¹‰é”™è¯¯>Windows Terminal çš„å‘½ä»¤è¡Œè½¬ä¹‰é”™è¯¯</h2><p>åœ¨ Windows Termianl å¼€æºä¹‹å¤„ï¼Œæˆ‘ä¾¿å®‰è£…äº† Windows Termianlï¼Œå¹¶ä¸”æ¯ä¸ªå‘¨æœ«éƒ½å¯èƒ½ä¼šæ‹‰å–æœ€æ–°ä»£ç æ„å»º Windows Termianlã€‚ä½†åœ¨è‡ªå®šä¹‰ <code>profile.json</code> æ—¶ï¼Œæˆ‘å‘ç° Windows Termianl å¯åŠ¨æŸä¸ª <code>profiles</code> ä¼šä¸é¢„æœŸä¸ä¸€è‡´ï¼Œç›¸å…³çš„é…ç½®å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;acrylicOpacity&#34;</span>: <span style=color:#a6be9d>0.75</span>,
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;closeOnExit&#34;</span>: <span style=color:#ff636f>false</span>,
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;colorScheme&#34;</span>: <span style=color:#a6be9d>&#34;Campbell&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;commandline&#34;</span>: <span style=color:#a6be9d>&#34;\&#34;C:\\Program Files\\PowerShell\\7-preview\\pwsh.exe\&#34; -NoExit -Command \&#34;$Host.UI.RawUI.WindowTitle=\\\&#34;Windows Pwsh ğŸ’™ (7 Preview)\\\&#34;\&#34;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;cursorColor&#34;</span>: <span style=color:#a6be9d>&#34;#FFFFFF&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;cursorShape&#34;</span>: <span style=color:#a6be9d>&#34;bar&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;fontFace&#34;</span>: <span style=color:#a6be9d>&#34;Consolas&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;fontSize&#34;</span>: <span style=color:#a6be9d>12</span>,
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;guid&#34;</span>: <span style=color:#a6be9d>&#34;{08a0be98-ff68-4e3a-a054-0fbd3969d3bb}&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;historySize&#34;</span>: <span style=color:#a6be9d>9001</span>,
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;icon&#34;</span>: <span style=color:#a6be9d>&#34;ms-appdata:///roaming/pwsh-32.png&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;name&#34;</span>: <span style=color:#a6be9d>&#34;Windows Pwsh \ud83d\udc99 (7 Preview)&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;padding&#34;</span>: <span style=color:#a6be9d>&#34;0, 0, 0, 0&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;snapOnInput&#34;</span>: <span style=color:#ff636f>true</span>,
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;startingDirectory&#34;</span>: <span style=color:#a6be9d>&#34;C:\\Users\\CharlieInc&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>&#34;useAcrylic&#34;</span>: <span style=color:#ff636f>true</span>
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>å…¶ä¸­çš„ <code>commandline</code> æ˜¯å¯åŠ¨ Shell çš„å‘½ä»¤ï¼Œè¿™é‡Œçš„ç›®çš„æ˜¯å¯åŠ¨ <code>PowerShell 7 Preview</code> å¹¶å°†å…¶æ ‡é¢˜è®¾ç½®æˆ <code>Emoji</code>, è¿™é‡Œ <code>\ud83d\udc99</code> å®é™…ä¸Šæ˜¯ <code>U+1F499</code> å³ &lsquo;ğŸ’™&rsquo;ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>echo -e "\U0001F499"</code> è¾“å‡ºã€‚ä½† Windows Terminal ä¸­ï¼ŒæŠ¥å‘Šäº†å¦‚ä¸‹é”™è¯¯ï¼š</p><p><img src=https://user-images.githubusercontent.com/6904176/58741634-e7558300-844d-11e9-9b7e-dcdff905ffa3.png alt></p><p>æŸ¥çœ‹ä»»åŠ¡ç®¡ç†å™¨å‘½ä»¤è¡Œå¾—åˆ°å¦‚ä¸‹å‘½ä»¤ï¼š</p><p><img src=https://user-images.githubusercontent.com/6904176/58741666-38657700-844e-11e9-8711-e813c22bc137.png alt></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° Pwsh è¿›ç¨‹çš„å‘½ä»¤è¡Œä¸ JSON é…ç½®ä¸­çš„å·²ç»ä¸ä¸€è‡´äº†ï¼š</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-batch data-lang=batch><span style=display:flex><span>:<span style=color:#828b96;font-style:italic>: want</span>
</span></span><span style=display:flex><span><span style=color:#a6be9d>&#34;C:\Program Files\PowerShell\7-preview\pwsh.exe&#34;</span> -NoExit -Command <span style=color:#a6be9d>&#34;$Host.UI.RawUI.WindowTitle=\&#34;</span>Windows Pwsh ğŸ’™ (7 Preview)\<span style=color:#a6be9d>&#34;&#34;</span>
</span></span><span style=display:flex><span>:<span style=color:#828b96;font-style:italic>: got</span>
</span></span><span style=display:flex><span><span style=color:#a6be9d>&#34;C:\Program Files\PowerShell\7-preview\pwsh.exe&#34;</span> -NoExit -Command $Host.UI.RawUI.WindowTitle=<span style=color:#a6be9d>&#34;Windows Pwsh ğŸ’™ (7 Preview)&#34;</span>
</span></span></code></pre></div><p>æŒ‰ç…§ Windows å‘½ä»¤è¡Œè§£æè§„èŒƒ <a href="https://docs.microsoft.com/zh-cn/previous-versions/17w5ykft(v=vs.85)">Parsing C++ Command-Line Arguments </a>ï¼Œpwsh åœ¨è§£æå‘½ä»¤è¡Œæ—¶ï¼Œ è·å¾—åˆ°çš„å‘½ä»¤è¡Œä¼šç¼–æˆå¦‚ä¸‹æ•°ç»„ï¼š</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>ARGV0: C:\Program Files\PowerShell\7-preview\pwsh.exe
</span></span><span style=display:flex><span>ARGV1: -NoExit
</span></span><span style=display:flex><span>ARGV2: -Command
</span></span><span style=display:flex><span>ARGV3: $Host.UI.RawUI.WindowTitle=Windows Pwsh ğŸ’™ (7 Preview)
</span></span></code></pre></div><p>ä½†å®é™…ä¸Šæˆ‘ä»¬é¢„æœŸçš„å‘½ä»¤è¡Œåº”è¯¥æ˜¯ï¼š</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>ARGV0: C:\Program Files\PowerShell\7-preview\pwsh.exe
</span></span><span style=display:flex><span>ARGV1: -NoExit
</span></span><span style=display:flex><span>ARGV2: -Command 
</span></span><span style=display:flex><span>ARGV3: $Host.UI.RawUI.WindowTitle=&#34;Windows Pwsh ğŸ’™ (7 Preview)&#34;
</span></span></code></pre></div><p>è¿™æ ·ä¸€æ¥åœ¨ Pwsh è§£æå‘½ä»¤è¡Œåè®¾ç½® <code>$Host.UI.RawUI.WindowTitle</code> è‚¯å®šå°±ä¼šå‡ºé”™ï¼Œé‚£ä¹ˆé—®é¢˜æ˜¯æ€ä¹ˆäº§ç”Ÿçš„ï¼Ÿ</p><p>æˆ‘ä»¬æŸ¥çœ‹è¿›ç¨‹æ ‘ï¼Œå‘ç° Pwsh çš„çˆ¶è¿›ç¨‹æ˜¯ OpenConsoleï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­çš„ <code>conhost.exe</code>, å³ Windows æ§åˆ¶å°çª—å£ä¸»æœºçš„å¼€æºç‰ˆæœ¬ã€‚</p><p>é€šè¿‡åˆ†æ OpenConsole çš„æºç ï¼Œæˆ‘å‘ç°é—®é¢˜å‡ºç°åœ¨åˆæˆå­è¿›ç¨‹å‘½ä»¤è¡Œå‡ºé”™äº†ï¼š</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#58a1dd>[[nodiscard]]</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>HRESULT</span> <span style=color:#58a1dd>ConsoleArguments</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>_GetClientCommandline</span>(<span style=color:#58a1dd>_Inout_</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>vector</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring</span><span style=color:#ff636f>&gt;&amp;</span> <span style=color:#58a1dd>args</span>, <span style=color:#ff636f>const</span> <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>index</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>skipFirst</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>start</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>args</span>.<span style=color:#58a1dd>begin</span>()<span style=color:#ff636f>+</span><span style=color:#58a1dd>index</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// Erase the first token.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>//  Used to get rid of the explicit commandline token &#34;--&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>skipFirst</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#828b96;font-style:italic>// Make sure that the arg we&#39;re deleting is &#34;--&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>        <span style=color:#58a1dd>FAIL_FAST_IF</span>(<span style=color:#ff636f>!</span>(<span style=color:#58a1dd>CLIENT_COMMANDLINE_ARG</span> <span style=color:#ff636f>==</span> <span style=color:#58a1dd>start</span><span style=color:#ff636f>-&gt;</span><span style=color:#58a1dd>c_str</span>()));
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>args</span>.<span style=color:#58a1dd>erase</span>(<span style=color:#58a1dd>start</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>_clientCommandline</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#34;&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>j</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff636f>for</span> (<span style=color:#58a1dd>j</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>index</span>; <span style=color:#58a1dd>j</span> <span style=color:#ff636f>&lt;</span> <span style=color:#58a1dd>args</span>.<span style=color:#58a1dd>size</span>(); <span style=color:#58a1dd>j</span><span style=color:#ff636f>++</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>_clientCommandline</span> <span style=color:#ff636f>+=</span> <span style=color:#58a1dd>args</span>[<span style=color:#58a1dd>j</span>];
</span></span><span style=display:flex><span>        <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>j</span><span style=color:#ff636f>+</span><span style=color:#a6be9d>1</span> <span style=color:#ff636f>&lt;</span> <span style=color:#58a1dd>args</span>.<span style=color:#58a1dd>size</span>())
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#58a1dd>_clientCommandline</span> <span style=color:#ff636f>+=</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#34; &#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>args</span>.<span style=color:#58a1dd>erase</span>(<span style=color:#58a1dd>args</span>.<span style=color:#58a1dd>begin</span>()<span style=color:#ff636f>+</span><span style=color:#58a1dd>index</span>, <span style=color:#58a1dd>args</span>.<span style=color:#58a1dd>begin</span>()<span style=color:#ff636f>+</span><span style=color:#58a1dd>j</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>S_OK</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ<code>_clientCommandline</code> ä»…ä»…åªæ˜¯ç®€å•ç›¸åŠ ï¼Œæ²¡æœ‰åšä»»ä½•çš„è½¬ä¹‰ï¼Œä¸€æ—¦æŸä¸€ä¸ªå‚æ•°ä¸­éœ€è¦è½¬ä¹‰å´æœªè½¬ä¹‰ï¼Œåˆ™ä¼šå¯¼è‡´å­è¿›ç¨‹å‘½ä»¤è¡Œä¸é¢„æœŸä¸ç›¸ç¬¦ï¼Œäºæ˜¯æˆ‘ä¾¿æ‰“å¼€äº† Issue: <a href=https://github.com/microsoft/terminal/issues/1090>Bug Report: The conhost command line is not properly escaped #1090 </a>ï¼Œç”±äºæˆ‘åœ¨å®ç° <a href=https://github.com/M2Team/Privexec>Privexec/wsudo</a>ï¼Œå·²ç»æœ‰è¿‡æ­¤ç±»ç»éªŒï¼Œè¿˜åœ¨æ­¤ Issue ä¸­æ·»åŠ äº†ä¸€æ®µä»£ç å‘ŠçŸ¥å¦‚ä½•è½¬ä¹‰ï¼Œä½†æœ€åˆ Windows Terminal çš„æ„è§æ˜¯ç›´æ¥ä½¿ç”¨ <code>ConPTY</code> æ›¿æ¢ <code>Conhost</code>ï¼Œä¹Ÿå°±æ˜¯çœå»äº†ä½¿ç”¨ Conhost ä½œä¸º ConPTYï¼Œå¥½å§ï¼Œè¿™æœ‰ç‚¹ç»•ï¼Œç›®å‰ Windows Terminal ä¾ç„¶ä½¿ç”¨ Conhost åˆ›å»º ConPTY, ç„¶åï¼ŒWindowsTerminal.exe é€šè¿‡ä¸‰æ¡ç®¡é“è¿æ¥ Conhost.exe åˆ†åˆ«æ˜¯è¾“å…¥è¾“å‡ºå’Œä¿¡å·ç®¡é“ã€‚åˆ›å»º <a href=https://github.com/microsoft/terminal/blob/master/src/inc/conpty.h>Conhost-ConPTY</a> çš„ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#828b96;font-style:italic>// https://github.com/rprichard/win32-console-docs
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// https://github.com/microsoft/terminal/blob/master/src/server/Entrypoints.cpp
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// https://github.com/microsoft/terminal/blob/master/src/cascadia/TerminalConnection/ConptyConnection.cpp
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// https://github.com/microsoft/terminal/blob/master/src/server/DeviceComm.cpp
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// https://github.com/microsoft/terminal/blob/master/src/cascadia/TerminalConnection/ConhostConnection.cpp
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// https://github.com/microsoft/terminal/blob/master/src/inc/conpty.h
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ff636f>__declspec</span>(<span style=color:#58a1dd>noinline</span>) <span style=color:#ff636f>inline</span> <span style=color:#58a1dd>HRESULT</span> <span style=color:#58a1dd>CreateConPty</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring</span><span style=color:#ff636f>&amp;</span> <span style=color:#58a1dd>cmdline</span>,
</span></span><span style=display:flex><span>                                                 <span style=color:#ff636f>const</span> <span style=color:#ff636f>unsigned</span> <span style=color:#ff636f>short</span> <span style=color:#58a1dd>w</span>,
</span></span><span style=display:flex><span>                                                 <span style=color:#ff636f>const</span> <span style=color:#ff636f>unsigned</span> <span style=color:#ff636f>short</span> <span style=color:#58a1dd>h</span>,
</span></span><span style=display:flex><span>                                                 <span style=color:#58a1dd>HANDLE</span><span style=color:#ff636f>*</span> <span style=color:#ff636f>const</span> <span style=color:#58a1dd>hInput</span>,
</span></span><span style=display:flex><span>                                                 <span style=color:#58a1dd>HANDLE</span><span style=color:#ff636f>*</span> <span style=color:#ff636f>const</span> <span style=color:#58a1dd>hOutput</span>,
</span></span><span style=display:flex><span>                                                 <span style=color:#58a1dd>HANDLE</span><span style=color:#ff636f>*</span> <span style=color:#ff636f>const</span> <span style=color:#58a1dd>hSignal</span>,
</span></span><span style=display:flex><span>                                                 <span style=color:#58a1dd>PROCESS_INFORMATION</span><span style=color:#ff636f>*</span> <span style=color:#ff636f>const</span> <span style=color:#58a1dd>piPty</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// Create some anon pipes so we can pass handles down and into the console.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>// IMPORTANT NOTE:
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>// We&#39;re creating the pipe here with un-inheritable handles, then marking
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>//      the conhost sides of the pipes as inheritable. We do this because if
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>//      the entire pipe is marked as inheritable, when we pass the handles
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>//      to CreateProcess, at some point the entire pipe object is copied to
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>//      the conhost process, which includes the terminal side of the pipes
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>//      (_inPipe and _outPipe). This means that if we die, there&#39;s still
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>//      outstanding handles to our side of the pipes, and those handles are
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>//      in conhost, despite conhost being unable to reference those handles
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>//      and close them.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>// CRITICAL: Close our side of the handles. Otherwise you&#39;ll get the same
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>//      problem if you close conhost, but not us (the terminal).
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#58a1dd>HANDLE</span> <span style=color:#58a1dd>outPipeConhostSide</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>HANDLE</span> <span style=color:#58a1dd>inPipeConhostSide</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>HANDLE</span> <span style=color:#58a1dd>signalPipeConhostSide</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>SECURITY_ATTRIBUTES</span> <span style=color:#58a1dd>sa</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>sa</span> <span style=color:#ff636f>=</span> { <span style=color:#a6be9d>0</span> };
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>sa</span>.<span style=color:#58a1dd>nLength</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>sizeof</span>(<span style=color:#58a1dd>sa</span>);
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>sa</span>.<span style=color:#58a1dd>bInheritHandle</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>FALSE</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>sa</span>.<span style=color:#58a1dd>lpSecurityDescriptor</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>nullptr</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>CreatePipe</span>(<span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>inPipeConhostSide</span>, <span style=color:#58a1dd>hInput</span>, <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>sa</span>, <span style=color:#a6be9d>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>CreatePipe</span>(<span style=color:#58a1dd>hOutput</span>, <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>outPipeConhostSide</span>, <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>sa</span>, <span style=color:#a6be9d>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// Mark inheritable for signal handle when creating. It&#39;ll have the same value on the other side.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#58a1dd>sa</span>.<span style=color:#58a1dd>bInheritHandle</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>TRUE</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>CreatePipe</span>(<span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>signalPipeConhostSide</span>, <span style=color:#58a1dd>hSignal</span>, <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>sa</span>, <span style=color:#a6be9d>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>SetHandleInformation</span>(<span style=color:#58a1dd>inPipeConhostSide</span>, <span style=color:#58a1dd>HANDLE_FLAG_INHERIT</span>, <span style=color:#a6be9d>1</span>);
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>SetHandleInformation</span>(<span style=color:#58a1dd>outPipeConhostSide</span>, <span style=color:#58a1dd>HANDLE_FLAG_INHERIT</span>, <span style=color:#a6be9d>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring</span> <span style=color:#58a1dd>conhostCmdline</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#34;conhost.exe&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>conhostCmdline</span> <span style=color:#ff636f>+=</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#34; --headless&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstringstream</span> <span style=color:#58a1dd>ss</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>w</span> <span style=color:#ff636f>!=</span> <span style=color:#a6be9d>0</span> <span style=color:#ff636f>&amp;&amp;</span> <span style=color:#58a1dd>h</span> <span style=color:#ff636f>!=</span> <span style=color:#a6be9d>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>ss</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#34; --width &#34;</span> <span style=color:#ff636f>&lt;&lt;</span> (<span style=color:#ff636f>unsigned</span> <span style=color:#ff636f>long</span>)<span style=color:#58a1dd>w</span>;
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>ss</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#34; --height &#34;</span> <span style=color:#ff636f>&lt;&lt;</span> (<span style=color:#ff636f>unsigned</span> <span style=color:#ff636f>long</span>)<span style=color:#58a1dd>h</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>ss</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#34; --signal 0x&#34;</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>hex</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#58a1dd>HandleToUlong</span>(<span style=color:#58a1dd>signalPipeConhostSide</span>);
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>conhostCmdline</span> <span style=color:#ff636f>+=</span> <span style=color:#58a1dd>ss</span>.<span style=color:#58a1dd>str</span>();
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>conhostCmdline</span> <span style=color:#ff636f>+=</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#34; -- &#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>conhostCmdline</span> <span style=color:#ff636f>+=</span> <span style=color:#58a1dd>cmdline</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>STARTUPINFO</span> <span style=color:#58a1dd>si</span> <span style=color:#ff636f>=</span> { <span style=color:#a6be9d>0</span> };
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>si</span>.<span style=color:#58a1dd>cb</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>sizeof</span>(<span style=color:#58a1dd>STARTUPINFOW</span>);
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>si</span>.<span style=color:#58a1dd>hStdInput</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>inPipeConhostSide</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>si</span>.<span style=color:#58a1dd>hStdOutput</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>outPipeConhostSide</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>si</span>.<span style=color:#58a1dd>hStdError</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>outPipeConhostSide</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>si</span>.<span style=color:#58a1dd>dwFlags</span> <span style=color:#ff636f>|=</span> <span style=color:#58a1dd>STARTF_USESTDHANDLES</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>unique_ptr</span><span style=color:#ff636f>&lt;</span><span style=color:#ff636f>wchar_t</span>[]<span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>mutableCommandline</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>make_unique</span><span style=color:#ff636f>&lt;</span><span style=color:#ff636f>wchar_t</span>[]<span style=color:#ff636f>&gt;</span>(<span style=color:#58a1dd>conhostCmdline</span>.<span style=color:#58a1dd>length</span>() <span style=color:#ff636f>+</span> <span style=color:#a6be9d>1</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#58a1dd>mutableCommandline</span> <span style=color:#ff636f>==</span> <span style=color:#ff636f>nullptr</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> <span style=color:#58a1dd>E_OUTOFMEMORY</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>HRESULT</span> <span style=color:#58a1dd>hr</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>StringCchCopy</span>(<span style=color:#58a1dd>mutableCommandline</span>.<span style=color:#58a1dd>get</span>(), <span style=color:#58a1dd>conhostCmdline</span>.<span style=color:#58a1dd>length</span>() <span style=color:#ff636f>+</span> <span style=color:#a6be9d>1</span>, <span style=color:#58a1dd>conhostCmdline</span>.<span style=color:#58a1dd>c_str</span>());
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#ff636f>!</span><span style=color:#58a1dd>SUCCEEDED</span>(<span style=color:#58a1dd>hr</span>))
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> <span style=color:#58a1dd>hr</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>fSuccess</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>!!</span><span style=color:#58a1dd>CreateProcessW</span>(
</span></span><span style=display:flex><span>        <span style=color:#ff636f>nullptr</span>,
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>mutableCommandline</span>.<span style=color:#58a1dd>get</span>(),
</span></span><span style=display:flex><span>        <span style=color:#ff636f>nullptr</span>, <span style=color:#828b96;font-style:italic>// lpProcessAttributes
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>        <span style=color:#ff636f>nullptr</span>, <span style=color:#828b96;font-style:italic>// lpThreadAttributes
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>        <span style=color:#58a1dd>true</span>, <span style=color:#828b96;font-style:italic>// bInheritHandles
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>        <span style=color:#a6be9d>0</span>, <span style=color:#828b96;font-style:italic>// dwCreationFlags
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>        <span style=color:#ff636f>nullptr</span>, <span style=color:#828b96;font-style:italic>// lpEnvironment
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>        <span style=color:#ff636f>nullptr</span>, <span style=color:#828b96;font-style:italic>// lpCurrentDirectory
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>        <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>si</span>, <span style=color:#828b96;font-style:italic>// lpStartupInfo
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>        <span style=color:#58a1dd>piPty</span> <span style=color:#828b96;font-style:italic>// lpProcessInformation
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>CloseHandle</span>(<span style=color:#58a1dd>inPipeConhostSide</span>);
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>CloseHandle</span>(<span style=color:#58a1dd>outPipeConhostSide</span>);
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>CloseHandle</span>(<span style=color:#58a1dd>signalPipeConhostSide</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#58a1dd>fSuccess</span> <span style=color:#ff636f>?</span> <span style=color:#58a1dd>S_OK</span> : <span style=color:#58a1dd>HRESULT_FROM_WIN32</span>(<span style=color:#58a1dd>GetLastError</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä½†ç”±äº <a href=https://github.com/microsoft/terminal/issues/1131>Switch from ConhostConnection to the official ConPTY API #1131</a> ä¾èµ– <a href=https://github.com/microsoft/terminal/issues/1130><code>winconpty.c</code></a>ï¼Œä½† <code>winconpty.c</code> è¿Ÿè¿Ÿæ²¡æœ‰å¼€æºï¼Œå› æ­¤ï¼Œæ­¤é—®é¢˜ä¸€ç›´æ²¡æœ‰å¾—åˆ°è§£å†³ï¼Œåæ¥éšç€ Windows Terminal çš„å…¬å¼€é¢„è§ˆï¼Œæ­¤é—®é¢˜ä¹Ÿä¸æ–­ç”±ç”¨æˆ·æŠ¥å‘Šã€‚äºæ˜¯æˆ‘æäº¤äº†ä¸€ä¸ª <a href=https://github.com/microsoft/terminal/pull/1815>Fix The conhost command line is not properly escaped</a>, è¯•å›¾ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œç»è¿‡ä¸€ä¸ªæ˜ŸæœŸçš„ç­‰å¾…ï¼ŒPR ç»ˆäºè¢«åˆå¹¶ï¼Œç›®å‰ä½¿ç”¨æœ€æ–°æºç æ„å»ºçš„ Windows Terminal å·²ç»èƒ½å¤ŸæŒ‰ç…§é¢„æœŸå·¥ä½œï¼Œæˆ‘çš„ Windows Terminal é…ç½®æ–‡ä»¶ä¹Ÿå·²ç»æ›´æ–°ï¼š<a href=https://gist.github.com/fcharlie/7530d36175bc5249f1ae92be536238cd>https://gist.github.com/fcharlie/7530d36175bc5249f1ae92be536238cd</a></p><p>è¿™ä¸ªé—®é¢˜åœ¨ conhost ä¸­éƒ½èƒ½å‡ºç°ï¼Œå¯èƒ½å¹¶ä¸æ˜¯ä¸ªä¾‹ï¼Œé‚£ä¹ˆåº”è¯¥å¾ˆå¤šè½¯ä»¶éƒ½ä¼šå‡ºç°å‘½ä»¤è¡Œæ­£ç¡®è½¬ä¹‰ã€‚</p><h2 id=windows-ucrt-çš„è¿›ç¨‹å¯åŠ¨å‡½æ•°>Windows UCRT çš„è¿›ç¨‹å¯åŠ¨å‡½æ•°</h2><p>åœ¨ Windows ä¸­ï¼Œé€šå¸¸ç¼–å†™ C ç¨‹åºå¯åŠ¨è¿›ç¨‹é™¤äº†ä½¿ç”¨ <code>CreateProcess</code> API ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ <code>_spawn*</code> <code>_exec*</code> ä¹‹ç±»çš„å‡½æ•°ï¼Œä½†åœ¨ Windows 1903ï¼ˆ10.0.18362.0ï¼‰UCRT çš„æºç ä¸­ï¼Œéƒ½æ˜¯è°ƒç”¨ <code>common_spawnvp</code> å®ç°ï¼Œè€Œå‘½ä»¤è¡Œåˆæˆçš„ä»£ç æ˜¯é€šè¿‡å¦‚ä¸‹å‡½æ•°å®ç°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#828b96;font-style:italic>// &#34;C:\Program Files (x86)\Windows Kits\10\Source\10.0.18362.0\ucrt\exec\cenvarg.cpp&#34; +24
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// Converts a main()-style argv arguments vector into a command line.  On success,
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// returns a pointer to the newly constructed arguments block; the caller is
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// responsible for freeing the string.  On failure, returns null and sets errno.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#ff636f>typename</span> <span style=color:#58a1dd>Character</span><span style=color:#ff636f>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>static</span> <span style=color:#58a1dd>errno_t</span> <span style=color:#ff636f>__cdecl</span> <span style=color:#58a1dd>construct_command_line</span>(
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>Character</span> <span style=color:#ff636f>const</span><span style=color:#ff636f>*</span> <span style=color:#ff636f>const</span><span style=color:#ff636f>*</span> <span style=color:#ff636f>const</span> <span style=color:#58a1dd>argv</span>,
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>Character</span><span style=color:#ff636f>**</span>             <span style=color:#ff636f>const</span> <span style=color:#58a1dd>command_line_result</span>
</span></span><span style=display:flex><span>    ) <span style=color:#ff636f>throw</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff636f>typedef</span> <span style=color:#58a1dd>__crt_char_traits</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>Character</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>traits</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>*</span><span style=color:#58a1dd>command_line_result</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>nullptr</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// Compute the number of bytes required to store the arguments in argv in a
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#828b96;font-style:italic>// command line string (including spaces between arguments and a terminator):
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#58a1dd>size_t</span> <span style=color:#ff636f>const</span> <span style=color:#58a1dd>command_line_count</span> <span style=color:#ff636f>=</span> [<span style=color:#ff636f>&amp;</span>]
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>n</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff636f>for</span> (<span style=color:#58a1dd>Character</span> <span style=color:#ff636f>const</span><span style=color:#ff636f>*</span> <span style=color:#ff636f>const</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>it</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>argv</span>; <span style=color:#ff636f>*</span><span style=color:#58a1dd>it</span>; <span style=color:#58a1dd>n</span> <span style=color:#ff636f>+=</span> <span style=color:#58a1dd>traits</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>tcslen</span>(<span style=color:#ff636f>*</span><span style=color:#58a1dd>it</span><span style=color:#ff636f>++</span>) <span style=color:#ff636f>+</span> <span style=color:#a6be9d>1</span>) { }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#828b96;font-style:italic>// If there were no arguments, return 1 so that we can return an empty
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>        <span style=color:#828b96;font-style:italic>// string:
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>        <span style=color:#ff636f>return</span> <span style=color:#58a1dd>__max</span>(<span style=color:#58a1dd>n</span>, <span style=color:#a6be9d>1</span>);
</span></span><span style=display:flex><span>    }();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>__crt_unique_heap_ptr</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>Character</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>command_line</span>(<span style=color:#58a1dd>_calloc_crt_t</span>(<span style=color:#58a1dd>Character</span>, <span style=color:#58a1dd>command_line_count</span>));
</span></span><span style=display:flex><span>    <span style=color:#ff636f>if</span> (<span style=color:#ff636f>!</span><span style=color:#58a1dd>command_line</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>__acrt_errno_map_os_error</span>(<span style=color:#58a1dd>ERROR_NOT_ENOUGH_MEMORY</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> <span style=color:#58a1dd>errno</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>ENOMEM</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>Character</span> <span style=color:#ff636f>const</span><span style=color:#ff636f>*</span> <span style=color:#ff636f>const</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>source_it</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>argv</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>Character</span><span style=color:#ff636f>*</span>              <span style=color:#58a1dd>result_it</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>command_line</span>.<span style=color:#58a1dd>get</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// If there are no arguments, just return the empty string:
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#ff636f>if</span> (<span style=color:#ff636f>*</span><span style=color:#58a1dd>source_it</span> <span style=color:#ff636f>==</span> <span style=color:#a6be9d>&#39;\0&#39;</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff636f>*</span><span style=color:#58a1dd>command_line_result</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>command_line</span>.<span style=color:#58a1dd>detach</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff636f>return</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// Copy the arguments, separated by spaces:
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#ff636f>while</span> (<span style=color:#ff636f>*</span><span style=color:#58a1dd>source_it</span> <span style=color:#ff636f>!=</span> <span style=color:#a6be9d>&#39;\0&#39;</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>_ERRCHECK</span>(<span style=color:#58a1dd>traits</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>tcscpy_s</span>(<span style=color:#58a1dd>result_it</span>, <span style=color:#58a1dd>command_line_count</span> <span style=color:#ff636f>-</span> (<span style=color:#58a1dd>result_it</span> <span style=color:#ff636f>-</span> <span style=color:#58a1dd>command_line</span>.<span style=color:#58a1dd>get</span>()), <span style=color:#ff636f>*</span><span style=color:#58a1dd>source_it</span>));
</span></span><span style=display:flex><span>        <span style=color:#58a1dd>result_it</span> <span style=color:#ff636f>+=</span> <span style=color:#58a1dd>traits</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>tcslen</span>(<span style=color:#ff636f>*</span><span style=color:#58a1dd>source_it</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff636f>*</span><span style=color:#58a1dd>result_it</span><span style=color:#ff636f>++</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>&#39; &#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff636f>++</span><span style=color:#58a1dd>source_it</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// Replace the last space with a terminator:
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#58a1dd>result_it</span>[<span style=color:#ff636f>-</span><span style=color:#a6be9d>1</span>] <span style=color:#ff636f>=</span> <span style=color:#a6be9d>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff636f>*</span><span style=color:#58a1dd>command_line_result</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>command_line</span>.<span style=color:#58a1dd>detach</span>();
</span></span><span style=display:flex><span>    <span style=color:#ff636f>return</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å®é™…ä¸Šè¿™ä¸ª UCRT å‡ºç°æ­¤é—®é¢˜ï¼Œä¿®å¤çš„å¯èƒ½æ€§è¦å°äº Windows Terminalï¼Œæ¯•ç«Ÿæ²¡å•¥æ¸ é“ã€‚è¿™å’Œ SSH çš„å‘½ä»¤è¡Œè½¬ä¹‰ä¸€æ ·éš¾ä¿®ã€‚è¿˜æœ‰ä¸€äº›å…¶ä»–è½¯ä»¶ä¹Ÿå­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚ <a href=https://github.com/DaanDeMeyer/reproc/issues/18>reproc</a>ã€‚</p><h2 id=è¯´ä¸å®Œçš„è½¬ä¹‰>è¯´ä¸å®Œçš„è½¬ä¹‰</h2><p>è½¬ä¹‰é—®é¢˜ä¸ä»…ä»…æ˜¯å‘½ä»¤è¡Œéœ€è¦æ³¨æ„çš„ï¼Œåœ¨æŸ¥è¯¢æ•°æ®åº“ï¼Œè§£æç½‘ç»œè¯·æ±‚ï¼Œæ–¹æ–¹é¢é¢éƒ½éœ€è¦æ³¨æ„åˆ°è½¬ä¹‰é—®é¢˜ï¼Œä¸€äº›å®‰å…¨æ¼æ´ä¹Ÿæ˜¯æœ‰ç¼ºä¹è½¬ä¹‰å¯¼è‡´çš„ã€‚å†™ä»£ç è™½æ˜“ï¼Œå†™å¥½ä»£ç éš¾ã€‚</p><p>è¿™ä¸ªé—®é¢˜åœ¨ Windows ä¸­å‘ç”Ÿé¢‘ç‡è¾ƒé«˜çš„åŸå› ä¹‹ä¸€æ˜¯åœ¨ Windows è¿›ç¨‹ PEB ä¸­ï¼Œå‘½ä»¤è¡Œä¸ POSIX çš„å‘½ä»¤è¡Œä¿å­˜æ ¼å¼å·®å¼‚ï¼ŒWindows å‘½ä»¤è¡Œå‚æ•°æ˜¯ <code>CommandLine</code> å½¢å¼ï¼Œè€Œ POSIX ä»¥ Linux ä¸ºä¾‹æ˜¯ <code>Argv</code>ã€‚å†…å­˜ä¸­å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>WinCommandLine</span><span style=color:#ff636f>=</span><span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>\&#34;</span><span style=color:#a6be9d>C:</span><span style=color:#a6be9d>\\</span><span style=color:#a6be9d>Program Files</span><span style=color:#a6be9d>\\</span><span style=color:#a6be9d>PowerShell</span><span style=color:#a6be9d>\\</span><span style=color:#a6be9d>7-preview</span><span style=color:#a6be9d>\\</span><span style=color:#a6be9d>pwsh.exe</span><span style=color:#a6be9d>\&#34;</span><span style=color:#a6be9d> -NoExit -Command </span><span style=color:#a6be9d>\&#34;</span><span style=color:#a6be9d>$Host.UI.RawUI.WindowTitle=</span><span style=color:#a6be9d>\\\&#34;</span><span style=color:#a6be9d>Windows Pwsh ğŸ’™ (7 Preview)</span><span style=color:#a6be9d>\\\&#34;\&#34;\0</span><span style=color:#a6be9d>&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>argvblock</span><span style=color:#ff636f>=</span><span style=color:#a6be9d>&#34;pwsh</span><span style=color:#a6be9d>\0</span><span style=color:#a6be9d>-NoExit</span><span style=color:#a6be9d>\0</span><span style=color:#a6be9d>-Command</span><span style=color:#a6be9d>\0\&#34;</span><span style=color:#a6be9d>$Host.UI.RawUI.WindowTitle=</span><span style=color:#a6be9d>\&#34;</span><span style=color:#a6be9d>Windows Pwsh ğŸ’™ (7 Preview)</span><span style=color:#a6be9d>\&#34;\0</span><span style=color:#a6be9d>&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>//char *const argv[]={0x0100,...};
</span></span></span></code></pre></div><p>å› æ­¤ï¼Œä»¥ Argv çš„è¿™ç§å‘½ä»¤è¡Œå½¢å¼åœ¨ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨çœŸæ­£å¯åŠ¨è¿›ç¨‹æ—¶ï¼ŒWindows ä»éœ€è¦ä¸€æ¬¡è½¬æ¢ï¼Œè¿™å°±å®¹æ˜“å¸¦æ¥é—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯å‘½ä»¤è¡Œè½¬ä¹‰é—®é¢˜åœ¨ Windows å¹³å°å¤ªæ¯”è¾ƒå¤šçš„åŸå› ã€‚</p><h2 id=æœ€å>æœ€å</h2><p>Windows Terminal å¼€æºè¿˜æ˜¯éå¸¸ä¸é”™çš„ï¼Œå‚ä¸åˆ°å…¶ä¸­æ”¹è¿›åœ¨ Windows ç³»ç»Ÿçš„å¼€å‘ä½“éªŒæ„Ÿè§‰å¾ˆä¸é”™ï¼Œè€Œå…¶ä¸­çš„ OpenConsole æºç ä¹Ÿè®©æˆ‘æ›´åŠ æ·±å…¥äº†è§£äº† Windows Console çš„ä¸€äº›åŸç†ã€‚</p><p>OpenConsole ç›®å‰å¯ä»¥å¼€å¯ æ³¨å†Œè¡¨é€‰é¡¹ <code>HKCU\Console\UseDx</code>=<code>DWORD(1)</code> åˆ‡æ¢åˆ°ä½¿ç”¨ DirectWrite æ¸²æŸ“å­—ä½“ï¼Œä½†æˆ‘ç›®å‰ï¼ˆ2019-07-20ï¼‰æµ‹è¯•è™½ç„¶ä½¿ç”¨ DirectWrite æ¸²æŸ“ï¼Œä½† Emoji æ— æ³•æ˜¾ç¤ºï¼Œè¿™ä¸ªé—®é¢˜æˆ‘å°†è¿›ä¸€æ­¥è·Ÿè¸ªã€‚</p><p>æ§åˆ¶å°å›¢é˜Ÿè¿˜åœ¨ Windows Terminal æºç ä¸­æ·»åŠ äº†ä¸€ä¸ª Console æ§ä»¶ï¼Œè¿™æ ·ä¸€æ¥ï¼Œç¬¬ä¸‰æ–¹ç¨‹åºä¸­é›†æˆæ§åˆ¶å°çª—å£å°†æ›´åŠ å®¹æ˜“ã€‚Visual Studio <a href=https://github.com/microsoft/WhackWhackTerminal>WhackWhackTerminal</a> çš„ä½œè€… Daniel Griffen è¿˜å¢åŠ äº†ä¸€äº› PR, å®ç° WPF æ§åˆ¶å°æ§ä»¶ï¼Œè¿™å¯ä»¥é¢„è§ï¼Œå¯èƒ½å°†æ–°çš„æ§åˆ¶å°é›†æˆåˆ° Visual Studioã€‚</p><p>ä¸‹é¢æ˜¯ä¸€äº›æ§åˆ¶å°çš„æ–‡æ¡£å’Œå…³é”®ä»£ç ï¼š</p><ul><li>WinPTY ä½œè€…çš„æ§åˆ¶å°æ–‡æ¡£ï¼š <a href=https://github.com/rprichard/win32-console-docs>Console Handles and Standard Handles</a></li><li>Conhost å¯åŠ¨è¿›ç¨‹å¹¶åˆ›å»º ConDrv è®¾å¤‡ï¼š<a href=https://github.com/microsoft/terminal/blob/master/src/server/Entrypoints.cpp>https://github.com/microsoft/terminal/blob/master/src/server/Entrypoints.cpp</a></li><li>Conhost è¯»å†™å†…æ ¸å¯¹è±¡(è¯»å†™æ§åˆ¶å°ç¨‹åºçš„è¾“å…¥è¾“å‡º): <a href=https://github.com/microsoft/terminal/blob/master/src/server/DeviceComm.cpp>https://github.com/microsoft/terminal/blob/master/src/server/DeviceComm.cpp</a></li><li>Windows Terminal è¿æ¥å™¨ <a href=https://github.com/microsoft/terminal/blob/master/src/cascadia/TerminalConnection/ConptyConnection.cpp>ConptyConnection</a> åŠ <a href=https://github.com/microsoft/terminal/blob/master/src/cascadia/TerminalConnection/ConhostConnection.cpp>ConhostConnection</a></li></ul><hr width=100% id=EOF><p style=color:#777>Last modified on 2019-07-20</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/2019/2019-07-30-gnk-server-side/>Next<br>æœåŠ¡ç«¯ Git é’©å­çš„å¦™ç”¨
</a><a class=older-posts href=/posts/2019/2019-07-09-july-tech-sharing/>Previous<br>ä¸ƒæœˆçš„æŠ€æœ¯åˆ†äº«</a></nav><div class=post-comment-wrapper></div></div></div></div></div><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://forcemz.net/><div class=nav-title>æ±ŸäºŒåä¸‰çš„æ€è€ƒ</div><div class=nav-subtitle>Themed by Diary.</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>å½’æ¡£
</a><a class="a-block nav-link-item false" href=/categories>åˆ†ç±»
</a><a class="a-block nav-link-item false" href=/tags>æ ‡ç­¾
</a><a class="a-block nav-link-item false" href=/about>å…³äº
</a><a class="a-block nav-link-item false" href=/index.xml>RSS Feed</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><div id=extraContainer class=extra-container><div class=toc-wrapper><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e8%83%8c%e6%99%af class=nav-èƒŒæ™¯>èƒŒæ™¯</a></li><li><a href=#windows-terminal-%e7%9a%84%e5%91%bd%e4%bb%a4%e8%a1%8c%e8%bd%ac%e4%b9%89%e9%94%99%e8%af%af class=nav-windows-terminal-çš„å‘½ä»¤è¡Œè½¬ä¹‰é”™è¯¯>Windows Terminal çš„å‘½ä»¤è¡Œè½¬ä¹‰é”™è¯¯</a></li><li><a href=#windows-ucrt-%e7%9a%84%e8%bf%9b%e7%a8%8b%e5%90%af%e5%8a%a8%e5%87%bd%e6%95%b0 class=nav-windows-ucrt-çš„è¿›ç¨‹å¯åŠ¨å‡½æ•°>Windows UCRT çš„è¿›ç¨‹å¯åŠ¨å‡½æ•°</a></li><li><a href=#%e8%af%b4%e4%b8%8d%e5%ae%8c%e7%9a%84%e8%bd%ac%e4%b9%89 class=nav-è¯´ä¸å®Œçš„è½¬ä¹‰>è¯´ä¸å®Œçš„è½¬ä¹‰</a></li><li><a href=#%e6%9c%80%e5%90%8e class=nav-æœ€å>æœ€å</a></li></ul></div></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up
</i></a><a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><script src=/js/journal.js></script></body></html>