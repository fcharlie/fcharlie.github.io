<!doctype html><html lang=en><head><title>字符串格式化漫谈</title>
<meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=5" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><script src=/js/toc.js></script><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Material+Icons"></head><body><div id=app><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>归档
</a><a class="a-block drawer-menu-item false" href=/categories>分类
</a><a class="a-block drawer-menu-item false" href=/tags>标签
</a><a class="a-block drawer-menu-item false" href=/about>关于
</a><a class="a-block drawer-menu-item false" href=/index.xml>RSS Feed</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><li><a href=#%e5%89%8d%e8%a8%80 class=nav-前言>前言</a></li><ul><li><a href=#%e6%a0%bc%e5%bc%8f%e5%8c%96%e5%86%85%e5%b9%95 class=nav-格式化内幕>格式化内幕</a></li><li><a href=#c-style-%e6%a0%bc%e5%bc%8f%e5%8c%96%e7%9a%84%e7%bc%ba%e9%99%b7 class=nav-c-style-格式化的缺陷>C-Style 格式化的缺陷</a></li><li><a href=#%e5%ae%89%e5%85%a8%e6%a0%bc%e5%bc%8f%e5%8c%96%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88 class=nav-安全格式化解决方案>安全格式化解决方案</a></li><ul><li><a href=#%e7%bc%96%e8%af%91%e5%99%a8%e7%9a%84%e5%8f%82%e6%95%b0%e5%8c%b9%e9%85%8d%e6%a3%80%e6%9f%a5 class=nav-编译器的参数匹配检查>编译器的参数匹配检查</a></li><li><a href=#%e5%8f%98%e5%8f%82%e5%87%bd%e6%95%b0%e6%a8%a1%e6%9d%bf%e7%9a%84%e8%be%85%e5%8a%a9 class=nav-变参函数模板的辅助>变参函数模板的辅助</a></li></ul><li><a href=#%e7%8e%b0%e4%bb%a3-c-%e6%a0%bc%e5%bc%8f%e5%8c%96%e5%ba%93 class=nav-现代-c-格式化库>现代 C++ 格式化库</a></li><ul><li><a href=#%e7%a7%af%e6%9e%81%e5%85%a5%e6%a0%87%e5%87%86%e7%9a%84-fmtlib class=nav-积极入标准的-fmtlib>积极入标准的 fmtlib</a></li><li><a href=#facebook-folly-format class=nav-facebook-folly-format>Facebook folly format</a></li><li><a href=#google-abseil-strformat class=nav-google-abseil-strformat>Google Abseil StrFormat</a></li></ul><li><a href=#%e5%ad%97%e7%ac%a6%e4%b8%b2%e5%8e%bb%e6%a0%bc%e5%bc%8f%e5%8c%96 class=nav-字符串去格式化>字符串去格式化</a></li><ul><li><a href=#substitute class=nav-substitute>Substitute</a></li><li><a href=#strcat class=nav-strcat>StrCat</a></li></ul><li><a href=#%e5%bc%82%e6%ad%a5%e4%bf%a1%e5%8f%b7%e5%ae%89%e5%85%a8%e7%9a%84%e5%ad%97%e7%ac%a6%e4%b8%b2%e6%a0%bc%e5%bc%8f%e5%8c%96 class=nav-异步信号安全的字符串格式化>异步信号安全的字符串格式化</a></li><li><a href=#bela-strformat class=nav-bela-strformat>Bela StrFormat</a></li><li><a href=#%e7%bb%93%e5%b0%be class=nav-结尾>结尾</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu
</i></button>
<a id=navTitle class=navbar-brand href=https://forcemz.net/>江二十三的思考
</a><button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://forcemz.net/><div class=single-column-header-title>江二十三的思考</div><div class=single-column-header-subtitle>Themed by Diary.</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>字符串格式化漫谈<div class=post-meta><time itemprop=datePublished>2019-04-29 10:00
</time><i class=material-icons>folder</i>
<a href=/categories/cxx>cxx</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h1 id=前言>前言</h1><p>春风化雨，万物复苏，编程始于 <code>Hello world</code>，C 语言的 Hello world 可如下，同样 C++ 亦可如下:</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#828b96;font-style:italic>#include</span> <span style=color:#828b96;font-style:italic>&lt;stdio.h&gt;</span><span style=color:#828b96;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>main</span>() {
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>printf</span>(<span style=color:#a6be9d>&#34;Hello World!&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>printf 函数类型为：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>printf</span>(<span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>fmt</span>,...);
</span></span></code></pre></div><p>按照此声明我们可以格式化输出：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#828b96;font-style:italic>#include</span> <span style=color:#828b96;font-style:italic>&lt;stdio.h&gt;</span><span style=color:#828b96;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>main</span>() {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>name</span><span style=color:#ff636f>=</span><span style=color:#a6be9d>&#34;Tony Stark&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>printf</span>(<span style=color:#a6be9d>&#34;Hello %s</span><span style=color:#a6be9d>\n</span><span style=color:#a6be9d>&#34;</span>,<span style=color:#58a1dd>name</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>使用 C 编译器 Clang/MSVC/GCC 将其编译运行，在终端或者命令行中会输出如下结果：</p><blockquote><p>$ Hello Tony Stark</p></blockquote><p>printf 函数家族声明如下：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#828b96;font-style:italic>// https://en.cppreference.com/w/cpp/header/cstdio
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>printf</span>( <span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>format</span>, ... );
</span></span><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>fprintf</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>FILE</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>stream</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>format</span>, ... );
</span></span><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>sprintf</span>( <span style=color:#ff636f>char</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>buffer</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>format</span>, ... );
</span></span><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>snprintf</span>( <span style=color:#ff636f>char</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>buffer</span>, <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>buf_size</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>format</span>, ... );
</span></span><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>vprintf</span>( <span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>format</span>, <span style=color:#58a1dd>va_list</span> <span style=color:#58a1dd>vlist</span> );
</span></span><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>vfprintf</span>( <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>FILE</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>stream</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>format</span>, <span style=color:#58a1dd>va_list</span> <span style=color:#58a1dd>vlist</span> );
</span></span><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>vsprintf</span>( <span style=color:#ff636f>char</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>buffer</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>format</span>, <span style=color:#58a1dd>va_list</span> <span style=color:#58a1dd>vlist</span> );
</span></span><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>vsnprintf</span>( <span style=color:#ff636f>char</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>buffer</span>, <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>buf_size</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>format</span>, <span style=color:#58a1dd>va_list</span> <span style=color:#58a1dd>vlist</span> );
</span></span></code></pre></div><p>如果我们需要格式化字符串时，则可以使用 <code>sprintf</code> 或者是 <code>snprintf</code> ，那么问题来了，<code>snprintf</code> 是如何格式化的？</p><h2 id=格式化内幕>格式化内幕</h2><p>要了解 snprintf 的细节，我们需要去找一个 libc 了解一番，这里建议是 <a href=https://github.com/bminor/musl>musl</a>，musl 只支持 Linux，没有像 Glibc 那么多的遗留代码，代码比较整洁。而 Visual C++ 的 ucrt 源码基本使用 C++ 模板编写，比较复杂，不容易借此理清 snprintf 的细节。翻阅 musl snprintf.c 源码，我们发现 snprintf 将会调用 <code>vsnprintf</code>，</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#828b96;font-style:italic>// https://github.com/bminor/musl/blob/master/src/stdio/snprintf.c
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#828b96;font-style:italic>#include</span> <span style=color:#828b96;font-style:italic>&lt;stdio.h&gt;</span><span style=color:#828b96;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>#include</span> <span style=color:#828b96;font-style:italic>&lt;stdarg.h&gt;</span><span style=color:#828b96;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>snprintf</span>(<span style=color:#ff636f>char</span> <span style=color:#ff636f>*</span><span style=color:#ff636f>restrict</span> <span style=color:#58a1dd>s</span>, <span style=color:#ff636f>size_t</span> <span style=color:#58a1dd>n</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span> <span style=color:#ff636f>*</span><span style=color:#ff636f>restrict</span> <span style=color:#58a1dd>fmt</span>, ...)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#ff636f>int</span> <span style=color:#58a1dd>ret</span>;
</span></span><span style=display:flex><span>	<span style=color:#58a1dd>va_list</span> <span style=color:#58a1dd>ap</span>;
</span></span><span style=display:flex><span>	<span style=color:#58a1dd>va_start</span>(<span style=color:#58a1dd>ap</span>, <span style=color:#58a1dd>fmt</span>);
</span></span><span style=display:flex><span>	<span style=color:#58a1dd>ret</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>vsnprintf</span>(<span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>n</span>, <span style=color:#58a1dd>fmt</span>, <span style=color:#58a1dd>ap</span>);
</span></span><span style=display:flex><span>	<span style=color:#58a1dd>va_end</span>(<span style=color:#58a1dd>ap</span>);
</span></span><span style=display:flex><span>	<span style=color:#ff636f>return</span> <span style=color:#58a1dd>ret</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// https://github.com/bminor/musl/blob/master/src/stdio/vsnprintf.c
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>vsnprintf</span>(<span style=color:#ff636f>char</span> <span style=color:#ff636f>*</span><span style=color:#ff636f>restrict</span> <span style=color:#58a1dd>s</span>, <span style=color:#ff636f>size_t</span> <span style=color:#58a1dd>n</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span> <span style=color:#ff636f>*</span><span style=color:#ff636f>restrict</span> <span style=color:#58a1dd>fmt</span>, <span style=color:#58a1dd>va_list</span> <span style=color:#58a1dd>ap</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#ff636f>unsigned</span> <span style=color:#ff636f>char</span> <span style=color:#58a1dd>buf</span>[<span style=color:#a6be9d>1</span>];
</span></span><span style=display:flex><span>	<span style=color:#ff636f>char</span> <span style=color:#58a1dd>dummy</span>[<span style=color:#a6be9d>1</span>];
</span></span><span style=display:flex><span>	<span style=color:#ff636f>struct</span> <span style=color:#58a1dd>cookie</span> <span style=color:#58a1dd>c</span> <span style=color:#ff636f>=</span> { .<span style=color:#58a1dd>s</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>n</span> <span style=color:#ff636f>?</span> <span style=color:#58a1dd>s</span> : <span style=color:#58a1dd>dummy</span>, .<span style=color:#58a1dd>n</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>n</span> <span style=color:#ff636f>?</span> <span style=color:#58a1dd>n</span><span style=color:#ff636f>-</span><span style=color:#a6be9d>1</span> <span style=color:#ff636f>:</span> <span style=color:#a6be9d>0</span> };
</span></span><span style=display:flex><span>	<span style=color:#58a1dd>FILE</span> <span style=color:#58a1dd>f</span> <span style=color:#ff636f>=</span> {
</span></span><span style=display:flex><span>		.<span style=color:#58a1dd>lbf</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>EOF</span>,
</span></span><span style=display:flex><span>		.<span style=color:#58a1dd>write</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>sn_write</span>,
</span></span><span style=display:flex><span>		.<span style=color:#58a1dd>lock</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>-</span><span style=color:#a6be9d>1</span>,
</span></span><span style=display:flex><span>		.<span style=color:#58a1dd>buf</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>buf</span>,
</span></span><span style=display:flex><span>		.<span style=color:#58a1dd>cookie</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>c</span>,
</span></span><span style=display:flex><span>	};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff636f>if</span> (<span style=color:#58a1dd>n</span> <span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>INT_MAX</span>) {
</span></span><span style=display:flex><span>		<span style=color:#58a1dd>errno</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>EOVERFLOW</span>;
</span></span><span style=display:flex><span>		<span style=color:#ff636f>return</span> <span style=color:#ff636f>-</span><span style=color:#a6be9d>1</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff636f>*</span><span style=color:#58a1dd>c</span>.<span style=color:#58a1dd>s</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>	<span style=color:#ff636f>return</span> <span style=color:#58a1dd>vfprintf</span>(<span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>f</span>, <span style=color:#58a1dd>fmt</span>, <span style=color:#58a1dd>ap</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在 musl 之中，vsnprintf 创建一个 FILE 结构，然后最终使用 vfprintf 格式化字符串。这里使用了 <code>va_list</code> <code>va_start</code> <code>va_end</code> 宏，这组宏将变参函数的参数从函数栈中取出来，从而实现了变参函数的功能，我们可以参考 Visual C++ 在 <a href=https://gist.github.com/fcharlie/e2b6a2d578d7b484d0338886ce0db768><code>vadefs.h</code></a> 中的定义。</p><p>而 va_list 本质上是从函数参数栈中获得特定位置的值。</p><p><code>vfprintf</code> 函数的源码在： <a href=https://github.com/bminor/musl/blob/master/src/stdio/vfprintf.c>musl: src/stdio/vfprintf.c</a>。我们可以发现格式化输出实际上是解析 <code>format</code> 字符串，在解析到占位符时，使用 <code>va_arg</code> 提取 <code>va_list</code> 中的变量（或者转变为特定格式字符串后）替换占位符，从而实现格式化输出的目的（文件或者缓冲区）。格式化占位符以 <code>%</code> 开头，支持格式化的类型可以参考 <a href=http://pubs.opengroup.org/onlinepubs/9699919799/functions/fprintf.html>http://pubs.opengroup.org/onlinepubs/9699919799/functions/fprintf.html</a></p><p>了解到格式化输出的原理之后，我们可以很容易的实现一个格式化字符串或者格式化输出函数，在 nginx 源码中，就有一个 类似实现： <a href=https://github.com/nginx/nginx/blob/27b3d3dcca5fcc82350a823881f3d06161327b59/src/core/ngx_string.c#L163><code>ngx_vslprintf</code></a> ，这个代码比较简单比较容易移植。</p><h2 id=c-style-格式化的缺陷>C-Style 格式化的缺陷</h2><p>上述格式化使用变参函数，使用 va_list 获得参数值，这种使用 va_list 的函数在 C++ 中是不被推荐的 <a href=https://github.com/isocpp/CppCoreGuidelines/blob/master/CppCoreGuidelines.md#F-varargs>F.55: Don&rsquo;t use va_arg arguments</a>。当用户编码时，可能是程序员疏忽或者故意，依赖 va_list 的代码很容易由于类型不匹配，参数个数不匹配而造成栈溢出。导致安全漏洞或者是程序崩溃。以下代码可能会导致程序崩溃，并且编译器也不会警告：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#828b96;font-style:italic>#include</span> <span style=color:#828b96;font-style:italic>&lt;string_view&gt;</span><span style=color:#828b96;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>#include</span> <span style=color:#828b96;font-style:italic>&lt;cstdio&gt;</span><span style=color:#828b96;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>#include</span> <span style=color:#828b96;font-style:italic>&lt;cstdarg&gt;</span><span style=color:#828b96;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>dump</span>(<span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>fmt</span>,...){
</span></span><span style=display:flex><span>  <span style=color:#ff636f>int</span> <span style=color:#58a1dd>ret</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>va_list</span> <span style=color:#58a1dd>ap</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>va_start</span>(<span style=color:#58a1dd>ap</span>,<span style=color:#58a1dd>fmt</span>);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>vfprintf</span>(<span style=color:#58a1dd>stderr</span>,<span style=color:#58a1dd>fmt</span>,<span style=color:#58a1dd>ap</span>);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>va_end</span>(<span style=color:#58a1dd>ap</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>ret</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>main</span>(){
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>name</span><span style=color:#ff636f>=</span><span style=color:#a6be9d>&#34;Tony Stark&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>dump</span>(<span style=color:#a6be9d>&#34;hello %s</span><span style=color:#a6be9d>\n</span><span style=color:#a6be9d>&#34;</span>,<span style=color:#58a1dd>name</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>编译器的构建信息如下:</p><pre tabindex=0><code>使用内建 specs。
COLLECT_GCC=/opt/gcc/bin/g++
COLLECT_LTO_WRAPPER=/opt/gcc/libexec/gcc/x86_64-linux-gnu/9.0.1/lto-wrapper
目标：x86_64-linux-gnu
配置为：../configure --with-pkgversion=Baslat.Inc --prefix=/opt/gcc --enable-shared --enable-linker-build-id --without-included-gettext --enable-threads=posix --enable-checking=release --enable-languages=c,c++ --disable-multilib --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-vtable-verify --enable-libmpx --enable-plugin --with-system-zlib --with-abi=m64 --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu
线程模型：posix
gcc 版本 9.0.1 20190426 (prerelease) (Baslat.Inc) 
</code></pre><p>运行编译器命令：</p><blockquote><p>/opt/gcc/bin/g++ -fsanitize=address -fno-omit-frame-pointer fuck.cc -std=c++17</p></blockquote><p>运行程序：</p><blockquote><p>./a.out</p></blockquote><p>地址消毒剂报告如下：</p><pre tabindex=0><code>AddressSanitizer:DEADLYSIGNAL
=================================================================
==16509==ERROR: AddressSanitizer: SEGV on unknown address 0x00000000000a (pc 0x7fc137bc3af2 bp 0x7ffffbf14ea0 sp 0x7ffffbf145c8 T0)
==16509==The signal is caused by a READ memory access.
==16509==Hint: address points to the zero page.
    #0 0x7fc137bc3af1  (/usr/lib/x86_64-linux-gnu/libasan.so.5+0x109af1)
    #1 0x7fc137b0e61c  (/usr/lib/x86_64-linux-gnu/libasan.so.5+0x5461c)
    #2 0x7fc137b0efb4 in __interceptor_vfprintf (/usr/lib/x86_64-linux-gnu/libasan.so.5+0x54fb4)
    #3 0x400cf0 in dump(char const*, ...) (/tmp/a.out+0x400cf0)
    #4 0x400e06 in main (/tmp/a.out+0x400e06)
    #5 0x7fc136dabb96 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x21b96)
    #6 0x400b09 in _start (/tmp/a.out+0x400b09)

AddressSanitizer can not provide additional info.
SUMMARY: AddressSanitizer: SEGV (/usr/lib/x86_64-linux-gnu/libasan.so.5+0x109af1) 
==16509==ABORTING
</code></pre><p>出现问题其实很容易理解，由于 std::string_view 的结构大致如下：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>template</span><span style=color:#ff636f>&lt;</span><span style=color:#ff636f>class</span> <span style=color:#58a1dd>charT</span>, <span style=color:#ff636f>class</span> <span style=color:#58a1dd>traits</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>char_traits</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>charT</span><span style=color:#ff636f>&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>class</span> <span style=color:#58a1dd>basic_string_view</span> {
</span></span><span style=display:flex><span><span style=color:#ff636f>public</span><span style=color:#ff636f>:</span>
</span></span><span style=display:flex><span>      <span style=color:#828b96;font-style:italic>// types
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>typedef</span> <span style=color:#58a1dd>traits</span> <span style=color:#58a1dd>traits_type</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>typedef</span> <span style=color:#58a1dd>charT</span> <span style=color:#58a1dd>value_type</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>typedef</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>pointer</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>typedef</span> <span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>const_pointer</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>typedef</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>&amp;</span> <span style=color:#58a1dd>reference</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>typedef</span> <span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>&amp;</span> <span style=color:#58a1dd>const_reference</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>typedef</span> <span style=color:#58a1dd>implementation</span><span style=color:#ff636f>-</span><span style=color:#58a1dd>defined</span> <span style=color:#58a1dd>const_iterator</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>typedef</span> <span style=color:#58a1dd>const_iterator</span> <span style=color:#58a1dd>iterator</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>typedef</span> <span style=color:#58a1dd>reverse_iterator</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>const_iterator</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>const_reverse_iterator</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>typedef</span> <span style=color:#58a1dd>const_reverse_iterator</span> <span style=color:#58a1dd>reverse_iterator</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>typedef</span> <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>size_type</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>typedef</span> <span style=color:#58a1dd>ptrdiff_t</span> <span style=color:#58a1dd>difference_type</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>static</span> <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>npos</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>size_type</span>(<span style=color:#ff636f>-</span><span style=color:#a6be9d>1</span>);
</span></span><span style=display:flex><span>      <span style=color:#828b96;font-style:italic>// 7.3, basic_string_view constructors and assignment operators
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>basic_string_view</span>() <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>basic_string_view</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>basic_string_view</span><span style=color:#ff636f>&amp;</span>) <span style=color:#ff636f>noexcept</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>default</span>;
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>basic_string_view</span><span style=color:#ff636f>&amp;</span> <span style=color:#ff636f>operator</span><span style=color:#ff636f>=</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>basic_string_view</span><span style=color:#ff636f>&amp;</span>) <span style=color:#ff636f>noexcept</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>default</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>template</span><span style=color:#ff636f>&lt;</span><span style=color:#ff636f>class</span> <span style=color:#58a1dd>Allocator</span><span style=color:#ff636f>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>basic_string_view</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>str</span>);
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>basic_string_view</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>str</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>len</span>);
</span></span><span style=display:flex><span>      <span style=color:#828b96;font-style:italic>// 7.4, basic_string_view iterator support
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>const_iterator</span> <span style=color:#58a1dd>begin</span>() <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>const_iterator</span> <span style=color:#58a1dd>end</span>() <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>const_iterator</span> <span style=color:#58a1dd>cbegin</span>() <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>const_iterator</span> <span style=color:#58a1dd>cend</span>() <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>const_reverse_iterator</span> <span style=color:#58a1dd>rbegin</span>() <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>const_reverse_iterator</span> <span style=color:#58a1dd>rend</span>() <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>const_reverse_iterator</span> <span style=color:#58a1dd>crbegin</span>() <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>const_reverse_iterator</span> <span style=color:#58a1dd>crend</span>() <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#828b96;font-style:italic>// 7.5, basic_string_view capacity
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>size</span>() <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>length</span>() <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>max_size</span>() <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>empty</span>() <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#828b96;font-style:italic>// 7.6, basic_string_view element access
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>const_reference</span> <span style=color:#ff636f>operator</span>[](<span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>const_reference</span> <span style=color:#58a1dd>at</span>(<span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>const_reference</span> <span style=color:#58a1dd>front</span>() <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>const_reference</span> <span style=color:#58a1dd>back</span>() <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>const_pointer</span> <span style=color:#58a1dd>data</span>() <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#828b96;font-style:italic>// 7.7, basic_string_view modifiers
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>constexpr</span> <span style=color:#ff636f>void</span> <span style=color:#58a1dd>remove_prefix</span>(<span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>n</span>);
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#ff636f>void</span> <span style=color:#58a1dd>remove_suffix</span>(<span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>n</span>);
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#ff636f>void</span> <span style=color:#58a1dd>swap</span>(<span style=color:#58a1dd>basic_string_view</span><span style=color:#ff636f>&amp;</span> <span style=color:#58a1dd>s</span>) <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>copy</span>(<span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>n</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>basic_string_view</span> <span style=color:#58a1dd>substr</span>(<span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>n</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>npos</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#ff636f>int</span> <span style=color:#58a1dd>compare</span>(<span style=color:#58a1dd>basic_string_view</span> <span style=color:#58a1dd>s</span>) <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#ff636f>int</span> <span style=color:#58a1dd>compare</span>(<span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos1</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>n1</span>, <span style=color:#58a1dd>basic_string_view</span> <span style=color:#58a1dd>s</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#ff636f>int</span> <span style=color:#58a1dd>compare</span>(<span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos1</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>n1</span>,
</span></span><span style=display:flex><span>                            <span style=color:#58a1dd>basic_string_view</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos2</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>n2</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#ff636f>int</span> <span style=color:#58a1dd>compare</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#ff636f>int</span> <span style=color:#58a1dd>compare</span>(<span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos1</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>n1</span>, <span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#ff636f>int</span> <span style=color:#58a1dd>compare</span>(<span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos1</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>n1</span>,
</span></span><span style=display:flex><span>                            <span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>n2</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find</span>(<span style=color:#58a1dd>basic_string_view</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>) <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find</span>(<span style=color:#58a1dd>charT</span> <span style=color:#58a1dd>c</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>) <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>n</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>rfind</span>(<span style=color:#58a1dd>basic_string_view</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>npos</span>) <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>rfind</span>(<span style=color:#58a1dd>charT</span> <span style=color:#58a1dd>c</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>npos</span>) <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>rfind</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>n</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>rfind</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>npos</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find_first_of</span>(<span style=color:#58a1dd>basic_string_view</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>) <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find_first_of</span>(<span style=color:#58a1dd>charT</span> <span style=color:#58a1dd>c</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>) <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find_first_of</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>n</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find_first_of</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find_last_of</span>(<span style=color:#58a1dd>basic_string_view</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>npos</span>) <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find_last_of</span>(<span style=color:#58a1dd>charT</span> <span style=color:#58a1dd>c</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>npos</span>) <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find_last_of</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>n</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find_last_of</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>npos</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find_first_not_of</span>(<span style=color:#58a1dd>basic_string_view</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>) <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find_first_not_of</span>(<span style=color:#58a1dd>charT</span> <span style=color:#58a1dd>c</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>) <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find_first_not_of</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>n</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find_first_not_of</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>0</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find_last_not_of</span>(<span style=color:#58a1dd>basic_string_view</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>npos</span>) <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find_last_not_of</span>(<span style=color:#58a1dd>charT</span> <span style=color:#58a1dd>c</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>npos</span>) <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find_last_not_of</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>n</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>find_last_not_of</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>, <span style=color:#58a1dd>size_type</span> <span style=color:#58a1dd>pos</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>npos</span>) <span style=color:#ff636f>const</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>constexpr</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>starts_with</span>(<span style=color:#58a1dd>basic_string_view</span> <span style=color:#58a1dd>s</span>) <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>; <span style=color:#828b96;font-style:italic>// C++2a
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>constexpr</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>starts_with</span>(<span style=color:#58a1dd>charT</span> <span style=color:#58a1dd>c</span>) <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;             <span style=color:#828b96;font-style:italic>// C++2a
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>constexpr</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>starts_with</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>) <span style=color:#ff636f>const</span>;               <span style=color:#828b96;font-style:italic>// C++2a
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>constexpr</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>ends_with</span>(<span style=color:#58a1dd>basic_string_view</span> <span style=color:#58a1dd>s</span>) <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;   <span style=color:#828b96;font-style:italic>// C++2a
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>constexpr</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>ends_with</span>(<span style=color:#58a1dd>charT</span> <span style=color:#58a1dd>c</span>) <span style=color:#ff636f>const</span> <span style=color:#ff636f>noexcept</span>;               <span style=color:#828b96;font-style:italic>// C++2a
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>constexpr</span> <span style=color:#ff636f>bool</span> <span style=color:#58a1dd>ends_with</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>charT</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>) <span style=color:#ff636f>const</span>;                 <span style=color:#828b96;font-style:italic>// C++2a
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>private</span><span style=color:#ff636f>:</span>
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>const_pointer</span> <span style=color:#58a1dd>data_</span>;  <span style=color:#828b96;font-style:italic>// exposition only
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#58a1dd>size_type</span>     <span style=color:#58a1dd>size_</span>;  <span style=color:#828b96;font-style:italic>// exposition only
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    };
</span></span></code></pre></div><p>由于 string_view 值被错误的转变为 <code>char *</code>，而 C-Style 的字符串是 <code>null-terminated string</code>，在处理 <code>%s</code> 的时候无法正常解析到终止字符，出现溢出然后导致程序崩溃，同样，如果类型宽度不一致，比如 format 中需要 <code>%lld</code>，而输入为 <code>int</code> 同样容易出现问题，但这种问题可能更多的预期结果不一致。。</p><p>在这个例子中，如果将 <code>std::string_view</code> 改成 <code>std::string</code>, clang 8.0.1 则会报告 std::string 不是 POD 类型的错误：</p><pre tabindex=0><code>fuck2.cc:16:21: error: cannot pass object of non-trivial type &#39;std::string&#39; (aka &#39;basic_string&lt;char&gt;&#39;) through variadic
      function; call will abort at runtime [-Wnon-pod-varargs]
  dump(&#34;hello %s\n&#34;,name);
                    ^
1 error generated.
</code></pre><h2 id=安全格式化解决方案>安全格式化解决方案</h2><h3 id=编译器的参数匹配检查>编译器的参数匹配检查</h3><p>为了减少上面错误的发生，开发者增加了很多解决方案，比如，对于 C 或者 C++ 而言，可以使用特定的 <code>Attributes</code> 限制函数的属性，当格式不匹配时，编译器会发出警告。</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#828b96;font-style:italic>#ifdef __GNUC__
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>void</span> <span style=color:#58a1dd>log_unlocked</span>(<span style=color:#ff636f>int</span> <span style=color:#58a1dd>level</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>fmt</span>, ...)
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>__attribute__</span>((<span style=color:#58a1dd>__format__</span>(<span style=color:#58a1dd>__printf__</span>, <span style=color:#a6be9d>2</span>, <span style=color:#a6be9d>3</span>)));
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>#else
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>void</span> <span style=color:#58a1dd>log_unlocked</span>(<span style=color:#ff636f>int</span> <span style=color:#58a1dd>level</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>fmt</span>, ...);
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>#endif
</span></span></span></code></pre></div><p>但这种方案受限于编译器，不是一个普遍方案。<a href=https://clang.llvm.org/docs/AttributeReference.html#format>Clang</a> 保持了对 GCC 的兼容，可以使用上述 <code>__attribute__</code>。而 MSVC 则可以使用 <a href="https://docs.microsoft.com/en-us/previous-versions/visualstudio/visual-studio-2010/ms235402(v=vs.100)">SAL: <code>_Printf_format_string_</code></a>。</p><h3 id=变参函数模板的辅助>变参函数模板的辅助</h3><p>如果要在 C++ 当中使用类似的格式化函数方案，可以变参函数模板包装，cppwinrt 的作者 Kenny Kerr 就有一篇文章告诉人们改怎么做： <a href=https://msdn.microsoft.com/en-us/magazine/dn913181.aspx>Windows with C++ - Using Printf with Modern C++</a>。</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#ff636f>typename</span> <span style=color:#58a1dd>T</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>T</span> <span style=color:#58a1dd>Argument</span>(<span style=color:#58a1dd>T</span> <span style=color:#58a1dd>value</span>) <span style=color:#ff636f>noexcept</span> { <span style=color:#ff636f>return</span> <span style=color:#58a1dd>value</span>; }
</span></span><span style=display:flex><span><span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#ff636f>typename</span> <span style=color:#58a1dd>T</span><span style=color:#ff636f>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>T</span> <span style=color:#ff636f>const</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>Argument</span>(<span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>basic_string</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>T</span><span style=color:#ff636f>&gt;</span> <span style=color:#ff636f>const</span> <span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>value</span>) <span style=color:#ff636f>noexcept</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>value</span>.<span style=color:#58a1dd>c_str</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#ff636f>typename</span>... <span style=color:#58a1dd>Args</span><span style=color:#ff636f>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>StringPrint</span>(<span style=color:#ff636f>char</span> <span style=color:#ff636f>*</span><span style=color:#ff636f>const</span> <span style=color:#58a1dd>buffer</span>, <span style=color:#58a1dd>size_t</span> <span style=color:#ff636f>const</span> <span style=color:#58a1dd>bufferCount</span>,
</span></span><span style=display:flex><span>                <span style=color:#ff636f>char</span> <span style=color:#ff636f>const</span> <span style=color:#ff636f>*</span><span style=color:#ff636f>const</span> <span style=color:#58a1dd>format</span>, <span style=color:#58a1dd>Args</span> <span style=color:#ff636f>const</span> <span style=color:#ff636f>&amp;</span>... <span style=color:#58a1dd>args</span>) <span style=color:#ff636f>noexcept</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>int</span> <span style=color:#ff636f>const</span> <span style=color:#58a1dd>result</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>snprintf</span>(<span style=color:#58a1dd>buffer</span>, <span style=color:#58a1dd>bufferCount</span>, <span style=color:#58a1dd>format</span>, <span style=color:#58a1dd>Argument</span>(<span style=color:#58a1dd>args</span>)...);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>result</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#ff636f>typename</span>... <span style=color:#58a1dd>Args</span><span style=color:#ff636f>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#58a1dd>StrFormat</span>(<span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>format</span>, <span style=color:#58a1dd>Args</span>... <span style=color:#58a1dd>args</span>) {
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#58a1dd>buffer</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>size_t</span> <span style=color:#ff636f>const</span> <span style=color:#58a1dd>size</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>StringPrint</span>(<span style=color:#ff636f>nullptr</span>, <span style=color:#a6be9d>0</span>, <span style=color:#58a1dd>format</span>, <span style=color:#58a1dd>args</span>...);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>buffer</span>.<span style=color:#58a1dd>resize</span>(<span style=color:#58a1dd>size</span>);
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>StringPrint</span>(<span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>buffer</span>[<span style=color:#a6be9d>0</span>], <span style=color:#58a1dd>buffer</span>.<span style=color:#58a1dd>size</span>() <span style=color:#ff636f>+</span> <span style=color:#a6be9d>1</span>, <span style=color:#58a1dd>format</span>, <span style=color:#58a1dd>args</span>...);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>buffer</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在格式化时将 <code>std::string</code> 转变为了 <code>const char *</code>，这种方案的缺陷有两处，第一 <code>std::string</code> 是可以存在 <code>\0</code> 这样的字符的，但是在这里却被截断，第二，<code>std::string</code> 需要再次计算长度。</p><h2 id=现代-c-格式化库>现代 C++ 格式化库</h2><p>既然 C-Style 的格式化方案缺陷那么多，那么 C++ 开发者们也会不遗余力的去造轮子，实现自己的目标的，早期比如我刚学 C++ 那会，都是 <code>iostream</code> 家族，字符串格式化可以使用 <code>stringstream</code>，<code>iostream</code> 这类方案一直被视为糟糕的设计，一来继承复杂，二来效率低。特别在 C++11 变参模板等特性出来后，饱受鄙视，因此也不是建议的格式化方案。现在 C++20 都快发布了，也涌现了一些更好的方案，好的格式化库有积极入标准的 <a href=https://github.com/fmtlib/fmt>fmtlib</a>。还有 Facebook 的 C++ 标准库补充 <a href=https://github.com/facebook/folly>folly</a> 也有一个 <code>format</code> 实现。在 Google 里面，很多项目使用了 C++，他们也积累了一些 C++ 组件，后来开源了 <a href=https://github.com/abseil/abseil-cpp>Abseil</a>，Abseil 中也有字符串格式化函数 <code>absl::StrFormat</code>，<code>absl::StrAppendFormat</code> ，当然还有一些实现比较慢，代码不太干净的，这里也就不多说了。</p><h3 id=积极入标准的-fmtlib>积极入标准的 fmtlib</h3><p>fmtlib 目前是冲着进入 C++ 标准去的，它支持两种风格，一个是类似 python 的风格：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#58a1dd>fmt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>format</span>(<span style=color:#a6be9d>&#34;The answer is {}.&#34;</span>, <span style=color:#a6be9d>42</span>);
</span></span><span style=display:flex><span><span style=color:#58a1dd>fmt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>print</span>(<span style=color:#a6be9d>&#34;I&#39;d rather be {1} than {0}.&#34;</span>, <span style=color:#a6be9d>&#34;right&#34;</span>, <span style=color:#a6be9d>&#34;happy&#34;</span>);
</span></span></code></pre></div><p>这种风格还可以通过重载 <code>format_to</code> 函数， 输出特定的对象。</p><p>fmtlib 还支持 printf 的格式化风格，使用变参模板展开，是格式化安全的。</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#58a1dd>message</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>fmt</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>sprintf</span>(<span style=color:#a6be9d>&#34;The answer is %d&#34;</span>, <span style=color:#a6be9d>42</span>);
</span></span></code></pre></div><p>当类型不匹配时 fmtlib 会抛出异常，这是一种运行时行为。另外 fmtlib 还支持 <code>wchar_t</code>，这在 <code>Windows</code> 系统中比较重要。在格式化浮点类型时，可能会回退到 <code>snprintf</code>。</p><h3 id=facebook-folly-format>Facebook folly format</h3><p><a href=https://github.com/facebook/folly/blob/master/folly/docs/Format.md>Folly format</a> 的风格类似于 python 的格式化风格，与 fmtlib 的第一种一致。</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>using</span> <span style=color:#58a1dd>folly</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>format</span>;
</span></span><span style=display:flex><span><span style=color:#ff636f>using</span> <span style=color:#58a1dd>folly</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>sformat</span>;
</span></span><span style=display:flex><span><span style=color:#ff636f>using</span> <span style=color:#58a1dd>folly</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>vformat</span>;
</span></span><span style=display:flex><span><span style=color:#ff636f>using</span> <span style=color:#58a1dd>folly</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>svformat</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// Objects produced by format() can be streamed without creating
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// an intermediary string; {} yields the next argument using default
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// formatting.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>cout</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#58a1dd>format</span>(<span style=color:#a6be9d>&#34;The answers are {} and {}&#34;</span>, <span style=color:#a6be9d>23</span>, <span style=color:#a6be9d>42</span>);
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// =&gt; &#34;The answers are 23 and 42&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// If you just want the string, though, you&#39;re covered.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#58a1dd>result</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>sformat</span>(<span style=color:#a6be9d>&#34;The answers are {} and {}&#34;</span>, <span style=color:#a6be9d>23</span>, <span style=color:#a6be9d>42</span>);
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// =&gt; &#34;The answers are 23 and 42&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// Arguments can be referenced out of order, even multiple times
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>cout</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#58a1dd>format</span>(<span style=color:#a6be9d>&#34;The answers are {1}, {0}, and {1} again&#34;</span>, <span style=color:#a6be9d>23</span>, <span style=color:#a6be9d>42</span>);
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// =&gt; &#34;The answers are 42, 23, and 42 again&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// It&#39;s perfectly fine to not reference all arguments
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>cout</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#58a1dd>format</span>(<span style=color:#a6be9d>&#34;The only answer is {1}&#34;</span>, <span style=color:#a6be9d>23</span>, <span style=color:#a6be9d>42</span>);
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// =&gt; &#34;The only answer is 42&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// Values can be extracted from indexable containers
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// (random-access sequences and integral-keyed maps), and also from
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// string-keyed maps
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>vector</span><span style=color:#ff636f>&lt;</span><span style=color:#ff636f>int</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>v</span> {<span style=color:#a6be9d>23</span>, <span style=color:#a6be9d>42</span>};
</span></span><span style=display:flex><span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>map</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span>, <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>m</span> { {<span style=color:#a6be9d>&#34;what&#34;</span>, <span style=color:#a6be9d>&#34;answer&#34;</span>} };
</span></span><span style=display:flex><span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>cout</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#58a1dd>format</span>(<span style=color:#a6be9d>&#34;The only {1[what]} is {0[1]}&#34;</span>, <span style=color:#58a1dd>v</span>, <span style=color:#58a1dd>m</span>);
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// =&gt; &#34;The only answer is 42&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// If you only have one container argument, vformat makes the syntax simpler
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>map</span><span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span>, <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>m</span> { {<span style=color:#a6be9d>&#34;what&#34;</span>, <span style=color:#a6be9d>&#34;answer&#34;</span>}, {<span style=color:#a6be9d>&#34;value&#34;</span>, <span style=color:#a6be9d>&#34;42&#34;</span>} };
</span></span><span style=display:flex><span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>cout</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#58a1dd>vformat</span>(<span style=color:#a6be9d>&#34;The only {what} is {value}&#34;</span>, <span style=color:#58a1dd>m</span>);
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// =&gt; &#34;The only answer is 42&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// same as
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>cout</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#58a1dd>format</span>(<span style=color:#a6be9d>&#34;The only {0[what]} is {0[value]}&#34;</span>, <span style=color:#58a1dd>m</span>);
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// =&gt; &#34;The only answer is 42&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// And if you just want the string,
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#58a1dd>result</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>svformat</span>(<span style=color:#a6be9d>&#34;The only {what} is {value}&#34;</span>, <span style=color:#58a1dd>m</span>);
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// =&gt; &#34;The only answer is 42&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#58a1dd>result</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>sformat</span>(<span style=color:#a6be9d>&#34;The only {0[what]} is {0[value]}&#34;</span>, <span style=color:#58a1dd>m</span>);
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// =&gt; &#34;The only answer is 42&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// {} works for vformat too
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>vector</span><span style=color:#ff636f>&lt;</span><span style=color:#ff636f>int</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>v</span> {<span style=color:#a6be9d>42</span>, <span style=color:#a6be9d>23</span>};
</span></span><span style=display:flex><span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>cout</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#58a1dd>vformat</span>(<span style=color:#a6be9d>&#34;{} {}&#34;</span>, <span style=color:#58a1dd>v</span>);
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// =&gt; &#34;42 23&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// format and vformat work with pairs and tuples
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>tuple</span><span style=color:#ff636f>&lt;</span><span style=color:#ff636f>int</span>, <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span>, <span style=color:#ff636f>int</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>t</span> {<span style=color:#a6be9d>42</span>, <span style=color:#a6be9d>&#34;hello&#34;</span>, <span style=color:#a6be9d>23</span>};
</span></span><span style=display:flex><span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>cout</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#58a1dd>vformat</span>(<span style=color:#a6be9d>&#34;{0} {2} {1}&#34;</span>, <span style=color:#58a1dd>t</span>);
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// =&gt; &#34;42 23 hello&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// Format supports width, alignment, arbitrary fill, and various
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// format specifiers, with meanings similar to printf
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// &#34;X&lt;10&#34;: fill with &#39;X&#39;, left-align (&#39;&lt;&#39;), width 10
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>cout</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#58a1dd>format</span>(<span style=color:#a6be9d>&#34;{:X&lt;10} {}&#34;</span>, <span style=color:#a6be9d>&#34;hello&#34;</span>, <span style=color:#a6be9d>&#34;world&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// =&gt; &#34;helloXXXXX world&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// Field width may be a runtime value rather than part of the format string
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>x</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>6</span>;
</span></span><span style=display:flex><span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>cout</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#58a1dd>format</span>(<span style=color:#a6be9d>&#34;{:-^*}&#34;</span>, <span style=color:#58a1dd>x</span>, <span style=color:#a6be9d>&#34;hi&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// =&gt; &#34;--hi--&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// Explicit arguments work with dynamic field width, as long as indexes are
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// given for both the value and the field width.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>cout</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#58a1dd>format</span>(<span style=color:#a6be9d>&#34;{2:+^*0}&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#a6be9d>9</span>, <span style=color:#a6be9d>&#34;unused&#34;</span>, <span style=color:#a6be9d>456</span>); <span style=color:#828b96;font-style:italic>// =&gt; &#34;+++456+++&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// Format supports printf-style format specifiers
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>cout</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#58a1dd>format</span>(<span style=color:#a6be9d>&#34;{0:05d} decimal = {0:04x} hex&#34;</span>, <span style=color:#a6be9d>42</span>);
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// =&gt; &#34;00042 decimal = 002a hex&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// Formatter objects may be written to a string using folly::to or
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// folly::toAppend (see folly/Conv.h), or by calling their appendTo(),
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// str(), and fbstr() methods
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string</span> <span style=color:#58a1dd>s</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>format</span>(<span style=color:#a6be9d>&#34;The only answer is {}&#34;</span>, <span style=color:#a6be9d>42</span>).<span style=color:#58a1dd>str</span>();
</span></span><span style=display:flex><span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>cout</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#58a1dd>s</span>;
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// =&gt; &#34;The only answer is 42&#34;
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// Decimal precision usage
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>cout</span> <span style=color:#ff636f>&lt;&lt;</span> <span style=color:#58a1dd>format</span>(<span style=color:#a6be9d>&#34;Only 2 decimals is {:.2f}&#34;</span>, <span style=color:#a6be9d>23.34134534535</span>);
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// =&gt; &#34;Only 2 decimals is 23.34&#34;
</span></span></span></code></pre></div><p>但 Folly 的构建是个重量级的活动，所以像我这样的开发者一般是不会采用 folly 的。虽然 folly 侧重与 Linux ，但目前可以构建为 Windows x64 目标，使用 vcpkg 亦可安装。</p><h3 id=google-abseil-strformat>Google Abseil StrFormat</h3><p>在 GNK 项目中，我曾使用 fmtlib，但 clang-tidy 老是警告没有捕获异常，添加异常捕获，代码繁琐不整洁，我在考察 Abseil 之后，发现使用体验要优于 fmtlib，就将其切换到 Abseil 了。<br>Abseil StrFormat 只支持 C-Style 的格式化风格，格式化支持的类型可以查看如下注释：</p><pre tabindex=0><code>// In specific, the `FormatSpec` supports the following type specifiers:
//   * `c` for characters
//   * `s` for strings
//   * `d` or `i` for integers
//   * `o` for unsigned integer conversions into octal
//   * `x` or `X` for unsigned integer conversions into hex
//   * `u` for unsigned integers
//   * `f` or `F` for floating point values into decimal notation
//   * `e` or `E` for floating point values into exponential notation
//   * `a` or `A` for floating point values into hex exponential notation
//   * `g` or `G` for floating point values into decimal or exponential
//     notation based on their precision
//   * `p` for pointer address values
//   * `n` for the special case of writing out the number of characters
//     written to this point. The resulting value must be captured within an
//     `absl::FormatCountCapture` type.
//
// NOTE: `o`, `x\X` and `u` will convert signed values to their unsigned
// counterpart before formatting.
//
// Examples:
//     &#34;%c&#34;, &#39;a&#39;                -&gt; &#34;a&#34;
//     &#34;%c&#34;, 32                 -&gt; &#34; &#34;
//     &#34;%s&#34;, &#34;C&#34;                -&gt; &#34;C&#34;
//     &#34;%s&#34;, std::string(&#34;C++&#34;) -&gt; &#34;C++&#34;
//     &#34;%d&#34;, -10                -&gt; &#34;-10&#34;
//     &#34;%o&#34;, 10                 -&gt; &#34;12&#34;
//     &#34;%x&#34;, 16                 -&gt; &#34;10&#34;
//     &#34;%f&#34;, 123456789          -&gt; &#34;123456789.000000&#34;
//     &#34;%e&#34;, .01                -&gt; &#34;1.00000e-2&#34;
//     &#34;%a&#34;, -3.0               -&gt; &#34;-0x1.8p+1&#34;
//     &#34;%g&#34;, .01                -&gt; &#34;1e-2&#34;
//     &#34;%p&#34;, *int               -&gt; &#34;0x7ffdeb6ad2a4&#34;
//
//     int n = 0;
//     std::string s = absl::StrFormat(
//         &#34;%s%d%n&#34;, &#34;hello&#34;, 123, absl::FormatCountCapture(&amp;n));
//     EXPECT_EQ(8, n);
//
// The `FormatSpec` intrinsically supports all of these fundamental C++ types:
//
// *   Characters: `char`, `signed char`, `unsigned char`
// *   Integers: `int`, `short`, `unsigned short`, `unsigned`, `long`,
//         `unsigned long`, `long long`, `unsigned long long`
// *   Floating-point: `float`, `double`, `long double`
//
// However, in the `str_format` library, a format conversion specifies a broader
// C++ conceptual category instead of an exact type. For example, `%s` binds to
// any string-like argument, so `std::string`, `absl::string_view`, and
// `const char*` are all accepted. Likewise, `%d` accepts any integer-like
// argument, etc.
</code></pre><p>Abseil 支持如下函数：</p><ul><li>StrFormat</li><li>StrAppendFormat</li><li>StreamFormat</li><li>PrintF</li><li>FPrintF</li><li>SNPrintF</li></ul><p>我们在实现日志库时，可以使用 <code>StrFormat</code> 格式化日志级别，时间等信息，然后使用 <code>StrAppendFormat</code> 格式化日志内容，这比 fmtlib 要方便的多。Abseil StrFormat 使用编译期检查取代运行时异常，这是让我选择的主要原因。配合 <code>absl::string_view</code> 在 GNK 一个 C++14 项目中，C++17 的使用体验非常好，字符串内存分配也减少了很多。<br>如果在 Windows 环境 <code>wchar_t</code> 编码环境使用 Abseil 可能效果还不如 fmtlib。由于实现了编译期类型检查，代码还是比较复杂，如果要将 Abseil StrFormat 剥离出来还比较麻烦。</p><h2 id=字符串去格式化>字符串去格式化</h2><p>如果我们使用字符串连接取代字符串格式化，字符串格式化问题则会少很多。在 Abseil 之中，有 StrCat 和 Subsitute 方案，可以连接或者组装字符串。</p><h3 id=substitute>Substitute</h3><p>实际上 <a href=https://github.com/abseil/abseil-cpp/blob/master/absl/strings/substitute.h>Subsitute</a> 类似 python 格式化风格，但参数只支持 0～9 个：</p><pre tabindex=0><code>auto s=Substitute(&#34;$1 purchased $0 $2. Thanks $1!&#34;, 5, &#34;Bob&#34;, &#34;Apples&#34;);
</code></pre><p>实现 Subsitute 的关键是遍历格式化参数，解析到 <code>$</code> 后获得参数位置，然后将特定的参数转变为 <code>Arg</code>，Arg 类型重载支持不同的基本类型，以及字符串类型，将其转变为 <code>absl::string_view</code> 数组，然后由 <code>SubstituteAndAppendArray</code> 拼接在一起。</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>class</span> <span style=color:#58a1dd>Arg</span> {
</span></span><span style=display:flex><span> <span style=color:#ff636f>public</span><span style=color:#ff636f>:</span>
</span></span><span style=display:flex><span>  <span style=color:#828b96;font-style:italic>// Overloads for std::string-y things
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#828b96;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#828b96;font-style:italic>// Explicitly overload `const char*` so the compiler doesn&#39;t cast to `bool`.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>value</span>)  <span style=color:#828b96;font-style:italic>// NOLINT(runtime/explicit)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>:</span> <span style=color:#58a1dd>piece_</span>(<span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>NullSafeStringView</span>(<span style=color:#58a1dd>value</span>)) {}
</span></span><span style=display:flex><span>  <span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#ff636f>typename</span> <span style=color:#58a1dd>Allocator</span><span style=color:#ff636f>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(  <span style=color:#828b96;font-style:italic>// NOLINT
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>const</span> <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>basic_string</span><span style=color:#ff636f>&lt;</span><span style=color:#ff636f>char</span>, <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>char_traits</span><span style=color:#ff636f>&lt;</span><span style=color:#ff636f>char</span><span style=color:#ff636f>&gt;</span>, <span style=color:#58a1dd>Allocator</span><span style=color:#ff636f>&gt;&amp;</span>
</span></span><span style=display:flex><span>          <span style=color:#58a1dd>value</span>) <span style=color:#ff636f>noexcept</span>
</span></span><span style=display:flex><span>      <span style=color:#ff636f>:</span> <span style=color:#58a1dd>piece_</span>(<span style=color:#58a1dd>value</span>) {}
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>value</span>)  <span style=color:#828b96;font-style:italic>// NOLINT(runtime/explicit)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>:</span> <span style=color:#58a1dd>piece_</span>(<span style=color:#58a1dd>value</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#828b96;font-style:italic>// Overloads for primitives
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#828b96;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#828b96;font-style:italic>// No overloads are available for signed and unsigned char because if people
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#828b96;font-style:italic>// are explicitly declaring their chars as signed or unsigned then they are
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#828b96;font-style:italic>// probably using them as 8-bit integers and would probably prefer an integer
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#828b96;font-style:italic>// representation. However, we can&#39;t really know, so we make the caller decide
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#828b96;font-style:italic>// what to do.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>char</span> <span style=color:#58a1dd>value</span>)  <span style=color:#828b96;font-style:italic>// NOLINT(runtime/explicit)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>:</span> <span style=color:#58a1dd>piece_</span>(<span style=color:#58a1dd>scratch_</span>, <span style=color:#a6be9d>1</span>) { <span style=color:#58a1dd>scratch_</span>[<span style=color:#a6be9d>0</span>] <span style=color:#ff636f>=</span> <span style=color:#58a1dd>value</span>; }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>short</span> <span style=color:#58a1dd>value</span>)  <span style=color:#828b96;font-style:italic>// NOLINT(*)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>:</span> <span style=color:#58a1dd>piece_</span>(<span style=color:#58a1dd>scratch_</span>,
</span></span><span style=display:flex><span>               <span style=color:#58a1dd>numbers_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>FastIntToBuffer</span>(<span style=color:#58a1dd>value</span>, <span style=color:#58a1dd>scratch_</span>) <span style=color:#ff636f>-</span> <span style=color:#58a1dd>scratch_</span>) {}
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>unsigned</span> <span style=color:#ff636f>short</span> <span style=color:#58a1dd>value</span>)  <span style=color:#828b96;font-style:italic>// NOLINT(*)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>:</span> <span style=color:#58a1dd>piece_</span>(<span style=color:#58a1dd>scratch_</span>,
</span></span><span style=display:flex><span>               <span style=color:#58a1dd>numbers_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>FastIntToBuffer</span>(<span style=color:#58a1dd>value</span>, <span style=color:#58a1dd>scratch_</span>) <span style=color:#ff636f>-</span> <span style=color:#58a1dd>scratch_</span>) {}
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>int</span> <span style=color:#58a1dd>value</span>)  <span style=color:#828b96;font-style:italic>// NOLINT(runtime/explicit)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>:</span> <span style=color:#58a1dd>piece_</span>(<span style=color:#58a1dd>scratch_</span>,
</span></span><span style=display:flex><span>               <span style=color:#58a1dd>numbers_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>FastIntToBuffer</span>(<span style=color:#58a1dd>value</span>, <span style=color:#58a1dd>scratch_</span>) <span style=color:#ff636f>-</span> <span style=color:#58a1dd>scratch_</span>) {}
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>unsigned</span> <span style=color:#ff636f>int</span> <span style=color:#58a1dd>value</span>)  <span style=color:#828b96;font-style:italic>// NOLINT(runtime/explicit)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>:</span> <span style=color:#58a1dd>piece_</span>(<span style=color:#58a1dd>scratch_</span>,
</span></span><span style=display:flex><span>               <span style=color:#58a1dd>numbers_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>FastIntToBuffer</span>(<span style=color:#58a1dd>value</span>, <span style=color:#58a1dd>scratch_</span>) <span style=color:#ff636f>-</span> <span style=color:#58a1dd>scratch_</span>) {}
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>long</span> <span style=color:#58a1dd>value</span>)  <span style=color:#828b96;font-style:italic>// NOLINT(*)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>:</span> <span style=color:#58a1dd>piece_</span>(<span style=color:#58a1dd>scratch_</span>,
</span></span><span style=display:flex><span>               <span style=color:#58a1dd>numbers_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>FastIntToBuffer</span>(<span style=color:#58a1dd>value</span>, <span style=color:#58a1dd>scratch_</span>) <span style=color:#ff636f>-</span> <span style=color:#58a1dd>scratch_</span>) {}
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>unsigned</span> <span style=color:#ff636f>long</span> <span style=color:#58a1dd>value</span>)  <span style=color:#828b96;font-style:italic>// NOLINT(*)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>:</span> <span style=color:#58a1dd>piece_</span>(<span style=color:#58a1dd>scratch_</span>,
</span></span><span style=display:flex><span>               <span style=color:#58a1dd>numbers_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>FastIntToBuffer</span>(<span style=color:#58a1dd>value</span>, <span style=color:#58a1dd>scratch_</span>) <span style=color:#ff636f>-</span> <span style=color:#58a1dd>scratch_</span>) {}
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>long</span> <span style=color:#ff636f>long</span> <span style=color:#58a1dd>value</span>)  <span style=color:#828b96;font-style:italic>// NOLINT(*)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>:</span> <span style=color:#58a1dd>piece_</span>(<span style=color:#58a1dd>scratch_</span>,
</span></span><span style=display:flex><span>               <span style=color:#58a1dd>numbers_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>FastIntToBuffer</span>(<span style=color:#58a1dd>value</span>, <span style=color:#58a1dd>scratch_</span>) <span style=color:#ff636f>-</span> <span style=color:#58a1dd>scratch_</span>) {}
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>unsigned</span> <span style=color:#ff636f>long</span> <span style=color:#ff636f>long</span> <span style=color:#58a1dd>value</span>)  <span style=color:#828b96;font-style:italic>// NOLINT(*)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>:</span> <span style=color:#58a1dd>piece_</span>(<span style=color:#58a1dd>scratch_</span>,
</span></span><span style=display:flex><span>               <span style=color:#58a1dd>numbers_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>FastIntToBuffer</span>(<span style=color:#58a1dd>value</span>, <span style=color:#58a1dd>scratch_</span>) <span style=color:#ff636f>-</span> <span style=color:#58a1dd>scratch_</span>) {}
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>float</span> <span style=color:#58a1dd>value</span>)  <span style=color:#828b96;font-style:italic>// NOLINT(runtime/explicit)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>:</span> <span style=color:#58a1dd>piece_</span>(<span style=color:#58a1dd>scratch_</span>, <span style=color:#58a1dd>numbers_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>SixDigitsToBuffer</span>(<span style=color:#58a1dd>value</span>, <span style=color:#58a1dd>scratch_</span>)) {
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>double</span> <span style=color:#58a1dd>value</span>)  <span style=color:#828b96;font-style:italic>// NOLINT(runtime/explicit)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>:</span> <span style=color:#58a1dd>piece_</span>(<span style=color:#58a1dd>scratch_</span>, <span style=color:#58a1dd>numbers_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>SixDigitsToBuffer</span>(<span style=color:#58a1dd>value</span>, <span style=color:#58a1dd>scratch_</span>)) {
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>bool</span> <span style=color:#58a1dd>value</span>)  <span style=color:#828b96;font-style:italic>// NOLINT(runtime/explicit)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>      <span style=color:#ff636f>:</span> <span style=color:#58a1dd>piece_</span>(<span style=color:#58a1dd>value</span> <span style=color:#ff636f>?</span> <span style=color:#a6be9d>&#34;true&#34;</span> <span style=color:#ff636f>:</span> <span style=color:#a6be9d>&#34;false&#34;</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#58a1dd>Hex</span> <span style=color:#58a1dd>hex</span>);  <span style=color:#828b96;font-style:italic>// NOLINT(runtime/explicit)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#58a1dd>Dec</span> <span style=color:#58a1dd>dec</span>);  <span style=color:#828b96;font-style:italic>// NOLINT(runtime/explicit)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#828b96;font-style:italic>// `void*` values, with the exception of `char*`, are printed as
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#828b96;font-style:italic>// &#34;0x&lt;hex value&gt;&#34;. However, in the case of `nullptr`, &#34;NULL&#34; is printed.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>const</span> <span style=color:#ff636f>void</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>value</span>);  <span style=color:#828b96;font-style:italic>// NOLINT(runtime/explicit)
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>Arg</span><span style=color:#ff636f>&amp;</span>) <span style=color:#ff636f>=</span> <span style=color:#ff636f>delete</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span><span style=color:#ff636f>&amp;</span> <span style=color:#ff636f>operator</span><span style=color:#ff636f>=</span>(<span style=color:#ff636f>const</span> <span style=color:#58a1dd>Arg</span><span style=color:#ff636f>&amp;</span>) <span style=color:#ff636f>=</span> <span style=color:#ff636f>delete</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>piece</span>() <span style=color:#ff636f>const</span> { <span style=color:#ff636f>return</span> <span style=color:#58a1dd>piece_</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#ff636f>private</span><span style=color:#ff636f>:</span>
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>string_view</span> <span style=color:#58a1dd>piece_</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff636f>char</span> <span style=color:#58a1dd>scratch_</span>[<span style=color:#58a1dd>numbers_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>kFastToBufferSize</span>];
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>对于 <code>double</code> 和 <code>float</code> 则使用 <code>SixDigitsToBuffer</code> 将浮点转变为 <code>%g</code> 的格式。如果要实现固定长度输出，则可以使用 <code>absl::Hex</code> <code>absl::Dec</code> 。</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Substitute</span>(<span style=color:#a6be9d>&#34;$0$1$2$3$4 $5&#34;</span>, <span style=color:#828b96;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>                 <span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Dec</span>(<span style=color:#a6be9d>0</span>), <span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Dec</span>(<span style=color:#a6be9d>1</span>, <span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>kSpacePad2</span>),
</span></span><span style=display:flex><span>                 <span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Dec</span>(<span style=color:#a6be9d>0xf</span>, <span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>kSpacePad2</span>),
</span></span><span style=display:flex><span>                 <span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Dec</span>(<span style=color:#ff636f>int16_t</span>{<span style=color:#ff636f>-</span><span style=color:#a6be9d>1</span>}, <span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>kSpacePad5</span>),
</span></span><span style=display:flex><span>                 <span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Dec</span>(<span style=color:#ff636f>int16_t</span>{<span style=color:#ff636f>-</span><span style=color:#a6be9d>1</span>}, <span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>kZeroPad5</span>),
</span></span><span style=display:flex><span>                 <span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>Dec</span>(<span style=color:#a6be9d>0x123456789abcdef</span>, <span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>kZeroPad16</span>));
</span></span></code></pre></div><p>对于 bool 类型，则会输出 <code>true</code> 或者 <code>false</code>。<br>本质上来说 <code>Substitute</code> 是一种简化的格式化输出方案，使用编译器重载解决了运行时检查类型的麻烦，因此，这种方案安全程度比较高，效率也非常不错。但 format 支持的参数个数比较有限。absl::Substitute 同样实现了编译器参数个数检查。</p><h3 id=strcat>StrCat</h3><p>在 Abseil 之中还有一个 <a href=https://github.com/abseil/abseil-cpp/blob/master/absl/strings/str_cat.h>absl::StrCat</a> 用来取代字符串格式化。在 C 语言标准库中，<code>strcat</code> 用于连接字符串，参数个数是固定的，并且只支持 C-Style 字符串，而 Abseil 团队利用 C++ 变参模板特性实现了现代的 StrCat.</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>auto</span> <span style=color:#58a1dd>result</span> <span style=color:#ff636f>=</span>
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>absl</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>StrCat</span>(<span style=color:#a6be9d>1</span>, <span style=color:#a6be9d>2</span>, <span style=color:#a6be9d>3</span>, <span style=color:#a6be9d>4</span>, <span style=color:#a6be9d>5</span>, <span style=color:#a6be9d>6</span>, <span style=color:#a6be9d>7</span>, <span style=color:#a6be9d>8</span>, <span style=color:#a6be9d>9</span>, <span style=color:#a6be9d>&#34;a&#34;</span>, <span style=color:#a6be9d>&#34;b&#34;</span>, <span style=color:#a6be9d>&#34;c&#34;</span>, <span style=color:#a6be9d>&#34;d&#34;</span>, <span style=color:#a6be9d>&#34;e&#34;</span>, <span style=color:#a6be9d>&#34;f&#34;</span>, <span style=color:#a6be9d>&#34;g&#34;</span>,
</span></span><span style=display:flex><span>                 <span style=color:#a6be9d>&#34;h&#34;</span>, <span style=color:#a6be9d>&#34;i&#34;</span>, <span style=color:#a6be9d>&#34;j&#34;</span>, <span style=color:#a6be9d>&#34;k&#34;</span>, <span style=color:#a6be9d>&#34;l&#34;</span>, <span style=color:#a6be9d>&#34;m&#34;</span>, <span style=color:#a6be9d>&#34;n&#34;</span>, <span style=color:#a6be9d>&#34;o&#34;</span>, <span style=color:#a6be9d>&#34;p&#34;</span>, <span style=color:#a6be9d>&#34;q&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// 123456789abcdefghijklmnopq
</span></span></span></code></pre></div><p>与 Subsititute 一样，StrCat 也是用了类似 <code>Arg</code> 的 <code>AlphaNum</code> 将字符串和基本类型按照原因（或者 Hex,Dec）拼接成特定的字符串，并且在拼接字符串时能够提前 resize 从而减少内存分配次数，达到优化的目的，在 GNK 的代码中，凡是需要连接字符串的操作，我们都使用 StrCat 来操作，避免使用 snprintf 或者 strcat 操作。
在 <a href=https://github.com/M2Team/Privexec>Privexec</a>, <a href=https://github.com/fstudio/clangbuilder>Clangbuilder</a> 和 <a href=https://github.com/fcharlie/Planck>Planck</a> 当中，我借鉴 absl::StrCat 实现了一个宽字符版本的 <a href=https://github.com/M2Team/Privexec/blob/master/include/strcat.hpp><code>base::StringCat</code></a> 不支持 double/float，不支持 Hex，Dec ，仅支持其他基本类型和 <code>char*</code> <code>std::wstring_view</code> <code>std::wstring</code>。</p><h2 id=异步信号安全的字符串格式化>异步信号安全的字符串格式化</h2><p>上述现代 C++ 格式化方案通常情况下令人满意，但是当我们需要实现一个异步信号安全的格式化输出方案时，则不得不重新打算，异步信号安全指的是在信号中断的回调函数中不得调用非异步安全的函数，由于信号随时可能发生，因此，在信号中断函数中必须不存在内存分配，不能拥有互斥锁等，在 Glibc 和 musl 之中，由于 snprintf 使用了文件对象和锁调用了 <code>vfprintf</code> 则不是异步信号安全的，这很容易理解，由于 <code>FILE</code> 使用了缓存，需要使用锁保证线程安全。在 OpenBSD 当中，snprintf 实现是异步信号安全的，在 Github 上有异步信号安全的 snprintf 实现，如 <a href=https://github.com/weiss/c99-snprintf>c99-snprintf</a> 和 <a href=https://github.com/idning/safe_snprintf>safe_snprintf</a>。前面所说的 <code>ngx_snprintf</code> 也可以轻松的实现异步信号安全。</p><p>在 absl::StrFormat 中，查看源码发现 <code>absl::SNPrintF</code> 是没有内存分配的，但异步信号安全还有待考察。</p><p>在 Chromium 项目中，也有一个基于现代 C++ 实现的异步信号安全的 <a href=https://github.com/chromium/chromium/blob/master/base/strings/safe_sprintf.h>SafeSNPrintf</a>。在这个实现中，使用 union 包装变量，并增加类型信息，这种常见于 Json, Toml 等格式文件的解析。在格式化时，解析 format 字符串，期望的格式与输入的参数匹配类型，一旦类型匹配，则正常格式化，不匹配则退出，这种方案比 snprintf 要好的多，毕竟 snprintf 只预期输入格式正确。</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>struct</span> <span style=color:#58a1dd>Arg</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>enum</span> <span style=color:#58a1dd>Type</span> { <span style=color:#58a1dd>INT</span>, <span style=color:#58a1dd>UINT</span>, <span style=color:#58a1dd>STRING</span>, <span style=color:#58a1dd>POINTER</span> };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#828b96;font-style:italic>// Any integer-like value.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>signed</span> <span style=color:#ff636f>char</span> <span style=color:#58a1dd>c</span>) <span style=color:#ff636f>:</span> <span style=color:#58a1dd>type</span>(<span style=color:#58a1dd>INT</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>i</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>c</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>width</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>sizeof</span>(<span style=color:#ff636f>char</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>unsigned</span> <span style=color:#ff636f>char</span> <span style=color:#58a1dd>c</span>) <span style=color:#ff636f>:</span> <span style=color:#58a1dd>type</span>(<span style=color:#58a1dd>UINT</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>i</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>c</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>width</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>sizeof</span>(<span style=color:#ff636f>char</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>signed</span> <span style=color:#ff636f>short</span> <span style=color:#58a1dd>j</span>) <span style=color:#ff636f>:</span> <span style=color:#58a1dd>type</span>(<span style=color:#58a1dd>INT</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>i</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>j</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>width</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>sizeof</span>(<span style=color:#ff636f>short</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>unsigned</span> <span style=color:#ff636f>short</span> <span style=color:#58a1dd>j</span>) <span style=color:#ff636f>:</span> <span style=color:#58a1dd>type</span>(<span style=color:#58a1dd>UINT</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>i</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>j</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>width</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>sizeof</span>(<span style=color:#ff636f>short</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>signed</span> <span style=color:#ff636f>int</span> <span style=color:#58a1dd>j</span>) <span style=color:#ff636f>:</span> <span style=color:#58a1dd>type</span>(<span style=color:#58a1dd>INT</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>i</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>j</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>width</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>sizeof</span>(<span style=color:#ff636f>int</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>unsigned</span> <span style=color:#ff636f>int</span> <span style=color:#58a1dd>j</span>) <span style=color:#ff636f>:</span> <span style=color:#58a1dd>type</span>(<span style=color:#58a1dd>UINT</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>i</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>j</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>width</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>sizeof</span>(<span style=color:#ff636f>int</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>signed</span> <span style=color:#ff636f>long</span> <span style=color:#58a1dd>j</span>) <span style=color:#ff636f>:</span> <span style=color:#58a1dd>type</span>(<span style=color:#58a1dd>INT</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>i</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>j</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>width</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>sizeof</span>(<span style=color:#ff636f>long</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>unsigned</span> <span style=color:#ff636f>long</span> <span style=color:#58a1dd>j</span>) <span style=color:#ff636f>:</span> <span style=color:#58a1dd>type</span>(<span style=color:#58a1dd>UINT</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>i</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>j</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>width</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>sizeof</span>(<span style=color:#ff636f>long</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>signed</span> <span style=color:#ff636f>long</span> <span style=color:#ff636f>long</span> <span style=color:#58a1dd>j</span>) <span style=color:#ff636f>:</span> <span style=color:#58a1dd>type</span>(<span style=color:#58a1dd>INT</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>i</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>j</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>width</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>sizeof</span>(<span style=color:#ff636f>long</span> <span style=color:#ff636f>long</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>unsigned</span> <span style=color:#ff636f>long</span> <span style=color:#ff636f>long</span> <span style=color:#58a1dd>j</span>) <span style=color:#ff636f>:</span> <span style=color:#58a1dd>type</span>(<span style=color:#58a1dd>UINT</span>) {
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>i</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>j</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>integer</span>.<span style=color:#58a1dd>width</span> <span style=color:#ff636f>=</span> <span style=color:#ff636f>sizeof</span>(<span style=color:#ff636f>long</span> <span style=color:#ff636f>long</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#828b96;font-style:italic>// A C-style text string.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>) <span style=color:#ff636f>:</span> <span style=color:#58a1dd>str</span>(<span style=color:#58a1dd>s</span>), <span style=color:#58a1dd>type</span>(<span style=color:#58a1dd>STRING</span>) { }
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>Arg</span>(<span style=color:#ff636f>char</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>s</span>)       <span style=color:#ff636f>:</span> <span style=color:#58a1dd>str</span>(<span style=color:#58a1dd>s</span>), <span style=color:#58a1dd>type</span>(<span style=color:#58a1dd>STRING</span>) { }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#828b96;font-style:italic>// Any pointer value that can be cast to a &#34;void*&#34;.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#ff636f>template</span><span style=color:#ff636f>&lt;</span><span style=color:#ff636f>class</span> <span style=color:#58a1dd>T</span><span style=color:#ff636f>&gt;</span> <span style=color:#58a1dd>Arg</span>(<span style=color:#58a1dd>T</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>p</span>) <span style=color:#ff636f>:</span> <span style=color:#58a1dd>ptr</span>((<span style=color:#ff636f>void</span><span style=color:#ff636f>*</span>)<span style=color:#58a1dd>p</span>), <span style=color:#58a1dd>type</span>(<span style=color:#58a1dd>POINTER</span>) { }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff636f>union</span> {
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// An integer-like value.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#ff636f>struct</span> {
</span></span><span style=display:flex><span>      <span style=color:#ff636f>int64_t</span>       <span style=color:#58a1dd>i</span>;
</span></span><span style=display:flex><span>      <span style=color:#ff636f>unsigned</span> <span style=color:#ff636f>char</span> <span style=color:#58a1dd>width</span>;
</span></span><span style=display:flex><span>    } <span style=color:#58a1dd>integer</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// A C-style text string.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>str</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#828b96;font-style:italic>// A pointer to an arbitrary object.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>    <span style=color:#ff636f>const</span> <span style=color:#ff636f>void</span><span style=color:#ff636f>*</span> <span style=color:#58a1dd>ptr</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#ff636f>const</span> <span style=color:#ff636f>enum</span> <span style=color:#58a1dd>Type</span> <span style=color:#58a1dd>type</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>如果要实现 <code>std::string</code> <code>std::string_view</code> 的格式化，我们也可以在 union 中使用如下结构取代 <code>const char* str</code>：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#ff636f>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff636f>const</span> <span style=color:#ff636f>char</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>data</span>;
</span></span><span style=display:flex><span>    <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>len</span>;
</span></span><span style=display:flex><span>}<span style=color:#58a1dd>stringview</span>;
</span></span></code></pre></div><p>这样的好处是 <code>std::string/std::string_view</code> 不再需要计算长度。我们还可以使用 <code>%v</code> 按照输入参数的类型自主格式化，这样就不存在类型不匹配了。</p><h2 id=bela-strformat>Bela StrFormat</h2><p><strong>2019-05-17 Update:</strong> 最近我编写了一个基于 C++17 的 Windows 系统上的工具库，叫 <a href=https://github.com/fcharlie/bela>Bela</a>，Bela 学习了 <code>Chromium SafeNPrintf</code>，实现了类型安全的字符串格式化，任意长度整型 <code>%d</code>，字符串<code>%s</code>, 浮点(float, double) <code>%f</code>, 十六进制 <code>%x</code> <code>%X</code>，还有 <code>%p</code> 输出指针。支持 Pading 输出。</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#828b96;font-style:italic>// https://github.com/fcharlie/bela/blob/master/include/bela/fmt.hpp
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#ff636f>typename</span>... <span style=color:#58a1dd>Args</span><span style=color:#ff636f>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>ssize_t</span> <span style=color:#58a1dd>StrFormat</span>(<span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>buf</span>, <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>N</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>fmt</span>, <span style=color:#58a1dd>Args</span>... <span style=color:#58a1dd>args</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>const</span> <span style=color:#58a1dd>format_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>FormatArg</span> <span style=color:#58a1dd>arg_array</span>[] <span style=color:#ff636f>=</span> {<span style=color:#58a1dd>args</span>...};
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>format_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>StrFormatInternal</span>(<span style=color:#58a1dd>buf</span>, <span style=color:#58a1dd>N</span>, <span style=color:#58a1dd>fmt</span>, <span style=color:#58a1dd>arg_array</span>,
</span></span><span style=display:flex><span>                                            <span style=color:#ff636f>sizeof</span>...(<span style=color:#58a1dd>args</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>N</span>, <span style=color:#ff636f>typename</span>... <span style=color:#58a1dd>Args</span><span style=color:#ff636f>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>ssize_t</span> <span style=color:#58a1dd>StrFormat</span>(<span style=color:#ff636f>wchar_t</span> (<span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>buf</span>)[<span style=color:#58a1dd>N</span>], <span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>fmt</span>, <span style=color:#58a1dd>Args</span>... <span style=color:#58a1dd>args</span>) {
</span></span><span style=display:flex><span>  <span style=color:#828b96;font-style:italic>// Use Arg() object to record type information and then copy arguments to an
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#828b96;font-style:italic>// array to make it easier to iterate over them.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#ff636f>const</span> <span style=color:#58a1dd>format_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>FormatArg</span> <span style=color:#58a1dd>arg_array</span>[] <span style=color:#ff636f>=</span> {<span style=color:#58a1dd>args</span>...};
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>format_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>StrFormatInternal</span>(<span style=color:#58a1dd>buf</span>, <span style=color:#58a1dd>N</span>, <span style=color:#58a1dd>fmt</span>, <span style=color:#58a1dd>arg_array</span>,
</span></span><span style=display:flex><span>                                            <span style=color:#ff636f>sizeof</span>...(<span style=color:#58a1dd>args</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#ff636f>typename</span>... <span style=color:#58a1dd>Args</span><span style=color:#ff636f>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring</span> <span style=color:#58a1dd>StrFormat</span>(<span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>fmt</span>, <span style=color:#58a1dd>Args</span>... <span style=color:#58a1dd>args</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>const</span> <span style=color:#58a1dd>format_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>FormatArg</span> <span style=color:#58a1dd>arg_array</span>[] <span style=color:#ff636f>=</span> {<span style=color:#58a1dd>args</span>...};
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>format_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>StrFormatInternal</span>(<span style=color:#58a1dd>fmt</span>, <span style=color:#58a1dd>arg_array</span>, <span style=color:#ff636f>sizeof</span>...(<span style=color:#58a1dd>args</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic>// Fast-path when we don&#39;t actually need to substitute any arguments.
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>ssize_t</span> <span style=color:#58a1dd>StrFormat</span>(<span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>buf</span>, <span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>N</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>fmt</span>);
</span></span><span style=display:flex><span><span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring</span> <span style=color:#58a1dd>StrFormat</span>(<span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>fmt</span>);
</span></span><span style=display:flex><span><span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#58a1dd>size_t</span> <span style=color:#58a1dd>N</span><span style=color:#ff636f>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff636f>inline</span> <span style=color:#58a1dd>ssize_t</span> <span style=color:#58a1dd>StrFormat</span>(<span style=color:#ff636f>wchar_t</span> (<span style=color:#ff636f>&amp;</span><span style=color:#58a1dd>buf</span>)[<span style=color:#58a1dd>N</span>], <span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>fmt</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>StrFormat</span>(<span style=color:#58a1dd>buf</span>, <span style=color:#58a1dd>N</span>, <span style=color:#58a1dd>fmt</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>支持的字符串类型：</p><ul><li><code>std::wstring</code></li><li><code>std::wstring_view</code></li><li><code>const wchar_t *</code></li><li><code>wchar_t *</code></li><li><code>std::u16string</code></li><li><code>std::u16string_view</code></li><li><code>const char16_t *</code></li><li><code>char16_t *</code></li></ul><p>以及以下会转换为 UTF-16 的 UTF-8 字符串类型：</p><ul><li><code>std::string</code></li><li><code>std::string_view</code></li><li><code>const char *</code></li><li><code>char *</code></li></ul><p>基于 <code>Bela Format</code> 我还编写了 <code>bela::FPrintF</code> 将格式化的数据输出到控制台终端或者文件，当输出到 Conhost 时，则会以 UTF-16 编码输出，若输出到文件或者 Cygwin 终端时，则会转为 UTF-8 输出。</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#828b96;font-style:italic>//https://github.com/fcharlie/bela/blob/master/include/bela/stdwriter.hpp
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#58a1dd>ssize_t</span> <span style=color:#58a1dd>StdWrite</span>(<span style=color:#58a1dd>FILE</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>out</span>, <span style=color:#58a1dd>std</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>wstring_view</span> <span style=color:#58a1dd>msg</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>template</span> <span style=color:#ff636f>&lt;</span><span style=color:#ff636f>typename</span>... <span style=color:#58a1dd>Args</span><span style=color:#ff636f>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#58a1dd>ssize_t</span> <span style=color:#58a1dd>FPrintF</span>(<span style=color:#58a1dd>FILE</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>out</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>fmt</span>, <span style=color:#58a1dd>Args</span>... <span style=color:#58a1dd>args</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>const</span> <span style=color:#58a1dd>format_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>FormatArg</span> <span style=color:#58a1dd>arg_array</span>[] <span style=color:#ff636f>=</span> {<span style=color:#58a1dd>args</span>...};
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>str</span> <span style=color:#ff636f>=</span>
</span></span><span style=display:flex><span>      <span style=color:#58a1dd>format_internal</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>StrFormatInternal</span>(<span style=color:#58a1dd>fmt</span>, <span style=color:#58a1dd>arg_array</span>, <span style=color:#ff636f>sizeof</span>...(<span style=color:#58a1dd>args</span>));
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>StdWrite</span>(<span style=color:#58a1dd>out</span>, <span style=color:#58a1dd>str</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff636f>inline</span> <span style=color:#58a1dd>ssize_t</span> <span style=color:#58a1dd>FPrintF</span>(<span style=color:#58a1dd>FILE</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>out</span>, <span style=color:#ff636f>const</span> <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>*</span><span style=color:#58a1dd>fmt</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>str</span> <span style=color:#ff636f>=</span> <span style=color:#58a1dd>StrFormat</span>(<span style=color:#58a1dd>fmt</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#58a1dd>StdWrite</span>(<span style=color:#58a1dd>out</span>, <span style=color:#58a1dd>str</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>一个简单的例子（此代码能够在 Windows Terminal 和 Mintty 等终端上正常显示 emoji）：</p><div class=highlight><pre tabindex=0 style=color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#828b96;font-style:italic>// https://github.com/fcharlie/bela/blob/master/test/fmt/main.cc
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span><span style=color:#828b96;font-style:italic>#include</span> <span style=color:#828b96;font-style:italic>&lt;bela/stdwriter.hpp&gt;</span><span style=color:#828b96;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ff636f>int</span> <span style=color:#58a1dd>wmain</span>(<span style=color:#ff636f>int</span> <span style=color:#58a1dd>argc</span>, <span style=color:#ff636f>wchar_t</span> <span style=color:#ff636f>**</span><span style=color:#58a1dd>argv</span>) {
</span></span><span style=display:flex><span>  <span style=color:#ff636f>auto</span> <span style=color:#58a1dd>ux</span> <span style=color:#ff636f>=</span> <span style=color:#a6be9d>&#34;</span><span style=color:#a6be9d>\xf0\x9f\x98\x81</span><span style=color:#a6be9d> UTF-8 text </span><span style=color:#a6be9d>\xE3\x8D\xA4</span><span style=color:#a6be9d>&#34;</span>; <span style=color:#828b96;font-style:italic>// force encode UTF-8
</span></span></span><span style=display:flex><span><span style=color:#828b96;font-style:italic></span>  <span style=color:#ff636f>wchar_t</span> <span style=color:#58a1dd>wx</span>[] <span style=color:#ff636f>=</span> <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#34;Engine </span><span style=color:#a6be9d>\xD83D\xDEE0</span><span style=color:#a6be9d>&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#58a1dd>bela</span><span style=color:#ff636f>::</span><span style=color:#58a1dd>FPrintF</span>(<span style=color:#58a1dd>stderr</span>, <span style=color:#a6be9d>L</span><span style=color:#a6be9d>&#34;Argc: %d Arg0: %s W: %s UTF-8: %s __cplusplus: %d</span><span style=color:#a6be9d>\n</span><span style=color:#a6be9d>&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#58a1dd>argc</span>, <span style=color:#58a1dd>argv</span>[<span style=color:#a6be9d>0</span>], <span style=color:#58a1dd>wx</span>, <span style=color:#58a1dd>ux</span>, <span style=color:#58a1dd>__cplusplus</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff636f>return</span> <span style=color:#a6be9d>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=结尾>结尾</h2><p>在格式化函数的过程中，C++ 的不足在于没有反射，从而无法很好的获得对象的类型，这样传统的格式化方案就容易出现问题，而是用变参模板，在复杂的编码技巧加成后，使用编译器的检查能够很好的实现类型安全高效的格式化，但是也存在一个问题，那就是程序编译后提交较大，但都到了 9012，只要不超过 Clang 的体积都是能接受的。</p><hr width=100% id=EOF><p style=color:#777>Last modified on 2019-04-29</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/2019/2019-05-25-introduction-bela/>Next<br>介绍 Bela
</a><a class=older-posts href=/posts/2019/2019-04-01-implement-git-dir-accesss-control/>Previous<br>实现 Git 目录权限控制</a></nav><div class=post-comment-wrapper></div></div></div></div></div><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://forcemz.net/><div class=nav-title>江二十三的思考</div><div class=nav-subtitle>Themed by Diary.</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>归档
</a><a class="a-block nav-link-item false" href=/categories>分类
</a><a class="a-block nav-link-item false" href=/tags>标签
</a><a class="a-block nav-link-item false" href=/about>关于
</a><a class="a-block nav-link-item false" href=/index.xml>RSS Feed</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><div id=extraContainer class=extra-container><div class=toc-wrapper><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><li><a href=#%e5%89%8d%e8%a8%80 class=nav-前言>前言</a></li><ul><li><a href=#%e6%a0%bc%e5%bc%8f%e5%8c%96%e5%86%85%e5%b9%95 class=nav-格式化内幕>格式化内幕</a></li><li><a href=#c-style-%e6%a0%bc%e5%bc%8f%e5%8c%96%e7%9a%84%e7%bc%ba%e9%99%b7 class=nav-c-style-格式化的缺陷>C-Style 格式化的缺陷</a></li><li><a href=#%e5%ae%89%e5%85%a8%e6%a0%bc%e5%bc%8f%e5%8c%96%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88 class=nav-安全格式化解决方案>安全格式化解决方案</a></li><ul><li><a href=#%e7%bc%96%e8%af%91%e5%99%a8%e7%9a%84%e5%8f%82%e6%95%b0%e5%8c%b9%e9%85%8d%e6%a3%80%e6%9f%a5 class=nav-编译器的参数匹配检查>编译器的参数匹配检查</a></li><li><a href=#%e5%8f%98%e5%8f%82%e5%87%bd%e6%95%b0%e6%a8%a1%e6%9d%bf%e7%9a%84%e8%be%85%e5%8a%a9 class=nav-变参函数模板的辅助>变参函数模板的辅助</a></li></ul><li><a href=#%e7%8e%b0%e4%bb%a3-c-%e6%a0%bc%e5%bc%8f%e5%8c%96%e5%ba%93 class=nav-现代-c-格式化库>现代 C++ 格式化库</a></li><ul><li><a href=#%e7%a7%af%e6%9e%81%e5%85%a5%e6%a0%87%e5%87%86%e7%9a%84-fmtlib class=nav-积极入标准的-fmtlib>积极入标准的 fmtlib</a></li><li><a href=#facebook-folly-format class=nav-facebook-folly-format>Facebook folly format</a></li><li><a href=#google-abseil-strformat class=nav-google-abseil-strformat>Google Abseil StrFormat</a></li></ul><li><a href=#%e5%ad%97%e7%ac%a6%e4%b8%b2%e5%8e%bb%e6%a0%bc%e5%bc%8f%e5%8c%96 class=nav-字符串去格式化>字符串去格式化</a></li><ul><li><a href=#substitute class=nav-substitute>Substitute</a></li><li><a href=#strcat class=nav-strcat>StrCat</a></li></ul><li><a href=#%e5%bc%82%e6%ad%a5%e4%bf%a1%e5%8f%b7%e5%ae%89%e5%85%a8%e7%9a%84%e5%ad%97%e7%ac%a6%e4%b8%b2%e6%a0%bc%e5%bc%8f%e5%8c%96 class=nav-异步信号安全的字符串格式化>异步信号安全的字符串格式化</a></li><li><a href=#bela-strformat class=nav-bela-strformat>Bela StrFormat</a></li><li><a href=#%e7%bb%93%e5%b0%be class=nav-结尾>结尾</a></li></ul></div></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up
</i></a><a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copyright (c) 2009-2024 J23</div></div><script src=/js/journal.js></script></body></html>